---
title: "substate analysis"
author: "Helio Cuve"
date: "2023-04-27"
output: html_document
---



libraries
if you don't have those install them
```{r}
library(tidyverse)



```
classify substates

- quick test witha  single case

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)
p1_angry<- df_OF_output_AUsW_unblind_posed_binned %>%
  ungroup()%>%
  subset(filename == "./cut_posed_angry_day1_p1.csv")

set.seed(1)
wcss = vector()
colnames(p1_angry)
# for (i in 1:10) wcss[i] = sum(kmeans(p1_angry[,38:41], i)$withinss)
kmeans(p1_angry[,38:41], i)$withinss)
# plot(1:10,
#      wcss,
#      type = 'b',
#      main = paste('The Elbow Method'),
#      xlab = 'Number of clusters',
#      ylab = 'WCSS')
# 
# # Fitting K-Means to the dataset
# set.seed(25)
# kmeans = kmeans(x = clust_dataset, centers = 3)
# y_kmeans = kmeans$cluster
# 
# # Visualising the clusters
# # install.packages("cluster")
# library(cluster)
# 
# ?clusplot
# 
# clust_dataset
# y_kmeans
# clusplot(clust_dataset,
#          y_kmeans,
#          lines = 2,
#          shade = TRUE,
#          color = TRUE,
#          labels = 1,
#          plotchar = FALSE,
#          span = TRUE
#          # label = 
#          # main = paste('Clusters of customers'),
#          # xlab = 'Annual Income',
#          # ylab = 'Spending Score'
#          )
?kmeans

p1_angry<- p1_angry[,c(2,38:41)]

?diff()

p1_angry 

p1_angry1<- p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k4_comp1_speed = (abs(lag(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)),
         k4_comp2_speed = (abs(lag(k4_comp2) - k4_comp2))/abs((lead(bin_frame)-bin_frame)),
         k4_comp3_speed = (abs(lag(k4_comp3) - k4_comp3))/abs((lead(bin_frame)-bin_frame)),
         k4_comp4_speed = (abs(lag(k4_comp4) - k4_comp4))/abs((lead(bin_frame)-bin_frame)),
         k4_comp1_diff =diff(zoo::zoo(k4_comp1), na.pad = TRUE),
         k4_comp2_diff =diff(zoo::zoo(k4_comp2), na.pad = TRUE),
         k4_comp3_diff =diff(zoo::zoo(k4_comp3), na.pad = TRUE),
         k4_comp4_diff =diff(zoo::zoo(k4_comp4), na.pad = TRUE),
         
         # moving averages
         k4_comp1_diff_ma = zoo::rollmean(k4_comp1_diff, k = 5, fill = NA),
         k4_comp2_diff_ma = zoo::rollmean(k4_comp2_diff, k = 5, fill = NA),
         k4_comp3_diff_ma = zoo::rollmean(k4_comp3_diff, k = 5, fill = NA),
         k4_comp4_diff_ma = zoo::rollmean(k4_comp4_diff, k = 5, fill = NA),
           
          k4_comp1_speed_ma = zoo::rollmean(k4_comp1_speed, k = 5, fill = NA),
        k4_comp2_speed_ma = zoo::rollmean(k4_comp2_speed, k = 5, fill = NA),
         k4_comp3_speed_ma = zoo::rollmean(k4_comp3_speed, k = 5, fill = NA),
         k4_comp4_speed_ma = zoo::rollmean(k4_comp4_speed, k = 5, fill = NA),
         )%>%
  select(1,14:21)%>%
gather(component, coef,-bin_frame)%>%
  # group_by( component, bin_frame)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), abs(coef), color = component))+
  geom_line()

p1_angry1<- na.omit(p1_angry1)
p1_angry1
p1_angry1_scale<- p1_angry1%>%mutate_at(2:9, scale)


p1_angry1_scale%>%
  gather(component, coef,-bin_frame)%>%
  # group_by( component, bin_frame)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef, color = component))+
  geom_line()


cor(p1_angry[,2:5])
  
```


```{r}

colnames(p1_angry)
# replace nas
replace_na(list(p1_angry=0, y = 0))
p1_angry<-as.data.frame(p1_angry)
p1_angry[is.na(p1_angry)] <-0

p1_angry[is.na(p1_angry)] <- 0


p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:42))%>%
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame,-kmean_order)%>%
  group_by( component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


# lets compute speed
colnames(p1_angry)
p1_angry<- p1_angry %>%
mutate_at(c(43:46), ~replace(., is.na(.), 0))
  


testk$cluster
testk<-kmeans(p1_angry[,38:41], 3)
colnames(p1_angry)

# let's do the kmeans
p1_angry1_scale
# p1_angry_kmean_clust<- kmeans(p1_angry1_scale[,2:9], 3)
# p1_angry_kmean_clust_speed<- kmeans(p1_angry[,43:46], 3)
# p1_angry$kmean_order<- p1_angry_kmean_clust$cluster
# p1_angry$kmean_order_speed<- p1_angry_kmean_clust_speed$cluster
# 
# p1_angry$kmean_center<- p1_angry_kmean_clust$cluster


# based on dist and speed
# scale predictors

p1_angry_kmean_clust_speed_dist<- kmeans(p1_angry1_scale[,c(2:9)], 3)
p1_angry1_scale$kmean_order_dist_speed<- p1_angry_kmean_clust_speed_dist$cluster


# plot cluster absed on component weights
colnames(p1_angry)
p1_angry1_scale%>%
ungroup()%>%
  # select(c(2,38:42))%>%
  gather(component, coef,-bin_frame,-kmean_order_dist_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_dist_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


left_join(p1_angry1_scale, p1_angry)[,c(1,10:14)]%>%
  # su
  
  # select(c(2,38:42))%>%
  gather(component, coef,-bin_frame,-kmean_order_dist_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_dist_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

# lets test in a seconf example


```



# what we need to do now is for every person run a loop that first for each trial a kmean,

algorithmic from 2 to 10 and 
store
- kmean result cluster in each iteration

we need a list that will store unique trial name + number of K+ resulting k object


when we find these clusters we can write a  simple algorythim that classifies the data into

sustain, activation, sustain, dectivatio sutain
for example is the respective cluster average is bigger than the avergae of all clusters or smaller than,
its sustain.

if the clister dispalcement is bigger than the whole average and the speed is higher than the whole average - displacement, is direction is positive, activation, of direction is negeative is deactovation



```{r}


# <- unique(df_OF_output_AUsW_unblind_posed_binned$filename)
# 228

store_kmeans<- list()

# len <- 5
# empty_list <- vector(mode = "list", length = length(unique_trial))

empty_list


colnames(df_OF_output_AUsW_unblind_posed_binned)

# compute the speed metrics
options(scipen = 999)
df_OF_output_AUsW_unblind_posed_binned

df_OF_output_AUsW_unblind_posed_binned1<- df_OF_output_AUsW_unblind_posed_binned[,1:36]%>%
  ungroup()%>%
  group_by(filename)%>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k3_comp1_speed = (abs(lag(comp1) - comp1))/abs((lead(bin_frame)-bin_frame)),
         k3_comp2_speed = (abs(lag(comp2) - comp2))/abs((lead(bin_frame)-bin_frame)),
         k3_comp3_speed = (abs(lag(comp3) - comp3))/abs((lead(bin_frame)-bin_frame)),
        
         k3_comp1_diff = as.numeric(diff(zoo::zoo(comp1), na.pad = TRUE)),
         k3_comp2_diff =as.numeric(diff(zoo::zoo(comp2), na.pad = TRUE)),
         k3_comp3_diff =as.numeric(diff(zoo::zoo(comp3), na.pad = TRUE)),
         
         # moving averages
         k3_comp1_diff_ma = as.numeric(zoo::rollmean(k3_comp1_diff, k = 5, fill = NA)),
         k3_comp2_diff_ma = as.numeric(zoo::rollmean(k3_comp2_diff, k = 5, fill = NA)),
         k3_comp3_diff_ma = as.numeric(zoo::rollmean(k3_comp3_diff, k = 5, fill = NA)),
           
          k3_comp1_speed_ma = as.numeric(zoo::rollmean(k3_comp1_speed, k = 5, fill = NA)),
        k3_comp2_speed_ma = as.numeric(zoo::rollmean(k3_comp2_speed, k = 5, fill = NA)),
         k3_comp3_speed_ma = as.numeric(zoo::rollmean(k3_comp3_speed, k = 5, fill = NA)))%>%
    ungroup()%>%
  mutate(idno = rep(1:228, each = 100))

# 
# pad NAS
#   mutate(df_OF_output_AUsW_unblind_posed_binned1, across(everything(), ~replace_na(.x, 0)))
# 
#   mutate_at(c("k4_comp1_speed", "k4_comp2_speed", "k4_comp3_speed", "k4_comp4_speed"), ~replace(., is.na(.), 0))


unique(df_OF_output_AUsW_unblind_posed_binned1$filename)
df_OF_output_AUsW_unblind_posed_binned1%>%
  subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
  mutate(speed_diff = abs(k3_comp1_speed - lag(k3_comp1_speed)))%>%
  ggplot(aes(bin_frame, k3_comp1_speed_ma))+
  geom_line()+
  geom_line(aes(y  = k3_comp1_diff_ma), color = "red")

df_OF_output_AUsW_unblind_posed_binned

```
  ungroup()%>%
  group_by(filename)%>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k3_comp1_speed = (abs(lag(comp1) - comp1))/abs((lead(bin_frame)-bin_frame)),
         k3_comp2_speed = (abs(lag(comp2) - comp2))/abs((lead(bin_frame)-bin_frame)),
         k3_comp3_speed = (abs(lag(comp3) - comp3))/abs((lead(bin_frame)-bin_frame)),
        
         k3_comp1_diff = as.numeric(diff(zoo::zoo(comp1), na.pad = TRUE)),
         k3_comp2_diff =as.numeric(diff(zoo::zoo(comp2), na.pad = TRUE)),
         k3_comp3_diff =as.numeric(diff(zoo::zoo(comp3), na.pad = TRUE)),
         
         # moving averages
         k3_comp1_diff_ma = as.numeric(zoo::rollmean(k3_comp1_diff, k = 5, fill = NA)),
         k3_comp2_diff_ma = as.numeric(zoo::rollmean(k3_comp2_diff, k = 5, fill = NA)),
         k3_comp3_diff_ma = as.numeric(zoo::rollmean(k3_comp3_diff, k = 5, fill = NA)),
           
          k3_comp1_speed_ma = as.numeric(zoo::rollmean(k3_comp1_speed, k = 5, fill = NA)),
        k3_comp2_speed_ma = as.numeric(zoo::rollmean(k3_comp2_speed, k = 5, fill = NA)),
         k3_comp3_speed_ma = as.numeric(zoo::rollmean(k3_comp3_speed, k = 5, fill = NA)))%>%
    ungroup()%>%
  mutate(idno = rep(1:228, each = 100))
  
quick tst lmer approach
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned1)

lmermodels<-list()

posed_forlmertest_maxnorm <- df_OF_output_AUsW_unblind_posed_binned1[c(1:3,9:10,34:36)] %>%
  group_by(filename)%>%
  gather(comp, nmf_comp_value, -c(1:5))%>%
    group_by(subject)%>%
    mutate(nmf_comp_value = maxnorm(nmf_comp_value))

library(lmerTest)

posed_forlmertest_maxnorm$nmf_comp_value
posed_forlmertest_maxnorm$comp


posed_forlmertest_maxnorm$bin_frame_z <- scale(posed_forlmertest_maxnorm$bin_frame)

lmermodels$moel1<- lmer(nmf_comp_value ~ expression * comp  *drug.placebo +bin_frame_z
       (1 +expression * comp+bin_frame_z | subject),
     REML = FALSE,
     data = posed_forlmertest_maxnorm,
     # optimizer="nloptwrap",
     control = lmerControl(calc.derivs = FALSE),
     verbose = T)

summary(lmermodels$moel1)

lmermodels$moel2<- lmer(nmf_comp_value ~ expression * comp  *drug.placebo +bin_frame_z+
       (1 +expression * comp+bin_frame_z | subject),
     REML = FALSE,
     data = posed_forlmertest_maxnorm,
     # optimizer="nloptwrap",
     control = lmerControl(calc.derivs = FALSE),
     verbose = T)
summary(lmermodels$moel2)
write.csv(posed_forlmertest_maxnorm, "posed_forlmertest_maxnorm.csv")

lmermodels$moel3<- lmer(nmf_comp_value ~ expression * comp  *drug.placebo +bin_frame_z+
       (1 +expression * comp*drug.placebo+bin_frame_z | subject),
     REML = FALSE,
     data = posed_forlmertest_maxnorm,
     # optimizer="nloptwrap",
     control = lmerControl(calc.derivs = FALSE),
     verbose = T)
summary(lmermodels$moel2)



```



spatiotemporal clustering using k-means 

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned1)

empty_list<- list()


df_OF_output_AUsW_unblind_posed_binned1

colnames(df_OF_output_AUsW_unblind_posed_binned1)



df_OF_output_AUsW_unblind_posed_binned2_nona<- df_OF_output_AUsW_unblind_posed_binned1
# replace NAS
df_OF_output_AUsW_unblind_posed_binned2_nona[, 37:48][is.na(df_OF_output_AUsW_unblind_posed_binned2_nona[, 37:48])] <- 0

table(df_OF_output_AUsW_unblind_posed_binned2_nona$filename)
df_OF_output_AUsW_unblind_posed_binned1$idno
colnames(df_OF_output_AUsW_unblind_posed_binned2_nona)



# k-means clustering based on NMF components and derivatives
k3_list<- list()

unique_trial<- unique(df_OF_output_AUsW_unblind_posed_binned2_nona$filename)
 
df_OF_output_AUsW_unblind_posed_binned2_nona
# df_OF_output_AUsW_unblind_posed_binned$clust3<- NA

df_OF_output_AUsW_unblind_posed_binned3_nona<- df_OF_output_AUsW_unblind_posed_binned2_nona
df_OF_output_AUsW_unblind_posed_binned3_nona$clust3<- NA
colnames(df_OF_output_AUsW_unblind_posed_binned2_nona)

# loop fit kmeans and store clusters in the original data


df_OF_output_AUsW_unblind_posed_binned2_nona<- df_OF_output_AUsW_unblind_posed_binned2_nona%>%
  mutate(speed_avg_comp1to3_ma = (k3_comp1_speed_ma+k3_comp3_speed_ma+k3_comp3_speed_ma )/3,
         diff_avg_comp1to3_ma = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3,
         abs_diff_avg_comp1to3_ma = (abs(k3_comp1_diff_ma) +abs(k3_comp2_diff_ma)+abs(k3_comp3_diff_ma))/3)
         


# plot


df_OF_output_AUsW_unblind_posed_binned2_nona%>%
  subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
  mutate(speed_avg_comp1to3_ma = normalize(speed_avg_comp1to3_ma),
         diff_avg_comp1to3_ma = normalize(diff_avg_comp1to3_ma),
         abs_diff_avg_comp1to3_ma = normalize(abs_diff_avg_comp1to3_ma)
         )%>%
  # mutate(speed_diff = abs(k3_comp1_speed - lag(k3_comp1_speed)))%>%
  ggplot(aes(bin_frame, speed_avg_comp1to3_ma))+
  geom_line()+
  # geom_line(aes(y  = diff_avg_comp1to3_ma), color = "red")+
  geom_line(aes(y  = abs_diff_avg_comp1to3_ma), color = "blue")

df_OF_output_AUsW_unblind_posed_binned

```

```{r}
for (u in 1: length(unique_trial)) {
  # subset each reial on every run
   temp_df<- subset(df_OF_output_AUsW_unblind_posed_binned2_nona,filename == unique_trial[u])[,43:48]

       # r = u+r
  # for (k in 2:10) {
    k3_list[[u]] = kmeans(temp_df, 3)
    df_OF_output_AUsW_unblind_posed_binned3_nona$clust3[df_OF_output_AUsW_unblind_posed_binned3_nona$idno == u] <- k3_list[[u]]$cluster
    # r = r+1
}

table(df_OF_output_AUsW_unblind_posed_binned3_nona$clust3)

# visualise one or two people


unique(df_OF_output_AUsW_unblind_posed_binned3_nona$idno)
df_OF_output_AUsW_unblind_posed_binned3_nona

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)

# heurictis ionspired by eye movement classification
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  subset(idno  == 1)%>%
    group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3,
           cutoff = (mean(sp_avg, na.rm = TRUE) + (2* mad(sp_avg, na.rm = TRUE)))) %>%
  ungroup() %>%
  select(c(2,43:49, 50:51, 34:36))%>%
  gather(component, coef,-bin_frame,-clust3,-idno ) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf"))))%>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  # mutate(coef_z = scale(coef))%>%
  group_by(component,var_type, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)+
  geom_hline(yintercept = 0.5118612)
# 0.5118612 1.071568
# the ones where it fails
  # subset(idno  == 5)%>%

# scald



```


whats this below not substate


spatiotemporal clustering

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust = if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ (2*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                                "stable state"))%>%
  
  
   ungroup()%>%
   subset(idno  == 1)%>%
     select(c(2,43:49, 50:52, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64,65))%>%
  gather(component, coef,-bin_frame,-clust3,-idno) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf")))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, clust3)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)




```

# what if we say when speed exceedes X ammounts of sd

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)


```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust = if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ (2*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                                "stable state"))%>%
  
  
   ungroup()%>%
   subset(idno  == 1)%>%
    select(c(2,43:49, 50:52, 34:36,56))%>%
  # select(c(2,52:59, 46:47,38:41,64,65))%>%
  gather(component, coef,-bin_frame,-clust3,-idno,-manual_clust) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf")))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)


```



# if speed is above the adaptive threshold and diff is positive = acceleration
# if speed is abobe the threshold and diff = negative
# anything else stable state


```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)
install.packages("ggforce")

max(df_OF_output_AUsW_unblind_posed_binned3_nona[,46:48])


chool_talk$substate_illustration <-
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
   group_by(idno)%>%
  mutate(comp_delta_avg1 = scale(comp_delta_avg))%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), 
                   # & 
                     # comp_delta_avg > (mean(abs(comp_delta_avg), na.rm = TRUE)+(.5*(mad(abs(comp_delta_avg), na.rm = TRUE)))), 
                   "transition state", "sustain state"))%>%
  group_by(idno, manual_clust_sp_disp)%>%
  
   ungroup()%>%
   subset(idno  == 10)%>%
      select(c(2,43:49, 34:36, 55:56, 58))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno) %>%
  mutate(var_type = if_else(grepl("diff", component ), "3. diff",
                        if_else(grepl("speed", component ), "2. speed",  
                                if_else(grepl("sp_avg", component ), "3. avg speed",  
                                        if_else(grepl("comp_delta_avg", component ), "5. avg diff",  
                            "1. NMF comp"))))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            alpha = .2)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
    # ggforce::facet_col(facets = vars(var_type), 
    #                  scales = "free_y", 
    #                  space = "free")+

  theme_classic()+
  facet_grid(var_type~.)+

  # scale_fill_viridis_d(option = "inferno")+
  theme_classic()+
  xlab("time bin")+
  ylab("coef")+
  p$graphstyle_int+
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 5))+
    scale_fill_brewer(palette = "Dark2")



chool_talk$substate_illustrationnosahde <-
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
   group_by(idno)%>%
  mutate(comp_delta_avg1 = scale(comp_delta_avg))%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), 
                   # & 
                     # comp_delta_avg > (mean(abs(comp_delta_avg), na.rm = TRUE)+(.5*(mad(abs(comp_delta_avg), na.rm = TRUE)))), 
                   "transition state", "sustain state"))%>%
  group_by(idno, manual_clust_sp_disp)%>%
  
   ungroup()%>%
   subset(idno  == 10)%>%
      select(c(2,43:49, 34:36, 55:56, 58))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno) %>%
  mutate(var_type = if_else(grepl("diff", component ), "3. diff",
                        if_else(grepl("speed", component ), "2. speed",  
                                if_else(grepl("sp_avg", component ), "3. avg speed",  
                                        if_else(grepl("comp_delta_avg", component ), "5. avg diff",  
                            "1. NMF comp"))))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = component))+

  # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
  #           alpha = .2)  +
    geom_line(aes(group = component, color = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
    # ggforce::facet_col(facets = vars(var_type), 
    #                  scales = "free_y", 
    #                  space = "free")+

  theme_classic()+
  facet_grid(var_type~.)+

  scale_color_viridis_d(option = "magma")+
  theme_classic()+
  xlab("time bin")+
  ylab("coef")+
  p$graphstyle_int+
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 5))
    scale_fill_brewer(palette = "Dark2")


# do a third whether we take the clusters and put transition whenever they are larger than a specified speed



  ggsave("substate_illustration.tiff", chool_talk$substate_illustration,
         device = "tiff",
         width = 10, height = 10, dpi = 800)
  
  
    ggsave("substate_illustrationnoshade.tiff", chool_talk$substate_illustrationnosahde,
         device = "tiff",
         width = 10, height = 10, dpi = 800)
  

```

the k means segmentation




```{r}
# colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)

df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  subset(idno  == 10)%>%
ungroup()%>%
        # select(c(2, 34:36,43:49, 50:53))%>%
   select(c(2, 34:36,50))%>%
  # select(c(2,38:41, 47))%>%
  gather(component, coef,-bin_frame,-clust3)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()
```


```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona$clust3
# okay let's do some smoothing such that a cluster needs to have at least 3 in row



library(dplyr)
library(data.table)


df_OF_output_AUsW_unblind_posed_binned3_nona<- df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  group_by(idno)%>%
    mutate(new = cumsum(clust3)) %>%
    group_by(grp = rleid(clust3)) %>%
    mutate(output = if(n() <2) NA else clust3) %>%
    # ungroup %>%
    # select(idno,grp, new,output,clust3)%>%
    group_by(idno)%>%
  mutate(output1= output)%>%
  fill(output1, .direction = c("down"))

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)


df_OF_output_AUsW_unblind_posed_binned3_nona1<- df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  group_by(filename)%>%
  
  mutate(cluster_ordered = match(clust3, unique(clust3)))%>%
  # select(clust3, bin_frame, cluster_ordered)%>%
  arrange(filename, bin_frame)


  
  colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)

  
  # heatmap drug vs placebo
  df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
     select(c(1,2,9,34:36, 49,55))%>%
  # select(c(1,2,9,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(filename,component, bin_frame,cluster_ordered, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~.)
  
  
  
  
  # to do: do this plot with the heuristics
  # colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)
  
  
```


```{r}
  
  df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  # group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (2*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
      select(c(2, 9,10, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno,-drug.placebo,-expression) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(idno,component, bin_frame,manual_clust_sp_disp, drug.placebo,expression)%>%
  
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.factor(idno)))+
            geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
 #            alpha = .9)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  scale_color_brewer(palette = "dark2")+
  # facet_grid(drug.placebo~expression)+
    scale_fill_viridis_d(option = "inferno")

  
```



now heat maps bye xpression
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
       select(c(1,2,10,34:36, 49,55))%>%
  # select(c(1,2,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -expression)%>%
  group_by(filename,component, bin_frame,cluster_ordered,expression)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)


```



```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
        select(c(1,2,3,10,34:36, 49,55))%>%
  # select(c(1,2,3,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -expression,-subject)%>%
  group_by(filename,component, bin_frame,cluster_ordered,expression, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered)))+

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)+
  scale_fill_viridis_d()

```



```{r}
# heap with participants and clusters
 df_OF_output_AUsW_unblind_posed_binned3 %>%
  
  # compare kmean and manual clustering
  # group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg > 
                     1.5*(mad(comp_delta_avg, na.rm = TRUE))+mean(sp_avg, na.rm = TRUE), "activation state", 
                    
                   if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < mean(sp_avg, na.rm = TRUE)+
                              (-1.5*(mad(comp_delta_avg, na.rm = TRUE))), "de-activation state", 
                   
                                "stable state")))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
    select(c(1,2,3,9,34:36, 49,57))%>%
      # select(c(2, 9, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-drug.placebo) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(subject,component, bin_frame,manual_clust_sp_disp, drug.placebo)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
   geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            # alpha = .3)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  # facet_grid(drug.placebo~.)+
     scale_fill_viridis_d()
    

```


```{r}
    
# expresion
    
 df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "activation state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
    select(c(1,2,3,10,34:36, 49,57))%>%
      # select(c(2, 9, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
   group_by(subject,component,manual_clust_sp_disp, expression)%>%
   # mutate_at(c())
  group_by(subject,component, bin_frame,manual_clust_sp_disp, expression)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
   geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            # alpha = .3)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)+
   # scale_fill_brewer(palette = "Dark2")
     # scale_fill_viridis_d()
    scale_fill_viridis_d(option = "plasma")


df_OF_output_AUsW_unblind_posed_binned3_nona_clust$clust3


```

New
```{r}



df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg
df_OF_output_AUsW_unblind_posed_binned3_nona_clust$comp_delta_avg
df_OF_output_AUsW_unblind_posed_binned3_nona_clust

abs_diff_avg_comp1to3_ma
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
  mutate(sp_avg = normalize(sp_avg),
         comp_delta_avg = normalize(comp_delta_avg),
         # comp_delta_avg = normalize(abs_diff_avg_comp1to3_ma),
           comp_delta_avg_abs = (abs(k3_comp1_diff_ma) +abs(k3_comp2_diff_ma)+abs(k3_comp3_diff_ma))/3)%>%
  mutate(comp_delta_avg_abs = normalize(comp_delta_avg_abs))%>%
         # )%>%
  # mutate(speed_diff = abs(k3_comp1_speed - lag(k3_comp1_speed)))%>%
  ggplot(aes(bin_frame, sp_avg))+
  geom_line()+
  # geom_line(aes(y  = comp_delta_avg_abs), color = "red")+
  geom_line(aes(y  = comp_delta_avg), color = "blue")



```

df_OF_output_AUsW_unblind_posed_binned



```{r}
# new approach
# Load the required packages
library(dplyr)
library(purrr)

# Define a custom function to perform max-norm normalization
maxnorm <- function(x) {
  x / max(abs(x))
}

# Define a custom function to perform clustering with k-means
perform_kmeans_clustering <- function(data) {
  # Normalize the X and Y columns using max-norm

  data$sp_avg <- maxnorm(data$sp_avg)
  data$comp_delta_avg <- maxnorm(data$comp_delta_avg)
  
  kmeans_result <- kmeans(data[, c("sp_avg", "comp_delta_avg")], centers = 3)
  data$cluster_avg_new <- kmeans_result$cluster
  return(data)
}

# Assume 'df' is your data frame with columns: video_name, time_frame, X, Y, ...
# Perform clustering and update the data frame with a new 'cluster' column
df_with_clusters <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust %>%
  group_by(filename) %>%
  group_split() %>%
  map_dfr(perform_kmeans_clustering)

df_with_clusters
df_with_clusters%>%
    subset(filename == "./cut_posed_sad_day1_p7.csv")




# visualise one
colnames(df_with_clusters)

df_with_clusters
df_with_clusters%>%
  subset(filename == "./cut_posed_sad_day1_p7.csv")%>%


# df_OF_output_AUsW_unblind_posed_binned3_nona %>%
#   subset(idno  == 1)%>%
#     group_by(idno)%>%
#     mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3,
#            cutoff = (mean(sp_avg, na.rm = TRUE) + (2* mad(sp_avg, na.rm = TRUE)))) %>%
#   ungroup() %>%
  # select(c(2,43:49, 50:51, 34:36))%>%
  # gather(component, coef,-bin_frame,-clust3,-idno ) %>%
  # mutate(var_type = if_else(grepl("diff", component ), "diff",
  #                       if_else(grepl("speed", component ), "speed",  
  #                               if_else(grepl("sp_avg", component ), "avg_speed",  
  #                           "comp_nmf"))))%>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   # group_by(var_type)%>%
  # mutate(coef_z = scale(coef))%>%
  # group_by(component,var_type, bin_frame)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), sp_avg))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_avg_new)), 
            alpha = .6)  +
    geom_line(size = 1)+
  geom_line(aes(y = comp_delta_avg),  size = 1, linetype = 2)+
  geom_line(aes(y = comp1))+
  geom_line(aes(y = comp2))+
  geom_line(aes(y = comp3))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

```
  # facet_grid(var_type~.)
  geom_hline(yintercept = 0.5118612)

```{r}
  # quick heatmaps
  df_with_clusters$idno
  
  df_with_clusters
  df_with_clusters%>%
      # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
    ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = sp_avg))+
    geom_tile()+
        scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)
  
  

  df_with_clusters%>%
      # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
    ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = comp_delta_avg))+
    geom_tile()+
        scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)
  
  
  
    df_with_clusters%>%
      # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
    ggplot(aes(as.numeric(bin_frame), as.factor(expression), fill = sp_avg))+
    geom_tile()+
        scale_fill_viridis_c(option = "magma")
    facet_grid(~expression)
    
        df_with_clusters%>%
      # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
    ggplot(aes(as.numeric(bin_frame), as.factor(expression), fill = comp_delta_avg))+
    geom_tile()+
        scale_fill_viridis_c(option = "magma")
    facet_grid(~expression)
  
df_with_clusters%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%



  ggplot(aes(as.numeric(bin_frame), as.factor(idno), fill = as.factor(cluster_avg_new)))+
  geom_tile()+

   # scale_color_viridis_d(option = "magma")+

  # facet_grid(drug.day~expression)+
  theme_classic()

    
  
# wgata happening is that the order of clusters is changing per person.

# lets see cluster across people while normalised


# Load the required packages
library(dplyr)

# Define a custom function to perform max-norm normalization
maxnorm <- function(x) {
  x / max(abs(x))
}

# Define a custom function to perform clustering with k-means
perform_kmeans_clustering <- function(data) {
  kmeans_result <- kmeans(data[, c("sp_avg", "comp_delta_avg")], centers = 3)
  return(kmeans_result$cluster)
}

# Apply max-norm normalization and perform k-means clustering
df_with_clusters2 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust %>%
  # group_by(filename) %>%
    group_by(subject) %>%
  mutate(sp_avg = maxnorm(sp_avg),
         comp_delta_avg = maxnorm(comp_delta_avg)) %>%
  ungroup() %>%
  mutate(cluster_across = perform_kmeans_clustering(cur_data()))



# Display the result
df_with_clusters2


  
df_with_clusters2%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across)))+
  geom_tile()+

   scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()


```


two substates illustration
```{r}
 df_with_clusters%>%
      # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
    ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = sp_avg))+
    geom_tile()+
        scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)
  
  

  df_with_clusters%>%
      # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
    ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = comp_delta_avg))+
    geom_tile()+
        scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)
  
  
  
  df_with_clusters2$drug.placebo
  df_with_clusters2%>%
    # subset(drug.placebo = placebo)%>%
    group_by(filename, cluster_across, expression, subject)%>%
    mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE))%>%
    group_by(filename, cluster_across,expression,drug.placebo)%>%
    summarise_if(is.numeric, mean, na.rm = T)%>%
    ggplot(aes(max_displacement, peak_speed, colour = drug.placebo))+
      # geom_point()+
  geom_smooth(method = "glm",se = T, formula = y~log(x+.1),
  method.args = list(
                     start=c(A=0,B=0)))+
    # geom_smooth(method = "lm",se = T)+
    facet_grid(expression~cluster_across)
  
  
df_with_clusters_agg<-  df_with_clusters2%>%
    group_by(filename, cluster_across, expression, subject)%>%
    mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE))%>%
    group_by(filename, cluster_across,expression, subject)%>%
    summarise_if(is.numeric, mean, na.rm = T)

write_csv(df_with_clusters_agg, "df_with_clusters_agg.csv")


df_with_clusters

df_with_clusters2%>%
  subset(idno == 30)%>%

  ggplot(aes(as.numeric(bin_frame), sp_avg))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_across)), 
            alpha = .6)  +
    geom_line(size = 1)+
  geom_line(aes(y = comp_delta_avg),  size = 1, linetype = 2)+
  geom_line(aes(y = comp1))+
  geom_line(aes(y = comp2))+
  geom_line(aes(y = comp3))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(~drug.placebo)+
  theme_classic()

```




cluster across with speed and displacement normalised per video
probably deleted cluster
```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  mutate(compavg = (comp1+comp2+comp3)/3)

perform_kmeans_clustering <- function(data) {
  kmeans_result <- kmeans(data[, c("sp_avg", "comp_delta_avg","compavg")], centers = 3)
  return(kmeans_result$cluster)
}



df_with_clusters3 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust %>%
  group_by(filename) %>%
  mutate(sp_avg = maxnorm(sp_avg),
         comp_delta_avg = maxnorm(comp_delta_avg)) %>%
  ungroup() %>%
  mutate(cluster_across = perform_kmeans_clustering(cur_data()))

  df_with_clusters3%>%
      # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
    ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = comp_delta_avg))+
    geom_tile()+
        scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)
  
  df_with_clusters3%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across)))+
  geom_tile()+

   scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()
  
  
  
df_with_clusters3%>%
    subset(idno == 10)%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), sp_avg))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_across)), 
            alpha = .6)  +
    geom_line(size = 1)+
  geom_line(aes(y = comp_delta_avg),  size = 1, linetype = 2)+
  geom_line(aes(y = comp1))+
  geom_line(aes(y = comp2))+
  geom_line(aes(y = comp3))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

```

cluster across using DTW clustering and normalised speed, disp and compavg within each video



quiick dtw test first
```{r}
# Load the stclus package
install.packages("stclus")
library(stclus)
test

test<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
    subset(idno == 27)
  # subset(filename == "./cut_posed_sad_day1_p7.csv")
# Load the mvtsclust package
install.packages('dtwclust')
# Load the dtwclust package
# library(dtwclust)


# Model selection

range(test$sp_avg)
range(test$comp_delta_avg)
range(test$compavg)

test1<- test%>%
  mutate(sp_avg = maxnorm(sp_avg),
         comp_delta_avg = maxnorm(comp_delta_avg),
         compavg = maxnorm(compavg))


# colnames(test1)
?dtwclust::tsclust()

model <- tsclust(test[,c(55:56,58)], k = 3)


test1$clust_dtw_ts<- model@cluster

test1%>%
    # subset(idno == 30)%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), sp_avg))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust_dtw_ts)), 
            alpha = .6)  +
    geom_line(size = 1)+
  geom_line(aes(y = comp_delta_avg),  size = 1, linetype = 2)+
  geom_line(aes(y = comp1))+
  geom_line(aes(y = comp2))+
  geom_line(aes(y = comp3))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


```


```{r}
# Load the required packages
# Load the required packages
library(dplyr)
library(tsclust)

# Define a custom function to perform max-norm normalization
maxnorm <- function(x) {
  x / max(abs(x))
}

# Define a custom function to perform clustering with tsclust
perform_tsclust_clustering <- function(data) {
  tsclust_result <- tsclust(data[, c("sp_avg", "comp_delta_avg", "compavg")], k = 3)
  return(tsclust_result@cluster)
}

# Apply max-norm normalization and perform tsclust clustering
unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg)
range(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg)
df_with_clusters6 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust %>%
  group_by(filename) %>%
    # group_by(subject) %>%
  mutate(sp_avg = maxnorm(sp_avg),
         comp_delta_avg = maxnorm(comp_delta_avg),
         compavg = maxnorm(compavg)) %>%
  ungroup() %>%
  mutate(cluster_across = perform_tsclust_clustering(cur_data()))

# quick check

df_with_clusters6%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across)))+
  geom_tile()+

   scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()

# table(df_with_clusters6$filename, df_with_clusters6$cluster_across)
# # 
# rm(df_with_clusters5)
# rm(df_with_clusters4)

# rm(df_with_clusters3)

# illustration
df_with_clusters6%>%
  subset(idno == 30)%>%

  ggplot(aes(as.numeric(bin_frame), sp_avg))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_across)), 
            alpha = .6)  +
    geom_line(size = 1)+
  geom_line(aes(y = comp_delta_avg),  size = 1, linetype = 2)+
  geom_line(aes(y = comp1))+
  geom_line(aes(y = comp2))+
  geom_line(aes(y = comp3))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(~drug.placebo)+
  theme_classic()

# name clusters
df_with_clusters6$cluster_label <- if_else(df_with_clusters6$cluster_across == 2,
                                             "relaxed",
                                             if_else(df_with_clusters6$cluster_across == 1,
                                             "transition",
                                             if_else(df_with_clusters6$cluster_across == 3,
                                             "sustain",NA)))




colnames(df_with_clusters6)
df_with_clusters6%>%
  mutate(speed = sp_avg,
         displacement = comp_delta_avg,
         nmf_k1 = comp1,
         nmf_k2 = comp2,
         nmf_k3 = comp3)%>%
  subset(idno == 10)%>%
  select(c(bin_frame,speed,displacement,nmf_k1,nmf_k2,nmf_k3,cluster_label))%>%
  # gather(variable,value,-bin_frame,-cluster_label,-filename)%>%

  # test
  gather(variable, coef,-bin_frame,-filename,-cluster_label) %>%
  mutate(var_type = if_else(grepl("speed", variable), "2. speed",  
                                
                                        if_else(grepl("displacement", variable), "3. displacement",  
 if_else(grepl("nmf", variable ), "1. nmf",NA)))) %>%

group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  # group_by(variable, bin_frame,var_type, cluster_label)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = variable))+
  
    geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = cluster_label),
            alpha = .3)  +
  geom_line(aes(group = variable, linetype = var_type), size = 1)+
   facet_grid(var_type~.)+
  # facet_grid(variable_type~.)+
  theme_classic()

```


check a clustering based on NF components only

```{r}
# Define a custom function to perform clustering with tsclust
perform_tsclust_clustering_comp <- function(data) {
  tsclust_result <- tsclust(data[, c("comp1", "comp2", "comp3")], k = 3)
  return(tsclust_result@cluster)
}

# Apply max-norm normalization and perform tsclust clustering

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$comp1
df_OF_output_AUsW_unblind_posed_binned3_nona_clust$comp1
df_with_clusters6_comp <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust %>%
  group_by(filename) %>%
    # group_by(subject) %>%
  mutate(comp1 = maxnorm(comp1),
         comp2 = maxnorm(comp2),
         comp3 = maxnorm(comp3)) %>%
  ungroup() %>%
  mutate(cluster_across = perform_tsclust_clustering_comp(cur_data()))

# quick check

df_with_clusters6_comp%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across)))+
  geom_tile()+

   # scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()

df_with_clusters6_comp$sp_avg
df_with_clusters6_comp%>%
    subset(idno == 43)%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), sp_avg))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_across)), 
            alpha = .6)  +
    geom_line(size = 1)+
  geom_line(aes(y = comp_delta_avg),  size = 1, linetype = 2)+
  geom_line(aes(y = comp1))+
  geom_line(aes(y = comp2))+
  geom_line(aes(y = comp3))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

df_with_clusters6_comp%>%
  group_by(expression, subject,cluster_across)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(as.factor(cluster_across),sp_avg ))+
  geom_jitter(alpha = .1, width = .3)+
  stat_summary(geom = "pointrange")+
  facet_grid(~expression)


df_with_clusters6_comp%>%
  group_by(expression, subject,cluster_across)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(as.factor(cluster_across),comp_delta_avg ))+
  geom_jitter(alpha = .1, width = .3)+
  stat_summary(geom = "pointrange")+
  facet_grid(~expression)


```


spoken clusters





Entropy


```{r}  
rm(df_with_clusters6)

df_with_clusters6_agg<-  df_with_clusters6%>%
    group_by(filename, cluster_across, cluster_label, expression, subject,drug.placebo)%>%
    mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE))%>%
   group_by(filename)%>%
  
  mutate(peak_speed_norm =  maxnorm(peak_speed),
max_displacement_norm =  maxnorm(max_displacement))%>%
    group_by(filename, cluster_across,expression, subject,drug.placebo,cluster_label)%>%
    summarise_if(is.numeric, mean, na.rm = T)

df_with_clusters6$cluster_across

library(data.table)
df_with_clusters6_agg

install.packages("entropy")


df_with_clusters6$cluster_across<- as.factor(df_with_clusters6$cluster_across)
?entropy::entropy()
df_with_clusters6<- df_with_clusters6%>%
group_by(filename, cluster_across)%>%
mutate(freq_clus = n())%>%
  group_by(filename)%>%
  mutate(freq_clus_perc = freq_clus/n())%>%
  group_by(filename, expression, subject)%>%
mutate(cluster_count_group = rleid(cluster_across))%>%
  group_by(filename, cluster_across, expression, subject,drug.placebo)%>%
    mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE))%>%
   group_by(filename)%>%
  
  mutate(peak_speed_norm =  maxnorm(peak_speed),
max_displacement_norm =  maxnorm(max_displacement))%>%
  mutate(entropy_clust = entropy::entropy(table(cluster_across)))
?entropy::entropy
df_with_clusters6$entropy_clust

entropy::en

df_with_clusters6$entropy_clust
df_with_clusters6$cluster_across
df_with_clusters6$cluster_count_group
df_with_clusters6$cluster_count_group
df_with_clusters6_agg<- df_with_clusters6%>%
  group_by(filename, cluster_across, cluster_count_group)%>%
  mutate(clust_dur_count = n())%>%
  group_by(filename)%>%
  mutate(clust_dur_count_perc = clust_dur_count/n())%>%

# group_by(filename, manual_clust_sp_disp)%>%
#   mutate(clust_frame_no_bin = n())%>%
# df_with_clusters6
    group_by(filename, cluster_across,expression, subject,drug.placebo)%>%
    summarise_if(is.numeric, mean, na.rm = T)

  df_with_clusters6_agg$cluster_count_group


df_with_clusters6_agg%>%
 ggplot(aes( expression, freq_clus_perc))+
  geom_jitter(alpha = .1, width = .2)+
  stat_summary(geom = "pointrange")+
  facet_grid(~cluster_across)


df_with_clusters6_agg%>%
 ggplot(aes(expression, clust_dur_count_perc))+
  # geom_jitter(alpha = .1, width = .2)+
  stat_summary(geom = "pointrange")+
  facet_grid(~cluster_across)


df_with_clusters6_agg%>%
 ggplot(aes(expression, freq_clus))+
  # geom_jitter(alpha = .1, width = .2)+
  stat_summary(geom = "pointrange")+
  facet_grid(~cluster_across)


df_with_clusters6_agg%>%
 ggplot(aes(expression, clust_dur_count))+
  # geom_jitter(alpha = .1, width = .2)+
  stat_summary(geom = "pointrange")+
  facet_grid(~cluster_across)

install.packages("ggpubr")


# Normalize the variable between zero and one
normalize_0_1 <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}
x_norm <- (scale(x) - min(scale(x))) / (max(scale(x)) - min(scale(x)))

df_with_clusters6_agg%>%
  ungroup%>%
  group_by(subject)%>%
  mutate(entropy_clust_norm = normalize_0_1(entropy_clust))%>%
  group_by(filename, expression)%>%
  
  summarise_if(is.numeric,mean, na.rm = T)%>%
  # subset(entropy_clust> 4.53)%>%
 ggplot(aes(expression, entropy_clust_norm))+
  geom_jitter(alpha = .1, width = .2)+
  stat_summary(geom = "pointrange")
  facet_grid(~cluster_across)
    # ggpubr::stat_central_tendency()
  
  
df_with_clusters6_agg<-  df_with_clusters6_agg%>%
  ungroup%>%
  group_by(subject)%>%
  mutate(entropy_clust_norm = normalize_0_1(entropy_clust))

df_with_clusters6_agg_bysubj
```
  

write_csv(df_with_clusters6_agg, "df_with_clusters6_agg.csv")

install.packages("lmerTest")
```{r}

df_with_clusters6_agg$subject<- as.factor(df_with_clusters6_agg$subject)

df_with_clusters6_agg$cluster_across<- as.factor(df_with_clusters6_agg$cluster_across)

library(lmerTest)
options(scipen = 999)

lmer_substates$clust_dur_count_perc<- lmer(clust_dur_count_perc~ expression*cluster_across + (1+expression*cluster_across| subject), REML = FALSE,
     data = df_with_clusters6_agg)

summary(lmer_substates$clust_dur_count_perc)

df_with_clusters6_agg$cluster_across

anova(lmer_substates$clust_dur_count_perc)
# install.packages("emmeans")

# emmeans::emmeans()
# ?emmeans::emmeans
emmeans::emmeans(lmer_substates$clust_dur_count_perc, pairwise~expression|cluster_across, type = "response" )

# install.packages("interactions")
# interactions
?interactions::probe_interaction



 interactions::cat_plot(lmer_substates$clust_dur_count_perc, pred = cluster_across, modx =  expression,
                       plot.points = TRUE,
                       point.alpha = .3)
 
 
 df_with_clusters6_agg$subject<-as.factor(df_with_clusters6_agg$subject)
 lmer_substates$freq_clus_perc<- lmer(freq_clus_perc~ expression+cluster_across + (1 | subject), REML = FALSE,
     data = df_with_clusters6_agg)
 
 summary( lmer_substates$freq_clus_perc)
 anova(lmer_substates$freq_clus_perc)
 
 
 emmeans::emmeans( lmer_substates$freq_clus_perc, pairwise~expression|cluster_across, type = "response" )

# install.packages("interactions")
# interactions
?interactions::probe_interaction

interactions::probe_interaction(lmer_substates$clust_dur_count_perc, modx = cluster_across,modx2  = expression)



 interactions::cat_plot(lmer_substates$clust_dur_count_perc, pred = cluster_across, modx =  expression,
                       plot.points = TRUE,
                       point.alpha = .3)
 
 interactions::cat_plot( lmer_substates$freq_clus_perc, pred =cluster_across , modx =  expression,
                       plot.points = TRUE,
                       point.alpha = .3)
```
 
 
```{r}
df_with_clusters6_agg_bysubj<-  df_with_clusters6_agg%>%
   group_by(subject, expression, cluster_across, cluster_label)%>%
   summarise_if(is.numeric, mean, na.rm = T)

write_csv(df_with_clusters6_agg_bysubj, "df_with_clusters6_agg_bysubj.csv")

df_with_clusters6_agg_bysubj$dr

df_with_clusters6_agg_bysubj$cluster_count_group
df_with_clusters6_agg_bysubj%>%
  group_by(subject,expression)%>%
  summarise_if(is.numeric,mean)%>%
  
  ggplot(aes(expression, entropy_clust_norm))+
  # geom_jitter(width = .1, alpha = .3)+
  stat_summary(geom = "pointrange")


df_with_clusters6_agg_bysubj$cluster_count_group

df_with_clusters6_agg_bysubj2<-
df_with_clusters6_agg_bysubj%>%
  group_by(subject,expression)%>%
  summarise_if(is.numeric,mean)

write_csv(df_with_clusters6_agg_bysubj2, "df_with_clusters6_agg_bysubj2.csv")

```
    
df_with_clusters3_agg<-  df_with_clusters3%>%
    group_by(filename, cluster_across, expression, subject)%>%
    mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE))%>%
    group_by(filename, cluster_across,expression, subject)%>%
    summarise_if(is.numeric, mean, na.rm = T)

write_csv(df_with_clusters3_agg, "df_with_clusters3_agg.csv")
  

```

COMPUTE THE HEURISTIC BASED CLUSTERS AND PUT TO THE DATAFRAME

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust<- df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()


# now compare the speed per cluster
# copare duration of custers


   # subset(idno  == 10)%>%

  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression) %>%
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, clust_frame_no_bin))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  ggtitle("transition state")
```
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)



```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp,subject)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, expression,subject)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression , clust_frame_no_bin, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
      geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # facet_grid(~expression)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  ggtitle("transition state")

# stable
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, clust_frame_no_bin))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
   ggtitle("stable state")


# colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, manual_clust_sp_disp,component, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # facet_grid(~drug.placebo)+
  theme_classic()+
    ggpubr::stat_compare_means()+
  ggtitle("transition state")


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  # subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = manual_clust_sp_disp))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
  # facet_grid(~drug.placebo)+
  theme_classic()+
  facet_grid(~manual_clust_sp_disp)+
  ggpubr::stat_compare_means()+
     ggtitle("stable state")
  



  
  
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE),
          sp_sd_clust = sd(sp_avg, na.rm = TRUE)) %>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  # subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, sp_sd_clust, color = manual_clust_sp_disp))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
  # facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  facet_grid(~manual_clust_sp_disp)
  
  
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg

  df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE),
          sp_sd_clust = sd(sp_avg, na.rm = TRUE),
         RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)))   %>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE) %>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, RMS_sd_clust, color = manual_clust_sp_disp))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
      facet_grid(~manual_clust_sp_disp)+
  # facet_grid(~)+
  theme_classic()
      # ggpubr::stat_compare_means()+
  
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  # subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = manual_clust_sp_disp))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
  # facet_grid(~drug.placebo)+
  theme_classic()+
  facet_grid(~manual_clust_sp_disp)+
  ggpubr::stat_compare_means()+
     ggtitle("stable state")



```

Count how any states do we have

```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$BMI


df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp
library(data.table)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, drug.placebo)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
    mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(grp, color = expression, fill = expression))+
  geom_histogram(aes(y=..density..), alpha=0.5,
                position="identity")+
   geom_density(alpha=.2)+
  facet_grid(~drug.placebo)+
  theme_classic()


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, drug.placebo)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(expression, log(grp+.1), color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  facet_grid(~drug.placebo)+
  theme_classic()

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, drug.placebo, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(drug.placebo, grp, color = drug.placebo))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  # facet_grid(~drug.placebo)+
  theme_classic()


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(expression, grp, color = expression))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
    geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  # facet_grid(~drug.placebo)+
  theme_classic()
```


 model mixed models on the variables above

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(clust_frame_no = rleid(manual_clust_sp_disp))

# 
df_OF_output_AUsW_unblind_posed_binned3_nona_clust

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)
lmer_substates<- list()

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp)

library(lmerTest)

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$clust_frame_no)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg<-
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  group_by(filename, subject,drug.placebo,expression)%>%
  summarise_if(is.numeric, max, na.rm = TRUE)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$clust_frame_no

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$subject)

lmer_substates$clust_no <- glmer(clust_frame_no ~   1+expression+
                              (1 |subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg,
                            # REML = FALSE)
                            # ,
                            family = "poisson")
?isSingular
isSingular(lmer_substates$clust_no, tol = .002)

summary(lmer_substates$clust_no )

anova(lmer_substates$clust_no)

emmeans::emmeans(lmer_substates$clust_no, pairwise~drug.placebo, type = "response" )
emmeans::emmeans(lmer_substates$clust_no, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$clust_no, pairwise~ drug.placebo|expression, type = "response" )


interactions::cat_plot(lmer_substates$clust_no, pred = expression, modx = drug.placebo)



# 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  #     select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
   group_by(filename, subject,drug.placebo,expression,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$clust_frame_no_bin)


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$subject)

lmer_substates$clust_no_framebin <- glmer(clust_frame_no_bin ~  manual_clust_sp_disp * expression+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2,
                            # REML = FALSE)
                            # ,
                            family = "poisson")

summary(lmer_substates$clust_no_framebin)

anova(lmer_substates$clust_no_framebin)

emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~drug.placebo, type = "response" )
emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~ expression|manual_clust_sp_disp, type = "response" )

# m,odel how many states are ine ach 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  group_by(filename, subject,drug.placebo,expression)%>%
  summarise_if(is.numeric, max, na.rm = TRUE)

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3$grp)

lmer_substates$howmanystate_trans <- glmer(grp ~  drug.placebo * expression+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3,
                            # REML = FALSE)
                            # ,
                            family = "poisson")

summary(lmer_substates$howmanystate_trans)
anova(lmer_substates$howmanystate_trans)

# speed

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust  %>%
      # select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         # speed
         sp_avg_clust_k1 = mean(k3_comp1_speed_ma, na.rm = TRUE),
         sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         RMS_sd_clust_k1 = sqrt(mean(((lead(k3_comp1_speed_ma) - k3_comp1_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k2 = sqrt(mean(((lead(k3_comp2_speed_ma) - k3_comp2_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k3 = sqrt(mean(((lead(k3_comp3_speed_ma) - k3_comp3_speed_ma)^2),na.rm = TRUE)))%>%
         
          # 
          # 
          # sp_sd_clust = sd(sp_avg, na.rm = TRUE),
          # RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)),
          # RMS_diff_clust = sqrt(mean((comp_delta_avg^2),na.rm = TRUE)))   %>%
         # )%>%
group_by(filename, manual_clust_sp_disp, expression, subject, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4$test_ind<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4$drug.placebo == "drug", 1,0)


# do we compute these metrics for each co,ponent or just averages?
# 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$k3_comp1_diff_ma


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust  %>%
      # select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust
group_by(filename,manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         # speed
         sp_avg_clust_k1 = mean(k3_comp1_speed_ma, na.rm = TRUE),
         sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         
          avg_disp_clust_k1 = sum(abs(k3_comp1_diff_ma), na.rm = TRUE),
          avg_disp_clust_k2 = sum(abs(k3_comp2_diff_ma), na.rm = TRUE),
          avg_disp_clust_k3 = sum(abs(k3_comp3_diff_ma), na.rm = TRUE),
         # sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         # sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         
         
        peak_sp_avg_clust_k1 = max(k3_comp1_speed_ma, na.rm = TRUE),
          peak_sp_avg_clust_k2 = max(k3_comp2_speed_ma, na.rm = TRUE),
          peak_sp_avg_clust_k3 = max(k3_comp3_speed_ma, na.rm = TRUE),
         
         RMS_sd_clust_k1 = sqrt(mean(((lead(k3_comp1_speed_ma) - k3_comp1_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k2 = sqrt(mean(((lead(k3_comp2_speed_ma) - k3_comp2_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k3 = sqrt(mean(((lead(k3_comp3_speed_ma) - k3_comp3_speed_ma)^2),na.rm = TRUE)))%>%
         
          # 
          # 
          # sp_sd_clust = sd(sp_avg, na.rm = TRUE),
          # RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)),
          # RMS_diff_clust = sqrt(mean((comp_delta_avg^2),na.rm = TRUE)))   %>%
         # )%>%
group_by(filename, manual_clust_sp_disp, expression, subject, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)


# power low
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  # subset(manual_clust_sp_disp == "stable state")%>%
  
  ggplot(aes(avg_disp_clust_k1,peak_sp_avg_clust_k1, color = expression))+
  geom_point(alpha = .5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~manual_clust_sp_disp)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
   #                    method.args = list(family = gaussian(link = 'log2'),
   #                                       start=c(A=0,B=0)), size = .2)+
  
 geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor()+
  scale_color_brewer(palette = "Dark2")+
  # scale_color_viridis_d(option = "inferno")+
  p$graphstyle_int


chool_talk$speed_disp_fucntionk1 
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum%>%
  ungroup()%>%
  mutate_if(is.numeric, maxnorm)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k1,peak_sp_avg_clust_k1, color = expression))+
  geom_point(alpha = .5, size = 1.5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~statespace)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)))+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(p.accuracy = .001)+
  ylab("peak speed k1 - au")+
   xlab("displacement k1 - au")+
  scale_color_brewer(palette = "Dark2")+
    scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))+
  # scale_colour_viridis_d()+
  # ggpubr::stat_conf_ellipse()+
  p$graphstyle_int+
    theme(panel.spacing = unit(1, "cm"))

```

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq$statespace<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq$manual_clust_sp_disp == "stable state",
"sustain", "transition")

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum$statespace<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum$manual_clust_sp_disp == "stable state",
"sustain", "transition")

chool_talk$speed_disp_fucntionk2 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  ungroup()%>%
  mutate_if(is.numeric, maxnorm)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k2,peak_sp_avg_clust_k2, color = expression))+
  geom_point(alpha = .5, size = 1.5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~statespace)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)))+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(p.accuracy = .001)+
  ylab("peak speed k2 - au")+
   xlab("displacement k2 - au")+
  scale_color_brewer(palette = "Dark2")+
    scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))+
  # scale_colour_viridis_d()+
  # ggpubr::stat_conf_ellipse()+
  p$graphstyle_int+
    theme(panel.spacing = unit(1, "cm"))


chool_talk$speed_disp_fucntionk3 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
ungroup()%>%
  mutate_if(is.numeric, maxnorm)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k3,peak_sp_avg_clust_k3, color = expression))+
  geom_point(alpha = .5, size = 1.5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~statespace)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)))+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(p.accuracy = .001)+
  ylab("peak speed k3 - au")+
   xlab("displacement k3 - au")+
  scale_color_brewer(palette = "Dark2")+
  # scale_colour_viridis_d()+
  # ggpubr::stat_conf_ellipse()+
    scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))+
  p$graphstyle_int+
    theme(panel.spacing = unit(1, "cm"))


chool_talk$speed_disp_fucntionk3
install.packages("patchwork")

library(patchwork)

chool_talk$speed_displace_fucn_patch<- (chool_talk$speed_disp_fucntionk1 +chool_talk$speed_disp_fucntionk2 +chool_talk$speed_disp_fucntionk3)+
   plot_layout(guides = "collect") & theme(legend.position = "top")


chool_talk$speed_displace_fucn_patch+  scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))
ggsave("speed_displace_fucn_patch2.tiff", chool_talk$speed_displace_fucn_patch,
       device = "tiff",
       width = 18, height = 5, dpi = 100)
```



```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq


df %>%
  gather(key = "age", value = "age_values", age1, age2) %>%
  gather(key = "weight", value = "weight_values", weight1, weight2) %>%
  filter(substring(age, 4) == substring(weight, 7))


speed_dis_func_agg_lmer<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq %>%
  # group_by(filename)
  gather(key = "speed_k", value = "peak_speed", peak_sp_avg_clust_k1, peak_sp_avg_clust_k2,
         peak_sp_avg_clust_k3) %>%
  gather(key = "displ_k", value = "disp_avg", avg_disp_clust_k1, avg_disp_clust_k2,
         avg_disp_clust_k3)%>%
  group_by(filename, subject, expression, manual_clust_sp_disp, drug.placebo,speed_k,displ_k)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
library(lmerTest)
poly()
lmer_substates$speed_diusp_fucn <- lmer(peak_speed ~ poly(disp_avg, degree = 2) * drug.placebo  + (1|manual_clust_sp_disp),
                                       REML = FALSE,data = speed_dis_func_agg_lmer)

summary(lmer_substates$speed_diusp_fucn)
anova(lmer_substates$speed_diusp_fucn)
```

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  group_by(subject)%>%
  mutate(n_subj = n())%>%
  subset(n_subj>6)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k3,peak_sp_avg_clust_k3, color = drug.placebo))+
  geom_point(alpha = .5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(~manual_clust_sp_disp)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = drug.placebo), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)), size = .2)+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(method = "spearman", cor.coef.name = c("R"))+
  # ggpubr::stat_conf_ellipse()+
  scale_color_brewer(palette = "Dark2")+
  # scale_color_viridis_d(option = "inferno")+
  p$graphstyle_int


1lmer(peak_s)


test<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  group_by(subject)%>%
  mutate(n_subj = n())%>%
  subset(n_subj>6)

unique(test$subject)
```




df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq %>%
  # group_by(manual_clust_sp_disp)%>%
  # mutate_if(is.numeric, scale) %>%
  ggplot(aes(expression, avg_disp_clust_k1))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~ manual_clust_sp_disp)+
  ggpubr::stat_compare_means(method = "anova")+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(2.5, 3.5, 4.5))
   stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons)
   
   
   write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq, "df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq.csv")
```





df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  subset(manual_clust_sp_disp != "stable state")%>%
  # group_by(expression)%>%
  # mutate_if(is.numeric, maxnorm)%>%
  # 
  ggplot(aes(avg_disp_clust_k1,peak_sp_avg_clust_k1, color = expression,group = expression))+

 
  # geom_smooth(aes(group = subject), se = F)+

  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
   #                    method.args = list(family = gaussian(link = 'log2'),
   #                                       start=c(A=0,B=0)), size = .2)+

    geom_point(alpha = .5)+
  
 # geom_smooth(aes(group = expression), method = "nls",
 #             method.args = list(start=c(a=21,b=0)),
 #             formula = y~a*log(b*x),
 #             size = .2,)+

    facet_grid(.~manual_clust_sp_disp)+
  theme_classic()+
  # ggpubr::stat_cor()+
  scale_color_brewer(palette = "Dark2")+
  # scale_color_viridis_d(option = "inferno")+
  p$graphstyle_int

```


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust  %>%
      # select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust
group_by(filename,manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         # speed
         sp_avg_clust_k1 = mean(k3_comp1_speed_ma, na.rm = TRUE),
         sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         RMS_sd_clust_k1 = sqrt(mean(((lead(k3_comp1_speed_ma) - k3_comp1_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k2 = sqrt(mean(((lead(k3_comp2_speed_ma) - k3_comp2_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k3 = sqrt(mean(((lead(k3_comp3_speed_ma) - k3_comp3_speed_ma)^2),na.rm = TRUE)))%>%
         
          # 
          # 
          # sp_sd_clust = sd(sp_avg, na.rm = TRUE),
          # RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)),
          # RMS_diff_clust = sqrt(mean((comp_delta_avg^2),na.rm = TRUE)))   %>%
         # )%>%
group_by(filename, expression, subject, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)

write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,"df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.csv")


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$test_ind<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$drug.placebo == "drug", 1,0)
write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1,
          "df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1.csv")

```

```

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2$test_ind<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2$drug.placebo == "drug", 1,0)
write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2,
          "df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2.csv")


my_comparisons <- list( c("angry", "sad"), c("angry", "happy"), c("happy", "sad") )
ggboxplot(ToothGrowth, x = "dose", y = "len",
          color = "dose", palette = "npg")+
# Add pairwise comparisons p-value
stat_compare_means(comparisons = my_comparisons, label.y = c(29, 35, 40))+
stat_compare_means(label.y = 45)     # Add global Anova p-value

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2)

library(ggpubr)

```

```

```{r}

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1:5,60:62)]%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
  
  
  # select(!starts_with("comp"))%>%
  gather(component_AU, coef, - filename, - manual_clust_sp_disp, - expression, - subject, - drug.placebo)%>%
  group_by(component_AU)%>%
  
  
  #   group_by(component_AU,manual_clust_sp_disp)%>%
  # mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = manual_clust_sp_disp))+
  # geom_jitter(width = .1, alpha = .1, position = position_dodge())+
  geom_bar(stat = "summary", fun.y = "mean", alpha = .1, position = position_dodge())+
  stat_summary(geom = "pointrange", position = position_dodge(1))+
  stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70", position = position_dodge(1))+
  facet_grid( ~ component_AU)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  stat_compare_means(aes(label = ..p.signif..),method = "anova", label.y = 3)+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(1.8, 2, 2.2))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()


colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$Speed_RMS_AVG<-
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$RMS_sd_clust_k1+
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$RMS_sd_clust_k2+
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$RMS_sd_clust_k3


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$com_sum<-
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$comp1+
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$comp2+
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$comp3


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1:5, 64)]%>%
  # select(!starts_with("comp"))%>%
  gather(component_AU, coef, - filename, - manual_clust_sp_disp, - expression, - subject, - drug.placebo)%>%

  #   group_by(component_AU,manual_clust_sp_disp)%>%
  # mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  geom_bar(stat = "summary", fun.y = "mean", alpha = .1)+
  stat_summary(geom = "pointrange")+
  stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70")+
  facet_grid( ~manual_clust_sp_disp)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  stat_compare_means(aes(label = ..p.signif..),method = "anova", label.y = 3)+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(1.8, 2, 2.2))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()



colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1,3:5, 49,33:35,57:59)]%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
  
  
  # select(!starts_with("comp"))%>%
  gather(component_AU, coef, - filename, - clust3, - expression, - subject, - drug.placebo)%>%
  # group_by(component_AU)%>%
  
  
    # group_by(component_AU,clust3)%>%
  # mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,clust3)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = expression))+
  # geom_jitter(width = .1, alpha = .1)+
  # geom_bar(stat = "summary", fun.y = "mean", alpha = .1)+
  stat_summary(geom = "pointrange", fun = mean)+
  # stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70")+
  facet_grid( clust3~ component_AU)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  # stat_compare_means(aes(label = ..p.signif..),method = "anova", label.y = 3)+
  # stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     # label.y = c(1.8, 2, 2.2))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()


write_csv("RMS_new.csv",
          df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
```
  

unique(test$component_AU)
 # gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject)%>%
   
   
   
# corr
   
   df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1:5,33:35,60:62)]%>%
  select(!starts_with("RMS"))%>%
  gather(component_AU, coef, - filename, - manual_clust_sp_disp, - expression, - subject, - drug.placebo)%>%
  group_by(component_AU)%>%
  
  mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  geom_bar(stat = "summary", fun.y = "mean", alpha = .1)+
  stat_summary(geom = "pointrange")+
  stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70")+
  facet_grid( manual_clust_sp_disp~ component_AU)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  # stat_compare_means(method = "anova", label.y = 10)+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(2.5, 3.5, 4.5))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()
  
# 
# unique(test$component_AU)
#  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject)
#  
 dcast_time2_aggjasp
 df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2
 
space_time<- left_join(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2,
           dcast_time2_aggjasp, by = "filename")
write_csv(space_time, "space_time.csv")
```


df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg


lmer_substates$speed <- lmer(sp_avg_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1+|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed)

# emmeans::emmeans(lmer_substates$speed , pairwise~drug.placebo, type = "response" ) #ns
emmeans::emmeans(lmer_substates$speed, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$speed, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot
int_plot_speed <- interactions::cat_plot(lmer_substates$speed, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)
  ggExtra::ggMarginal(int_plot_speed)

  library(ggside)

  int_plot_speed+ geom_ysidedensity(aes(x=stat(density), fill = expression), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "left") +
  labs(title = "FacetNull", subtitle = "Xside placed bottom, Yside placed left")
  
  
  # sd
lmer_substates$speed1 <- lmer(sp_sd_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed1)

emmeans::emmeans(lmer_substates$speed1, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$speed1, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot

int_plot_speed1<- interactions::cat_plot(lmer_substates$speed1, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)


   int_plot_speed1+ geom_ysidedensity(aes(x=stat(density), color = expression,  fill = expression), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "left") +
  labs(title = "FacetNull", subtitle = "Xside placed bottom, Yside placed left")+
     facet_grid(~manual_clust_sp_disp)+
    geom_smooth(aes(group = subject), method = "lm", se = F)
   
   
   # RMS_sd_clust
   
   lmer_substates$speed2 <- lmer(RMS_sd_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed2)

emmeans::emmeans(lmer_substates$speed2, pairwise~expression, type = "response" )
emmeans::emmeans(lmer_substates$speed2, pairwise~ manual_clust_sp_disp, type = "response" )

emmeans::emmeans(lmer_substates$speed2, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot

interactions::cat_plot(lmer_substates$speed2, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)
   
   

   
  
```

```{r}
# try anovas

library(afex)
library(car)
# avg number of frames 
afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2,
              id = "subject",
              dv = "clust_frame_no_bin",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)


afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg,
              id = "subject",
              dv = "clust_frame_no",
              within = c("drug.placebo", "expression"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

# how many states


afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3,
              id = "subject",
              dv = "grp",
              within = c("drug.placebo", "expression"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

# speed
afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
              id = "subject",
              dv = "sp_avg_clust",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4

afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
              id = "subject",
              dv = "RMS_sd_clust",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

```




```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
  select(c(1,2,3,9,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject)%>%
  group_by(filename,component, bin_frame,cluster_ordered,drug.placebo, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered))) +

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~.)+
  scale_fill_viridis_d()



df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
  select(c(1,2,3,9,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject,-expression)%>%
  group_by(filename,component, bin_frame,cluster_ordered, expression, drug.placebo, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered)))+

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~expression)+
  scale_fill_viridis_d()


# let's plot variabkes based on the clusters
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  ungroup()%>%
  select(c(3,9,10,48:59, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-cluster_ordered, -drug.placebo,-subject,-expression,)%>%
  group_by(cluster_ordered, drug.placebo,subject,expression,component)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(cluster_ordered), coef))+
  geom_jitter(width = .1, alpha = .01)+
  geom_boxplot(alpha = .1)+
  facet_grid(~component)+
  theme_classic()

```

# don't plot

```{r}

# don't plot
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  ungroup()%>%
  select(c(3,9,10,48:52, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-cluster_ordered, -drug.placebo,-subject,-expression,)%>%
  group_by(cluster_ordered, drug.placebo,subject,expression,component)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(component ), coef))+
  geom_jitter(width = .1, alpha = .01)+
  geom_boxplot(alpha = .1)+
  geom_smooth(aes(group = subject), se = F, size = .1)+
  # facet_grid(~cluster_ordered)+
  theme_classic()
```

new algorithm first find sustain and transition
based on:
- if cluster duration (in frames) > than the average duration of a cluster = sustain (this is beacuse transition should be short, sustain should be longest, so)

and the cluster avg speed < than the average speed



```{r}

rleid(df_OF_output_AUsW_unblind_posed_binned3_nona1$cluster_ordered)

df_OF_output_AUsW_unblind_posed_binned3_nona2<- df_OF_output_AUsW_unblind_posed_binned3_nona1 %>%
  ungroup()%>%
  group_by(idno)%>%
  mutate(cluster_ordered_unique = rleid(cluster_ordered), bin_new_id = 1:n())%>%
  group_by(idno, cluster_ordered_unique)%>%
  mutate(frame_dur = n())%>%
  group_by(idno)%>%
  mutate(frame_dur_avg = mean(frame_dur, na.rm = TRUE),
         frame_dur_min = min(frame_dur, na.rm = TRUE),
         frame_dur_max = max(frame_dur, na.rm  = TRUE),
         )
  

df_OF_output_AUsW_unblind_posed_binned3_nona3<-
df_OF_output_AUsW_unblind_posed_binned3_nona2%>%
  group_by(idno)%>%
  mutate(name_new_clust = if_else(frame_dur> frame_dur_avg, "sustain", "transition"))
  
  
  select(c(3,9,10,48:56, 64))
  
  
  
  colnames(df_OF_output_AUsW_unblind_posed_binned3_nona3)
  
  df_OF_output_AUsW_unblind_posed_binned3_nona3%>%
  subset(idno  == 12)%>%
ungroup()%>%
  select(c(2,38:41, 46,71))%>%
  gather(component, coef,-bin_frame,-name_new_clust,-idno )%>%
  group_by(component, bin_frame,name_new_clust)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(name_new_clust)), 
            alpha = .5)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

```


then look at transitions to find

if the average weight of the last 2 samples of the transition a higher than the first 2 samples then its activation, if the last two samples value if lower than the first 2 then deactivation

```{r}

```

transform(k3_list[[1]]$cluster, id = as.numeric(factor(k3_list[[1]]$cluster)))
# create a unique value for new values ina. column in r

df2 <- transform(df,id=as.numeric(factor(sample)))

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(filename)%>%
  group_indices(clust3)
  transform(id = as.numeric(factor(clust3)))
  
  
colnames(df_OF_output_AUsW_unblind_posed_binned)
  
df_OF_output_AUsW_unblind_posed_binned%>%
  
  ggplot(aes(as.numeric(bin_frame), idno))+
  # ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(~drug.placebo)



```


  message(sprintf("$$$$$RUNING kmean %i", i))
  
  
  
  resampled_temp_test<- fabricatr::resample_data(clustering_new_pre_PCA3.1 [,c(1,2,3, 5:9)], 
                                  N = c(51,55),
                                  ID_labels = c("ssid", "stimDescription"),
                                  unique_labels = TRUE)
  resampled_temp$sim_no = i
  
# run PCA on the resampled data
# ?list
    message(sprintf("$$$$$fitting PCA %i", i))
mfa.res_res <- FactoMineR::MFA(resampled_temp[,1:8], 
               group = c(3, 3, 2), 
               type = c("n", "s", "s"),
              # ind.sup = c(1),
              ncp = 2,
               name.group = c("pp_stim","auton","subj"),
               num.group.sup = c(1),
               # ind.sup = c(1,2),
               graph = FALSE)


# store the eigen values
  message(sprintf("$$$$$storing PCA %i", i))
eugentest<- as.data.frame(mfa.res_res$eig[1:2,])
eugentest$sim_no<- i

cortest<- as.data.frame(mfa.res_res$quanti.var$cor)
cortest$sim_no = i

partials_temp<- as.data.frame(res.mfa_bio_vs_self2_k2$partial.axes$cor)
partials_temp$sim_no = i
# update the initial d=frames
  message(sprintf("$$$$$upating dataframes %i", i))
  resamp_1st<- (bind_rows(resamp_1st, resampled_temp))
eigen_first<- bind_rows(eigen_first, eugentest)
cor_first<- bind_rows(cor_first, cortest)
partials_first<- bind_rows(partials_first, partials_temp)
  message(sprintf("$$$$$completed iteration%i", i))
}



```
```
store the cluster


SUBSTATE POSED
spoken_NMF

```{r}
colnames(spoken_NMF)

unique(spoken_NMF$posed_spoken)


k3_comp1
install.packages("zoo")
spoken_NMF<- spoken_NMF %>%
  group_by(filename)%>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k3_comp1_speed = (abs(lag(k3_comp1) - k3_comp1))/abs((lead(bin_frame)-bin_frame)),
         k3_comp2_speed = (abs(lag(k3_comp2) - k3_comp2))/abs((lead(bin_frame)-bin_frame)),
         k3_comp3_speed = (abs(lag(k3_comp3) - k3_comp3))/abs((lead(bin_frame)-bin_frame)),
        
         k3_comp1_diff = as.numeric(diff(zoo::zoo(k3_comp1), na.pad = TRUE)),
         k3_comp2_diff =as.numeric(diff(zoo::zoo(k3_comp2), na.pad = TRUE)),
         k3_comp3_diff =as.numeric(diff(zoo::zoo(k3_comp3), na.pad = TRUE)),
         
         # moving averages
         k3_comp1_diff_ma = as.numeric(zoo::rollmean(k3_comp1_diff, k = 5, fill = NA)),
         k3_comp2_diff_ma = as.numeric(zoo::rollmean(k3_comp2_diff, k = 5, fill = NA)),
         k3_comp3_diff_ma = as.numeric(zoo::rollmean(k3_comp3_diff, k = 5, fill = NA)),
           
          k3_comp1_speed_ma = as.numeric(zoo::rollmean(k3_comp1_speed, k = 5, fill = NA)),
        k3_comp2_speed_ma = as.numeric(zoo::rollmean(k3_comp2_speed, k = 5, fill = NA)),
         k3_comp3_speed_ma = as.numeric(zoo::rollmean(k3_comp3_speed, k = 5, fill = NA)))%>%
  
  
  mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  
  
  mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE),
          compavg = sum(abs(k3_comp1+k3_comp2+k3_comp3), na.rm = TRUE)
         )


# plot to see if we can viusally notice subates based on speed profiles
unique(spoken_NMF$filename)
spoken_NMF$filename
spoken_NMF%>%
  subset(drug.placebo == "placebo")%>%
      ungroup()%>%
  # mutate(idno = rep(1:333, each = 100))%>%
  ggplot(aes(bin_frame, as.factor(subject), fill = sp_avg))+
  geom_tile()+
  scale_fill_viridis_c(option = "magma")+
  facet_grid(~expression)


spoken_NMF%>%
  subset(drug.placebo == "placebo")%>%
      ungroup()%>%
  # mutate(idno = rep(1:333, each = 100))%>%
  ggplot(aes(bin_frame, as.factor(subject), fill = comp_delta_avg))+
  geom_tile()+
  scale_fill_viridis_c(option = "magma")+
  facet_grid(~expression)




```
  
# cluster substates here spoken?
  
```{r}
# Load the required packages

# Define a custom function to perform clustering with tsclust
perform_tsclust_clustering <- function(data) {
  tsclust_result <- tsclust(data[, c("sp_avg", "comp_delta_avg", "compavg")], k = 3)
  return(tsclust_result@cluster)
}

# Apply max-norm normalization and perform tsclust clustering

?zoo::na.approx()
library(zoo)

spoken_NMF_int <- spoken_NMF %>%
  group_by(filename) %>%
  mutate(sp_avg = na.approx(sp_avg, na.rm = FALSE),
         comp_delta_avg = na.approx(comp_delta_avg, na.rm = FALSE),
 compavg = na.approx(compavg, na.rm = FALSE))%>%
  ungroup()


table(is.na(spoken_NMF_int$sp_avg))

table(is.na(spoken_NMF_int$comp_delta_avg))
table(is.na(spoken_NMF_int$compavg))

spoken_NMF_int$sp_avg<- if_else(is.na(spoken_NMF_int$sp_avg), 0,spoken_NMF_int$sp_avg)
spoken_NMF_int$comp_delta_avg<- if_else(is.na(spoken_NMF_int$comp_delta_avg), 0,spoken_NMF_int$comp_delta_avg)
spoken_NMF_int$compavg<- if_else(is.na(spoken_NMF_int$compavg), 0,spoken_NMF_int$compavg)

# rm(df_with_clusters5hier, df_with_clusters6_lm_nonl)
# rm(df_with_clusters3_agg)
# rm(dcast_time)
# rm(df_OF_output_AU_andLand)
# rm(df_OF_output_AUstest)
# 
# rm(df_OF_output_AUsW_unblind)
# rm(df_OF_output_land_posed_binned_select)
# rm(df_sp)

unique(spoken_NMF_int$drug.placebo)

# remove temporarfile.show
# rm(tmp_tbl, test, test_bind_agg_spoken_posed, test_bind_agg_spoken_posed_noneutr,
#    test_del, test_gradient,testspokenmtsnafilled, test_happy_dcast_summ, test_happy_dcast_summ_paired_test,
#    test4_df)
# rm(spoken_NMF_with_clusters6)

spoken_NMF_with_clusters6 


spoken_NMF_int<- spoken_NMF_int %>%
  group_by(filename) %>%
  # subset(drug.placebo == "placebo")%>%
  mutate(sp_avg = maxnorm(sp_avg),
         comp_delta_avg = maxnorm(comp_delta_avg),
         compavg = maxnorm(compavg))

# try to separate placebo and drug to avoid exhaust memory
spoken_NMF_with_clusters6_plac<- spoken_NMF_int%>%
  subset(drug.placebo == "placebo")%>%
  ungroup() %>%
  mutate(cluster_across = perform_tsclust_clustering(cur_data()))

# drug
spoken_NMF_int$drug.placebo

spoken_NMF_with_clusters6_drug<- spoken_NMF_int%>%
  subset(drug.placebo == "drug")%>%
  ungroup() %>%
  mutate(cluster_across = perform_tsclust_clustering(cur_data()))

# quick check

spoken_NMF_with_clusters6_drug%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across)))+
  geom_tile()+

   scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()

spoken_NMF_with_clusters6_plac%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across)))+
  geom_tile()+

   scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()
# 2 in drug is 3 in placebo
# 1 and 1 are the same?
# 3 is 2
?recode
spoken_NMF_with_clusters6_drug<- spoken_NMF_with_clusters6_drug%>%
  mutate(cluster_across_recode = recode(cluster_across, `2` = 3, `1` = 1, `3` =2))

# now copare again

spoken_NMF_with_clusters6_drug%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across_recode)))+
  geom_tile()+

   scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()

spoken_NMF_with_clusters6_plac%>%
  # subset(filename == "./cut_posed_sad_day1_p7.csv")%>%

  ggplot(aes(as.numeric(bin_frame), as.factor(subject), fill = as.factor(cluster_across)))+
  geom_tile()+

   scale_fill_viridis_d(option = "magma")+

  facet_grid(~expression)+
  theme_classic()

spoken_NMF_with_clusters6_drug$cluster_across<- spoken_NMF_with_clusters6_drug$cluster_across_recode
spoken_NMF_with_clusters6_drug$cluster_across_recode<- NULL

# now merge drug and placebo
spoken_NMF_with_clusters6<- bind_rows(spoken_NMF_with_clusters6_plac, spoken_NMF_with_clusters6_drug)
```

some visualisations of spoken_NMF_with_clusters6
```{r}
unique(spoken_NMF_with_clusters6$filename)

# visualise example of substates
spoken_NMF_with_clusters6%>%
    # subset(idno == 30)%>%
  subset(filename == "./cut_spoken_sad_day1_p17.csv")%>%

  ggplot(aes(as.numeric(bin_frame), sp_avg))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_across)), 
            alpha = .6)  +
    geom_line(size = 1)+
  geom_line(aes(y = comp_delta_avg),  size = 1, linetype = 2)+
  geom_line(aes(y = k3_comp1))+
  geom_line(aes(y = k3_comp2))+
  geom_line(aes(y = k3_comp3))+
     scale_fill_viridis_d(option = "magma")+
  theme_classic()

# visualise one profile for substates and facegrid variables
spoken_NMF_with_clusters6
spoken_NMF_with_clusters6%>%
    # subset(idno == 30)%>%
  subset(filename == "./cut_spoken_sad_day1_p10.csv")%>%
mutate(speed = sp_avg,
       displacement = comp_delta_avg)%>%


  select(c(bin_frame,speed,displacement,k3_comp1,k3_comp2,k3_comp3,cluster_across))%>%

  gather(variable, coef,-bin_frame,-cluster_across) %>%
  mutate(var_type = if_else(grepl("speed", variable), "2. speed",  
                                
                                        if_else(grepl("displacement", variable), "3. displacement",  
 if_else(grepl("k3", variable ), "1. nmf",NA)))) %>%

group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  # group_by(variable, bin_frame,var_type, cluster_label)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = variable))+
  
    geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = as.factor(cluster_across)),
            alpha = .6)  +
  geom_line(aes(group = variable, linetype = var_type), size = 1)+
   facet_grid(var_type~.)+
   scale_fill_viridis_d(option = "magma")+
  # facet_grid(variable_type~.)+
  theme_classic()

```

create cluster labels consistent with posed labels

```{r}
spoken_NMF_with_clusters6$cluster_label <- if_else(spoken_NMF_with_clusters6$cluster_across == 3, "relax",
                                                 if_else(spoken_NMF_with_clusters6$cluster_across == 1, "transition",
                                                         if_else(spoken_NMF_with_clusters6$cluster_across == 2,"sustain", NA)))


spoken_NMF_with_clusters6

spoken_NMF_with_clusters6


# peak speed displ

```

quick checkl of displacement and speed relationships, note peak speed and displacemnts need to be recomputed based on the clusters
```{r}

spoken_NMF_with_clusters6%>%
group_by(filename, cluster_label, expression, subject)%>%
    mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE))%>%
  
  mutate(speed_avg =  max((sp_avg), na.rm = TRUE),
           displacement_avg = max(abs(comp_delta_avg), na.rm = TRUE))%>%
  group_by(filename)%>%
    group_by(filename, cluster_label,expression,drug.placebo)%>%
    summarise_if(is.numeric, mean, na.rm = T)%>%
    ggplot(aes(displacement_avg, speed_avg))+
      geom_point()+
    geom_smooth(aes(colour = cluster_label),method = "lm",se = T)+
    facet_grid(~cluster_label)


```


# entropy - we really need transition entropy (as opposed to stationary)


```{r}
# simulate a case to test this
# Define the transition matrix
P <- matrix(c(0.7, 0.2, 0.1, 0.1, 0.8, 0.1, 0.3, 0.5, 0.2), nrow = 3)

# Define a starting state
start_state <- c("relax", "transition", "sustain")

# Define the number of time steps
num_steps <- 100

# Initialize a vector to store the states
states <- character(num_steps)
states[1] <- start_state[1]

# Simulate the evolution of the system over time
for (i in 2:num_steps) {
  prev_state <- which(start_state == states[i - 1])
  next_state <- sample(start_state, 1, prob = P[prev_state, ])
  states[i] <- next_state
}

# Output the vector of states
states


# now a fucntion to compute transition entropy
# fn_transition_entropy <- function(states) {
#   # Create a table of state transitions
#   state_transitions <- table(states[-1], states[-length(states)])
# 
#   # Create the transition matrix
#   n <- nlevels(states)
#   P <- matrix(0, nrow = n, ncol = n)
#   rownames(P) <- colnames(P) <- levels(states)
#   for (i in 1:n) {
#     P[i, ] <- state_transitions[i, ] / sum(state_transitions[i, ])
#   }
# 
#   # Compute the stationary distribution
#   eigval <- eigen(t(P))$values
#   stat_dist <- eigen(t(P))$vectors[, which.max(abs(eigval))]
#   stat_dist <- stat_dist / sum(stat_dist)
# 
#   # Compute the entropy of the stationary distribution
#   entropy_stat_dist <- -sum(stat_dist * log(stat_dist))
# 
#   # Compute the entropy rate
#   entropy_rate <- -sum(stat_dist * rowSums(P * log(P)))
# 
#   # Return the transition entropy
#   entropy_stat_dist + entropy_rate
# }



# test
install.packages("GrpString")
GrpString::TransEntro(states)#overall entropy
GrpString::TransEntropy(states) #for each state
mean(GrpString::TransEntro(states))


# To  normalise entropy in bits would be H / log2(n)
# similar to our eye-movements paper


```

Now calculate entropy on the data
```{r}
spoken_NMF_with_clusters6

spoken_NMF_with_clusters6<-
spoken_NMF_with_clusters6%>%
group_by(filename, cluster_label, cluster_across)%>%
mutate(freq_clus = n())%>% # compute frequency of each state
  group_by(filename)%>%
  mutate(freq_clus_perc = freq_clus/n())%>% # compute percentage of eacch state e.g. duration
  group_by(filename, expression, subject)%>%
mutate(cluster_count_group = rleid(cluster_label))%>%
  group_by(filename, cluster_label, expression, subject,drug.placebo)%>%
    mutate(peak_speed =  sum(abs(sp_avg), na.rm = TRUE),
           max_displacement = sum(abs(comp_delta_avg), na.rm = TRUE))%>%
   group_by(filename)%>%
  
  mutate(peak_speed_norm =  maxnorm(peak_speed),
max_displacement_norm =  maxnorm(max_displacement))%>%
  # compute entropy
  # shanon entropy
  mutate(entropy_clust = entropy::entropy(table(cluster_label)),
         trans_entropy = GrpString::TransEntro(cluster_label),
         trans_entropy_perclust = GrpString::TransEntropy(cluster_label),
         )%>%
  group_by(filename, cluster_across)%>%
  
  
  # now transition entropy
  mutate(clust_dur_count = n())%>%
  group_by(filename)%>%
  mutate(clust_dur_count_perc = clust_dur_count/n())

  spoken_NMF_with_clusters6$trans_entropy_perclust_new<- spoken_NMF_with_clusters6$trans_entropy_perclust$Entropy
  
# quick visualisation entropy
  spoken_NMF_with_clusters6%>%
  group_by(subject,expression)%>%
    mutate(entropy_clust_norm = entropy_clust/log2(3) )%>%
  summarise_if(is.numeric,mean)%>%
  
  ggplot(aes(expression, entropy_clust_norm))+
  geom_jitter(width = .1, alpha = .3)+
  stat_summary(geom = "pointrange")
  
  # transition entropy
   spoken_NMF_with_clusters6%>%
      mutate(trans_entropy_norm = trans_entropy/log2(3))%>%
  group_by(subject,expression)%>%
  summarise_if(is.numeric,mean)%>%
  
  ggplot(aes(expression, trans_entropy_norm))+
  geom_jitter(width = .1, alpha = .3)+
  stat_summary(geom = "pointrange")
  
  
  # quick visualisation entropy transition per cluster
  spoken_NMF_with_clusters6%>%
     mutate(trans_entropy_perclust_new_norm = trans_entropy_perclust_new/log2(3))%>%
  group_by(subject,cluster_label,expression)%>%
  summarise_if(is.numeric,mean)%>%
  
  ggplot(aes( cluster_label, trans_entropy_perclust_new_norm))+
  # geom_jitter(width = .1, alpha = .3)+
  stat_summary(geom = "pointrange")+
    facet_grid(~cluster_label)
```
  
<!-- Start aggregating -->

```{r}

# agg by siubject
  spoken_NMF_with_clusters6_agg_subj<- spoken_NMF_with_clusters6%>%
    # subset(drug.placebo == "placebo")%>%
  group_by(subject, cluster_across, cluster_label, expression)%>%
    summarise_if(is.numeric, mean, na.rm = T)
  
# agg by filename and subject
  
  spoken_NMF_with_clusters6_agg<- spoken_NMF_with_clusters6%>%
    # subset(drug.placebo == "placebo")%>%
  group_by(filename,subject, cluster_across, cluster_label, expression)%>%
    summarise_if(is.numeric, mean, na.rm = T)
  
  # spoken_NMF_with_clusters6_agg_subj$subject<- as.factor(spoken_NMF_with_clusters6_agg_subj$subject)
  # 
  # spoken_NMF_with_clusters6_agg_subj$cluster_across<- as.factor(spoken_NMF_with_clusters6_agg_subj$cluster_across)  
  
  
  spoken_NMF_with_clusters6_agg_subj$posed.spoken<- "spoken"
  df_with_clusters6_agg_bysubj$posed.spoken<- "posed"
  
  rbind(
  spoken_NMF_with_clusters6_agg_subj [,c("subject", "cluster_label","expression","posed.spoken", "peak_speed", "max_displacement")],
  df_with_clusters6_agg_bysubj[,c("subject", "cluster_label","expression","posed.spoken", "peak_speed", "max_displacement")])%>%
    subset(expression!= "neutral")%>%
     ggplot(aes(max_displacement, peak_speed, colour = posed.spoken))+
    geom_point()+
    geom_smooth(method = "lm")+
    facet_grid(~expression)
    facet_grid(~posed.spoken)
    

spoken_NMF_with_clusters6_agg_subj$cluster_label
df_with_clusters6_agg_bysubj$clu

table(spoken_NMF_with_clusters6_agg_subj$subject)
table(df_with_clusters6_agg_bysubj$subject)
bind_rows()
test_bind_agg_spoken_posed<-
bind_rows(
  spoken_NMF_with_clusters6_agg_subj [,c("subject", "cluster_label","expression","posed.spoken", "peak_speed", "max_displacement")],
  df_with_clusters6_agg_bysubj[,c("subject", "cluster_label","expression","posed.spoken", "peak_speed", "max_displacement")])

write_csv(test_bind_agg_spoken_posed, "test_bind_agg_spoken_posed")
```


anova

```{r}
install.packages("afex")
library(afex)


table(test_bind_agg_spoken_posed$posed.spoken)
tmp_tbl<-table(test_bind_agg_spoken_posed$subject)

unique(test_bind_agg_spoken_posed$expression
       )

tmp_tbl


# count unmatches
test_bind_agg_spoken_posed<-test_bind_agg_spoken_posed%>%
  group_by(subject)%>%
  mutate(subject_posed_spok_cnt = n())

table(test_bind_agg_spoken_posed$subject, test_bind_agg_spoken_posed$subject_posed_spok_cnt)

table(test_bind_agg_spoken_posed$subject)

test_bind_agg_spoken_posed_noneutr<- test_bind_agg_spoken_posed%>%
  subset(subject_posed_spok_cnt !=9 &
           expression!="neutral")

unique(test_bind_agg_spoken_posed_noneutr$subject)
unique(test_bind_agg_spoken_posed_noneutr)

table(test_bind_agg_spoken_posed_noneutr$posed.spoken)
table(test_bind_agg_spoken_posed_noneutr$expression)


```


bind spoken and posed by filename
```{r}
spoken_NMF_with_clusters6_agg$posed_spoken <-"spoken"

spoken_NMF_with_clusters6$cluster_label<-if_else(spoken_NMF_with_clusters6$cluster_label=="relax", "relaxed", spoken_NMF_with_clusters6$cluster_label)

df_with_clusters6_agg$posed_spoken<-"posed"

posed_spoken_NMF_with_clusters6_agg <-bind_rows(
  spoken_NMF_with_clusters6 [,c("filename","subject", "cluster_label","expression","posed_spoken","drug.placebo", "peak_speed", "max_displacement","entropy_clust")],
  df_with_clusters6[,c("filename","subject", "cluster_label","expression","posed_spoken","drug.placebo", "peak_speed", "max_displacement","entropy_clust")])%>%
  group_by(filename, subject, cluster_label, expression, posed_spoken,
           drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = T)

posed_spoken_NMF_with_clusters6_agg
table(posed_spoken_NMF_with_clusters6_agg$drug.placebo,
      posed_spoken_NMF_with_clusters6_agg$posed_spoken)
write_csv(posed_spoken_NMF_with_clusters6_agg, "posed_spoken_NMF_with_clusters6_agg.csv")
```


aggregate posed and spoken by subject
```{r}

posed_spoken_NMF_with_clusters6_agg_bysubj<-

bind_rows(
  spoken_NMF_with_clusters6 [,c("filename","subject", "cluster_label","expression","posed_spoken","drug.placebo", "peak_speed", "max_displacement","entropy_clust")],
  df_with_clusters6[,c("filename","subject", "cluster_label","expression","posed_spoken","drug.placebo", "peak_speed", "max_displacement","entropy_clust")])%>%
  group_by(subject, cluster_label, expression, posed_spoken,
           drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = T)

posed_spoken_NMF_with_clusters6_agg_bysubj

unique(posed_spoken_NMF_with_clusters6_agg_bysubj$expression)

# remove neutral
posed_spoken_NMF_with_clusters6_agg_bysubj<-
posed_spoken_NMF_with_clusters6_agg_bysubj%>%
  subset(expression!="neutral")

rsl_aov_peakspeed<-
afex::aov_ez(data = posed_spoken_NMF_with_clusters6_agg_bysubj,
              id = "subject",
              dv = "peak_speed",
              within = c("posed_spoken", "expression","cluster_label"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

write_csv(posed_spoken_NMF_with_clusters6_agg_bysubj, "posed_spoken_NMF_with_clusters6_agg_bysubj.csv")

options(scipen = 999)

posed_spoken_NMF_with_clusters6_agg_bysubj%>%
  subset(expression!= "neutral")%>%
  ggplot(aes(expression, peak_speed))+
  stat_summary(geom = "pointrange")+
  facet_grid(~ posed_spoken)+
  ggpubr::stat_compare_means()
```

bind spoken and posed include timebins for new entropy calculation

```{r}
unique(spoken_NMF_with_clusters6$expression)
spoken_NMF_with_clusters6
unique(spoken_NMF_with_clusters6$drug.placebo)

spoken_NMF_with_clusters6$comp1<- spoken_NMF_with_clusters6$k3_comp1
spoken_NMF_with_clusters6$comp2<- spoken_NMF_with_clusters6$k3_comp2
spoken_NMF_with_clusters6$comp3<- spoken_NMF_with_clusters6$k3_comp3

df_with_clusters6$comp1
spoken_NMF_with_clusters6
df_with_clusters6$
spoken_posed_nmf<- bind_rows(
  spoken_NMF_with_clusters6 [,c("filename","bin_frame", "subject", "cluster_label","expression","posed_spoken","drug.placebo","sp_avg","comp_delta_avg", "peak_speed", "max_displacement","comp1","comp2", "comp3")],
  df_with_clusters6[,c("filename","bin_frame","subject", "cluster_label","expression","posed_spoken","drug.placebo","sp_avg","comp_delta_avg", "peak_speed", "max_displacement","comp1","comp2", "comp3")])%>%
  group_by(filename, subject,bin_frame, cluster_label, expression, posed_spoken,
           drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = T)

# do the entropy calculation again here

spoken_posed_nmf

# spoken_posed_nmf$cluster_label<- if_else(spoken_posed_nmf$cluster_label == "relax", "relaxed", spoken_posed_nmf$cluster_label)

unique(spoken_posed_nmf$cluster_label)

# compute substate metrics
# note this recomputes a few things computed before, for doublechecking purposes
cluster_across


```


```{r}

# recompute speed and displacement
spoken_posed_nmf$comp1


spoken_posed_nmf%>%
  
  arrange(subject,filename,bin_frame)%>%
group_by(filename)%>%
   mutate(comp_avg = (comp1 +comp2+comp3)/3)%>%
  mutate(displacement = (comp_avg - lag(comp_avg, default = NA))) %>%
  mutate(time_difference = abs(bin_frame - lag(bin_frame, default = NA))) %>%
  mutate(speed = abs(displacement) / time_difference) %>%
  mutate(acceleration = ((speed - lag(speed, default = speed[1])) / time_difference))%>%
  subset(filename == "./cut_posed_angry_day1_p10.csv")%>%
  ggplot(aes(bin_frame, displacement, colour = "red"))+
  geom_line()+
  # geom_line(aes(y = comp2))+
  #  geom_line(aes(y = comp3))+
   # geom_line(aes(y = displacement), linetype = "dashed", colour = "red")+
   geom_line(aes(y = speed), linetype = "dashed", colour = "blue")+
   geom_line(aes(y = acceleration), linetype = "dashed", colour = "green")


# check peak and stuff

spoken_posed_nmf%>%
  
  arrange(subject,filename,bin_frame)%>%
group_by(filename)%>%
   mutate(comp_avg = (comp1 +comp2+comp3)/3)%>%
  mutate(displacement = (comp_avg - lag(comp_avg, default = NA))) %>%
  mutate(time_difference = abs(bin_frame - lag(bin_frame, default = NA))) %>%
  mutate(speed = abs(displacement) / time_difference) %>%
  mutate(acceleration = ((speed - lag(speed, default = speed[1])) / time_difference))%>%
  # subset(filename == "./cut_posed_angry_day1_p10.csv")%>%
  group_by(filename,cluster_label,posed_spoken,expression)%>%
  summarise_if(is.numeric, max, na.rm =T)%>%
  ggplot(aes(comp_avg, speed, colour =posed_spoken ))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_grid(cluster_label ~expression)


spoken_posed_nmf%>%
  
  arrange(subject,filename,bin_frame)%>%
group_by(filename)%>%
   mutate(comp_avg = (comp1 +comp2+comp3)/3)%>%
  mutate(displacement = abs(comp_avg - lag(comp_avg, default = NA))) %>%
  mutate(time_difference = abs(bin_frame - lag(bin_frame, default = NA))) %>%
  mutate(speed = abs(displacement) / time_difference) %>%
  mutate(acceleration = ((speed - lag(speed, default = speed[1])) / time_difference))%>%
  # subset(filename == "./cut_posed_angry_day1_p10.csv")%>%
  group_by(filename,cluster_label,posed_spoken,expression)%>%
  summarise_if(is.numeric, mean, na.rm =T)%>%
  ggplot(aes(expression, speed, colour =posed_spoken ))+
  stat_summary(geom = "pointrange")+
  geom_smooth(method = "lm")+
  facet_grid(~cluster_label)


spoken_posed_nmf<- spoken_posed_nmf%>%
  
  arrange(subject,filename,bin_frame)%>%
group_by(filename)%>%
   mutate(comp_avg_new = (comp1 +comp2+comp3)/3)%>%
  mutate(displacement = comp_avg - lag(comp_avg, default = NA)) %>%
  mutate(time_difference = abs(bin_frame - lag(bin_frame, default = NA))) %>%
  mutate(speed = abs(displacement) / time_difference) %>%
  mutate(acceleration = ((speed - lag(speed, default = speed[1])) / time_difference))

spoken_posed_nmf

```
 
 
 

 compute frequency entropy, etc
```{r}
library(data.table)
 
spoken_posed_nmf<- spoken_posed_nmf%>%
 mutate(freq_clus = n())%>% # compute frequency of each state
  group_by(filename)%>%
  mutate(freq_clus_perc = freq_clus/n())%>% # compute percentage of each state e.g. duration
  group_by(filename, expression, subject)%>%
mutate(cluster_count_group = rleid(cluster_label))%>%
  group_by(filename, cluster_label, expression, subject,drug.placebo)%>%
    mutate(speed_avg =  mean(speed, na.rm = TRUE),
           displacement_avg = mean(displacement, na.rm = TRUE),
acceleration_avg = mean(acceleration, na.rm = TRUE))%>%
   group_by(subject)%>%
  
  mutate(speed_avg_norm =  maxnorm(speed_avg),
displacement_avg_norm =  maxnorm(displacement_avg),
acceleration_avg_norm =  maxnorm(acceleration_avg))%>%
  # compute entropy
  # shanon entropy
  group_by(filename)%>%
  mutate(entropy_clust = entropy::entropy(table(cluster_label)),
         trans_entropy = GrpString::TransEntro(cluster_label),
         trans_entropy_perclust = GrpString::TransEntropy(cluster_label),
         )%>%
  group_by(filename, cluster_label)%>%
  
  # now transition entropy
  mutate(clust_dur_count = n())%>%
  group_by(filename)%>%
  mutate(clust_dur_count_perc = clust_dur_count/n())

# store transition entropy
spoken_posed_nmf$trans_entropy_perclust_use<-spoken_posed_nmf$trans_entropy_perclust$Entropy



spoken_posed_nmf
# 
# colnames(spoken_posed_nmf)
# spoken_posed_nmf$sp_avg

# remove those without one of the sets


# no data for p9 as he refused to do the task and then day 1 data only for 

# Values to remove
tmp_subj_to_remove <- c(4, 9, 12, 26, 34, 35, 41, 42, 43)

# Dataframe filtering
spoken_posed_nmf_filtered <- spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")


spoken_posed_nmf_filtered_agg<- spoken_posed_nmf_filtered%>%
  group_by(subject, filename, expression,posed_spoken, drug.placebo, cluster_label)%>%
  summarise_if(is.numeric,mean, na.rm = T)


spoken_posed_nmf_filtered$trans_entropy_perclust<-NULL
write_csv(spoken_posed_nmf_filtered_agg, "spoken_posed_nmf_filtered_agg.csv")


```

anovas


```{r}
spoken_posed_nmf_filtered$subject<- as.factor(spoken_posed_nmf_filtered$subject)

peak_speed

spoken_posed_nmf_filtered$sp_avg
spoken_posed_nmf_filtered_agg_bysubj<- spoken_posed_nmf_filtered%>%
  group_by(subject)%>%
  mutate(peak_speed_norm = normalize_0_1(peak_speed),
         entropy_clust_normlog = peak_speed/log2(entropy_clust))%>%
   group_by(subject, expression,posed_spoken,cluster_label)%>%
  summarise_if(is.numeric, mean, na.rm = T)
  

res_aovs<- list()  

res_aovs$peak_speed<-
afex::aov_ez(data = spoken_posed_nmf_filtered_agg_bysubj,
              id = "subject",
              dv = "peak_speed",
              within = c("posed_spoken", "expression","cluster_label"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

res_aovs$peak_speed

write_csv(res_aovs$peak_speed$data$wide, "spoken_posed_nmf_filtered_agg_bysubj_aov.csv")



```
Figure 5


```{r}


# spoken p30 angry
plts<- list()
?recode

spoken_posed_nmf_filtered$cluster<- as.factor(recode(spoken_posed_nmf_filtered$cluster_label, "relaxed" = 1, "transition" = 2, "sustain" = 3))

plts_substate_posed<-
spoken_posed_nmf_filtered%>%  
  subset(filename == "./cut_posed_angry_day1_p30.csv")%>%
mutate(speed = sp_avg,
       displacement = comp_delta_avg)%>%
  select(c(bin_frame,speed,displacement,acceleration, comp1,comp2,comp3,cluster_label, cluster))%>%
  gather(variable, coef,-bin_frame,-cluster_label,-cluster, -filename,) %>%
  mutate(var_type = if_else(grepl("speed", variable), "speed",  
                                        if_else(grepl("displacement", variable), "displacement",  
 if_else(grepl("comp", variable ), "NMF-comp","acceleration")))) %>%
  mutate(var_type = factor(var_type, levels = c("NMF-comp", "displacement", "speed", "acceleration")))%>%

group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  
  group_by(variable, bin_frame,var_type, cluster)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = variable))+
  
    geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill =cluster),
            alpha = .4)  +
  
    # geom_smooth(
    #             method = "gam", se = FALSE, aes(col = "GAM")) +
  # geom_smooth(aes(group = variable, linetype = var_type), size = 1)+
  geom_line(aes(group = variable), size = 1.5)+
   facet_grid(var_type~.)+
  scale_fill_brewer(palette = "Dark2")+
   # scale_fill_viridis_d(option = "inferno")+
  theme_classic()+
  ylab("z-score")+
  xlab("time bin")+
  # p$
  p$graphstyle_int+
  facet_wrap(~ var_type, ncol = 1)+
  ggtitle("Posed example")



plts_substate_posed
  
```
# spoken

# spoken p30 angry

```{r}

plts_substate_spoken<-

spoken_posed_nmf_filtered%>%  
  subset(filename == "./cut_spoken_happy_day1_p30.csv")%>%
mutate(speed = sp_avg,
       displacement = comp_delta_avg)%>%
  select(c(bin_frame,speed,displacement,acceleration, comp1,comp2,comp3,cluster_label,cluster))%>%
  gather(variable, coef,-bin_frame,-cluster_label,-cluster,-filename) %>%
  mutate(var_type = if_else(grepl("speed", variable), "speed",  
                                        if_else(grepl("displacement", variable), "displacement",  
 if_else(grepl("comp", variable ), "NMF-comp","acceleration")))) %>%
  mutate(var_type = factor(var_type, levels = c("NMF-comp", "displacement", "speed", "acceleration")))%>%

group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  
  group_by(variable, bin_frame,var_type, cluster)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = variable))+
  
    geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill =cluster),
            alpha = .4)  +
  
    # geom_smooth(
    #             method = "gam", se = FALSE, aes(col = "GAM")) +
  # geom_smooth(aes(group = variable, linetype = var_type), size = 1)+
  geom_line(aes(group = variable), size = 1.5)+
   facet_grid(var_type~.)+
  scale_fill_brewer(palette = "Dark2")+
   # scale_fill_viridis_d(option = "inferno")+
  theme_classic()+
  ylab("z-score")+
  xlab("time bin")+
  # p$
  p$graphstyle_int+
  facet_wrap(~ var_type, ncol = 1)+
    ggtitle("Spoken example")

plts_substate_spoken
```

```{r}
plts_substate_posed<- plts_substate_posed+
  theme(axis.text.y = element_blank(),
        legend.position = "top",
        strip.text = element_text(size = 5))+
    scale_fill_brewer(palette = "Dark2")

plts_substate_spoken<-plts_substate_spoken+
    theme(axis.text.y = element_blank(),
        legend.position = "top",
           strip.text = element_text(size = 5))+
    scale_fill_brewer(palette = "Dark2")


plts_substate_posed
plts_substate_spoken


```

# speed and displacement plots
```{r}
plts_substate_posed_HM


spoken_posed_nmf_filtered%>%
  subset(posed_spoken == "posed")%>%
      ungroup()%>%
  group_by(filename)%>%
  mutate(acceleration = acceleration/max(speed,na.rm = T))%>%
  # mutate(idno = rep(1:333, each = 100))%>%
  ggplot(aes(bin_frame, subject, fill = acceleration))+
  geom_tile()+
  facet_grid(~expression)+
  ylab("subject")+
  xlab("time bin")+
  theme_classic()+
  p$graphstyle_int+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
     scale_fill_viridis_c(option = "magma")+
   # scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
   #                     limits =c(0,1))+#)+
  theme(panel.spacing.x = unit(1.5, "lines"),
        axis.text.y = element_blank())+
        guides(fill=guide_colorbar(ticks.colour = NA))


plts_substate_posed_HM<-
spoken_posed_nmf_filtered%>%
  subset(posed_spoken == "posed")%>%
      ungroup()%>%
  group_by(filename)%>%
  # mutate(speed = speed/max(speed,na.rm = T))%>%
  mutate(speed = sp_avg)%>%
    # mutate(speed = speed/max(speed,na.rm = T))%>%
  # mutate(idno = rep(1:333, each = 100))%>%
  ggplot(aes(bin_frame, subject, fill = speed))+
  geom_tile()+
  facet_grid(~expression)+
  ylab("subject")+
  xlab("time bin")+
  theme_classic()+
  p$graphstyle_int+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
     scale_fill_viridis_c(option = "magma")+
   scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  theme(panel.spacing.x = unit(1.5, "lines"),
        axis.text.y = element_blank())+
        guides(fill=guide_colorbar(ticks.colour = NA))+
  ggtitle("Posed")
```
range(unique(spoken_posed_nmf_onlycomplete$sp_avg))

```{r}
plts_substate_spok_HM<-
spoken_posed_nmf_filtered%>%
  subset(posed_spoken == "spoken")%>%
      ungroup()%>%
  mutate(speed = sp_avg)%>%
  # mutate(idno = rep(1:333, each = 100))%>%
  ggplot(aes(bin_frame, subject, fill = speed))+
  geom_tile()+
  facet_grid(~expression)+
  ylab("subject")+
  xlab("time bin")+
    theme_classic()+
  p$graphstyle_int+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
   scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  theme(panel.spacing.x = unit(1.5, "lines"),
        axis.text.y = element_blank())+
        guides(fill=guide_colorbar(ticks.colour = NA))+
    ggtitle("Spoken")


unique(spoken_posed_nmf_filtered$cluster_label)
spoken_posed_nmf_filtered%>%
  subset(posed_spoken == "spoken")%>%
      ungroup()%>%
  # mutate(speed = sp_avg)%>%

    mutate(speed = speed/max(speed,na.rm = T))%>%
  # mutate(idno = rep(1:333, each = 100))%>%
  ggplot(aes(bin_frame, subject, fill = speed))+
  geom_tile()+
  facet_grid(~expression)+
  ylab("subject")+
  xlab("time bin")+
    theme_classic()+
  p$graphstyle_int+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
   scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  theme(panel.spacing.x = unit(1.5, "lines"),
        axis.text.y = element_blank())+
        guides(fill=guide_colorbar(ticks.colour = NA))


plts_substate_posed
plts_substate_spoken
plts_substate_posed_HM
plts_substate_spok_HM

install.packages("patchwork")
library(patchwork)


plts_substate_illustration_hm <- ((((plts_substate_posed+ plts_substate_spoken)+plot_annotation(title = "sample expressions"))+   plot_layout(guides = "collect") & theme(legend.position = "top"))/ 
  
  ((plts_substate_posed_HM+plts_substate_spok_HM) + plot_layout(nrow = 2) & theme(legend.position = "top")))+
  plot_layout(heights = c(1,2))+plot_annotation(tag_levels = 'A') 



ggsave("plts_substate_illustration_hm.tiff", plts_substate_illustration_hm, device = "tiff",
       width = 14, height = 14, dpi = 800)
  
```



speed lmms
# install.packages("sjstats")
# install.packages("sjPlot")
# install.packages("psycho")
# install.packages("remotes")
# install.packages("easystats")

```{r}
library(lmerTest)
options(scipen = 999)
rslt_speedavg<-lmer(speed_avg~ expression*posed_spoken*cluster_label +(1|subject),
     REML =FALSE,
     data = spoken_posed_nmf_filtered_agg)

anova(rslt_speedavg)

# Main effects pairwise
emmeans::emmeans(rslt_speedavg, pairwise~cluster_label, adjust = "bonf")
emmeans::emmeans(rslt_speedavg, pairwise~expression, adjust = "bonf")
emmeans::emmeans(rslt_speedavg, pairwise~posed_spoken, adjust = "none")

# two way interactions
emmeans::emmeans(rslt_speedavg, pairwise~expression|cluster_label, adjust = "bonf")
emmeans::emmeans(rslt_speedavg, pairwise~expression|posed_spoken, adjust = "bonf")
emmeans::emmeans(rslt_speedavg, pairwise~cluster_label|posed_spoken, adjust = "bonf")

# three way interactions
emmeans::emmeans(rslt_speedavg, pairwise~expression|posed_spoken*cluster_label, adjust = "bonf")
emmeans::emmeans(rslt_speedavg, pairwise~posed_spoken|expression*cluster_label, adjust = "bonf")

anova(rslt_speedavg)
summary(rslt_speedavg)
report::report(rslt_speedavg)
report::report(anova(rslt_speedavg))
# tmp_emmeans<- emmeans::emmeans(rslt_speedavg, pairwise~expression|posed_spoken*cluster_label, adjust = "bonf")
# report::report(tmp_emmeans$contrasts)


```


frequency

```{r}
rslt_clust_dur_count_perc<-lmer(clust_dur_count_perc~ expression*posed_spoken*cluster_label +(1+posed_spoken|subject),
     REML =FALSE,
     data = spoken_posed_nmf_filtered_agg)


anova_results <- afex::anova_stats(model)

summary(rslt_speedavg)
anova(rslt_clust_dur_count_perc)
report::report(rslt_clust_dur_count_perc)
report::report(anova(rslt_clust_dur_count_perc))


# summary(rslt_clust_dur_count_perc)
# anova(rslt_clust_dur_count_perc)

# interactions::sim_margins(rslt_clust_dur_count_perc, pred = expression)
emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~cluster_label, adjust = "bonf")
emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~expression, adjust = "bonf")

emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~posed_spoken, adjust = "bonf")

# twp way interactions

# emmeans::emmeans(rslt_speedavg, pairwise~cluster_label|expression, adjust = "bonf")
emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~expression|cluster_label, adjust = "bonf")
# emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~posed_spoken|expression, adjust = "bonf")
emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~expression|posed_spoken, adjust = "bonf")

# 3way
# emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~expression|posed_spoken*cluster_label, adjust = "bonf")

summary(rslt_clust_dur_count_perc)

```
entropy

```{r}

spoken_posed_nmf_filtered_agg2<- spoken_posed_nmf_filtered_agg%>%
  group_by(subject,expression,posed_spoken)%>%
  summarise_if(is.numeric, mean, na.rm = T)

spoken_posed_nmf_filtered_agg2$subject <- as.factor(spoken_posed_nmf_filtered_agg2$subject)

rslt_trans_entropy<-lmer(trans_entropy~ expression*posed_spoken +(1+posed_spoken+expression|subject),
     REML =FALSE,
     data = spoken_posed_nmf_filtered_agg2)
eigen(rslt_trans_entropy)

spoken_posed_nmf_filtered%>%
    # group_by(subject,expression,posed_spoken)%>%
  # summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(posed_spoken, entropy_clust))+
  # geom_jitter(width = .2,alpha = .1)+
  stat_summary(geom = "pointrange")
  facet_grid(~expression)
  
  
  afex::aov_ez(data = spoken_posed_nmf_filtered_agg2,
              id = "subject",
              dv = "trans_entropy",
              within = c("posed_spoken", "expression"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

```



Plots


```{r}
# install.packages("ggside")

# speed
plts_substate_speed_avg<-
spoken_posed_nmf_filtered_agg%>%
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
  group_by(subject,expression,cluster_label,cluster, posed_spoken)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes( cluster , speed, 
             color = posed_spoken, shape =posed_spoken))+
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 1),alpha = .2) +
 stat_summary(aes(group = posed_spoken, colour =posed_spoken, linetype =posed_spoken),fun.y = mean,  geom = "line",
               position = position_dodge(width = 1), size = 1.5)+
   stat_summary(aes(group = posed_spoken, colour =posed_spoken),
                fun.y = mean,  
                geom = "point",
                 position = position_dodge(width = 1),size = 1.5)+
    # stat_summary(aes(group = posed_spoken, colour =posed_spoken),  geom = "pointrange")+
  stat_summary(fun.data = "mean_se", 
               geom = "errorbar",
               width  = .5,
               size = 1.5,
               position = position_dodge(width = 1)
    # fun.y = mean,
               # fun.ymin = function(x) mean(x) - sd(x), 
               # fun.ymax = function(x) mean(x) + sd(x), 
               # geom = "pointrange"
    # geom = "errorbar"
    ) +
    facet_grid(~expression)+
  xlab("Substate cluster")+
  scale_color_brewer(palette = "Dark2")+
      scale_fill_brewer(palette = "Dark2")+
ggside::geom_ysidedensity(aes(x=stat(density), color = posed_spoken,  fill = posed_spoken), alpha = .5)+
  ggside::geom_xsideboxplot(aes(group = cluster), alpha = .5, orientation = "x")+
   # ggside::geom_xsideboxplot(aes(group = cluster), alpha = .5)+

  theme_classic()+
  theme(legend.position = "top")+
  p$graphstyle_int+
    theme(legend.title = element_blank())+
      theme(ggside.panel.scale = .5,
          ggside.axis.text.y = element_blank())

plts_substate_speed_avg
```

# frequency
```{r}
plts_substate_freq
plts_substate_freq<-


# spoken_posed_nmf_filtered_agg

spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
  
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
  group_by(filename,subject,expression,cluster_label,cluster, posed_spoken)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes( cluster , clust_dur_count_perc, 
             color = posed_spoken, shape =posed_spoken))+
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 1),alpha = .2) +
 stat_summary(aes(group = posed_spoken, colour =posed_spoken, linetype =posed_spoken),fun.y = mean,  geom = "line",
               position = position_dodge(width = 1), size = 1.5)+
   stat_summary(aes(group = posed_spoken, colour =posed_spoken),
                fun.y = mean,  
                geom = "point",
                 position = position_dodge(width = 1),size = 1.5)+
    # stat_summary(aes(group = posed_spoken, colour =posed_spoken),  geom = "pointrange")+
  stat_summary(fun.data = "mean_se", 
               geom = "errorbar",
               width  = .5,
               size = 1.5,
               position = position_dodge(width = 1)
    # fun.y = mean,
               # fun.ymin = function(x) mean(x) - sd(x), 
               # fun.ymax = function(x) mean(x) + sd(x), 
               # geom = "pointrange"
    # geom = "errorbar"
    ) +
    facet_grid(~expression)+

ggside::geom_ysidedensity(aes(x=stat(density), color = posed_spoken,  fill = posed_spoken), alpha = .5)+
  ggside::geom_xsideboxplot(aes(group = cluster), alpha = .5, orientation = "x")+


  xlab("Substate cluster")+
  ylab("Proportion")+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+

  theme_classic()+
  theme(legend.position = "top")+
  p$graphstyle_int+
    theme(legend.title = element_blank())+
      theme(ggside.panel.scale = .5,
          ggside.axis.text.y = element_blank())
plts_substate_freq

tmp_freq<- spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
  group_by(filename,subject,expression,cluster_label, posed_spoken,drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = T)

tmp_freq$subject<- as.factor(tmp_freq$subject)

tmp_freq$newre<- paste0(tmp_freq$expression, tmp_freq$posed_spoken)
rslt_clust_dur_count_perc<- lmer(log(clust_dur_count+.1) ~ cluster_label+expression+posed_spoken+
       expression:cluster_label+
       posed_spoken:cluster_label+
         (1|subject),
       # (1|expression)+ (1|posed_spoken), REML = FALSE,
     data = tmp_freq)
  
anova(rslt_clust_dur_count_perc)

report::report(anova(rslt_clust_dur_count_perc))
report::report((rslt_clust_dur_count_perc))
emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~cluster_label, adjust = "bonf")
emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~expression|cluster_label, adjust = "bonf")

emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~posed_spoken|cluster_label, adjust = "bonf")

emmeans::emmeans(rslt_clust_dur_count_perc, pairwise~posed_spoken|cluster_label, adjust = "bonf")
tmp_freq%>%
  mutate(clust_dur_count = n())%>%
  group_by(filename)%>%
  mutate(clust_dur_count_perc = clust_dur_count/n())
  
  tmp_freq%>%
ggplot(aes( cluster_label , clust_dur_count, 
             color = posed_spoken, shape =posed_spoken))+
    # facet_grid(~expression)+
  stat_summary(geom = "pointrange")
  
  
    tmp_freq%>%
ggplot(aes( cluster_label , clust_dur_count, 
             color = expression, shape =expression))+
    # facet_grid(~expression)+
  stat_summary(geom = "pointrange")
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 1),alpha = .2) +
```

# entropy

```{r}
plts_substate_entropy

# spoken_posed_nmf$trans_entropy

spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
    group_by(subject)%>%
  mutate(trans_entropy = maxnormalize(log10(trans_entropy+.001)))%>%
      group_by(filename,subject,expression, posed_spoken, cluster)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  
  ggplot(aes(expression , trans_entropy, 
             color = expression, shape =expression))+
  stat_summary(geom = "pointrange")+
  
  # geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 1),alpha = .2) +
    
 # stat_summary(fun.y = mean,  geom = "line",
 #               position = position_dodge(width = 1), size = 1.5)+

   # 
   # stat_summary(aes(group = expression, colour =expression),
   #              fun.y = mean,  
   #              geom = "point",
   #               position = position_dodge(width = 1),size = 1.5)+

  stat_summary(fun.data = "mean_se", 
               geom = "errorbar",
               width  = .5,
               size = 1.5,
               position = position_dodge(width = 1))+


  xlab("Substate cluster")+
  ylab("entropy (bits)")+
          facet_grid(~posed_spoken)

  
 ggside::geom_ysidedensity(aes(x=stat(density), color = expression,  fill = expression), alpha = .5)+
          facet_grid(~posed_spoken)

  ggside::geom_xsideboxplot(aes(group = cluster), alpha = .5, orientation = "x")+
  # ggside::geom_xsidepath()+

  
     # ggside(x.pos = "bottom", y.pos = "left") +
    scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
        facet_grid(~posed_spoken)
  theme_classic()+
  theme(legend.position = "top")+
  p$graphstyle_int+
    theme(legend.title = element_blank())+
    theme(ggside.panel.scale = .5,
          ggside.axis.text.y = element_blank())

```

plts_substate_entropy

```{r}
ggsave("plts_substate_entropy.tiff", plts_substate_entropy, device = "tiff",
       width = 14, height = 14, dpi = 800)



spoken_posed_nmf1<-
spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
  group_by(subject)%>%
  
    group_by(subject)%>%
  # mutate(trans_entropy = maxnormalize(trans_entropy))%>%
      group_by(filename,subject,expression, posed_spoken,drug.placebo, cluster,cluster_label)%>%
  summarise_if(is.numeric, mean, na.rm = T)

spoken_posed_nmf1$subject<- as.factor(spoken_posed_nmf1$subject)

rslt_trans_entropy<-lmer(log1p(trans_entropy)~ expression*posed_spoken+
                           # expression:posed_spoken+
                           # expression:cluster_label+
                           # posed_spoken:cluster_label +
                           (1+posed_spoken|subject),
     REML =FALSE,
     data = spoken_posed_nmf1%>%
       group_by(filename, subject, posed_spoken, drug.placebo, expression)%>%
       summarise_if(is.numeric, mean, na.rm = T))
summary(rslt_trans_entropy)
emmeans::emmeans(rslt_trans_entropy, pairwise~cluster_label)

anova(rslt_trans_entropy)

summary(rslt_trans_entropy)

emmeans::emmeans(rslt_trans_entropy, pairwise~expression, adjust = "bonf")
emmeans::emmeans(rslt_trans_entropy, pairwise~posed_spoken,)

emmeans::emmeans(rslt_trans_entropy, pairwise~expression*posed_spoken, adjust = "holm")
report::report(rslt_trans_entropy)
report::report(anova(rslt_trans_entropy))

```

# compute just one entropy

```{r}

install.packages("entropy")

unique(spoken_posed_nmf$filename)
install.packages("GrpString")

 spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
   # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
  group_by(filename)%>%
  mutate(entropy_clust = entropy::entropy(table(cluster_label)),
         trans_entropy_overall = GrpString::TransEntro(cluster_label),
         trans_entropy_within = GrpString::TransEntropy(cluster_label)[,2])%>%
   group_by(filename, subject, expression, posed_spoken, drug.placebo, cluster,cluster_label)%>%
   summarise_if(is.numeric, mean, na.rm = T)%>%
 # mutate(testnew = sum(trans_entropy_within))%>%
   ggplot(aes( cluster_label, trans_entropy_within, color = posed_spoken))+
   geom_jitter(width = .1)+
   stat_summary(geom = "pointrange")+
   facet_grid(~expression)

```



```{r}
((plts_substate_speed_avg/
plts_substate_freq)|(guide_area() +
plts_substate_entropy))+
   plot_layout(guides = "collect")+
  plot_layout(nrow = 2,widths = c(2.5,1.5))

plts_substate_speed_entropy<-
(plts_substate_speed_avg/plts_substate_entropy)+
   plot_layout(guides = "collect")& theme(legend.position = "top")
  plot_layout(nrow = 2,widths = c(2.5,1.5))
  
  
  plts_substate_speed_entropy<-
((plts_substate_speed_avg+theme(axis.title.x = element_blank()))/plts_substate_entropy)+
   plot_layout(guides = "collect")& theme(legend.position = "top")

  
  
    plts_substate_speed_entropy_freq<-
((plts_substate_speed_avg+theme(axis.title.x = element_blank()))/(plts_substate_entropy+theme(axis.title.x = element_blank()))/plts_substate_freq)+
   plot_layout(guides = "collect")+ plot_annotation(tag_levels = 'A') & theme(legend.position = "top")
  
  
  
ggsave("plts_substate_speed_entropy.tiff", plts_substate_speed_entropy, device = "tiff",
       width = 12, height = 10, dpi = 800)

ggsave("plts_substate_speed_entropy_freq.tiff", plts_substate_speed_entropy_freq, device = "tiff",
       width = 12, height = 12, dpi = 800)



```
# compute amplitude of substate

```{r}
spoken_posed_nmf$cluster_label
spoken_posed_nmf$bin_frame

spoken_posed_nmf$speed
spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(substate_group = rleid(cluster_label)) %>%
  group_by(filename,subject,expression, posed_spoken,drug.placebo, cluster_label, substate_group) %>%
  summarise(amplitude = max(bin_frame) - min(bin_frame) + 1,
             peak_speed = max(speed))%>%
  # substate_group
  group_by(filename,subject,expression, posed_spoken, cluster_label,substate_group) %>%
  summarise_if(is.numeric, mean,na.rm = T)%>%
  subset(cluster_label == "transition")%>%
  ungroup()%>%
  ggplot(aes(x = amplitude, y = speed_avg)) +
  geom_point(alpha = .1) +
  geom_smooth(method = "lm")+
  labs(title = "Relationship between Amplitude and Peak Speed",
       x = "Amplitude",
       y = "Peak Speed",
       color = "Substate") +
  theme_minimal()+
  # facet_grid(~expression)+
  ggpubr::stat_cor()


spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(substate_group = rleid(cluster_label)) %>%
  group_by(filename,subject,expression, posed_spoken,drug.placebo, cluster_label, substate_group) %>%
  summarise(amplitude = max(bin_frame) - min(bin_frame) + 1,
             peak_speed = max(speed))%>%
  # substate_group
  group_by(filename,subject,expression, posed_spoken, drug.placebo, cluster_label,) %>%
  summarise_if(is.numeric, mean,na.rm = T)%>%
  subset(cluster_label == "transition")%>%
  ungroup()%>%
  ggplot(aes(x = log(amplitude+.1), y = log(peak_speed+.1), colour = expression,group= expression)) +
  geom_point(alpha = .5) +
    # geom_smooth(
                # method = "gam", se = FALSE) +
  geom_smooth(method = "lm", se = F)+
  labs(title = "Relationship between Amplitude and Peak Speed",
       x = "Transition Amplitude",
       y = "Peak Speed",
       color = "expression") +
  
  theme_minimal()+
  facet_grid(~posed_spoken)+
  geom_ysidedensity(aes(x=stat(density), fill = expression), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "right") +
  
  ggpubr::stat_cor()+
  p$graphstyle_int

peak_speed_transitions<-
spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(substate_group = rleid(cluster_label)) %>%
  group_by(filename,subject,expression, posed_spoken,drug.placebo, cluster_label, substate_group) %>%
  summarise(amplitude = max(bin_frame) - min(bin_frame) + 1,
             peak_speed = max(speed))%>%
  # substate_group
  group_by(subject,expression, posed_spoken, drug.placebo, cluster_label,) %>%
  summarise_if(is.numeric, mean,na.rm = T)%>%
  subset(cluster_label == "transition")%>%
  ungroup()%>%
  ggplot(aes(x = log1p(amplitude+.1), y = log1p(peak_speed+.1), colour = posed_spoken,group= posed_spoken ,
             shape= posed_spoken )) +
  geom_point(alpha = .5) +
    # geom_smooth(
                # method = "gam", se = FALSE) +
  geom_smooth(method = "lm", se = F)+
  labs(
  # title = "Relationship between Amplitude and Peak Speed for 
  #      n\ transition substates",
       x = "Amplitude (log)",
       y = "Peak Speed (log)",
       color = "expression") +
  
  theme_minimal()+
  facet_grid(~expression)+
  geom_ysidedensity(aes(x=stat(density), fill = posed_spoken), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "right") +
  
  ggpubr::stat_cor()+
      scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
  # p$graphstyle_int+
  theme_classic()+
  theme(legend.position = "top")+
  p$graphstyle_int+
    theme(legend.title = element_blank()
          # legend.position = "none"
          )+
      theme(ggside.panel.scale = .3,
          ggside.axis.text.x = element_blank())



```


AU visualisation for SM


```{r}
colnames(df_OF_output_AUsW_unblind_spoken1_binned)
colnames(df_with_clusters6)
df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]


df_with_clusters6$comp1
spoken_NMF_with_clusters6

colnames(df_OF_output_AUsW_unblind_spoken1_binned[,c(17:33)])

df_OF_output_AUsW_unblind_spoken1_binned$posed.spoken

range(df_OF_output_AUsW_unblind_spoken1_binned$AU01_r_Inner_brow_raiser)
range(df_with_clusters6$AU01_r_Inner_brow_raiser)


df_with_clusters6$posed.spoken<- df_with_clusters6$posed_spoken



bind_rows(
  df_OF_output_AUsW_unblind_spoken1_binned [,c("filename","bin_frame", "subject" ,"expression","posed.spoken","drug.placebo", colnames(df_OF_output_AUsW_unblind_spoken1_binned[,c(17:33)]))] ,
  df_with_clusters6[,c("filename","bin_frame", "subject" ,"expression","posed_spoken","drug.placebo", colnames(df_OF_output_AUsW_unblind_spoken1_binned[,c(17:33)]))])%>%
  filter(!subject %in% tmp_subj_to_remove)%>%
    subset(expression!= "neutral")%>%
  group_by(filename, subject,bin_frame, expression, posed.spoken)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%

  gather("AU", "Coef", -bin_frame,-filename, -expression,-subject,-posed.spoken)%>%
    group_by(subject,posed.spoken,AU)%>%
  mutate(Coef = maxnormalize(Coef))%>%
  ggplot(aes(bin_frame,AU,fill= Coef))+
  geom_tile()+
  facet_grid(expression~posed.spoken)+
  scale_fill_viridis_c(option = "magma")


# sd
df_with_clusters6$posed.spoken<- "posed"
bind_rows(
  df_OF_output_AUsW_unblind_spoken1_binned [,c("filename","bin_frame", "subject" ,"expression","posed.spoken","drug.placebo", colnames(df_OF_output_AUsW_unblind_spoken1_binned[,c(17:33)]))] ,
  df_with_clusters6[,c("filename","bin_frame", "subject" ,"expression","posed.spoken","drug.placebo", colnames(df_OF_output_AUsW_unblind_spoken1_binned[,c(17:33)]))])%>%
  filter(!subject %in% tmp_subj_to_remove)%>%
    subset(expression!= "neutral")%>%
  # group_by(filename, subject,bin_frame, expression, posed.spoken)%>%


  gather("AU", "Coef", -bin_frame,-filename, -expression,-subject,-posed.spoken,-drug.placebo) %>%
      group_by(subject,posed.spoken,AU)%>%
  mutate(Coef = scale(as.numeric(Coef, na.rm = T))) %>%
  group_by(bin_frame, expression, posed.spoken,AU)%>%
  subset(!is.na(Coef))%>%
    summarise_at(c("Coef"), sd, na.rm = T) %>%

  ggplot(aes(bin_frame,AU,fill= Coef))+
  geom_tile()+
  facet_grid(expression~posed.spoken)+
  scale_fill_viridis_c(option = "magma")+
  ylab("Variability - SD (z)")


```

spoken_posed_nmf$trans_entropy_perclust_use<- spoken_posed_nmf$trans_entropy_perclust$Entropy
spoken_posed_nmf1<- spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  mutate(cluster = recode(cluster_label, "relaxed" = "1", "sustain" = "2", "transition" = "3"))%>%
  group_by(filename)%>%
  mutate(entropy_clust = entropy::entropy(table(cluster_label)),
         trans_entropy = GrpString::TransEntro(cluster),
         trans_entropy_perclust = GrpString::TransEntropy(cluster_label)[,2])

spoken_posed_nmf1$trans_entropy_perclust

spoken_posed_nmf1$cluster
spoken_posed_nmf[!spoken_posed_nmf$subject %in% tmp_subj_to_remove, ]%>%
    subset(expression!= "neutral")%>%
  group_by(subject,cluster_label)%>%
  mutate(trans_entropy = scale(trans_entropy))%>%
  # subset(cluster_label!= "transition")%>%
    group_by(subject,expression, cluster_label)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(trans_entropy, clust_dur_count_perc))+
  geom_point() +
  geom_smooth(method = "lm")+
  facet_grid(~cluster_label)+
  ggside::geom_ysidedensity()+
    ggside::geom_xsidedensity()+
  ggpubr::stat_cor()
  
  p$graphstyle_int

```

