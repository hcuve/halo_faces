---
title: "delaunay faces and meshes"
author: "Helio"
date: "2022-12-25"
output: html_document
---


# landmarks and normalisation

```{r}
require(data.table)
require(ggforce)

library(tidyverse)
View(df_OF_output_land)
df_OF_output_land

colnames(df_OF_output_land)
unique(df_OF_output_land$filename)

# lets start by taking one single subject and plotting the change
# but to do that we fist need to normalise and alligh

library(data.table)

df_OF_output_land$filename
# select one test sample
test_happy <-df_OF_output_land%>%
  subset(filename == "./cut_posed_happy_day2_p6.csv")
  
colnames(df_OF_output_land)
df_OF_output_land
# first binify it
colnames(df_OF_output_land_posed_binned)

unique(df_OF_output_land_posed_binned$bin_frame)

# dcasted
df_OF_output_land_posed_binned$
df_OF_output_land_posed_binned_select
# group_by(filename)%>%
#   gather(key, value, -frame, -timestamp,-filename) %>%
#   mutate(coordinate = substr(key,1,1))%>%
#   mutate(lanmark_id = substr(key,3,4)) %>%
#   dcast(filename+lanmark_id+frame+timestamp~coordinate, value.var = "value",  mean)



```

rotate

```{r}

df_OF_output_land_posed_binned_select$Stimuli_frame <- paste0(df_OF_output_land_posed_binned_select$filename,df_OF_output_land_posed_binned_select$bin_frame)

filename_unique<-unique(df_OF_output_land_posed_binned_select$Stimuli_frame)

f = 1
temp_df_bind<- data.frame() # e empty dataframe to store results

for (f in 1:length(filename_unique)) {
  # f = 2
  # video = filename_video[f]
  temp_df <- df_OF_output_land_posed_binned_select%>%
    subset(Stimuli_frame == filename_unique[f])
  
    # start
  message(paste0("running video no_: ", f), paste0("_",filename_unique[f]))


  
  # First, isolate the points of interest (the subject's left and right eyes)
  left_eye  <- temp_df[temp_df$lanmark_id == 42,]
  right_eye <- temp_df[temp_df$lanmark_id == 39,] 
  
  # now find the difference in the y co-ordinates and x co-ordinates between these two points:
  diff_x <- left_eye$x - right_eye$x
  diff_y <- left_eye$y - right_eye$y
  
   message(paste0("angle - ratio - transform"))
  # The arctangent of the ratio will be the angle you need to rotate all the points by:
  theta  <- atan2(-diff_y, diff_x)
  
# print("matrix") 
# To transform the points, you need to create a rotation matrix, which is a specific two-by-two matrix which you can use to rotate the original points:
# 
# enter image description here - https://stackoverflow.com/questions/74493141/align-x-and-y-coordinates-of-face-landmarks-in-r/74493424?noredirect=1#comment131500839_74493424
  
  mat <- matrix(c(cos(theta), sin(theta), -sin(theta), cos(theta)), 2)

# Now we multiply each x, y point by this matrix to get our rotated points, and write it back into our original data frame:
  temp_df$x_new_norm_rot <- t(apply(temp_df[,7:8], 1, function(x) mat %*% x))[,1]
  temp_df$y_new_norm_rot <- t(apply(temp_df[,7:8], 1, function(x) mat %*% x))[,2] 
   
  message(paste0("bind datasets"))
  
    temp_df_bind<- bind_rows(temp_df_bind,temp_df)
}


# unique(temp_df_bind$filename)
unique(temp_df_bind$filename)
```

after this we want to plot again the average landmark position for each expression

```{r}
options(scipen = 999)
# 
# df_OF_output_land_posed_binned_select$subject<- sub(".*_p", "", str_match(df_OF_output_land_posed_binned_select$filename, "p\\s*(.*?)\\s*.csv")[,2])
# df_OF_output_land_posed_binned_select
nrow(df_OF_output_land_posed_binned_select)
nrow(df_OF_output_land_posed_binned_select_alligned_eyes)

df_OF_output_land_posed_binned_select_alligned_eyes<- temp_df_bind

# plot alligned landmarks to check
df_OF_output_land_posed_binned_select_alligned_eyes%>%
    filter(bin_frame>40 & bin_frame<75)%>%
  subset(subject == 20)%>% # explore specific subjects
 group_by(lanmark_id,expression)%>%
         summarise_if(is.numeric, mean,na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot, y = 1-y_new_norm_rot))+
  geom_point()+
    facet_grid(~expression)

# of the above looks right, store average position of ndmarls for plotting
# norm and diff

# now compute difference maps - i.e compute commutative differences for each landmark



# taking too long??
# test_happy_dcast_binned<- 
  # test_happy_dcast %>%
df_OF_output_land_posed_binned_select_alligned_eyes$bin_frame

df_OF_output_land_posed_binned_select_alligned_eyes<-

df_OF_output_land_posed_binned_select_alligned_eyes%>%
  mutate(lanmark_id = as.numeric(lanmark_id))%>%
  group_by(filename)%>%
  arrange(lanmark_id)%>%
  # group_by(filename, expression,lanmark_id)%>%
 group_by(filename, bin_frame)%>%
  mutate(x_new_norm_rot2 = maxnormalize(x_new_norm_rot),
         y_new_norm_rot2 = maxnormalize(y_new_norm_rot))%>%
  # compute landmark differences
  group_by(filename,lanmark_id)%>%
  mutate(x_norm_diff= x_new_norm_rot2 - lag(x_new_norm_rot2),
         y_norm_diff= y_new_norm_rot2 - lag(y_new_norm_rot2))%>%
# %>%
    mutate(x_norm_diff_abs= (x_norm_diff),#decide wherher to absolute or not, i cut the abs for now
         y_norm_diff_abs= (y_norm_diff))%>%

  # compute a sum - also consider a rolling sum
   # mutate(x_norm_diff_abs_sum= sum(x_norm_diff_abs, na.rm = TRUE),
   #       y_norm_diff_abs_sum= sum(y_norm_diff_abs, na.rm = TRUE))%>%
  # do a cummulative summ
  # subset(frame == 100)%>%
  # ungroup()%>%
  mutate(fill_x_y_sum = (x_norm_diff_abs+y_norm_diff_abs)/2) %>%
  # this is what we are goint to use to colour pints
  
  group_by(filename,lanmark_id)%>%
  #the line below just ignores NA (introduced in lag) which would throw error to cumsum otehrwise
      mutate(cum_x_norm_abs_diff = cumsum(ifelse(is.na(x_norm_diff_abs), 0, x_norm_diff_abs)) + x_norm_diff_abs*0,
             cum_y_norm_abs_diff = cumsum(ifelse(is.na(y_norm_diff_abs), 0, y_norm_diff_abs)) + y_norm_diff_abs*0)%>%
  mutate(cum_x_y_norm_abs_diff_mean_fill = ((cum_x_norm_abs_diff+cum_y_norm_abs_diff)/2))%>%
  mutate(fill_x_y_sum2 = sum(fill_x_y_sum))%>%
  # cum_x_y_norm_abs_diff_mean_fill
  # normalise the fills
  group_by(subject, lanmark_id)%>%
  mutate(cum_x_y_norm_abs_diff_mean_fill_norm = maxnormalize(cum_y_norm_abs_diff))%>%
          # ungroup()%>% 
         
        mutate(fill_x_y_sum_norm = maxnormalize(fill_x_y_sum),
               # fill_x_y_sum_norm2 = maxnormalize(fill_x_y_sum2)
               )



# df_OF_output_land_posed_binned_select_alligned_eyes2<-
# 
# df_OF_output_land_posed_binned_select_alligned_eyes%>%
#   mutate(lanmark_id = as.numeric(lanmark_id))%>%
#   group_by(filename)%>%
#   arrange(lanmark_id)%>%
# 
#  # group_by(filename, bin_frame)%>%
#  #  mutate(x_new_norm_rot2 = maxnormalize(x_new_norm_rot),
#  #         y_new_norm_rot2 = maxnormalize(y_new_norm_rot))%>%
#   # compute landmark differences
#   group_by(filename,lanmark_id)%>%
#   mutate(x_norm_diff= x_new_norm_rot - lag(x_new_norm_rot),
#          y_norm_diff= x_new_norm_rot2 - lag(y_new_norm_rot2))%>%
# # %>%
#     mutate(x_norm_diff_abs= (x_norm_diff),#decide wherher to absolute or not, i cut the abs for now
#          y_norm_diff_abs= (y_norm_diff))%>%
# 
#   # compute a sum - also consider a rolling sum
#    # mutate(x_norm_diff_abs_sum= sum(x_norm_diff_abs, na.rm = TRUE),
#    #       y_norm_diff_abs_sum= sum(y_norm_diff_abs, na.rm = TRUE))%>%
#   # do a cummulative summ
#   # subset(frame == 100)%>%
#   # ungroup()%>%
#   mutate(fill_x_y_sum = (x_norm_diff_abs+y_norm_diff_abs)/2) %>%
#   # this is what we are goint to use to colour pints
#   
#   group_by(filename,lanmark_id)%>%
#   #the line below just ignores NA (introduced in lag) which would throw error to cumsum otehrwise
#       mutate(cum_x_norm_abs_diff = cumsum(ifelse(is.na(x_norm_diff_abs), 0, x_norm_diff_abs)) + x_norm_diff_abs*0,
#              cum_y_norm_abs_diff = cumsum(ifelse(is.na(y_norm_diff_abs), 0, y_norm_diff_abs)) + y_norm_diff_abs*0)%>%
#   mutate(cum_x_y_norm_abs_diff_mean_fill = ((cum_x_norm_abs_diff+cum_y_norm_abs_diff)/2))%>%
#   mutate(fill_x_y_sum2 = sum(fill_x_y_sum))%>%
#   # cum_x_y_norm_abs_diff_mean_fill
#   # normalise the fills
#   group_by(subject, lanmark_id)%>%
#   mutate(cum_x_y_norm_abs_diff_mean_fill_norm = maxnormalize(cum_y_norm_abs_diff))%>%
#           # ungroup()%>% 
#          
#         mutate(fill_x_y_sum_norm = maxnormalize(fill_x_y_sum),
#                # fill_x_y_sum_norm2 = maxnormalize(fill_x_y_sum2)
#                )

```
  group_by(filename,lanmark_id,)%>%
  # this just ensures we have means which we can sumamrise later
  mutate(cum_x_y_norm_abs_diff_mean_fill_norm_mean = mean(cum_x_y_norm_abs_diff_mean_fill_norm, na.rm = T),
         fill_x_y_sum_norm_mean = mean(fill_x_y_sum_norm, na.rm = T))
  


# might not need to summarise below
  #   group_by(filename, expression, bin_frame, lanmark_id)%>% #posed.spoken
  # summarise_if(is.numeric, mean, na.rm = T)
  


# summarise for del and vor
```{r}


colnames(df_OF_output_land_posed_binned_select_alligned_eyes)



df_OF_output_land_posed_binned_select_alligned_eyes<- left_join(df_OF_output_land_posed_binned_select_alligned_eyes,
df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,10,34:36)])

unique(df_OF_output_land_posed_binned_select_alligned_eyes$comp1_NMFLand)
unique(df_OF_output_land_posed_binned_select_alligned_eyes$nmf_land_value_norm1)
df_OF_output_land_posed_binned_select_alligned_eyes %>%
    subset(subject == 1)%>% 
 # filter(bin_frame>40 & bin_frame<75)%>%
 filter(bin_frame>10 & bin_frame<60)%>%
  group_by(filename)%>%
  mutate(comp1_normmax = maxnormalize(comp1),
         comp2_normmax = maxnormalize(comp2),
         comp3_normmax = maxnormalize(comp3)
         
         )%>%
  
    mutate(comp1_NMFLand = maxnormalize(comp1_NMFLand),
         comp2_NMFLand = maxnormalize(comp2_NMFLand),
         comp3_NMFLand = maxnormalize(comp3_NMFLand)
         
         )%>%
  # mutate(coef_fill = (comp1_normmax+comp2_normmax+comp3_normmax)*(nmf_land_value_norm1 +
                                                                    # nmf_land_value_norm2+nmf_land_value_norm3))%>%
  
    mutate(coef_fill =  (comp1_NMFLand*comp2_NMFLand*comp3_NMFLand) +(nmf_land_value_norm1 *
                                                                    nmf_land_value_norm2*nmf_land_value_norm3))%>%
  
# explore specific subj
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)



df_OF_output_land_posed_binned_select_alligned_eyes %>%
    subset(subject == 1)%>% 
 # filter(bin_frame>40 & bin_frame<75)%>%
 filter(bin_frame>10 & bin_frame<60)%>%
  group_by(filename)%>%
  mutate(comp1_normmax = maxnormalize(comp1),
         comp2_normmax = maxnormalize(comp2),
         comp3_normmax = maxnormalize(comp3)
         
         )%>%
  
    mutate(comp1_NMFLand = maxnormalize(comp1_NMFLand),
         comp2_NMFLand = maxnormalize(comp2_NMFLand),
         comp3_NMFLand = maxnormalize(comp3_NMFLand)
         
         )%>%
  # mutate(coef_fill = (comp1_normmax+comp2_normmax+comp3_normmax)*(nmf_land_value_norm1 +
                                                                    # nmf_land_value_norm2+nmf_land_value_norm3))%>%
  
    mutate(coef_fill =  cum_x_y_norm_abs_diff_mean_fill_norm *(nmf_land_value_norm1 ))%>%
  # %>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)


 # 
 
```



simpler way to find filling coeficients

```{r}

colnames(df_OF_output_land_posed_binned_select_alligned_eyes)


df_OF_output_land_posed_binned_select_alligned_eyes<-
  df_OF_output_land_spoken_binned_select_alligned_eyes %>%
    # subset(subject == 1)%>% 
 # filter(bin_frame>40 & bin_frame<75)%>%
 # filter(bin_frame>10 & bin_frame<60)%>%
  group_by(filename)%>%
  mutate(comp1_normmax = maxnormalize(comp1),
         comp2_normmax = maxnormalize(comp2),
         comp3_normmax = maxnormalize(comp3)
         
         )%>%
  ungroup()%>%
  mutate(cum_x_y_norm_abs_diff_mean_fill_norm =
           if_else(is.na(cum_x_y_norm_abs_diff_mean_fill_norm) == TRUE, 0,
                   cum_x_y_norm_abs_diff_mean_fill_norm)) %>%
  group_by(expression, lanmark_id)%>% #consider grouping it by file too
  mutate(cor_comp1_land_cum_diff_fill = cor(cum_x_y_norm_abs_diff_mean_fill_norm,comp1_normmax,use = "complete.obs"),
    cor_comp2_land_cum_diff_fill = cor(cum_x_y_norm_abs_diff_mean_fill_norm,comp2_normmax,use = "complete.obs"), 
    cor_comp3_land_cum_diff_fill = cor(cum_x_y_norm_abs_diff_mean_fill_norm,comp3_normmax, use = "complete.obs"))



```
try del amnd vor plots

```{r}
require(ggforce)
# one colour per triangle

df_OF_output_land_posed_binned_select_alligned_eyes
df_OF_output_land_posed_binned_select_alligned_eyes_agg

df_OF_output_land_posed_binned_select_alligned_eyes%>%
  group_by(filename)%>%
   # mutate(comp1_normmax = maxnormalize(comp1),
   #       comp2_normmax = maxnormalize(comp2),
   #       comp3_normmax = maxnormalize(comp3)
   #       
   #       )%>%
  
    # mutate(comp1_NMFLand_maxnorm = maxnormalize(comp1_NMFLand),
    #      comp2_NMFLand_maxnorm = maxnormalize(comp2_NMFLand),
    #      comp3_NMFLand_maxnorm = maxnormalize(comp3_NMFLand)
         
         # )%>%
  mutate(coef_fill_AUcomp_nmf = cum_x_y_norm_abs_diff_mean_fill_norm * 
           ((cor_comp1_land_cum_diff_fill_sq_max_norm+cor_comp2_land_cum_diff_fill_sq_max_norm+cor_comp3_land_cum_diff_fill_sq_max_norm)/3))%>%
  #      mutate(coef_fill_land_comp_nmf = ((comp1_NMFLand_maxnorm+comp2_NMFLand_maxnorm+comp3_NMFLand_maxnorm)/3) * ((nmf_land_value_norm1 +
  # nmf_land_value_norm2+nmf_land_value_norm3)/3))%>%
  
  mutate(coef_fill_AUcomp_nmf_max_norm = maxnormalize(coef_fill_AUcomp_nmf))%>%
   # mutate(coef_fill_land_comp_nmf_max_norm = maxnormalize(coef_fill_land_comp_nmf))%>%
  
  
  
   filter(bin_frame>10 & bin_frame<60)%>%
 # filter(bin_frame>40 & bin_frame<75)%>%

  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)
  # ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = cum_x_y_norm_abs_diff_mean_fill_norm,
  #              colour = cum_x_y_norm_abs_diff_mean_fill_norm))+
  #  geom_voronoi_tile(aes(fill = cum_x_y_norm_abs_diff_mean_fill_norm), colour =NA)+
  #  geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
  #    scale_color_viridis_c(option = "magma")+
  # scale_fill_viridis_c(option = "magma")+
  #   facet_grid(~expression)+
  # geom_hline(yintercept = 1)

df_OF_output_land_posed_binned_select_alligned_eyes_agg

df_OF_output_land_posed_binned_select_alligned_eyes_agg

library(deldir)
tri <- triang.list(deldir(df_OF_output_land_posed_binned_select_alligned_eyes_agg$x_new_norm_rot2, 
                          df_OF_output_land_posed_binned_select_alligned_eyes_agg$y_new_norm_rot2))

delaunay_tri_all<- do.call(rbind, lapply(seq_along(tri), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri[[x]]$x, y_new_norm_rot2 = tri[[x]]$y, 
             coef_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg$cum_x_y_norm_abs_diff_mean_fill_norm[tri[[x]]$ptNum]),
             tri = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = coef_fill, group = tri)) +

  geom_point(aes(colour = coef_fill))+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")

delaunay_tri_all

View(delaunay_tri_all)




```

# do the fill gradient

```{r}
# fill gradients
# Additional

# To gradient fill your triangles, probably best to draw blank triangles over a 2D interpolation:
# install.packages("interp")
library(interp)
library(ggforce)

?interp

nms<-c('x_new_norm_rot2', 'y_new_norm_rot2', 'coef_fill')
colnames(df_OF_output_land_posed_binned_select_alligned_eyes_agg)
test_gradient<-df_OF_output_land_posed_binned_select_alligned_eyes_agg[,c(22,23,18)]

colnames(test_gradient)

test_gradient$coef_fill<- test_gradient$cum_x_y_norm_abs_diff_mean_fill_norm
test_gradient$cum_x_y_norm_abs_diff_mean_fill_norm<-NULL

interp(test_gradient$x_new_norm_rot2,
       test_gradient$y_new_norm_rot2, 
       test_gradient$coef_fill, 
              duplicate = "mean", nx = 1000, ny = 1000) |>
  interp2xyz() |>
  as.data.frame() |>
  setNames(names(test_gradient)[1:3]) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_raster(aes(fill = coef_fill)) +
  scale_fill_continuous(na.value = NA) +
  # geom_delaunay_tile(data = test_gradient, fill = NA, color = "#00000050")+
    # geom_delaunay_segment2(aes(colour = coef_fill), size = 2)+
   geom_delaunay_segment2(data = test_gradient, aes(colour = coef_fill))+
    # geom_point(aes(colour = coef_fill))+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")




```

separate emmotions

```{r}

df_OF_output_land_posed_binned_select_alligned_eyes_agg$expression

anger_del<-subset(df_OF_output_land_posed_binned_select_alligned_eyes_agg,
                expression == "angry")

happy_del<-subset(df_OF_output_land_posed_binned_select_alligned_eyes_agg,
                expression == "happy")


sad_del<-subset(df_OF_output_land_posed_binned_select_alligned_eyes_agg,
                expression == "sad")


anger_del

tri_ang <- triang.list(deldir(anger_del$x_new_norm_rot2, 
                          anger_del$y_new_norm_rot2))


triangle_plots$delaunay_tri_ang


do.call(rbind, lapply(seq_along(tri_ang), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_ang[[x]]$x, y_new_norm_rot2 = tri_ang[[x]]$y, 
             coef_fill = mean(anger_del$cum_x_y_norm_abs_diff_mean_fill_norm[tri_ang[[x]]$ptNum]),
             tri_ang = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_ang)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")
  
# theme(plot.background = element_rect(fill = "black"),
#                                        legend.position = "none")


do.call(rbind, lapply(seq_along(tri_ang), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_ang[[x]]$x, y_new_norm_rot2 = tri_ang[[x]]$y, 
             coef_fill = mean(anger_del$cum_x_y_norm_abs_diff_mean_fill_norm[tri_ang[[x]]$ptNum]),
             tri_ang = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_ang)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
    scale_y_reverse()+
  theme_void()+
    theme(
                                       legend.position = "none")
  
  
```


make legend bar size of plot
```{r}
library(ggplot2)
library(reshape2)
dat <- iris[,1:4]
cor <- melt(cor(dat, use="p"))
head(cor)
heat <- ggplot(data=cor, aes(x=Var1, y=Var2, fill=value)) 
heat + geom_tile() + labs(x = "", y = "") + scale_fill_gradient2(limits=c(-1, 1))+
  make_fullsize

library(ggplot2)

make_fullsize <- function() structure("", class = "fullsizebar")

ggplot_add.fullsizebar <- function(obj, g, name = "fullsizebar") {
  h <- ggplotGrob(g)$heights
  panel <- which(grid::unitType(h) == "null")
  panel_height <- unit(1, "npc") - sum(h[-panel])
  
  g + 
    guides(fill = guide_colorbar(barheight = panel_height,
                                 title.position = "right")) +
    theme(legend.title = element_text(angle = -90, hjust = 0.5))
}
ggplot2::ggplot(data=cor, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() + 
  labs(x = "", y = "") + 
  scale_fill_gradient2(limits=c(-1, 1)) +
  coord_cartesian(expand = FALSE) +
  make_fullsize()
```
  
# theme(plot.background = element_rect(fill = "black"),
#                                        legend.position = "none")

triangle_plots$delaunay_tri_ang


triangle_plots$delaunay_tri_ang

# 2
# df_OF_output_land_posed_binned_select_alligned_eyes$comp1_NMFLand - bu matrix
# df_OF_output_land_posed_binned_select_alligned_eyes$nmf_land_value_norm1 - small matrux
# anger_del$comp1_NMFLand

anger_del$comp1_NMFLand
anger_del
coef_fill_AUcomp_nmf
coef_fill_land_comp_nmf
  
     

triangle_plots$delaunay_tri_ang
# coef_fill_land_comp_nmf_max_norm seems off and the AU seems flipped
do.call(rbind, lapply(seq_along(tri_ang), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_ang[[x]]$x, y_new_norm_rot2 = tri_ang[[x]]$y, 
             coef_fill = mean(anger_del$coef_fill_AUcomp_nmf_max_norm[tri_ang[[x]]$ptNum]),
             tri_ang = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = 1-coef_fill, group = tri_ang)) +

  geom_point(colour = "white", alpha = .5)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"))

# the AU seems more accurate

```
# fillgradiuent
colnames(anger_del)

triangle_plots<-list()

triangle_plots$delaunay_tri_ang_grad<-
interp(anger_del$x_new_norm_rot2,
       anger_del$y_new_norm_rot2, 
       anger_del$cum_x_y_norm_abs_diff_mean_fill_norm, 
              duplicate = "mean", nx = 1000, ny = 1000) |>
  interp2xyz() |>
  as.data.frame() |>
  setNames(names(anger_del[,c(22,23,18)])) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_raster(aes(fill = cum_x_y_norm_abs_diff_mean_fill_norm)) +
  # scale_fill_continuous(na.value = NA) +
  geom_delaunay_tile(data = anger_del[,c(22,23,18)], fill = NA, color = "#00000050")+
    # geom_delaunay_segment2(aes(colour = coef_fill), size = 2)+
   # geom_delaunay_segment2(data = anger_del, aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm))+
    # geom_delaunay_segment2()+
    geom_point(aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm))+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
theme(
  # legend.position = "top",
      legend.title = element_blank())

triangle_plots$delaunay_tri_ang

triangle_plots$delaunay_tri_ang_grad



happy sad
```{r}
unique(happy_del$expression)
library(deldir)
tri_happy <- triang.list(deldir(happy_del$x_new_norm_rot2, 
                          happy_del$y_new_norm_rot2))


triangle_plots$delaunay_tri_happy<- do.call(rbind, lapply(seq_along(tri_happy), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_happy[[x]]$x, y_new_norm_rot2 = tri_happy[[x]]$y, 
             coef_fill = mean(happy_del$cum_x_y_norm_abs_diff_mean_fill_norm[tri_happy[[x]]$ptNum]),
             tri_happy = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill =coef_fill, group = tri_happy)) +

  geom_point(aes(colour = comp3_fill),colour = "white", alpha = .2, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
    theme_void()+
    theme(
                                       legend.position = "none")
  theme(plot.background = element_rect(fill = "black"),
        legend.position = "none")

triangle_plots$delaunay_tri_happy

# AU NMF
# triang.list(deldir(happy_del$x_new_norm_rot2, 
#                           happy_del$y_new_norm_rot2))


do.call(rbind, lapply(seq_along(tri_happy), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_happy[[x]]$x, y_new_norm_rot2 = tri_happy[[x]]$y, 
             coef_fill = mean(happy_del$coef_fill_AUcomp_nmf_max_norm[tri_happy[[x]]$ptNum]),
             tri_happy = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill =coef_fill, group = tri_happy)) +

  geom_point(aes(colour = comp3_fill),colour = "white", alpha = .5)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"))
# happy not accurate




```
# fillgradiuent
colnames(anger_del)

triangle_plots<-list()

triangle_plots$delaunay_tri_happy_grad<-
interp(happy_del$x_new_norm_rot2,
       happy_del$y_new_norm_rot2, 
       happy_del$cum_x_y_norm_abs_diff_mean_fill_norm, 
              duplicate = "mean", nx = 1000, ny = 1000) |>
  interp2xyz() |>
  as.data.frame() |>
  setNames(names(happy_del[,c(22,23,18)])) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_raster(aes(fill = cum_x_y_norm_abs_diff_mean_fill_norm)) +
  # scale_fill_continuous(na.value = NA) +
  geom_delaunay_tile(data = happy_del, fill = NA, color = "#00000050")+
    # geom_delaunay_segment2(aes(colour = coef_fill), size = 2)+
   # geom_delaunay_segment2(data = happy_del, aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm))+
    # geom_delaunay_segment2()+
    # geom_point(aes(colour = coef_fill))+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
theme(legend.position = "top")



triangle_plots$delaunay_tri_happy
triangle_plots$delaunay_tri_happy_grad


sad

```{r}
tri_sad <- triang.list(deldir(sad_del$x_new_norm_rot2, 
                          sad_del$y_new_norm_rot2))


triangle_plots$delaunay_tri_sad<- do.call(rbind, lapply(seq_along(tri_sad), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_sad[[x]]$x, y_new_norm_rot2 = tri_sad[[x]]$y, 
             coef_fill = mean(sad_del$cum_x_y_norm_abs_diff_mean_fill_norm[tri_sad[[x]]$ptNum]),
             tri_sad = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_sad)) +

  geom_point(aes(colour = comp3_fill),colour = "white", alpha = .2, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
    theme_void()+
    theme(
                                       legend.position = "none")
  theme(plot.background = element_rect(fill = "black"),
        legend.position = "none")

triangle_plots$delaunay_tri_sad

# AU NMF
 do.call(rbind, lapply(seq_along(tri_sad), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_sad[[x]]$x, y_new_norm_rot2 = tri_sad[[x]]$y, 
             coef_fill = mean(sad_del$coef_fill_AUcomp_nmf_max_norm[tri_sad[[x]]$ptNum]),
             tri_sad = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_sad)) +

  geom_point(aes(colour = comp3_fill),colour = "white", alpha = .5)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"))

```
# fillgradiuent

triangle_plots$delaunay_tri_sad_grad<-
interp(sad_del$x_new_norm_rot2,
       sad_del$y_new_norm_rot2, 
       sad_del$cum_x_y_norm_abs_diff_mean_fill_norm, 
              duplicate = "mean", nx = 1000, ny = 1000) |>
  interp2xyz() |>
  as.data.frame() |>
  setNames(names(sad_del[,c(22,23,18)])) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_raster(aes(fill = cum_x_y_norm_abs_diff_mean_fill_norm)) +
  # scale_fill_continuous(na.value = NA) +
  geom_delaunay_tile(data = sad_del[,c(22,23,18)], fill = NA, color = "#00000050")+
    # geom_delaunay_segment2(aes(colour = coef_fill), size = 2)+
   # geom_delaunay_segment2(data = sad_del, aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm))+
    # geom_delaunay_segment2()+
    # geom_point(aes(colour = coef_fill))+
  geom_point(aes(colour = comp3_fill),colour = "white", alpha = .5)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"))


triangle_plots$delaunay_tri_sad
triangle_plots$delaunay_tri_sad_grad


correlate landmarks with NMF components?

above not quite there yet

let's see correlations

```{r}

nrow(df_OF_output_land_posed_binned_select_alligned_eyes)
nrow(df_OF_output_land_posed_binned_select)
# correlation between land mark and AUS

df_OF_output_land_posed_binned_select_alligned_eyes
colnames(df_OF_output_land_posed_binned_select_alligned_eyes)

# dcast for merging with NMF results
df_OF_output_land_posed_binned_select
df_OF_output_land_posed_binned_select_alligned_eyes$x
df_OF_output_land_posed_binned_select_dcast

require(data.table)
# use rot after
colnames(df_OF_output_land_posed_binned_select_alligned_eyes)

df_OF_output_land_posed_binned_select_dcast <- setDT(df_OF_output_land_posed_binned_select_alligned_eyes[c(1:4,9,25:26)])%>%
  # mutate(x_norm_diff = if_else(bin_frame == 1, 0, x_norm_diff),
  #        y_norm_diff = if_else(bin_frame == 1, 0, y_norm_diff))%>%

  setDT()%>%
  dcast(filename+bin_frame+expression+subject~lanmark_id, value.var = c("x_new_norm_rot2","y_new_norm_rot2"))

colnames(df_OF_output_land_posed_binned_select_alligned_eyes)

df_OF_output_land_posed_binned_select_dcast$bin_frame
nrow(df_OF_output_AUsW_unblind_posed_binned)
nrow(df_OF_output_land_posed_binned_select_dcast)
  # both should be 22800
colnames(df_OF_output_land_posed_binned_select_dcast)
# merge with landmars

# df_OF_output_land_posed_binned_select_dcast
colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned

df_OF_output_land_posed_binned_select_dcast <- left_join(df_OF_output_land_posed_binned_select_dcast,df_OF_output_AUsW_unblind_posed_binned[,c(1,2,34:36)])

df_OF_output_land_posed_binned_select_dcast<- df_OF_output_land_posed_binned_select_dcast%>%
  group_by(filename)%>%
  mutate(comp1_max_norm = maxnormalize(comp1),
         comp2_max_norm = maxnormalize(comp2),
         comp3_max_norm = maxnormalize(comp3))

# df_OF_output_land_posed_binned_select_dcast%>%


df_OF_output_land_posed_binned_select_dcast


# df_AU_land_bin<- left_join(df_OF_output_AUsW_unblind_posed_binned1,df_OF_output_land_posed_binned_select_dcast,
#           by = c("filename", "expression", "bin_frame"))


# Select the two groups of variables
colnames(df_OF_output_land_posed_binned_select_dcast)
vars_x <- select(df_OF_output_land_posed_binned_select_dcast, 144:146)

# we can just take y to start
vars_y <- select(df_OF_output_land_posed_binned_select_dcast, 73:140)

# Compute the correl
cor_matrix<- cor(vars_x[,2:4], vars_y[,2:69], use="pairwise.complete.obs")


# Visualize the correlations
library(corrplot)

corrplot(cor_matrix)
cor_matrix

above_thresh<- as.data.frame(abs(cor_matrix))%>%
  summarise_if(is.numeric, max, na.rm = T)%>%
  gather(key, values)
  # subset(values>.3)



cor_matrix_tresh_repl_gath<- cor_matrix_tresh%>%
  mutate(comp = rownames(cor_matrix_tresh_repl))%>%
  gather(land_y, value,-comp)
  


cor_matrix_tresh_repl_gath%>%
  ggplot(aes(value))+
  geom_histogram()


cor_matrix_tresh_repl_gath_dcast<- cor_matrix_tresh_repl_gath%>%
  mutate(comp = paste0("abs_cor",comp))%>%
  setDT()%>%
  dcast(land_y~comp, value.var = "value")

cor_matrix_tresh_repl_gath_dcast<-cor_matrix_tresh_repl_gath_dcast%>%
  mutate(lanmark_id = substr(land_y,13,14))
cor_matrix_tresh_repl_gath_dcast
```

# combine with original data

```{r}
df_OF_output_land_posed_binned_select_alligned_eyes
df_OF_output_land_posed_binned_select_alligned_eyes

cor_matrix_tresh_repl_gath_dcast$lanmark_id<- as.numeric(cor_matrix_tresh_repl_gath_dcast$lanmark_id)
df_OF_output_land_posed_binned_select_alligned_eyes$lanmark_id

# nrow(df_OF_output_land_posed_binned_select_alligned_eyes)==nrow(
# left_join(df_OF_output_land_posed_binned_select_alligned_eyes,cor_matrix_tresh_repl_gath_dcast))#true

df_OF_output_land_posed_binned_select_alligned_eyes%>%
select(-c(names(cor_matrix_tresh_repl_gath_dcast[,1:4])))

df_OF_output_land_posed_binned_select_alligned_eyes<- left_join(df_OF_output_land_posed_binned_select_alligned_eyes%>%
select(-c(names(cor_matrix_tresh_repl_gath_dcast[,1:4]))),cor_matrix_tresh_repl_gath_dcast)


colnames(df_OF_output_land_posed_binned_select_alligned_eyes)
# df_OF_output_land_posed_binned_select_alligned_eyes


df_OF_output_land_posed_binned_select_alligned_eyes<- df_OF_output_land_posed_binned_select_alligned_eyes%>%
  # thresholded
  mutate(abs_corcomp1_max_norm_trsh = if_else(abs_corcomp1_max_norm< .02,0,abs_corcomp1_max_norm),
         abs_corcomp2_max_norm_trsh = if_else(abs_corcomp2_max_norm< .02,0,abs_corcomp2_max_norm),
         abs_corcomp3_max_norm_trsh = if_else(abs_corcomp3_max_norm< .02,0,abs_corcomp3_max_norm))

# comp3
df_OF_output_land_posed_binned_select_alligned_eyes%>%
 # filter(bin_frame>40 & bin_frame<75)%>%
  # subset(subject == 1)%>% # explore specific subj
  group_by( lanmark_id)%>% #posed.spoken
  # mutate()
  summarise_if(is.numeric, mean, na.rm = T)%>%
    ungroup()%>%
  
  mutate(coef_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp3_max_norm_trsh)%>%
  mutate(coef_fill = maxnormalize(coef_fill))%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill =coef_fill ,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    # facet_grid(~expression)+
  geom_hline(yintercept = 1)+
  theme(legend.title= element_blank())+
  ggtitle("comp3")

```
# comp2
# df_OF_output_land_posed_binned_select_alligned_eyes%>%
#  filter(bin_frame>40 & bin_frame<75)%>%
#   subset(subject == 1)%>% # explore specific subj
#   group_by( lanmark_id)%>% #posed.spoken
#   # mutate()
#   summarise_if(is.numeric, mean, na.rm = T)%>%
# 
#     group_by( lanmark_id)%>%
#   
#   mutate(coef_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp2_max_norm)%>%
#   mutate(coef_fill = maxnormalize(coef_fill))%>%
#   ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill =coef_fill ,
#                colour = coef_fill))+
#    geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
#    geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
#      scale_color_viridis_c(option = "magma")+
#   scale_fill_viridis_c(option = "magma")+
#     # facet_grid(~expression)+
#   geom_hline(yintercept = 1)+
#   theme(legend.title= element_blank())

```{r}

df_OF_output_land_posed_binned_select_alligned_eyes_agg
df_OF_output_land_posed_binned_select_alligned_eyes%>%
 filter(bin_frame>40 & bin_frame<75)%>%
  # subset(subject == 1)%>% # explore specific subj
  group_by( lanmark_id)%>% #posed.spoken
  # mutate()
  summarise_if(is.numeric, mean, na.rm = T)%>%
    ungroup()%>%
  
  mutate(coef_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp2_max_norm)%>%
  mutate(coef_fill = maxnormalize(coef_fill))%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill =coef_fill ,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    # facet_grid(~expression)+
  geom_hline(yintercept = 1)+
  theme(legend.title= element_blank())+
    ggtitle("comp2")

```


# comp1
```{r}
df_OF_output_land_posed_binned_select_alligned_eyes%>%
 filter(bin_frame>40 & bin_frame<75)%>%
  # subset(subject == 1)%>% # explore specific subj
  group_by( lanmark_id)%>% #posed.spoken
  # mutate()
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ungroup()%>%
  
  mutate(coef_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp1_max_norm)%>%
  mutate(coef_fill = maxnormalize(coef_fill))%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill =coef_fill ,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    # facet_grid(~expression)+
  geom_hline(yintercept = 1)+
  theme(legend.title= element_blank())+
    ggtitle("comp1")


```


delaunay with the new data



```{r}

# one colour per triangle

df_OF_output_land_posed_binned_select_alligned_eyes %>%
  group_by(filename)%>%
   mutate(comp1_normmax = maxnormalize(comp1),
         comp2_normmax = maxnormalize(comp2),
         comp3_normmax = maxnormalize(comp3)
         
         )%>%
  
    mutate(comp1_NMFLand_maxnorm = maxnormalize(comp1_NMFLand),
         comp2_NMFLand_maxnorm = maxnormalize(comp2_NMFLand),
         comp3_NMFLand_maxnorm = maxnormalize(comp3_NMFLand)
         
         )%>%
  mutate(coef_fill_AUcomp_nmf = ((comp1_normmax+comp2_normmax+comp3_normmax)/3) * ((abs_corcomp1_max_norm +
  abs_corcomp2_max_norm+abs_corcomp3_max_norm)/3))%>%
       mutate(coef_fill_land_comp_nmf = ((comp1_NMFLand_maxnorm+comp2_NMFLand_maxnorm+comp3_NMFLand_maxnorm)/3) * ((nmf_land_value_norm1 +
  nmf_land_value_norm2+nmf_land_value_norm3)/3))


df_OF_output_land_posed_binned_select_alligned_eyes_agg2<- df_OF_output_land_posed_binned_select_alligned_eyes%>%
   # filter(bin_frame>10 & bin_frame<60)%>%
 # filter(bin_frame>40 & bin_frame<75)%>%
  # subset(subject == 10)%>% # explore specific subj
    # group_by(filename)%>%
   mutate(comp1_normmax = maxnormalize(comp1),
         comp2_normmax = maxnormalize(comp2),
         comp3_normmax = maxnormalize(comp3)
         
         )%>%
  
    
    mutate(comp1_NMFLand_maxnorm = maxnormalize(comp1_NMFLand),
         comp2_NMFLand_maxnorm = maxnormalize(comp2_NMFLand),
         comp3_NMFLand_maxnorm = maxnormalize(comp3_NMFLand)
         
         )%>%
  
  
  group_by(lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ungroup()%>%
  
  mutate(comp1_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp1_max_norm,
         comp2_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp2_max_norm,
         comp3_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp3_max_norm)%>%
  mutate(comp1_fill = maxnormalize(comp1_fill),
         comp2_fill = maxnormalize(comp2_fill),
         comp3_fill = maxnormalize(comp3_fill))%>%
  # AU fill
    mutate(comp1_fill_AU = comp1_normmax*abs_corcomp1_max_norm,
         comp2_fill_AU = comp2_normmax*abs_corcomp2_max_norm,
         comp3_fill_AU = comp3_normmax*abs_corcomp3_max_norm)%>%
  mutate(comp1_fill_AU = maxnormalize(comp1_fill_AU),
         comp2_fill_AU = maxnormalize(comp2_fill_AU),
         comp3_fill_AU = maxnormalize(comp3_fill_AU))%>%
  
    # LANDmarkNMF fill
    mutate(comp1_fill_land = comp1_NMFLand_maxnorm*nmf_land_value_norm1,
         comp2_fill_land = comp2_NMFLand_maxnorm*nmf_land_value_norm2,
         comp3_fill_land = comp3_NMFLand_maxnorm*nmf_land_value_norm3)%>%
  mutate(comp1_fill_land = maxnormalize(comp1_fill_land),
         comp2_fill_land = maxnormalize(comp2_fill_land),
         comp3_fill_land = maxnormalize(comp3_fill_land))





df_OF_output_land_posed_binned_select_alligned_eyes_agg2

library(deldir)

# comp 1


tri_comp1 <- triang.list(deldir(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$x_new_norm_rot2, 
                          df_OF_output_land_posed_binned_select_alligned_eyes_agg2$y_new_norm_rot2))

triangle_plots$delaunay_tri_comp1<-

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp1_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp1_fill[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp1_fill, group = tri_comp1)) +

  geom_point(aes(colour = comp3_fill),colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  # plot.background = element_rect(fill = "black"), 
  theme(legend.position = "none")
 # geom_point(aes(colour = comp3_fill),colour = "white", alpha = .1, size = .1)+

triangle_plots$delaunay_tri_comp1

# AU fill nmf

triangle_plots$delaunay_tri_comp1

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp1_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp1_fill_AU[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp1_fill, group = tri_comp1)) +

  geom_point(aes(colour = comp3_fill),colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"), legend.position = "none")

# au is very similar
# triangle_plots$delaunay_tri_comp1

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp1_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$abs_corcomp1_max_norm_trsh [tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp1_fill, group = tri_comp1)) +

  geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"), legend.position = "none")
# for landm I need to reverse it to be consisiustent and is brighter

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp1_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp1_fill[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp1_fill, group = tri_comp1)) +

  geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"), legend.position = "none")

```

# do the fill gradient

```{r}
# fill gradients
# Additional

# To gradient fill your triangles, probably best to draw blank triangles over a 2D interpolation:
# install.packages("interp")
library(interp)
library(ggforce)


colnames(df_OF_output_land_posed_binned_select_alligned_eyes_agg2)

gradient_df<-list()

gradient_df$comp1 <-df_OF_output_land_posed_binned_select_alligned_eyes_agg2[,c(21,22,29)]

colnames(gradient_df$comp1)

# test_gradient$coef_fill<- test_gradient$cum_x_y_norm_abs_diff_mean_fill_norm
# test_gradient$cum_x_y_norm_abs_diff_mean_fill_norm<-NULL

triangle_plots$delaunay_tri_comp1_grad<- interp(gradient_df$comp1$x_new_norm_rot2,
       gradient_df$comp1$y_new_norm_rot2, 
       gradient_df$comp1$comp1_fill, 
              duplicate = "mean", nx = 1000, ny = 1000) |>
  interp2xyz() |>
  as.data.frame() |>
  setNames(names(gradient_df$comp1)[1:3]) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_raster(aes(fill = comp1_fill),alpha = .7) +
  scale_fill_continuous(na.value = NA) +
   # geom_delaunay_tile(data = gradient_df$comp1,aes(colour = comp1_fill, fill = comp1_fill), alpha = .5)+
   geom_delaunay_segment2(data = gradient_df$comp1,aes(colour = comp1_fill, fill = comp1_fill),alpha = .8)+
  geom_point(data = gradient_df$comp1,aes(colour = comp1_fill, fill = comp1_fill), alpha = .8,size = .9)+
  # geom_delaunay_tile(data = gradient_df$comp1, fill = NA, color = "#00000050")+
  
    # geom_delaunay_segment(aes(colour = comp1_fill), size = 2)+
   # geom_delaunay_segment2(data = gradient_df$comp1, aes(colour = comp1_fill))+

    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()

triangle_plots$delaunay_tri_comp1_grad
```

comp2
```{r}
# one colour per triangle


df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp2_fill

library(deldir)

# comp 1



tri_comp1 <- triang.list(deldir(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$x_new_norm_rot2, 
                          df_OF_output_land_posed_binned_select_alligned_eyes_agg2$y_new_norm_rot2))

triangle_plots$delaunay_tri_comp2 <-

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp2_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp2_fill[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp2_fill, group = tri_comp1)) +

geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  # theme(plot.background = element_rect(fill = "black"))
  theme( legend.position = "none")
 # geom_point(aes(colour = comp3_fill),colour = "white", alpha = .1, size = .1)+

triangle_plots$delaunay_tri_comp2

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp2_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$abs_corcomp2_max_norm_trsh[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp2_fill, group = tri_comp1)) +

geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  # theme(plot.background = element_rect(fill = "black"))
  theme( legend.position = "none")
 # geom_point(aes(colour = comp3_fill),colour = "white", alpha = .1, size = .1)+

triangle_plots$delaunay_tri_comp2


```



# ANMF3_k3_res

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp2_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp2_fill_AU[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp2_fill, group = tri_comp1)) +

geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  # theme(plot.background = element_rect(fill = "black"))
  theme(plot.background = element_rect(fill = "black"), legend.position = "none")
 # geom_point(aes(colour = comp3_fill),colour = "white", alpha = .1, size = .1)+
# very similar





# LAND NMF

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp2_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp2_fill_land[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = 1-comp2_fill, group = tri_comp1)) +

geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  # theme(plot.background = element_rect(fill = "black"))
  theme(plot.background = element_rect(fill = "black"), legend.position = "none")

# not cosistent



comp 3

```{r}
# one colour per triangle

df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp3_fill

library(deldir)

# comp 1

tri_comp1 <- triang.list(deldir(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$x_new_norm_rot2, 
                          df_OF_output_land_posed_binned_select_alligned_eyes_agg2$y_new_norm_rot2))

triangle_plots$delaunay_tri_comp3 <-

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp3_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp3_fill[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp3_fill, group = tri_comp1)) +

 geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  # plot.background = element_rect(fill = "black"),
  theme(
        legend.position = "none")

triangle_plots$delaunay_tri_comp3+  theme_dark()+
  theme_void()+
  # plot.background = element_rect(fill = "black"),
  theme(
        legend.position = "none")

do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp3_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$abs_corcomp3_max_norm_trsh[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp3_fill, group = tri_comp1)) +

 geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  # plot.background = element_rect(fill = "black"),
  theme(
        legend.position = "none")



```
# AU fill
do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp3_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp3_fill_AU[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = comp3_fill, group = tri_comp1)) +

 geom_point(colour = "white", alpha = .1, size = .5)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"),
        legend.position = "none")

# very similar

# NMF land
do.call(rbind, lapply(seq_along(tri_comp1), 
                      function(x) {
data.frame(x_new_norm_rot2 = tri_comp1[[x]]$x, y_new_norm_rot2 = tri_comp1[[x]]$y, 
             comp3_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg2$comp3_fill_land[tri_comp1[[x]]$ptNum]),
             tri_comp1 = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = 1-comp3_fill, group = tri_comp1)) +

 geom_point(colour = "white", alpha = .1, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_dark()+
  theme_void()+
  theme(plot.background = element_rect(fill = "black"),
        legend.position = "none")


```{r}
# triangle_plots$delaunay_tri_comp3
# triangle_plots$delaunay_tri_comp3+theme_void()+theme(legend.position = "none")
# triangle_plots$delaunay_tri_comp2+theme_void()+theme(legend.position = "none")
# 
# triangle_plots$delaunay_tri_comp1+theme_void()+theme(legend.position = "none")
# triangle_plots$delaunay_tri_comp3
# 
# 
# triangle_plots$delaunay_tri_comp3+theme(legend.position = "none")
# triangle_plots$delaunay_tri_comp2+theme(legend.position = "none")
# 
# triangle_plots$delaunay_tri_comp1+theme(legend.position = "none")

triangle_plots$delaunay_tri_comp1<-triangle_plots$delaunay_tri_comp1+  theme(plot.background = element_rect(fill = "black"))
triangle_plots$delaunay_tri_comp2<-triangle_plots$delaunay_tri_comp2+  theme(plot.background = element_rect(fill = "black"))

triangle_plots$delaunay_tri_comp3<- triangle_plots$delaunay_tri_comp3+ theme(plot.background = element_rect(fill = "black"))

ggsave("comp1n.png", device = "png", triangle_plots$delaunay_tri_comp1,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)

ggsave("comp2n.png", device = "png", triangle_plots$delaunay_tri_comp2,
         width = 700,
       height = 700,
                     units = 'px',
       dpi = 500)
ggsave("comp3n.png", device = "png", triangle_plots$delaunay_tri_comp3,
           width = 700,
       height = 700,
                     units = 'px',
       dpi = 500)


triangle_plots$delaunay_tri_ang

ggsave("ang.png", device = "png", triangle_plots$delaunay_tri_ang,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)

ggsave("hap.png", device = "png", triangle_plots$delaunay_tri_happy,
         width = 700,
       height = 700,
                     units = 'px',
       dpi = 500)
ggsave("sad.png", device = "png", triangle_plots$delaunay_tri_sad,
           width = 700,
       height = 700,
                     units = 'px',
       dpi = 500)

```
conclusion = use raw displacement? or au

```{r}
require(patchwork)

panel_comps<- (((triangle_plots$ delaunay_tri_comp1+
 triangle_plots$  delaunay_tri_comp2+
 triangle_plots$  delaunay_tri_comp3)+
  plot_layout(guides = "collect"))/
((triangle_plots$delaunay_tri_ang+
  triangle_plots$delaunay_tri_happy+
  triangle_plots$delaunay_tri_sad)+
    plot_layout(guides = "collect")))+
    # theme_dark()+
  # theme_void()+
  theme(plot.background = element_rect(fill = "black"))


panel_comps+
  theme(plot.background = element_rect(fill = "black"))

```
# combine with the plots


# need t do each expression separatelly I think


tri <- triang.list(deldir(df_OF_output_land_posed_binned_select_alligned_eyes_agg$x_new_norm_rot2, 
                          df_OF_output_land_posed_binned_select_alligned_eyes_agg$y_new_norm_rot2))

delaunay_tri_all<- do.call(rbind, lapply(seq_along(tri), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri[[x]]$x, y_new_norm_rot2 = tri[[x]]$y, 
             coef_fill = mean(df_OF_output_land_posed_binned_select_alligned_eyes_agg$cum_x_y_norm_abs_diff_mean_fill_norm[tri[[x]]$ptNum]),
             tri = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = coef_fill, group = tri)) +

  geom_point(aes(colour = coef_fill))+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")

delaunay_tri_all

View(delaunay_tri_all)



```{r}

unique(test_happy_dcast$filename)
nrow(test_happy_dcast_binned)

nrow(test_happy_dcast)

# redo NMF with
df_OF_output_land_posed_binned_select_alligned_eyes
```


# 
test_happy_dcast_binned$expression
test_happy_dcast$posed.spoken<- sapply(strsplit(test_happy_dcast$filename, "_"), function(x) x[2])
test_happy_dcast$expression <-sapply(strsplit(test_happy_dcast$filename, "_"), function(x) x[3])

# sumamrise_bin
colnames(test_happy_dcast_binned)
test_happy_dcast_binned1<- test_happy_dcast_binned%>%
  group_by(filename, expression, bin_frame, posed.spoken, lanmark_id)%>%
  summarise_if(is.numeric, mean, na.rm = T)
  

test_happy_dcast_summ<- test_happy_dcast%>%
    subset(posed.spoken == "posed")%>%
  subset(frame > 100 & frame <200)%>%
      group_by(filename,lanmark_id,expression)%>%

         summarise_if(is.numeric, mean,na.rm = T)

bound_plot<- cbind(test_happy_dcast_summ$x_new_norm,test_happy_dcast_summ$y_new_norm)
bound_plot


paneled
unique(test_happy_dcast$frame)


# 
# library(deldir)
#   frame_1<- subset(test_happy_dcast, test_happy_dcast$frame == 1)
# dxy <- deldir(frame_1$x_new_norm, frame_1$y_new_norm)

maxnormalize <- function(x, ...) {
    return((x - min(x, ...)) /(max(x, ...) - min(x, ...))) }

df_OF_output_land_f10_dcast_norm<- df_OF_output_land_f10_dcast%>%
    group_by(filename,frame)%>%
  mutate(x_new_norm = maxnormalize(x),
         y_new_norm = maxnormalize(y))

?cowplot::get_panel
get_panel1<-cowplot::get_panel(paneled)

# try and estimate y and x separately

library(data.table)
colnames(lan_AU_comp_paired)

lan_AU_comp_paired_dcast<-setDT(lan_AU_comp_paired)%>%
dcast(lanmark_id~comp, value.var = c('value', 'coef'), mean)


test_happy_dcast_summ_paired_test<-left_join(
test_happy_dcast_summ,lan_AU_comp_paired_dcast)
unique(df_OF_output_land_posed_binned_select$filename)

df_OF_output_land_posed_binned_select$subject<- sub(".*_p", "", str_match(df_OF_output_land_posed_binned_select$filename, "p\\s*(.*?)\\s*.csv")[,2])

df_OF_output_land_posed_binned_select$subject

df_OF_output_land_posed_binned_select%>%
    filter(bin_frame>40 & bin_frame<75)%>%
  subset(subject == 20)%>%
 group_by(lanmark_id,expression)%>%
         summarise_if(is.numeric, mean,na.rm = T)%>%
  ggplot(aes(x = x_new_norm, y = 1-y_new_norm))+
  geom_point()+
    facet_grid(~expression)

unique(df_OF_output_land_posed_binned)

test_happy_dcast_summ_paired_test%>%
   group_by(lanmark_id,expression)%>%
         summarise_if(is.numeric, mean,na.rm = T)%>%
  # subset()
    ggplot(aes(x = x_new_norm, y = 1-y_new_norm, fill = cum_x_y_norm_abs_diff_mean_fill_norm*coef_3*value_3,
               colour = cum_x_y_norm_abs_diff_mean_fill_norm*coef_3*value_3))+

     geom_point(aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm), colour = "white")+
    
   geom_voronoi_tile(aes(fill = cum_x_y_norm_abs_diff_mean_fill_norm*coef_3*value_3), colour =NA)+
  # geom_delaunay_segment2( colour = "white",alpha = .2)+
   geom_point(aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm), colour = "white",size = .5,alpha = .5)+

     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)
  
    test_happy_dcast
  


stack question
```{r}
iris


ggplot(iris, aes(Sepal.Length, Sepal.Width)) +
  geom_voronoi_tile(aes(fill = Petal.Length))
# Delaunay triangles
ggplot(iris, aes(Sepal.Length, Sepal.Width,fill = Petal.Length)) +
  geom_delaunay_tile()

# colouring lines
ggplot(iris, aes(Sepal.Length, Sepal.Width,colour = Petal.Length)) +
  geom_delaunay_segment2()


# deldir - let's examine the ouput of a delaunay trianglation
library(deldir)
?deldir
deldir_output<-deldir(iris$Sepal.Length, iris$Sepal.Width, plot=TRUE)
deldir_output


```




```{r}

test_happy_dcast
df_OF_output_land_posed_binned_select
lan_AU_comp_paired_W


colnames(lan_AU_comp_paired_W)
colnames(test_happy_dcast)
unique(lan_AU_comp_paired_W2$bin_frame)
# 79,070,400 
# test_happy_dcast$frame
colnames(lan_AU_comp_paired_W)


lan_AU_comp_paired_W %>%
      group_by(filename,bin_frame)%>%
  mutate(x_new_norm = maxnormalize(x),
         y_new_norm = maxnormalize(y))%>%
  group_by(filename,lanmark_id)%>%
  mutate(x_norm_diff= x_new_norm - lag(x_new_norm),
         y_norm_diff= y_new_norm - lag(y_new_norm))%>%
    mutate(x_norm_diff_abs= (x_norm_diff),
         y_norm_diff_abs= (y_norm_diff))%>%
  # compute a summ - also consider a roling sum
   mutate(x_norm_diff_abs_sum= sum(x_norm_diff_abs, na.rm = TRUE),
         y_norm_diff_abs_sum= sum(y_norm_diff_abs, na.rm = TRUE))%>%
  
  mutate(fill_x_y = (x_norm_diff_abs_sum+y_norm_diff_abs_sum)/2)%>%
  group_by(filename,lanmark_id)%>%
  #the line below just ignores NA (introduced in lag) which would throw error to cumsum otehrwise
      mutate(cum_x_norm_abs_diff = cumsum(ifelse(is.na(x_norm_diff_abs), 0, x_norm_diff_abs)) + x_norm_diff_abs*0,
             cum_y_norm_abs_diff = cumsum(ifelse(is.na(y_norm_diff_abs), 0, y_norm_diff_abs)) + y_norm_diff_abs*0)%>%
  mutate(cum_x_y_norm_abs_diff_mean_fill = ((cum_x_norm_abs_diff+cum_y_norm_abs_diff)/2))%>%
  # just y
  mutate(cum_x_y_norm_abs_diff_mean_fill_norm = maxnormalize(cum_y_norm_abs_diff))
```





NMF of landmarks?

```{r}

test_happy_dcast
# bin


# df_OF_output_land_posed_binned <-test_happy_dcast%>%
#     subset(posed.spoken == "posed")%>%
#   group_by(filename, expression,lanmark_id)%>%
#   mutate(bin_frame = cut(frame, 50, labels = FALSE))%>%
#   group_by(filename,bin_frame,expression,lanmark_id)%>%
#   summarise_if(is.numeric, mean, na.rm = TRUE)

colnames(df_OF_output_land_posed_binned)
 df_OF_output_land_posed_binned_select<- df_OF_output_land_posed_binned[,c(1:6,9:10)]

 colnames(df_OF_output_land_posed_binned_select)
 # df_OF_output_AUsW_unblind_posed_binned
 
 unique(df_OF_output_land_posed_binned_select$lanmark_id)
 
 df_OF_output_land_posed_binned_select$lanmark_id<- as.numeric(df_OF_output_land_posed_binned_select$lanmark_id)
 df_OF_output_land_posed_binned_select%>%
  group_by(filename,bin_frame)%>%
  arrange(as.numeric(lanmark_id),bin_frame)

```

NMF on landmarks

```{r}
# <!-- use the alligned ones -->
df_OF_output_land_posed_binned_select_alligned_eyes
df_OF_output_land_posed_binned_select_dcast
library(NMF)

colnames(df_OF_output_land_posed_binned_select_dcast)
colnames(df_OF_output_land_posed_binned_select_dcast)

df_OF_output_land_posed_binned_select_dcast
unique(df_OF_output_land_posed_binned_select_dcast$filename)
# use diffs
res_k3_land <- NMF::nmf(df_OF_output_land_posed_binned_select_dcast[,5:140], r = 3, 
                  nrun = 30, #
                  seed=123456,
                 .options = list( 'v')) #

# rotated

# NMF::basis(res_k3_land)
# coefmap(res_k3_land)
# basismap(res_k3_land)


NMF::coefmap(res_k3_land, scale = "column")
# plot(res_k3_land)

```

```{r}
res_k3_land@fit@W
res_k3_land_H<- as.data.frame(res_k3_land@fit@H)%>%
  gather(key, value)%>%
  mutate(comp = rep(seq(1:3), times = 136))%>%
  mutate(lanmark_id = substr(key,17,18))%>%
  mutate(coord = substr(key,1,1))
options(scipen = 999)
res_k3_land_H

colnames(df_OF_output_land_posed_binned_select_dcast)
df_OF_output_land_posed_binned_select_dcast[, c(1:4,150:155)]%>%
  group_by(bin_frame, expression,subject)%>%
    # group_by(filename,bin_frame, expression,subject)%>%
    summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(bin_frame, comp1_NMFLand_maxnorm))+
  geom_smooth(colour = "#1B9E77" )+
  geom_smooth(aes(y = comp2_NMFLand_maxnorm), colour = "#D95F02")+
  geom_smooth(aes(y = comp3_NMFLand_maxnorm), colour = "#7570B3")+
  facet_grid(~expression)+
  theme_bw()+
  p$graphstyle_int

RColorBrewer::brewer.pal.info(Dark2)

RColorBrewer::brewer.pal(3, "Dark2")
  
brewer.pal('Dark2', "Paired")

nmf_land_agg<- df_OF_output_land_posed_binned_select_dcast[, c(1:4,150:155)]%>%
  group_by(filename, expression,subject)%>%
    # group_by(filename,bin_frame, expression,subject)%>%
    summarise_if(is.numeric, mean, na.rm = T)

write_csv(nmf_land_agg, "nmf_land_agg.csv")

# we are gnerally abl;e to cl;assify reltying on landmarks
  
```

```{r}
res_k3_land_H_dcast<-res_k3_land_H%>%
   # group_by(comp)%>%
  # mutate(value = maxnormalize(value))%>%
  setDT()%>%
  dcast(comp+ lanmark_id ~coord, value.var = "value")

  res_k3_land_H_dcast
```

  
```{r}
  
res_k3_land_W<-  as.data.frame(res_k3_land@fit@W)%>%
    mutate(bin_frame = df_OF_output_land_posed_binned_select_dcast$bin_frame)%>%
    mutate(filename = df_OF_output_land_posed_binned_select_dcast$filename)%>%
       mutate(expression = df_OF_output_land_posed_binned_select_dcast$expression)
colnames(res_k3_land_W)

res_k3_land_W
```


```{r}
res_k3_land_H

res_k3_land_W_gath<- res_k3_land_W[,4:9]%>%
   gather(comp, value,-bin_frame,  -filename,-expression)%>%
  mutate(comp = substr(comp,5,5))

res_k3_land_W_gath

```

```{r}
res_k3_land_H_dcast$comp<- as.character(res_k3_land_H_dcast$comp)

# plot new
nrow(res_k3_land_W_gath)
nrow(res_k3_land_H_dcast)
res_k3_land_W_gath_H_dcast<- left_join(res_k3_land_W_gath, res_k3_land_H_dcast)%>%
  group_by(filename, comp)%>%
  mutate(value = maxnormalize(value))%>%
  mutate(x_new = maxnormalize(x),
         y_new = maxnormalize( y))

res_k3_land_W_gath_H_dcast

```
  


correlate compnents in landmark to AU componets
```{r}

colnames(df_OF_output_land_posed_binned_select_dcast)

nrow(df_OF_output_land_posed_binned_select_dcast)
nrow(res_k3_land_W)


res_k3_land_W$comp1_NMFLand<- res_k3_land_W$V1
res_k3_land_W$comp2_NMFLand<- res_k3_land_W$V2
res_k3_land_W$comp3_NMFLand<- res_k3_land_W$V3

df_OF_output_land_posed_binned_select_dcast<- left_join(df_OF_output_land_posed_binned_select_dcast,
          res_k3_land_W)

# correlate NMF on AUS vs NM on components


df_OF_output_land_posed_binned_select_dcast<-df_OF_output_land_posed_binned_select_dcast%>%
  group_by(filename)%>%
  # mutate(value = maxnormalize(value))%>%
  mutate(comp1_NMFLand_maxnorm = maxnormalize(comp1_NMFLand),
         comp2_NMFLand_maxnorm = maxnormalize(comp2_NMFLand),
         comp3_NMFLand_maxnorm = maxnormalize(comp3_NMFLand))
  # group_by(filename)%>%
  # summarise_if(is.numeric, mean, na.rm = T)%>%
  # ggplot(aes(comp1_NMFLand_maxnorm, comp3_max_norm))+
  # geom_point()+
  # geom_smooth(method = 'lm')
df_OF_output_land_posed_binned_select_dcast
```
cor
```{r}
colnames(df_OF_output_land_posed_binned_select_dcast)
vars_x_NMF_land <- select(df_OF_output_land_posed_binned_select_dcast, 153:155)

# we can just take y to start
vars_y_NMF_AUs <- select(df_OF_output_land_posed_binned_select_dcast, 144:146)

# Compute the correl
cor_matrix_nmf_land_aus<- cor(vars_x_NMF_land[,2:4], vars_y_NMF_AUs[,2:4], use="pairwise.complete.obs")

corr
corrplot(cor_matrix_nmf_land_aus, addCoefasPercent = TRUE)


as.data.frame(abs(cor_matrix_nmf_land_aus))%>%
  summarise_if(is.numeric, max, na.rm = T)%>%
  gather(key, values)

```
  # subset(values>.3)


```{r}
or_matrix_tresh%>%
  mutate(comp = rownames(cor_matrix_tresh_repl))%>%
  gather(land_y, value,-comp)


```
  


cor_matrix_tresh_repl_gath%>%
  ggplot(aes(value))+
  geom_histogram()


cor_matrix_tresh_repl_gath_dcast<- cor_matrix_tresh_repl_gath%>%
  mutate(comp = paste0("abs_cor",comp))%>%
  setDT()%>%
  dcast(land_y~comp, value.var = "value")

cor_matrix_tresh_repl_gath_dcast<-cor_matrix_tresh_repl_gath_dcast%>%
  mutate(lanmark_id = substr(land_y,13,14))
  

res_k3_land_H_dcast

try to make delaunay plots from NMF land


```{r}
# merge landmark weigts with timeseries weights

left_join()
df_OF_output_land_posed_binned_select_alligned_eyes
df_OF_output_land_posed_binned_select_dcast


# the esiest s to use the landmark matrix by combining it qih the currnt data we use

res_k3_land_H<-res_k3_land_H%>%
  group_by(comp)%>%
  mutate(nmf_land_value_norm = maxnormalize(value))

res_k3_land_H2<- res_k3_land_H[,c(3:6)]%>%
  setDT()%>%
  dcast(comp+lanmark_id~coord, value.var = 'nmf_land_value_norm') %>%
  # muta
  dcast(lanmark_id~comp, value.vars = 'y')

names(res_k3_land_H2)
names(res_k3_land_H2)<- c("lanmark_id", "nmf_land_value_norm1" ,  "nmf_land_value_norm2",         "nmf_land_value_norm3" )

res_k3_land_H2$lanmark_id<- as.numeric(res_k3_land_H2$lanmark_id)

df_OF_output_land_posed_binned_select_alligned_eyes<-left_join(df_OF_output_land_posed_binned_select_alligned_eyes, res_k3_land_H2)


# now merge timesereis comp

df_OF_output_land_posed_binned_select_alligned_eyes <- left_join(df_OF_output_land_posed_binned_select_alligned_eyes,res_k3_land_W)

```







df_OF_output_land_posed_binned_select_dcast

nrow(df_OF_output_land_posed_binned_select_alligned_eyes)
nrow(res_k3_land_W_gath_H_dcast)



res_k3_land_W_gath_H_dcast%>%
  group_by(filename, comp,bin_frame, lanmark_id)%>%
  summarise_if(is.numeric, mean, na.rm = T)
# 1550400
# 4651200
# 1550400

unique(res_k3_land_W_gath$filename)
unique(res_k3_land_W_gath$expression)
unique(df_OF_output_land_posed_binned_select_alligned_eyes$filename)

nrow(res_k3_land_W_gath)

res_k3


left_join(df_OF_output_land_posed_binned_select_alligned_eyes,res_k3_land_W_gath)
res_k3_land_W_gath
1,550,400

 df_OF_output_land_posed_binned_select_alligned_eyes%>%
   # filter(bin_frame>10 & bin_frame<60)%>%
 # filter(bin_frame>40 & bin_frame<75)%>%
  # subset(subject == 10)%>% # explore specific subj
  group_by(lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ungroup()%>%
  
  mutate(comp1_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp1_max_norm,
         comp2_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp2_max_norm,
         comp3_fill = cum_x_y_norm_abs_diff_mean_fill_norm*abs_corcomp3_max_norm)%>%
  mutate(comp1_fill = maxnormalize(comp1_fill),
         comp2_fill = maxnormalize(comp2_fill),
         comp3_fill = maxnormalize(comp3_fill))
```


```{r}




left_join(res_k3_land_W_gath,lan_AU_comp_paired, by = "comp")


colnames(lan_AU_comp_paired_W)
lan_AU_comp_paired_W$correlation<- lan_AU_comp_paired_W$value.y

colnames(lan_AU_comp_paired_W)

lan_AU_comp_paired_W

unique(lan_AU_comp_paired_W$bin_frame)

df_OF_output_land_posed_binned_select$lanmark_id<- as.character(df_OF_output_land_posed_binned_select$lanmark_id)



df_OF_output_land_posed_binned_select_alligned_eyes$lanmark_id
 # filter(bin_frame>40 & bin_frame<75)%>%
 filter(bin_frame>10 & bin_frame<60)%>%
  subset(subject == 1)%>% # explore specific subj
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = cum_x_y_norm_abs_diff_mean_fill_norm,
               colour = cum_x_y_norm_abs_diff_mean_fill_norm))+
   geom_voronoi_tile(aes(fill = cum_x_y_norm_abs_diff_mean_fill_norm), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)



```

go back to thebig dataset at the start
```{r}

# save(lan_AU_comp_paired,lan_AU_comp_paired_W,
#      df_OF_output_land_posed_binned_select,
#      
#      file = "part_land_AU_testdata.Rdata")


lan_AU_comp_paired_W<- left_join(res_k3_land_W_gath,lan_AU_comp_paired, by = "comp")


colnames(lan_AU_comp_paired_W)
lan_AU_comp_paired_W$correlation<- lan_AU_comp_paired_W$value.y

colnames(lan_AU_comp_paired_W)

lan_AU_comp_paired_W

unique(lan_AU_comp_paired_W$bin_frame)

df_OF_output_land_posed_binned_select$lanmark_id<- as.character(df_OF_output_land_posed_binned_select$lanmark_id)

df_OF_output_land_posed_binned

colnames(df_OF_output_land_posed_binned_select)

colnames(lan_AU_comp_paired_W2)
unique(lan_AU_comp_paired_W$bin_frame)
unique(df_OF_output_land_posed_binned_select$bin_frame)

lan_AU_comp_paired_W2<- left_join( lan_AU_comp_paired_W%>%
                                    subset(bin_frame>40 & bin_frame<80) %>%
                                    group_by(filename,expression,comp, lanmark_id, bin_frame)%>%
                                    summarise_if(is.numeric, mean, na.rm =T), df_OF_output_land_posed_binned_select%>%
                                      subset(bin_frame>40 & bin_frame<80)%>%
                                    group_by(filename,expression,lanmark_id,bin_frame)%>%
                                    summarise_if(is.numeric, mean, na.rm =T))

lan_AU_comp_paired_W2
# 79,070,400 
# 1,550,400


unique(lan_AU_comp_paired_W2$filename)

max(lan_AU_comp_paired_W2$coef)
max(lan_AU_comp_paired_W2$value.x)

lan_AU_comp_paired_W2
# res_k3
table(is.na(lan_AU_comp_paired_W2$coef))
table(is.na(lan_AU_comp_paired_W2$value.x))


lan_AU_comp_paired_W2%>%
      ungroup()%>%

  mutate(fill_coef = (coef*value.y)*correlation) %>%
   # group_by(expression,comp)%>%
  # mutate(fill_coef = fill_coef/max(fill_coef, na.rm =T)) %>%
  
group_by(filename,lanmark_id,expression,comp)%>%
         summarise_if(is.numeric, mean,na.rm = T)%>%
  ungroup()%>%
    ggplot(aes(x = x_new_norm, y = 1-y_new_norm,
             # value.x - time
             # $coef * basis
               colour = fill_coef))+

     geom_point(alpha = .1)+
       scale_color_viridis_c(option = "magma")+
  # scale_fill_viridis_c(option = "magma")+
      facet_grid(~comp)+
    
   geom_voronoi_tile(aes(fill = fill_coef), colour =NA)+
  geom_delaunay_segment2( colour = "white",alpha = .2)+
   geom_point(aes(colour = fill_coef), colour = "white",size = .5,alpha = .5)


unique(lan_AU_comp_paired_W2)
unique(lan_AU_comp_paired_W2$bin_frame)
lan_AU_comp_paired_W2%>%
# test_happy_dcast%>%
    # subset(posed.spoken == "posed")%>%
  subset(frame > 100 & frame <200)%>%
      group_by(lanmark_id,expression)%>%

         summarise_if(is.numeric, mean,na.rm = T)%>%
  ungroup()%>%
    ggplot(aes(x = x_new_norm, y = 1-y_new_norm, fill = cum_x_y_norm_abs_diff_mean_fill_norm,
               colour = cum_x_y_norm_abs_diff_mean_fill_norm))+

     geom_point(aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm), colour = "white")+
    
   geom_voronoi_tile(aes(fill = cum_x_y_norm_abs_diff_mean_fill_norm), colour =NA)+
  geom_delaunay_segment2( colour = "white",alpha = .2)+
   geom_point(aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm), colour = "white",size = .5,alpha = .5)+
  # geom_delaunay_tile(aes(colour = cum_x_y_norm_abs_diff_mean_fill_norm))+
  # ggforce::stat_delvor_summary()

     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)

# 
# rm(test_dtw,rnames, pd,pd1, ph,ph1)

install.paclages("interp")
```


<!-- proper alligments etc -->

Lanmarking
```{r}
library(readxl)
LANDMARKNMF <- read_excel("Library/CloudStorage/GoogleDrive-helioclemente.c@gmail.com/My Drive/2022 - University Of Birmingham/HaloStudy/Data/LANDMARKNMF.xlsx")
View(LANDMARKNMF)
LANDMARKNMF


NMFresk3test<- as.data.frame(res_k3@fit@H)%>%
  mutate(component = 1:n())%>%
  gather(AU, coef, -component)%>%
  group_by(component)%>%
  mutate(max_comp = max(coef),
         coef = coef/max_comp,
         # AU = substring(AU,8,40),
         AU_code = substring(AU,4,5)
         )%>%
  arrange(AU_code)



LANDMARKNMF


NMFresk3test

LANDMARKNMF<- LANDMARKNMF1
colnames(LANDMARKNMF)
colnames(LANDMARKNMF[,c(1,8:9,12:31)])

LANDMARKNMF_dcast<- LANDMARKNMF[,c(1,8:9,12:31)]%>%
gather(AU, land1_0,-c(1:3,21:23))%>%
gather(comp, land1_0_nmf, -c(1:3,7:8))

library(ggvoronoi)

left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  mutate(V1_1 = if_else(land1_0_nmf == 1, V1, NULL),
         V2_2 = if_else(land1_0_nmf == 1, V2, NULL)) %>%
  group_by(lanmark_id, component, AU)%>%
  summarise_if(is.numeric, mean, na.rm = T) %>%
  mutate(coef2 = if_else(land1_0_nmf == 1, coef,0))%>%
  ggplot(aes(V1_1, V2_2, color = coef2))+
  geom_point(aes(size = coef2), alpha = .5)+
  # geom_point( aes(x = V1_1, y = V2_2, color = coef2, fill = coef2))+
  ggvoronoi::stat_voronoi(geom="path")+
  geom_point(aes(x = V1, y = V2))+
  # geom_point(aes(size = coef), alpha = .1)+
  ylim(1,0)+
  facet_grid(~component)+
  scale_color_viridis_c(option = "magma")

  
LANDMARKNMF_dcast

# 

install.packages("ggforce")
library(ggforce)
left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  mutate(V1_1 = if_else(land1_0 == 1, V1, NULL),
         V2_2 = if_else(land1_0 == 1, V2, NULL)) %>%
  # group_by(lanmark_id)%>%
  # summarise_if(is.numeric, mean, na.rm = T) %>%
  mutate(coef2 = if_else(land1_0 == 1, coef,0))%>%
  ggplot(aes(V1_1, V2_2, color = coef2, fill=coef2 ))+
  geom_point(aes(size = coef2), alpha = .5)+
    # ggvoronoi::stat_voronoi(geom="path" )
  # geom_point( aes(x = V1_1, y = V2_2, color = coef2, fill = coef2))+

  geom_point(aes(x = V1, y = V2))+
  # geom_point(aes(size = coef), alpha = .1)+
  ylim(1,0)+
  facet_grid(~component)+
    geom_delaunay_tile(aes(x =V1, V2, fill = lanmark_id), alpha = 0.3, colour = 'black')+
  # geom_delaunay_segment2()+
  scale_color_viridis_c(option = "magma")

NMFresk3test$component
LANDMARKNMF_dcast$component<- as.numeric(substr(LANDMARKNMF_dcast$comp,4,4))

left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  mutate(V1_1 = if_else(land1_0 == 1, V1, NULL),
         V2_2 = if_else(land1_0 == 1, V2, NULL)) %>%
  # group_by(lanmark_id)%>%
  # summarise_if(is.numeric, mean, na.rm = T) %>%
  mutate(coef2 = if_else(land1_0 == 1, coef,0))%>%
  ggplot(aes(V1_1, V2_2, color = coef2, fill=coef2 ))+
  geom_point(aes(size = coef2), alpha = .5)+
    # ggvoronoi::stat_voronoi(geom="path" )
  # geom_point( aes(x = V1_1, y = V2_2, color = coef2, fill = coef2))+

  geom_point(aes(x = V1, y = V2))+
  # geom_point(aes(size = coef), alpha = .1)+
  ylim(1,0)+
  facet_grid(~component)+
    geom_delaunay_tile(aes(x =V1, V2), alpha = 0.1, colour = 'black')+
      geom_delaunay_segment2(aes(x =V1, V2, colour = coef2))+
  # geom_delaunay_segment2()+
  scale_color_viridis_c(option = "magma")

```
