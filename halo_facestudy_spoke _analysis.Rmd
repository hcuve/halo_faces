---
title: "halo_facestudy_spoken_analysis"
author: "Helio"
date: '2022-08-30'
output: html_document
---



dependencies: preprocss_halofaces.Rmd
df_OF_output_AUsW_unblind_posed_binned

related script:analysys_halofacestudy.Rmd
related data: df_OF_output_AUsW_unblind_posed



for the actual analyses we want
1- learn spatiotemporal structure suing NMF
2 - does drug vs no drug differ in NMF metrics?
3- can we separate groups based on NMF components using BADIA

spatiotemporal dynamics
- movement substates (initiation, sustainment, etc)
- if we use kmean clustering, do we have differences into how many substaes are there
- or if we use a fixed number of substates, are there significant temporal differences (e.g. duration, recurrence)

preferences
```{r}
library(tidyverse)
library(data.table)

library(NMF)

```

for the NMF we will start with k = 3 given our findings in the posed (we have a good prior for 3). 
But then we will also do 1 to 4 to to compare.

fit nmf just spoken
```{r}

unique(df_OF_output_AUsW_unblind_spoken1_2_binned$posed.spoken)

df_OF_output_AUsW_unblind_spoken1_2$bin
df_OF_output_AUsW_unblind_spoken1_2_binned
# use only the "spoken" condition
df_OF_output_AUsW_unblind_spoken1_binned<- subset(df_OF_output_AUsW_unblind_spoken1_2_binned,
                                           posed.spoken == "spoken")



# fit
colnames(df_OF_output_AUsW_unblind_spoken1_binned)
unique(df_OF_output_AUsW_unblind_spoken1_binned$bin_frame)
res_k3_spoken1 <- NMF::nmf(df_OF_output_AUsW_unblind_spoken1_binned[,17:33], r = 3, 
                  nrun = 200, #number of runs to try and update for
                  seed=123456, #specific seed for reproducibility
                 .options = list( 'v')) #verbose

range(df_OF_output_AUsW_unblind_spoken1_binned$bin_frame)

# plot(res_k3_spoken1) - this only work for multyiple fits with multiple ks
# summary(res_k3_spoken1) #dont run

# basis components 
NMF::basismap(res_k3_spoken1) # weights/ amplitudes
# memory exhaust - takes a lot of time

# mixture coefficients 
coefmap(res_k3_spoken1) #hidden variables

# access more info
# res_k3_em

```
face heatmaps for Spoje NMF




some custom visualisations

custom visalisation of H (mixing components)
```{r}

paper_plots$spoken_NMF
paper_plots$spoken_NMF_hm
paper_plots$spoken_NMF_ts_hm
# paper_plots

```



```{r}


delaunay_spoken_plots$spoken_tri_comp1

# black thememd components
delaunay_spoken_plots$spoken_tri_comp1_black<-delaunay_spoken_plots$spoken_tri_comp1 +  theme(plot.background = element_rect(fill = "black"))

delaunay_spoken_plots$spoken_tri_comp2_black<-delaunay_spoken_plots$spoken_tri_comp2+  theme(plot.background = element_rect(fill = "black"))

delaunay_spoken_plots$spoken_tri_comp3_black <- delaunay_spoken_plots$spoken_tri_comp3+ theme(plot.background = element_rect(fill = "black"))

# components with titles

delaunay_spoken_plots$spoken_tri_comp1.1 <-delaunay_spoken_plots$spoken_tri_comp1+
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp1")

delaunay_spoken_plots$spoken_tri_comp2.1<- delaunay_spoken_plots$spoken_tri_comp2+
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp2")
 
delaunay_spoken_plots$spoken_tri_comp3.1<- delaunay_spoken_plots$spoken_tri_comp3 +
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp3")


# export components to be used as axis labels
ggsave("comp1_spoken_black.png", device = "png", delaunay_spoken_plots$spoken_tri_comp1_black,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)
ggsave("comp2_spoken_black.png", device = "png", delaunay_spoken_plots$spoken_tri_comp2_black,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)


ggsave("comp3_spoken_black.png", device = "png", delaunay_spoken_plots$spoken_tri_comp3_black,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)

```

Now heatmap
```{r}
# chool_talk$AU_NM 
paper_plots$spoken_NMF_hm <-

as.data.frame(res_k3_spoken1@fit@H) %>%
  mutate(component = c(1,3,2)) %>%
  gather(AU, coef, -component)%>%
  group_by(as.factor(component))%>%
  mutate(max_comp = max(coef),
         coef = coef/max_comp,
         # AU = substring(AU,8,40),
         AU_code = substring(AU,4,5)
         )%>%
  arrange(AU_code)%>%
  ggplot(aes(as.factor(component),AU, fill = coef))+
  geom_tile()+
  theme_classic()+
  # scale_fill_viridis_()
   # scale_fill_()+#)+
   scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  xlab("K")+
  p$graphstyle_int +
guides(fill=guide_colorbar(ticks.colour = NA))
    # xlab("Component (K)")
  # ggtitle("SPOKEN EXPRESSIONS")
  

paper_plots$spoken_NMF_hm


#load component icons
# https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp1_spoken_black.png
labels_spoken <- c(
  `1` = "<img src='https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp1_spoken_black.png'
    width='100' /><br> 1",
  `2` = "<img src='https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp2_spoken_black.png'
    width='100' /><br> 2",
  `3` = "<img src='https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp3_spoken_black.pngg'
    width='100' /><br> 3"
)
# ggtext::

require(ggtext)

paper_plots$spoken_NMF_hm +
  xlab("Component (K)")+
    scale_x_discrete(
      position = "top",
    # name = NULL,
    labels = labels_spoken
  ) +
  theme(
     axis.text.x.top = element_markdown(color = "black", size = 16*(sf+.5)),
     axis.title.x = element_text(size = 16*(sf+.5)),#update this,
     axis.title.y = element_text(size = 16*(sf+.5)),#update this,
     axis.text.x = element_text(size = 15*(sf+.5), colour = "black"),
  axis.text.y = element_text(size = 15*(sf+.5), colour = "black"),
  legend.key.height = unit(1, "cm"),
  legend.key.width = unit(.7, "cm"),
  legend.text = element_text(size = 16*(sf+.5)),
  legend.title= element_text(size = 16*(sf+.5))
    # axis.text.x = element_markdown(color = "black", size = 15),
       # axis.text.x.top = element_markdown(size = 8, lineheight = 1.05)
     # axis.title.x = element_markdown(color = "black", size = 20)
  )


paper_plots$spoken_NMF_hm

delaunay_spoken_plots$spoken_tri_comp1
delaunay_spoken_plots$spoken_tri_comp2
delaunay_spoken_plots$spoken_tri_comp3


```


store components in the dataset
```{r}
# store nmftable in DF
df_OF_output_AUsW_unblind_spoken1$NMFtable_k3<- as.data.frame(res_k3_spoken1@fit@W)$V1

# store components
df_OF_output_AUsW_unblind_spoken1_binned$k3_comp1 = as.data.frame(res_k3_spoken1@fit@W)$V1
df_OF_output_AUsW_unblind_spoken1_binned$k3_comp2 = as.data.frame(res_k3_spoken1@fit@W)$V2
df_OF_output_AUsW_unblind_spoken1_binned$k3_comp3 = as.data.frame(res_k3_spoken1@fit@W)$V3



# visualisation based on time


# chool_talk$ts_smooth<- 

colnames(df_OF_output_AUsW_unblind_spoken1_binned)
# colnames(  df_OF_output_AUsW_unblind_spoken1[,c(1,6:7,9:10,33:35)])
  
  
  df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")
  
  
  # ts by expression
   df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~component  )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")
  
  
  # heatmap
  
  
  # chool_talk$ts_hm<-
df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max)%>%
  # mutate_at(c("coef"), scale)%>%
  group_by(component, expression, bin_frame)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, component, fill= coef))+
  geom_tile()+
  xlab("time bin")+
  scale_fill_viridis_c(option = "magma")+
  # geom_smooth(se = F)+
  facet_grid(~expression)+
  theme_classic()+
  p$graphstyle_int+
  guides(fill=guide_colorbar(ticks.colour = NA))+
  theme(panel.spacing = unit(1, "cm"))
  




library(patchwork)
# 
# chool_talk$ts_nmf_heat_NMF <- (chool_talk$ts_smooth/
#   chool_talk$ts_hm)+
#   plot_layout(heights = c(1,2))
# 
# chool_talk$ts_nmf_heat_NMF
# 
# ggsave("ts_nmf_heat_NMF.tiff", chool_talk$ts_nmf_heat_NMF, device = "tiff",
#        width = 10, height = 7, dpi = 800)

```

combine sooken and posed

```{r}
spoken_NMF<- df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]

posed_NMF<- 
df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]

df_OF_output_AUsW_unblind_spoken1_binned$k3_comp3

posed_NMF$k3_comp1<- posed_NMF$comp1
posed_NMF$k3_comp2<- posed_NMF$comp3
posed_NMF$k3_comp3<- posed_NMF$comp2

posed_NMF$comp1<- NULL
posed_NMF$comp2<- NULL

posed_NMF$comp3<- NULL

posed_NMF$posed_spoken<- "posed"
spoken_NMF$posed_spoken<- "spoken"


# bind_rows(posed_NMF, spoken_NMF)%>%
paper_plots$spoken_NMF <-
  spoken_NMF%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename,-posed_spoken)%>%
  # subset(expression!= "neutral")%>%
    mutate(component = substring(component,4,8))%>%
  
      group_by(filename,component,subject,expression,posed_spoken)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject,posed_spoken)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
    scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))+
  theme(panel.spacing.x = unit(1.5, "lines"))+
  theme(legend.position = "top")
  
  paper_plots$spoken_NMF
  
  
  
  # ts heatmap
  # df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
 paper_plots$spoken_NMF_ts_hm <- 
  spoken_NMF%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename,-posed_spoken)%>%
  # subset(expression!= "neutral")%>%
    mutate(component = substring(component,4,8))%>%
    mutate(expression = factor(expression, levels = c('angry', 'happy', 'sad', 'neutral')))%>%
  
      group_by(filename,component,subject,expression,posed_spoken)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  # 
  # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  # group_by(filename,component)%>%
  # mutate(coef_max = max(coef),
  #        coef = coef/coef_max)%>%

  group_by(component, expression, bin_frame)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, component, fill= coef))+
  geom_tile()+
  xlab("time bin")+
      scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  # scale_fill_viridis_c(option = "magma")+
  # geom_smooth(se = F)+
  facet_grid(~expression)+
  theme_classic()+
  p$graphstyle_int+
  guides(fill=guide_colorbar(ticks.colour = NA))+
  # theme(panel.spacing = unit(1, "cm"))+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
  theme(panel.spacing.x = unit(1.5, "lines"))

  paper_plots$spoken_NMF_ts_hm
  
  
  # panespoken_NMF_ts_hm paper_plots$spoken_NMF_ts_hm
  paper_plots$NMF_panel_spoken <-
(paper_plots$spoken_NMF_hm |
  (paper_plots$spoken_NMF/paper_plots$spoken_NMF_ts_hm))+
  plot_layout(ncol = 2, widths = c(.7,2))+
    plot_annotation(title = "SPOKEN EXPRESSIONS")

    paper_plots$NMF_panel_spoken
    
    
ggsave("fig2_NMF_panel_spokjen.tiff", paper_plots$NMF_panel_spoken, device = "tiff",
       width = 14, height = 7, dpi = 800)


paper_plots$panel_fig2_posed_spoken_panel<- 
  ((paper_plots$NMF_panel_posed+ggtitle("POSED EXPRESSIONS")) /(paper_plots$NMF_panel_spoken+ggtitle("SPOKEN EXPRESSIONS")))+
  plot_annotation(tag_levels = 'A')

paper_plots$NMF_panel_posed +
  ggtitle("posed")
  
ggsave("panel_fig2_posed_spoken_panel.tiff", paper_plots$panel_fig2_posed_spoken_pane, device = "tiff",
       width = 20, height = 14, dpi = 800)

```



```{r}
posed_spoken_bindrows<- bind_rows(posed_NMF, spoken_NMF)%>%
  group_by(filename,posed_spoken, expression, drug.placebo,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

posed_spoken_bindrows_ts<- bind_rows(posed_NMF, spoken_NMF)%>%
  group_by(filename, bin_frame, posed_spoken, expression, drug.placebo,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)


View(posed_spoken_bindrows_ts)

colnames(posed_spoken_bindrows)

write_csv(posed_spoken_bindrows, "posed_spoken_bindrows.csv")
write_csv(posed_spoken_bindrows, "posed_spoken_bindrows_ts.csv")

caret::createDataPartition(c(2:9),
                            2, p = .7, group = "filename")
posed_spoken_bindrows_ts

library(caTools)

?sample.split


posed_spoken_bindrows_ts$trainLogical<-sample.split(posed_spoken_bindrows_ts$k3_comp1, group = posed_spoken_bindrows_ts$filename, SplitRatio = 0.7)



posed_spoken_bindrows_ts$trainLogical_num<-as.numeric(posed_spoken_bindrows_ts$trainLogical)
table(posed_spoken_bindrows_ts$trainLogical)/length(posed_spoken_bindrows_ts$trainLogical)
table(posed_spoken_bindrows_ts$trainLogical_num)/length(posed_spoken_bindrows_ts$trainLogical_num)


write_csv(posed_spoken_bindrows_ts, "posed_spoken_bindrows_ts.csv")

unique(posed_spoken_bindrows_ts$posed_spoken)


```


