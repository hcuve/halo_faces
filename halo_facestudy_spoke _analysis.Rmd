---
title: "halo_facestudy_spoken_analysis"
author: "Helio"
date: '2022-08-30'
output: html_document
---



dependencies: preprocss_halofaces.Rmd
df_OF_output_AUsW_unblind_posed_binned

related script:analysys_halofacestudy.Rmd
related data: df_OF_output_AUsW_unblind_posed



for the actual analyses we want
1- learn spatiotemporal structure suing NMF
2 - does drug vs no drug differ in NMF metrics?
3- can we separate groups based on NMF components using BADIA

spatiotemporal dynamics
- movement substates (initiation, sustainment, etc)
- if we use kmean clustering, do we have differences into how many substaes are there
- or if we use a fixed number of substates, are there significant temporal differences (e.g. duration, recurrence)

preferences
```{r}
library(tidyverse)
library(data.table)

library(NMF)

```

for the NMF we will start with k = 3 given our findings in the posed (we have a good prior for 3). 
But then we will also do 1 to 4 to to compare.

fit nmf just spoken
```{r}

unique(df_OF_output_AUsW_unblind_spoken1_2_binned$posed.spoken)

df_OF_output_AUsW_unblind_spoken1_2$bin
df_OF_output_AUsW_unblind_spoken1_2_binned
# use only the "spoken" condition
df_OF_output_AUsW_unblind_spoken1_binned<- subset(df_OF_output_AUsW_unblind_spoken1_2_binned,
                                           posed.spoken == "spoken")



# fit
colnames(df_OF_output_AUsW_unblind_spoken1_binned)
unique(df_OF_output_AUsW_unblind_spoken1_binned$bin_frame)
# df_OF_output_AUsW_unblind_spoken1_binned
res_k3_spoken1 <- NMF::nmf(df_OF_output_AUsW_unblind_spoken1_binned[,17:33], r = 3, 
                  nrun = 200, #number of runs to try and update for
                  seed=123456, #specific seed for reproducibility
                 .options = list( 'v')) #verbose

range(df_OF_output_AUsW_unblind_spoken1_binned$bin_frame)

# plot(res_k3_spoken1) - this only work for multyiple fits with multiple ks
# summary(res_k3_spoken1) #dont run

# basis components 
NMF::basismap(res_k3_spoken1) # weights/ amplitudes
# memory exhaust - takes a lot of time

# mixture coefficients 
coefmap(res_k3_spoken1) #hidden variables

# access more info
# res_k3_em

```
face heatmaps for Spoje NMF




some custom visualisations

custom visalisation of H (mixing components)
```{r}

paper_plots$spoken_NMF
paper_plots$spoken_NMF_hm
paper_plots$spoken_NMF_ts_hm
# paper_plots

```



```{r}


delaunay_spoken_plots$spoken_tri_comp1

# black thememd components
delaunay_spoken_plots$spoken_tri_comp1_black<-delaunay_spoken_plots$spoken_tri_comp1 +  theme(plot.background = element_rect(fill = "black"))

delaunay_spoken_plots$spoken_tri_comp2_black<-delaunay_spoken_plots$spoken_tri_comp2+  theme(plot.background = element_rect(fill = "black"))

delaunay_spoken_plots$spoken_tri_comp3_black <- delaunay_spoken_plots$spoken_tri_comp3+ theme(plot.background = element_rect(fill = "black"))

# components with titles

delaunay_spoken_plots$spoken_tri_comp1.1 <-delaunay_spoken_plots$spoken_tri_comp1+
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp1")

delaunay_spoken_plots$spoken_tri_comp2.1<- delaunay_spoken_plots$spoken_tri_comp2+
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp2")
 
delaunay_spoken_plots$spoken_tri_comp3.1<- delaunay_spoken_plots$spoken_tri_comp3 +
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp3")


# export components to be used as axis labels
ggsave("comp1_spoken_black.png", device = "png", delaunay_spoken_plots$spoken_tri_comp1_black,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)
ggsave("comp2_spoken_black.png", device = "png", delaunay_spoken_plots$spoken_tri_comp2_black,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)


ggsave("comp3_spoken_black.png", device = "png", delaunay_spoken_plots$spoken_tri_comp3_black,
       width = 700,
       height = 700,
              units = 'px',
       dpi = 500)

delaunay_spoken_plots$spoken_tri_comp1.1

```

Now heatmap
```{r}
# chool_talk$AU_NM 
paper_plots$spoken_NMF_hm <-

as.data.frame(res_k3_spoken1@fit@H) %>%
  mutate(component = c(1,3,2)) %>%
  gather(AU, coef, -component)%>%
  group_by(as.factor(component))%>%
  mutate(max_comp = max(coef),
         coef = coef/max_comp,
         # AU = substring(AU,8,40),
         AU_code = substring(AU,4,5)
         )%>%
  arrange(AU_code)%>%
  ggplot(aes(as.factor(component),AU, fill = coef))+
  geom_tile()+
  theme_classic()+
  # scale_fill_viridis_()
   # scale_fill_()+#)+
   scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  xlab("K")+
  p$graphstyle_int +
guides(fill=guide_colorbar(ticks.colour = NA))
    # xlab("Component (K)")
  # ggtitle("SPOKEN EXPRESSIONS")
  

paper_plots$spoken_NMF_hm


#load component icons
# https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp1_spoken_black.png
labels_spoken <- c(
  `1` = "<img src='https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp1_spoken_black.png'
    width='100' /><br> 1",
  `2` = "<img src='https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp2_spoken_black.png'
    width='100' /><br> 2",
  `3` = "<img src='https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/comp3_spoken_black.png'
    width='100' /><br> 3"
)
# ggtext::

require(ggtext)

paper_plots$spoken_NMF_hm<-
paper_plots$spoken_NMF_hm +
  xlab("Component (K)")+
    scale_x_discrete(
      position = "top",
    # name = NULL,
    labels = labels_spoken
  ) +
  theme(
     axis.text.x.top = element_markdown(color = "black", size = 16*(sf+.5)),
     axis.title.x = element_text(size = 16*(sf+.5)),#update this,
     axis.title.y = element_text(size = 16*(sf+.5)),#update this,
     axis.text.x = element_text(size = 15*(sf+.5), colour = "black"),
  axis.text.y = element_text(size = 15*(sf+.5), colour = "black"),
  legend.key.height = unit(1, "cm"),
  legend.key.width = unit(.7, "cm"),
  legend.text = element_text(size = 16*(sf+.5)),
  legend.title= element_text(size = 16*(sf+.5))
    # axis.text.x = element_markdown(color = "black", size = 15),
       # axis.text.x.top = element_markdown(size = 8, lineheight = 1.05)
     # axis.title.x = element_markdown(color = "black", size = 20)
  )


paper_plots$spoken_NMF_hm



```


COMPONENTS PATCH

```{R}

delaunay_spoken_plots$COMP1_2_3_patch<- delaunay_spoken_plots$spoken_tri_comp1.1/
  delaunay_spoken_plots$spoken_tri_comp2.1/
  delaunay_spoken_plots$spoken_tri_comp3.1

delaunay_spoken_plots$COMP1_2_3_patch


```

store components in the dataset
```{r}
# store nmftable in DF
df_OF_output_AUsW_unblind_spoken1$NMFtable_k3<- as.data.frame(res_k3_spoken1@fit@W)$V1

# store components
df_OF_output_AUsW_unblind_spoken1_binned$k3_comp1 = as.data.frame(res_k3_spoken1@fit@W)$V1
df_OF_output_AUsW_unblind_spoken1_binned$k3_comp2 = as.data.frame(res_k3_spoken1@fit@W)$V2
df_OF_output_AUsW_unblind_spoken1_binned$k3_comp3 = as.data.frame(res_k3_spoken1@fit@W)$V3



# visualisation based on time


# chool_talk$ts_smooth<- 

colnames(df_OF_output_AUsW_unblind_spoken1_binned)
# colnames(  df_OF_output_AUsW_unblind_spoken1[,c(1,6:7,9:10,33:35)])
  
  
  df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")
  
  
  # ts by expression
   df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~component  )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")
  
  
  # heatmap
  
  
  # chool_talk$ts_hm<-
df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max)%>%
  # mutate_at(c("coef"), scale)%>%
  group_by(component, expression, bin_frame)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, component, fill= coef))+
  geom_tile()+
  xlab("time bin")+
  scale_fill_viridis_c(option = "magma")+
  # geom_smooth(se = F)+
  facet_grid(~expression)+
  theme_classic()+
  p$graphstyle_int+
  guides(fill=guide_colorbar(ticks.colour = NA))+
  theme(panel.spacing = unit(1, "cm"))
  




library(patchwork)
# 
# chool_talk$ts_nmf_heat_NMF <- (chool_talk$ts_smooth/
#   chool_talk$ts_hm)+
#   plot_layout(heights = c(1,2))
# 
# chool_talk$ts_nmf_heat_NMF
# 
# ggsave("ts_nmf_heat_NMF.tiff", chool_talk$ts_nmf_heat_NMF, device = "tiff",
#        width = 10, height = 7, dpi = 800)

```



timeseries and hetmap timesereis across emotions

```{r}
# bind_rows(posed_NMF, spoken_NMF)%>%
paper_plots$spoken_ts_across_exp<-


  spoken_NMF%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename,-posed_spoken)%>%
  # subset(expression!= "neutral")%>%
    mutate(component = substring(component,4,8))%>%
  
      group_by(filename,component,posed_spoken)%>%
  mutate(coef_max = max(coef),
         coef = maxnormalize(coef)) %>%
  
  group_by( component, bin_frame,posed_spoken)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  # facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
    # scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))+
  theme(panel.spacing.x = unit(1.5, "lines"))+
  theme(legend.position = "top")

  
  paper_plots$spoken_ts_across_exp
  
  # heatmap ts
  
   paper_plots$spoken_NMF_ts_hm_across <- 
  spoken_NMF%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename,-posed_spoken)%>%
  # subset(expression!= "neutral")%>%
    mutate(component = substring(component,4,8))%>%
    mutate(expression = factor(expression, levels = c('angry', 'happy', 'sad', 'neutral')))%>%
  
      group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = maxnormalize(coef)) %>%
  # 
  # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  # group_by(filename,component)%>%
  # mutate(coef_max = max(coef),
  #        coef = coef/coef_max)%>%

  group_by(component, bin_frame)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, component, fill= coef))+
  geom_tile()+
  xlab("time bin")+
      scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  # scale_fill_viridis_c(option = "magma")+
  # geom_smooth(se = F)+
  # facet_grid(~expression)+
  theme_classic()+
  p$graphstyle_int+
  guides(fill=guide_colorbar(ticks.colour = NA))+
  # theme(panel.spacing = unit(1, "cm"))+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
  theme(panel.spacing.x = unit(1.5, "lines"))
  
   paper_plots$spoken_NMF_ts_hm_across 
   
   
   
spoken_ts_ts_hm_compns<- (   paper_plots$spoken_ts_across_exp/ paper_plots$spoken_NMF_ts_hm_across )

spoken_ts_ts_hm_compns

```
combine spoken and posed

```{r}

spoken_NMF<- df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]

posed_NMF<- 
df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]

df_OF_output_AUsW_unblind_spoken1_binned$k3_comp3

posed_NMF$k3_comp1<- posed_NMF$comp1
posed_NMF$k3_comp2<- posed_NMF$comp3
posed_NMF$k3_comp3<- posed_NMF$comp2

posed_NMF$comp1<- NULL
posed_NMF$comp2<- NULL

posed_NMF$comp3<- NULL

posed_NMF$posed_spoken<- "posed"
spoken_NMF$posed_spoken<- "spoken"


# bind_rows(posed_NMF, spoken_NMF)%>%

spoken_NMF
paper_plots$spoken_NMF <-
  spoken_NMF%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename,-posed_spoken)%>%
  # subset(expression!= "neutral")%>%
    mutate(component = substring(component,4,8))%>%
  
      group_by(filename,component,subject,expression,posed_spoken)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject,posed_spoken)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
     mutate(expression = factor(expression, levels = c('angry', 'happy', 'sad', 'neutral')))%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
    scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))+
  theme(panel.spacing.x = unit(1.5, "lines"))+
  theme(legend.position = "top")
  
  paper_plots$spoken_NMF
  
  
  
  # ts heatmap
  # df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,9:10,34:36)]%>%
 paper_plots$spoken_NMF_ts_hm <- 
  spoken_NMF%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename,-posed_spoken)%>%
  # subset(expression!= "neutral")%>%
    mutate(component = substring(component,4,8))%>%
    mutate(expression = factor(expression, levels = c('angry', 'happy', 'sad', 'neutral')))%>%
  
      group_by(filename,component,subject,expression,posed_spoken)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  # 
  # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  # group_by(filename,component)%>%
  # mutate(coef_max = max(coef),
  #        coef = coef/coef_max)%>%

  group_by(component, expression, bin_frame)%>%
   mutate(expression = factor(expression, levels = c('angry', 'happy', 'sad', 'neutral')))%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, component, fill= coef))+
  geom_tile()+
  xlab("time bin")+
      scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  # scale_fill_viridis_c(option = "magma")+
  # geom_smooth(se = F)+
  facet_grid(~expression)+
  theme_classic()+
  p$graphstyle_int+
  guides(fill=guide_colorbar(ticks.colour = NA))+
  # theme(panel.spacing = unit(1, "cm"))+
    scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
  theme(panel.spacing.x = unit(1.5, "lines"))

  paper_plots$spoken_NMF_ts_hm
  paper_plots$spoken_NMF
  
  
  
  # spoken_NMF$
  
```
  
 emotion triangles
 
 
```{r}

triang_patch_spoken

triangle_plots$delaunay_tri_ang<-triangle_plots$delaunay_tri_ang+scale_x_continuous(limits = c(-.2,1.2))

delaunay_spoken_plots$spoken_triang_ang<- delaunay_spoken_plots$spoken_triang_ang+
  scale_x_continuous(limits = c(-.2,1.2))
delaunay_spoken_plots$spoken_triang_happy<-delaunay_spoken_plots$spoken_triang_happy+
    scale_x_continuous(limits = c(-.2,1.2))
  
delaunay_spoken_plots$spoken_triang_sad<-delaunay_spoken_plots$spoken_triang_sad+
    scale_x_continuous(limits = c(-.2,1.2))

delaunay_spoken_plots$spoken_triang_neutral<-delaunay_spoken_plots$spoken_triang_neutral+
    scale_x_continuous(limits = c(-.2,1.2))

triang_patch_spoken<- (delaunay_spoken_plots$spoken_triang_ang  +
                         delaunay_spoken_plots$spoken_triang_happy +
                         delaunay_spoken_plots$spoken_triang_sad+
                         delaunay_spoken_plots$spoken_triang_neutral)+plot_layout(ncol = 4)

 
```
 
```{r}

spoken_part1plot <- (wrap_elements(full = paper_plots$spoken_NMF_hm)+ 
                       wrap_elements(full = delaunay_spoken_plots$COMP1_2_3_patch)+wrap_elements(spoken_ts_ts_hm_compns))+
    plot_layout(ncol = 3, widths = c(1.2,.5,1))+ plot_annotation(tag_levels = 'A')+
  theme(plot.tag = element_text(size = 20*(sf+.5)))
 
 spoken_part1plot

spoken_part2plot <-(paper_plots$spoken_NMF /
           patchwork::wrap_elements(triang_patch_spoken)/
    paper_plots$spoken_NMF_ts_hm)+
  plot_layout(nrow = 3, heights = c(1,1.5,1))+
  plot_annotation(tag_levels = list(c('D', 'E','F')))+
  theme(plot.tag = element_text(size =20*(sf+.5)))
  

spoken_part2plot


paper_plots$panel_NMF_spoken<-
wrap_elements(full = spoken_part1plot) + wrap_elements(full = spoken_part2plot) + plot_layout(ncol = 1, nrow = 2, heights = c(1,1))
   # plot_annotation(tag_levels = 'A')


paper_plots$panel_NMF_spoken
   
   
   
ggsave("panel_NMF_spoken1.tiff",
       device = 'tiff',    
       paper_plots$panel_NMF_spoken,
       width = 25,
       height = 25,
       dpi = 800)
   
#   # panespoken_NMF_ts_hm paper_plots$spoken_NMF_ts_hm
#   paper_plots$NMF_panel_spoken <-
# (paper_plots$spoken_NMF_hm |
#   (paper_plots$spoken_NMF/paper_plots$spoken_NMF_ts_hm))+
#   plot_layout(ncol = 2, widths = c(.7,2))+
#     plot_annotation(title = "SPOKEN EXPRESSIONS")
# 
#     paper_plots$NMF_panel_spoken
#     
    
ggsave("fig2_NMF_panel_spokjen.tiff", paper_plots$NMF_panel_spoken, device = "tiff",
       width = 14, height = 7, dpi = 800)

# 
# paper_plots$panel_fig2_posed_spoken_panel<- 
#   ((paper_plots$NMF_panel_posed+ggtitle("POSED EXPRESSIONS")) /(paper_plots$NMF_panel_spoken+ggtitle("SPOKEN EXPRESSIONS")))+
#   plot_annotation(tag_levels = 'A')
# 
# paper_plots$NMF_panel_posed +
#   ggtitle("posed")
#   
# ggsave("panel_fig2_posed_spoken_panel.tiff", paper_plots$panel_fig2_posed_spoken_pane, device = "tiff",
#        width = 20, height = 14, dpi = 800)

```



```{r}
# 
posed_spoken_bindrows <- bind_rows(posed_NMF, spoken_NMF)%>%
  group_by(filename,posed_spoken, expression, drug.placebo,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

posed_spoken_bindrows_ts<- bind_rows(posed_NMF, spoken_NMF)%>%
  group_by(filename, bin_frame, posed_spoken, expression, drug.placebo,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)


View(posed_spoken_bindrows_ts)

colnames(posed_spoken_bindrows)

write_csv(posed_spoken_bindrows, "posed_spoken_bindrows.csv")
write_csv(posed_spoken_bindrows, "posed_spoken_bindrows_ts.csv")

caret::createDataPartition(c(2:9),
                            2, p = .7, group = "filename")
posed_spoken_bindrows_ts

library(caTools)

# ?sample.split
posed_spoken_bindrows_ts$trainLogical<-sample.split(posed_spoken_bindrows_ts$k3_comp1, group = posed_spoken_bindrows_ts$filename, SplitRatio = 0.7)


posed_spoken_bindrows_ts$trainLogical_num<-as.numeric(posed_spoken_bindrows_ts$trainLogical)
table(posed_spoken_bindrows_ts$trainLogical)/length(posed_spoken_bindrows_ts$trainLogical)
table(posed_spoken_bindrows_ts$trainLogical_num)/length(posed_spoken_bindrows_ts$trainLogical_num)


write_csv(posed_spoken_bindrows_ts, "posed_spoken_bindrows_ts.csv")

unique(posed_spoken_bindrows_ts$posed_spoken)


```


MULTIVARIATE TIMESERIES CLUSTERING
```{r}
# Load the caret package
# library(caret)
library(CMFMTS)
# ?CMFMTS::cmfmts
# Data to process (data.frame). Each row contains a time series.

df_OF_output_AUsW_unblind_spoken1_binned

colnames(df_OF_output_AUsW_unblind_spoken1_binned)
unique(df_OF_output_AUsW_unblind_spoken1_binned$posed.spoken)


colnames(df_OF_output_AUsW_unblind_spoken1_binned[c(1:10,34:36)])
# gather
df_OF_output_AUsW_unblind_spoken1_binned_gather<- gather(df_OF_output_AUsW_unblind_spoken1_binned[c(1:10,34:36)], 
                                                         key = "nm_comp", value = "nmf_comp_value", - c(1:10))
df_OF_output_AUsW_unblind_spoken1_binned_gather

# create a timeseries unique?

df_OF_output_AUsW_unblind_spoken1_binned_gather$timersies_unique <- paste0(df_OF_output_AUsW_unblind_spoken1_binned_gather$filename,                             paste0(df_OF_output_AUsW_unblind_spoken1_binned_gather$nm_comp))

unique(df_OF_output_AUsW_unblind_spoken1_binned_gather$timersies_unique)


# train_gather_comp1 <- train_gather%>%subset(timersies_unique == "./cut_posed_angry_day1_p10.csvk3_comp1")
# i need to dcast time ids to rows, because this fucntion needs each row to be a timeseries

ts_order<- c(paste0("t_",(1:100)))


# now dcast such that each row is a timeseriies
spoken_dcast_formts_maxnorm<-

df_OF_output_AUsW_unblind_spoken1_binned_gather%>%
  arrange(filename,nm_comp,bin_frame)%>%
  group_by(filename,nm_comp)%>%
  mutate(nmf_comp_value = zoo::na.approx(nmf_comp_value))%>%
  
  # potentially made a mistake here in spoken, max should be by subject and component
   group_by(filename,nm_comp)%>%
  # don't use maxnorm
  mutate(nmf_comp_value = maxnormalize(nmf_comp_value))%>%
  mutate(bin_frame = paste0("t_", paste0(bin_frame)))%>%
  arrange(filename,nm_comp,bin_frame)%>%
 data.table::dcast(timersies_unique+filename+subject+expression+drug.placebo+subject+nm_comp~bin_frame, value.var = "nmf_comp_value")

# spoken_dcast_formts_maxnorm



```

colnames(spoken_dcast_formts_maxnorm)

```{r}
ts_order
# colnames(train_gather_dcast)


# this extracts features from each timeseries - 41 in this case 
# see Multivariate times series classification through an interpretable representation
# Author links open overlay panelFrancisco J.BaldánaJosé M.Beníteza
# https://www.sciencedirect.com/science/article/pii/S0020025521004825#b0180


# we could do somethign similar where we create the features ourselves
# e.g. displacement, speed, RMSSD, jerk, etc, this gives a smaller set of data compared to 
# max_min_norm()


# max norm
#   
# train_gather_dcast_maxnorm<- train_gather%>%
#   group_by(subject)%>%
#   mutate(nmf_comp_value = maxnorm(nmf_comp_value))
  

  # reorder timeseries columns
  colnames(spoken_dcast_formts_maxnorm1)
  spoken_dcast_formts_maxnorm<- bind_cols(spoken_dcast_formts_maxnorm[,1:7], spoken_dcast_formts_maxnorm[,c(ts_order)])
  
  spoken_dcast_formts_maxnorm1<-bind_cols(spoken_dcast_formts_maxnorm[,1:7],
zoo::na.approx(spoken_dcast_formts_maxnorm[,8:107]))

  
  
  spoken_dcast_formts_maxnorm1

colnames(spoken_dcast_formts_maxnorm1)
# multivariate timeseries feature extraction

?CMFMTS::cmfmts
spoken_mts <- CMFMTS::cmfmts(dataset = spoken_dcast_formts_maxnorm1[,8:107],
                na = TRUE)


 table(is.na(spoken_dcast_formts_maxnorm1))
 table(is.na(spoken_mts))

View(spoken_mts)
colnames(train_gather_dcast_maxnorm_dcast)

library(CMFMTS)

# store essential columns

spoken_mts$filename<- spoken_dcast_formts_maxnorm$filename
spoken_mts$subject<- spoken_dcast_formts_maxnorm$subject
spoken_mts$expression<- spoken_dcast_formts_maxnorm$expression
spoken_mts$drug.placebo<- spoken_dcast_formts_maxnorm$drug.placebo
spoken_mts$nm_comp<- spoken_dcast_formts_maxnorm$nm_comp
spoken_mts$nm_comp<- spoken_dcast_formts_maxnorm$nm_comp

# drop columns with zero SD

# Calculate the sd for the selected columns
# Identify the numerical columns
num_cols <- sapply(spoken_mts, is.numeric)

num_col_names <- names(spoken_mts[,num_cols])

sd_values <- apply(spoken_mts[, num_col_names], 2, sd, na.rm = T)


# Identify the columns with a standard deviation of zero
zero_sd_cols <- names(which(sd_values == 0))

# Drop the columns with a standard deviation of zero
spoken_mts_no0Sd <- spoken_mts%>%select(-zero_sd_cols)
View(spoken_mts_no0Sd)

spoken_mts_no0Sd_no0Sd <- spoken_mts%>%select(-zero_sd_cols)

# Replace NA values with the column average
spoken_mts_no0Sd_no0Sd<- spoken_mts_no0Sd_no0Sd %>%
  mutate_if(is.numeric,funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))


# dcast
colnames(spoken_mts_no0Sd_no0Sd)
library(data.table)
 

spoken_mts_no0Sd_no0Sd_dcast<-
setDT(spoken_mts_no0Sd_no0Sd)%>%
   gather(ts_features, values, -filename,- subject, -expression,-drug.placebo, -nm_comp)%>%
  mutate(ts_features_k =  paste0(ts_features, nm_comp))%>%
  # mutate(bin_frame = paste0("t_", paste0(bin_frame)))%>%
 data.table::dcast(filename + subject+expression+drug.placebo ~ ts_features_k, value.var = "values", sep = "")

write_csv(spoken_mts_no0Sd_no0Sd, "spoken_mts_no0Sd_no0Sd.csv")
write_csv(spoken_mts_no0Sd_no0Sd_dcast, "spoken_mts_no0Sd_no0Sd_dcast.csv")

```

principal components

```{r}
colnames(spoken_mts_no0Sd_no0Sd_dcast)
spoken_PCA_maxnormpsych <-psych::principal(spoken_mts_no0Sd_no0Sd_dcast[,c(5:118)],3, scores = TRUE)

spoken_PCA_maxnormpsych

# need to have a threshold


# library(readxl)

library(readxl)
spoken_PCA_remove <- read_excel("spoken_PCA_remove.xlsx")
spoken_PCA_remove$remove

# 
spoken_mts_no0Sd_no0Sd_dcast_2<- spoken_mts_no0Sd_no0Sd_dcast%>%
select(-c(spoken_PCA_remove$remove))

spoken_mts_no0Sd_no0Sd_dcast_2
spoken_mts_no0Sd_no0Sd_dcast$PC1<-   spoken_PCA_maxnormpsych$scores[,1]
spoken_mts_no0Sd_no0Sd_dcast$PC2<-   spoken_PCA_maxnormpsych$scores[,2]
spoken_mts_no0Sd_no0Sd_dcast$PC3<-   spoken_PCA_maxnormpsych$scores[,3]


# nw pca
colnames(spoken_mts_no0Sd_no0Sd_dcast_2)
spoken_PCA_maxnormpsych2 <-psych::principal(spoken_mts_no0Sd_no0Sd_dcast_2[,c(5:61)],3, scores = TRUE)


spoken_mts_no0Sd_no0Sd_dcast_2$PC1<-   spoken_PCA_maxnormpsych2$scores[,1]
spoken_mts_no0Sd_no0Sd_dcast_2$PC2<-   spoken_PCA_maxnormpsych2$scores[,2]
spoken_mts_no0Sd_no0Sd_dcast_2$PC3<-   spoken_PCA_maxnormpsych2$scores[,3]

spoken_PCA_maxnormpsych

write_csv(spoken_mts_no0Sd_no0Sd, "spoken_mts_no0Sd_no0Sd.csv")
write_csv(spoken_mts_no0Sd_no0Sd_dcast, "spoken_mts_no0Sd_no0Sd_dcast.csv")
write_csv(spoken_mts_no0Sd_no0Sd_dcast_2, "spoken_mts_no0Sd_no0Sd_dcast2.csv")

```


random forest analysys and plots

```{r}
library(caret)
 trainIndex_spoken <- createDataPartition(spoken_mts_no0Sd_no0Sd_dcast_2$expression, p = .8, 
                                  list = FALSE, 
                                  times = 1)
  
 trainIndex_spoken
  
 
 spoken_train_set <- spoken_mts_no0Sd_no0Sd_dcast_2[ trainIndex_spoken,]
  spoken_test_set  <- spoken_mts_no0Sd_no0Sd_dcast_2[-trainIndex_spoken,]
  
# train
  
   spoken_r.forest_mts <- train(expression ~ PC1 + PC2 + PC3, 
                data = spoken_train_set, 
                method = "rf",
                trControl = trainControl(method = "oob"),
                ntree = 73)
   
   
   # test
   # spoken_r.forest_mts$finalModel$mtry 
   
   
spoken_test_set$prediction <- predict(spoken_r.forest_mts, spoken_test_set)
   
spoken_test_set_res<- confusionMatrix(spoken_test_set$prediction , as.factor(spoken_test_set$expression), mode = "everything", positive="1")
   
   

```


boundary plots

```{r}


spoken_rf <-randomForest::randomForest(as.factor(expression) ~ PC1 + PC2 + PC3, 
                                       data = spoken_mts_no0Sd_no0Sd_dcast_2,
                   proximity = TRUE,
                   ntree = 73
                   # mtry = 2
                   )


  
  spoken_rf <- train(expression ~ PC1 + PC2 + PC3, 
                data = spoken_mts_no0Sd_no0Sd_dcast_2, 
                method = "rf",
                ntree = 73,
               proximity = TRUE)
  
# 
# Now we just create a grid of all x, y values in the range of the data using expand.grid, and get the predicted species at each pair:
bind_train_test

# breask
getPrettyAxisBreaks(spoken_mts_no0Sd_no0Sd_dcast_2$PC1)
# min max
x_min_sp <- min(spoken_mts_no0Sd_no0Sd_dcast_2$PC1 + 0.5)
x_max_sp <- max(spoken_mts_no0Sd_no0Sd_dcast_2$PC1 + 0.5)

y_min_sp <- min(spoken_mts_no0Sd_no0Sd_dcast_2$PC2 + 0.5)
y_max_sp <- max(spoken_mts_no0Sd_no0Sd_dcast_2$PC2 + 0.5)

z_min_sp <- min(spoken_mts_no0Sd_no0Sd_dcast_2$PC3 + 0.5)
z_max_sp <- max(spoken_mts_no0Sd_no0Sd_dcast_2$PC3 + 0.5)

  # breaks
xBreaks_sp <- getPrettyAxisBreaks(spoken_mts_no0Sd_no0Sd_dcast_2$PC1, min.n = 4)
  
yBreaks_sp <- getPrettyAxisBreaks(spoken_mts_no0Sd_no0Sd_dcast_2$PC2, min.n = 4)
zBreaks_sp <- getPrettyAxisBreaks(spoken_mts_no0Sd_no0Sd_dcast_2$PC3, min.n = 4)
  
  x_min_sp <- xBreaks_sp[1]
  x_max_sp <- xBreaks_sp[length(xBreaks_sp)]
  y_min_sp <- yBreaks_sp[1]
  y_max_sp <- yBreaks_sp[length(yBreaks_sp)]
  
   z_min_sp <- zBreaks_sp[1]
  z_max_sp <- zBreaks_sp[length(zBreaks_sp)]
  # Adjust the graining
  hs_sp <- min(c(diff(range(xBreaks_sp)), diff(range(yBreaks_sp)))) / 50
  hs_z_sp <- min(c(diff(range(yBreaks_sp)), diff(range(zBreaks_sp)))) / 50
  
  # grid_sp <- as.data.frame(expand.grid(seq(x_min_sp, x_max_sp, by = hs_sp), 
  #                                   seq(y_min_sp, y_max_sp, by = hs_sp),
  #                                   seq(z_min_sp, z_max_sp, by = hs_z_sp),
  #                                   ))
  

df_sp <- expand.grid(PC1 = seq(x_min_sp, x_max_sp, 
                                            by = hs_sp
                            # length.out = 100
                            ),
                  PC2 = seq(y_min_sp, y_max_sp,
                                              by = hs_sp
                           # length.out = 100 
                           ),
                  
                  PC3 = seq(z_min_sp, z_max_sp ,
                                             by = hs_z_sp
                            # length.out = 100
                            )
                  )

df_sp



df_sp$expression <- predict(spoken_rf, df)

  
ggplot(df_sp, aes(PC1, PC2,fill = expression)) +

  geom_tile(aes(fill = expression),alpha = 0.01, size = 0) +
  # stat_contour(data = df,aes(x =PC1, y =PC2, z = expression))
   geom_point(data =spoken_mts_no0Sd_no0Sd_dcast_2,aes( colour =expression,fill = expression),size = 3) +
  geom_point(data = spoken_mts_no0Sd_no0Sd_dcast_2, shape = 21, size = 3) +
  # theme_minimal()
  # theme_void()+

  theme_bw() +
      plot_style+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
    # scale_color_viridis_d()+
    # scale_fill_viridis_d()+
  # theme(panel.border = element_blank(),
  #      panel.grid.major = element_blank(),
  #      panel.grid.minor = element_blank())+
  base_breaks_x(df$PC1) +
  base_breaks_y(df$PC2)+
  ylab("comp2")+
  xlab("comp1")



boundaryplots$pc1_2_ggside_sp
library(ggside)


df_sp$expression<- factor(df_sp$expression, levels = c('angry', 'happy', 'sad', 'neutral'))
spoken_mts_no0Sd_no0Sd_dcast_2$expression<- factor(spoken_mts_no0Sd_no0Sd_dcast_2$expression, levels = c('angry', 'happy', 'sad', 'neutral'))


ggplot(df_sp, aes(PC1, PC2,fill = expression)) +

  geom_tile(aes(fill = expression),alpha = 0.01, size = 0) +
   geom_point(data =spoken_mts_no0Sd_no0Sd_dcast_2,aes( colour =expression,fill = expression),size = 3) +
  geom_point(data = spoken_mts_no0Sd_no0Sd_dcast_2, shape = 21, size = 3) +
  
  geom_ysideboxplot(data = spoken_mts_no0Sd_no0Sd_dcast_2,aes(x = expression,colour =expression), orientation = "x",alpha = .5)+
  scale_ysidex_discrete(guide = guide_axis(angle = 90))+
  geom_xsidedensity(data = spoken_mts_no0Sd_no0Sd_dcast_2,aes(fill = expression,colour =expression), alpha = .5,show.legend =FALSE)+
   scale_xsidey_continuous(breaks = NULL)+
  # theme(axis.text.x = element_text(size = 10))+
  theme_bw() +
      plot_style+
     # scale_ysidex_discrete(guide = guide_axis(angle = 90))+
     theme(ggside.panel.scale = .2)+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+

  base_breaks_x(df$PC1) +
  base_breaks_y(df$PC2)+
  xlab("comp1")+
  ylab("comp2")


ggplot(df_sp, aes(PC2, PC3,fill = expression)) +

  geom_tile(aes(fill = expression),alpha = 0.01, size = 0) +
   geom_point(data =spoken_mts_no0Sd_no0Sd_dcast_2,aes( colour =expression,fill = expression),size = 3) +
  geom_point(data = spoken_mts_no0Sd_no0Sd_dcast_2, shape = 21, size = 3) +
  
  geom_ysideboxplot(data = spoken_mts_no0Sd_no0Sd_dcast_2,aes(x = expression,colour =expression), orientation = "x",alpha = .5)+
  scale_ysidex_discrete(guide = guide_axis(angle = 90))+
  geom_xsidedensity(data = spoken_mts_no0Sd_no0Sd_dcast_2,aes(fill = expression,colour =expression), alpha = .5,show.legend =FALSE)+
   scale_xsidey_continuous(breaks = NULL)+
  # theme(axis.text.x = element_text(size = 10))+
  theme_bw() +
      plot_style+
     # scale_ysidex_discrete(guide = guide_axis(angle = 90))+
     theme(ggside.panel.scale = .2)+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+

  base_breaks_x(df$PC2) +
  base_breaks_y(df$PC3)+
  xlab("comp2")+
  ylab("comp3")


ggplot(df_sp, aes(PC3, PC1,fill = expression)) +

  geom_tile(aes(fill = expression),alpha = 0.01, size = 0) +
   geom_point(data =spoken_mts_no0Sd_no0Sd_dcast_2,aes( colour =expression,fill = expression),size = 3) +
  geom_point(data = spoken_mts_no0Sd_no0Sd_dcast_2, shape = 21, size = 3) +
  
  geom_ysideboxplot(data = spoken_mts_no0Sd_no0Sd_dcast_2,aes(x = expression,colour =expression), orientation = "x",alpha = .5)+
  scale_ysidex_discrete(guide = guide_axis(angle = 90))+
  geom_xsidedensity(data = spoken_mts_no0Sd_no0Sd_dcast_2,aes(fill = expression,colour =expression), alpha = .5,show.legend =FALSE)+
   scale_xsidey_continuous(breaks = NULL)+
  # theme(axis.text.x = element_text(size = 10))+
  theme_bw() +
      plot_style+
     # scale_ysidex_discrete(guide = guide_axis(angle = 90))+
     theme(ggside.panel.scale = .2)+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+

  base_breaks_x(df$PC3) +
  base_breaks_y(df$PC1)+
  xlab("comp3")+
  ylab("comp1")

```


Heat map

ROCR

