---
title: "analysys_halofacestudy"
author: "Helio"
date: "06/06/2022"
output: html_document
---


dependencies: preprocss_halofaces.Rmd
df_OF_output_AUsW_unblind_posed



for the actual analyses we want
1- learn spatiotemporal structure suing NMF
2 - does drug vs no drug differ in NMF metrics?
3- can we separate groups based on NMF components using BADIA

spatiotemporal dynamics
- movement substates (initiation, sustainement, etc)
- if we use kmean clustering, do we have differences into how many substaes are there
- or if we use a fixed number of substaes, are there significant temporal differences (e.g. duration, reccurence)

preferences
```{r}
library(tidyverse)
library(data.table)

library(NMF)

```


Steps and decision
initialisation = random seed
find k
set iteratiions
fit final


fit drug and placebo separatelly?
```{r}
# Initialise and find k

colnames(df_OF_output_AUsW_unblind_posed_binned)


df_OF_output_AUsW_unblind_posed_binned

# single run and single numeric seed for reproducibility
res_find_k <- nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], 2:6, 
                      seed=123456,
                      nrun = 100,
                       .options = 'v')

summary(res_find_k)

# plot quality measures by rank (k)
NMF::plot(res_find_k)+
  geom_vline(xintercept = 3)

# ?NMF::consensusmap
NMF::consensusmap(res_find_k)


```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

between 3 and 4

Check for overfiting by reshufling the ata and refitting the NMF on simulated data
SHUFFLING to avoid overfiting to noise

```{r}
# shuffle original data 
colnames(df_OF_output_AUsW_unblind_posed_binned)

V.random <- randomize(df_OF_output_AUsW_unblind_posed_binned[,16:32]) 

# estimate quality measures from the shuffled data (use default NMF algorithm) 
estim.k.random <- nmf(V.random, 2:6, nrun=100, seed=123456,
                      .option = 'v') 

# then we can assess the quality of random estimation to our estimation

# plot measures on same graph (x, y) 
plot(res_k3, estim.k.random) + 
  geom_vline(xintercept = 3)


```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

```{r}

res_k3 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


plot(res_k3)
summary(res_k3)

# basis components 
NMF::basismap(res_k3) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3) #hidden variables

# access more info
# res_k3_em

res_k4 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 
coefmap(res_k4) 


```






Combine the data and visualise
```{r}
res_k3@fit@H

df_OF_output_AUsW_unblind_posed_binned$NMFtable<- as.data.frame(res_k3@fit@W)

df_OF_output_AUsW_unblind_posed_binned$comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V1
table(is.na(df_OF_output_AUsW_unblind_posed_binned$comp1))
df_OF_output_AUsW_unblind_posed_binned$comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V2
df_OF_output_AUsW_unblind_posed_binned$comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V3

# for k  = 4
df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4<- as.data.frame(res_k4@fit@W)
df_OF_output_AUsW_unblind_posed_binned$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V4



# visualization by emotion
colnames(df_OF_output_AUsW_unblind_posed_binned)
# bind_rows(db_of_natural1, db_of_morph)
colnames(df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,16:32,34:36)])
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  facet_grid(~component)+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(~component)+
  theme_classic()



```


same as above for  k 4

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  facet_grid(~component)+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()


```

aggregate solution
```{r}
library(lmerTest)

# test_lmer<- lmer()
df_OF_output_AUsW_unblind_posed_binned

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
  
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")



```

same as above for k4

```{r}
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
  
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")


```



we can also do classification on this

```{r}
# combine the datasets keep timbeins and stimuli
nmf_agg_ts_tb<-bind_rows(db_of_natural1, db_of_morph)[,c(1,2:5,31:33)]%>%
  # gather( component, coef, -timebin,-Emotion, -Dataset, -morph, -filename)%>%
  group_by(filename,timebin, Emotion, Dataset, morph)%>%
  summarise_at(c("comp1", "comp2", "comp3"), mean, na.rm = TRUE)

# combine datasets and aggregate over time bins
nmf_agg_ts <- bind_rows(db_of_natural1, db_of_morph)[,c(1,2:5,31:33)]%>%
  # gather( component, coef, -timebin,-Emotion, -Dataset, -morph, -filename)%>%
  group_by(filename, Emotion, Dataset, morph)%>%
  summarise_at(c("comp1", "comp2", "comp3"), mean, na.rm = TRUE)

# save 
write_csv(nmf_agg_ts, "nmf_agg_ts.csv")
write_csv(nmf_agg_ts_tb, "nmf_agg_ts_tb.csv")


```



do we get different patterns if we fit placebo and drug separate;;u




visualisations
- differences between emotions on the components
- differences between drug vs no drug?
- classification - can we classify drug vs no drug based in these components


```{r}



```


do the same for aggregated data

Visualize learned components by variables of interest (emotion, datadet, etc)


aggregate the solution





2 - substates in movement - 



do