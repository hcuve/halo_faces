---
title: "analysys_halofacestudy"
author: "Helio"
date: "06/06/2022"
output: html_document
---


dependencies: preprocss_halofaces.Rmd
df_OF_output_AUsW_unblind_posed



for the actual analyses we want
1- learn spatiotemporal structure suing NMF
2 - does drug vs no drug differ in NMF metrics?
3- can we separate groups based on NMF components using BADIA

spatiotemporal dynamics
- movement substates (initiation, sustainement, etc)
- if we use kmean clustering, do we have differences into how many substaes are there
- or if we use a fixed number of substaes, are there significant temporal differences (e.g. duration, reccurence)

preferences
```{r}
library(tidyverse)
library(data.table)

library(NMF)

```


Steps and decision
initialisation = random seed
find k
set iteratiions
fit final


fit drug and placebo separatelly?
```{r}
# Initialise and find k

colnames(df_OF_output_AUsW_unblind_posed_binned)


df_OF_output_AUsW_unblind_posed_binned

# single run and single numeric seed for reproducibility
res_find_k <- nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], 2:6, 
                      seed=123456,
                      nrun = 100,
                       .options = 'v')

summary(res_find_k)

# plot quality measures by rank (k)
NMF::plot(res_find_k)+
  geom_vline(xintercept = 3)

# ?NMF::consensusmap
NMF::consensusmap(res_find_k)


```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

between 3 and 4

Check for overfiting by reshufling the ata and refitting the NMF on simulated data
SHUFFLING to avoid overfiting to noise

```{r}
# shuffle original data 
colnames(df_OF_output_AUsW_unblind_posed_binned)

V.random <- randomize(df_OF_output_AUsW_unblind_posed_binned[,16:32]) 

# estimate quality measures from the shuffled data (use default NMF algorithm) 
estim.k.random <- nmf(V.random, 2:6, nrun=100, seed=123456,
                      .option = 'v') 

# then we can assess the quality of random estimation to our estimation

# plot measures on same graph (x, y) 
plot(res_k3, estim.k.random) + 
  geom_vline(xintercept = 3)


```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

```{r}

res_k3 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


plot(res_k3)
summary(res_k3)

# basis components 
NMF::basismap(res_k3) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3) #hidden variables

# access more info
# res_k3_em

res_k4 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 
coefmap(res_k4) 


```






Combine the data and visualise
```{r}
res_k3@fit@H

df_OF_output_AUsW_unblind_posed_binned$NMFtable<- as.data.frame(res_k3@fit@W)

df_OF_output_AUsW_unblind_posed_binned$comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V1
table(is.na(df_OF_output_AUsW_unblind_posed_binned$comp1))
df_OF_output_AUsW_unblind_posed_binned$comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V2
df_OF_output_AUsW_unblind_posed_binned$comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V3

# for k  = 4
df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4<- as.data.frame(res_k4@fit@W)
df_OF_output_AUsW_unblind_posed_binned$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V4



# visualization by emotion
colnames(df_OF_output_AUsW_unblind_posed_binned)
# bind_rows(db_of_natural1, db_of_morph)
colnames(df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,16:32,34:36)])
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  facet_grid(~component)+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(~component)+
  theme_classic()



```


same as above for  k 4

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  facet_grid(~component)+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()


```

aggregate solution
```{r}
library(lmerTest)

# test_lmer<- lmer()
df_OF_output_AUsW_unblind_posed_binned

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
  
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")



```

same as above for k4

```{r}
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
  
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")


```




do we get different patterns if we fit placebo and drug separately

```{r}
# df_OF_output_AUsW_unblind_posed_binned[df_OF_output_AUsW_unblind_posed_binned$drug.placebo == "drug"] 
#   subset(drug.placebo == "drug")[,16:32]

colnames(df_OF_output_AUsW_unblind_posed_binned)
# df_OF_output_AUsW_unblind_posed_binned$drug.placebo

df_OF_output_AUsW_unblind_posed_binned_drug<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "drug")%>%
                         ungroup()%>%
                         select(16:32)


df_OF_output_AUsW_unblind_posed_binned_placebo<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "placebo")%>%
                         ungroup()%>%
                         select(16:32)

res_k3_drug <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_drug,
                       r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


plot(res_k3_drug)
summary(res_k3_drug)

# basis components 
NMF::basismap(res_k3_drug) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3)
coefmap(res_k3_drug) #hidden variables

# access more info
# res_k3_drug

res_k4_drug <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_drug, r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 
coefmap(res_k4) 
NMF::basismap(res_k4_drug) 
coefmap(res_k4_drug) 

# very similar so far
# now fit placebo

res_k3_placebo <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_placebo,
                       r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


# plot(res_k3_placebo)
# summary(res_k3_placebo)

# basis components 
NMF::basismap(res_k3) 
NMF::basismap(res_k3_placebo) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3)
coefmap(res_k3_placebo) #hidden variables

# access more info
# res_k3_drug

res_k4_placebo <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_placebo, r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 

NMF::basismap(res_k4_placebo) 
coefmap(res_k4) 
coefmap(res_k4_placebo)





# visualisations
# - differences between emotions on the components
# - differences between drug vs no drug?
# - classification - can we classify drug vs no drug based in these components
# 
# 


```

now visualise joint NMF vs separate NMFS

```{r}
df_OF_output_AUsW_unblind_posed_binned_drug
df_OF_output_AUsW_unblind_posed_binned_placebo

# lets store the components frm k 4

df_OF_output_AUsW_unblind_posed_binned_drug

df_OF_output_AUsW_unblind_posed_binned_drug<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "drug")
                         # ungroup()%>%
                         # select(16:32)

df_OF_output_AUsW_unblind_posed_binned_placebo<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo != "drug")

df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4<- as.data.frame(res_k4_drug@fit@W)

# for drug set
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V4

# for placebo set
df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4<- as.data.frame(res_k4_placebo@fit@W)

df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V4



# compare vis for joint vs separwte NMF results

# start with selectign drug

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  subset(drug.placebo == "drug")%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(~expression)+
  theme_classic()

colnames(df_OF_output_AUsW_unblind_posed_binned_drug)
# forgot to store the combined data with info

df_OF_output_AUsW_unblind_posed_binned_drug[,c(2:3,9:10,38:41)]%>%
  # subset(drug.placebo == "drug")%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(~expression)+
  theme_classic()



df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(drug.placebo~expression)+
  theme_classic()

bind_rows(df_OF_output_AUsW_unblind_posed_binned_drug,df_OF_output_AUsW_unblind_posed_binned_placebo)[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(drug.placebo~expression)+
  theme_classic()
  
  


  
  
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")



bind_rows(df_OF_output_AUsW_unblind_posed_binned_drug,df_OF_output_AUsW_unblind_posed_binned_placebo)[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")

# this plot is deceiving as the compents shift order
# overall the patterns are the same_src(
# so its better to fit in one go to abvoid flips in compoent orders
```


we can also do classification on this
i.e. knowing the spatiotemporal components can we predict whether a condition is drug vs placebo

```{r}
df_OF_output_AUsW_unblind_posed_binned

colnames(df_OF_output_AUsW_unblind_posed_binned)
# combine the datasets keep timbeins and stimuli
nmfk4_agg_no_ts <- df_OF_output_AUsW_unblind_posed_binned%>%
  ungroup()%>%
  select(c(3,9:10,16:41))%>%
  # gather( component, coef, -timebin,-Emotion, -Dataset, -morph, -filename)%>%
  group_by(subject,drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

nmfk4_agg_no_ts

# combine datasets and aggregate over time bins
# nmf_agg_ts <- bind_rows(db_of_natural1, db_of_morph)[,c(1,2:5,31:33)]%>%
#   group_by(filename, Emotion, Dataset, morph)%>%
#   summarise_at(c("comp1", "comp2", "comp3"), mean, na.rm = TRUE)
# 
# # save 
write_csv(nmfk4_agg_no_ts, "nmfk4_agg_no_ts.csv")
# write_csv(nmf_agg_ts_tb, "nmf_agg_ts_tb.csv")


```
before we do for classification and clustering
let's do BADIA

```{r}
# start with the dimensions
colnames(nmfk4_agg_no_ts)
# drug no drug

bada_models<-list()
bada_models$drug_nodrug<- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$drug.placebo),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# based on emotion
bada_models$emotion <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)


# based on AUS
colnames(nmfk4_agg_no_ts)
bada_models$drug_nodrug_fromAUS<- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,4:20], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$drug.placebo),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)


bada_models$emotion_fromAUS <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,4:20], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)



# do placebo vs  drug separately
nmfk4_agg_no_ts_drug<-subset(nmfk4_agg_no_ts, drug.placebo == "drug")
nmfk4_agg_no_ts_plac<-subset(nmfk4_agg_no_ts, drug.placebo != "drug")

colnames(nmfk4_agg_no_ts_drug)
bada_models$drug_emotion_NMF <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts_drug[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts_drug$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# lacebo

bada_models$placebo_emotion_NMF <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts_plac[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts_plac$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned_drug<-subset(df_OF_output_AUsW_unblind_posed_binned, drug.placebo  =="drug")

bada_models$ts_drug<- TInPosition::tepBADA.inference.battery(df_OF_output_AUsW_unblind_posed_binned_drug[,38:41], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(df_OF_output_AUsW_unblind_posed_binned_drug$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 100, 
                                                       critical.value = 2)

df_OF_output_AUsW_unblind_posed_binned$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned$subject)

summary(lmer(k4_comp3 ~ 1 + expression*drug.placebo +(1+drug.placebo|subject),
             REML = FALSE,
     data  =df_OF_output_AUsW_unblind_posed_binned))

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(subject, expression, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo, k4_comp4))+
  geom_boxplot(alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group =subject), method = "lm", se  =F, sie = 1, alpha = .1)+
  facet_grid(~expression)


```


movement subspaces
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)
unique(df_OF_output_AUsW_unblind_posed_binned$filename)

df_OF_output_AUsW_unblind_posed_binned %>%
  ungroup()%>%
  subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:41))%>%
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame)%>%
  group_by( component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef, color = component))+
  geom_line()+
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


library(zoo)

df_OF_output_AUsW_unblind_posed_binned

??zoo::rollmean

install.packages("RcppRoll")
library(RcppRoll)
RcppRoll::roll_mean(df_OF_output_AUsW_unblind_posed_binned$k4_comp4)
??RcppRoll::roll_mean

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(filename)%>%
   dplyr::mutate(comp1_k3 = rollmean(k4_comp1, k = 10, fill = NA),
                 comp2_k3 = rollmean(k4_comp2, k = 10, fill = NA),
                 comp3_k3 = rollmean(k4_comp3, k = 10, fill = NA),
                 comp4_k3 = rollmean(k4_comp4, k = 10, fill = NA)) %>%
    # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
ungroup%>%
  select(subject, bin_frame,expression, drug.placebo, comp1_k3,comp2_k3,comp3_k3, comp4_k3)%>%
  gather(component, coef,-bin_frame,-subject, -expression, -drug.placebo) %>%

  ggplot(aes(bin_frame, coef, color =drug.placebo ))+
  # geom_line()+
  geom_smooth(se = F)+
  facet_grid(component~expression)+
  theme_classic()
  
  
  geom_line()+
  geom_line(aes(y = k4_comp3), color = "red")+
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()






                 comp3_k5 = roll_mean(k4_comp3, n = 5),
                 comp3_k10 = roll_mean(k4_comp3, n = 10),
                comp3_k15 = roll_mean(k4_comp3, n = 15),
                 comp3_k20 = roll_mean(k4_comp3, n = 20))


# lets do a moving average o the signals

```
classify substates

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)
p1_angry<- df_OF_output_AUsW_unblind_posed_binned %>%
  ungroup()%>%
  subset(filename == "./cut_posed_angry_day1_p1.csv")

set.seed(1)
wcss = vector()
colnames(p1_angry)
# for (i in 1:10) wcss[i] = sum(kmeans(p1_angry[,38:41], i)$withinss)
# plot(1:10,
#      wcss,
#      type = 'b',
#      main = paste('The Elbow Method'),
#      xlab = 'Number of clusters',
#      ylab = 'WCSS')
# 
# # Fitting K-Means to the dataset
# set.seed(25)
# kmeans = kmeans(x = clust_dataset, centers = 3)
# y_kmeans = kmeans$cluster
# 
# # Visualising the clusters
# # install.packages("cluster")
# library(cluster)
# 
# ?clusplot
# 
# clust_dataset
# y_kmeans
# clusplot(clust_dataset,
#          y_kmeans,
#          lines = 2,
#          shade = TRUE,
#          color = TRUE,
#          labels = 1,
#          plotchar = FALSE,
#          span = TRUE
#          # label = 
#          # main = paste('Clusters of customers'),
#          # xlab = 'Annual Income',
#          # ylab = 'Spending Score'
#          )
?kmeans


p1_angry <-p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k4_comp1_speed = (abs(lag(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)),
         k4_comp2_speed = (abs(lag(k4_comp2) - k4_comp2))/abs((lead(bin_frame)-bin_frame)),
         k4_comp3_speed = (abs(lag(k4_comp3) - k4_comp3))/abs((lead(bin_frame)-bin_frame)),
         k4_comp4_speed = (abs(lag(k4_comp4) - k4_comp4))/abs((lead(bin_frame)-bin_frame)),
         )

colnames(p1_angry)



replace_na(list(p1_angry=0, y = 0))
p1_angry<-as.data.frame(p1_angry)
p1_angry[is.na(p1_angry)] <-0

p1_angry[is.na(p1_angry)] <- 0




p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:42))%>%
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame,-kmean_order)%>%
  group_by( component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


# lets compute speed
colnames(p1_angry)
p1_angry<- p1_angry %>%
mutate_at(c(43:46), ~replace(., is.na(.), 0))
  


testk$cluster
testk<-kmeans(p1_angry[,38:41], 3)
colnames(p1_angry)

p1_angry_kmean_clust<- kmeans(p1_angry[,38:41], 3)
p1_angry_kmean_clust_speed<- kmeans(p1_angry[,43:46], 3)
p1_angry$kmean_order<- p1_angry_kmean_clust$cluster
p1_angry$kmean_order_speed<- p1_angry_kmean_clust_speed$cluster

p1_angry$kmean_center<- p1_angry_kmean_clust$cluster
# based on dist and speed
p1_angry_kmean_clust_speed_dist<- kmeans(p1_angry[,c(38:41,43:46)], 3)
p1_angry$kmean_order_dist_speed<- p1_angry_kmean_clust_speed_dist$cluster


# plot cluster absed on component weights
colnames(p1_angry)
p1_angry%>%
ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:42))%>%
  # mutate(k4_comp1_speed = (abs(lead(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)))%>%
  
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame,-kmean_order)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

# based on speed

# colnames(p1_angry)
p1_angry%>%
ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,43:47))%>%
  # mutate(k4_comp1_speed = (abs(lead(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)))%>%
  
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame,-kmean_order_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

# p1_angry$kmean_order_dist_speed<- as.integer(as.factor(as.character(p1_angry$kmean_order_dist_speed))

# duplicated(p1_angry$kmean_order_dist_speed)
p1_angry%>%
ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:41, 43:46, 48))%>%
  # mutate(k4_comp1_speed = (abs(lead(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)))%>%
  
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame,-kmean_order_dist_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_dist_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()





```
# what we need to do is for every person run a loop that first for each trial a kmean,

algorithymim from 2 to 10 and 
store
- kmean result cluster in each itteration

we need a list that will store unique trial name + number of K+ resulting k object


```{r}


<- unique(df_OF_output_AUsW_unblind_posed_binned$filename)
# 228

store_kmeans<- list()

len <- 5
empty_list <- vector(mode = "list", length = length(unique_trial))

empty_list
class(empty_list)



colnames(df_OF_output_AUsW_unblind_posed_binned)
# compute the speed metrics
df_OF_output_AUsW_unblind_posed_binned<-
df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(filename)%>%
    mutate(k4_comp1_speed = (abs(lag(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)),
         k4_comp2_speed = (abs(lag(k4_comp2) - k4_comp2))/abs((lead(bin_frame)-bin_frame)),
         k4_comp3_speed = (abs(lag(k4_comp3) - k4_comp3))/abs((lead(bin_frame)-bin_frame)),
         k4_comp4_speed = (abs(lag(k4_comp4) - k4_comp4))/abs((lead(bin_frame)-bin_frame)),
         )%>%
  mutate_at(c("k4_comp1_speed", "k4_comp2_speed", "k4_comp3_speed", "k4_comp4_speed"), ~replace(., is.na(.), 0))


colnames(df_OF_output_AUsW_unblind_posed_binned)



empty_list<- list()
list

r = 1
rm(u)
rm(k)
# rm(r)

u = 2

# loop over data and ks
# for (u in 1: length(unique_trial)) {
#   # u=1
#    temp_df<- subset(df_OF_output_AUsW_unblind_posed_binned,filename == unique_trial[u])[,38:45]
# 
#   # k=1
#        # r = u+r
#   for (k in 2:10) {
# 
#     empty_list[[r]] = kmeans(temp_df, k)
#     r = r+1
#   }
#   
#   }

# for now loop oover peple but fit the same k = 3

# create an id that matches what we have in the loop
df_OF_output_AUsW_unblind_posed_binned$idno<- rep(1:228, each = 100)

k3_list<- list()
df_OF_output_AUsW_unblind_posed_binned$clust3<- NA

for (u in 1: length(unique_trial)) {
  # subset each trail on every run
   temp_df<- subset(df_OF_output_AUsW_unblind_posed_binned,filename == unique_trial[u])[,38:45]

       # r = u+r
  # for (k in 2:10) {
    k3_list[[u]] = kmeans(temp_df, 3)
    df_OF_output_AUsW_unblind_posed_binned$clust3[df_OF_output_AUsW_unblind_posed_binned$idno == u] <- k3_list[[u]]$cluster
    # r = r+1
}

transform(k3_list[[1]]$cluster, id = as.numeric(factor(k3_list[[1]]$cluster)))
# create a unique value for new values ina. column in r

df2 <- transform(df,id=as.numeric(factor(sample)))

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(filename)%>%
  group_indices(clust3)
  transform(id = as.numeric(factor(clust3)))
  
  
  




```


  message(sprintf("$$$$$RUNING kmean %i", i))
  
  
  
  resampled_temp_test<- fabricatr::resample_data(clustering_new_pre_PCA3.1 [,c(1,2,3, 5:9)], 
                                  N = c(51,55),
                                  ID_labels = c("ssid", "stimDescription"),
                                  unique_labels = TRUE)
  resampled_temp$sim_no = i
  
# run PCA on the resampled data
# ?list
    message(sprintf("$$$$$fitting PCA %i", i))
mfa.res_res <- FactoMineR::MFA(resampled_temp[,1:8], 
               group = c(3, 3, 2), 
               type = c("n", "s", "s"),
              # ind.sup = c(1),
              ncp = 2,
               name.group = c("pp_stim","auton","subj"),
               num.group.sup = c(1),
               # ind.sup = c(1,2),
               graph = FALSE)


# store the eigen values
  message(sprintf("$$$$$storing PCA %i", i))
eugentest<- as.data.frame(mfa.res_res$eig[1:2,])
eugentest$sim_no<- i

cortest<- as.data.frame(mfa.res_res$quanti.var$cor)
cortest$sim_no = i

partials_temp<- as.data.frame(res.mfa_bio_vs_self2_k2$partial.axes$cor)
partials_temp$sim_no = i
# update the initial d=frames
  message(sprintf("$$$$$upating dataframes %i", i))
  resamp_1st<- (bind_rows(resamp_1st, resampled_temp))
eigen_first<- bind_rows(eigen_first, eugentest)
cor_first<- bind_rows(cor_first, cortest)
partials_first<- bind_rows(partials_first, partials_temp)
  message(sprintf("$$$$$completed iteration%i", i))
}



```

store the cluster
