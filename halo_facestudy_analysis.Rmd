---
title: "analysys_halofacestudy"
author: "Helio"
date: "06/06/2022"
output: html_document
---


dependencies: preprocss_halofaces.Rmd
df_OF_output_AUsW_unblind_posed



for the actual analyses we want
1- learn spatiotemporal structure suing NMF
2 - does drug vs no drug differ in NMF metrics?
3- can we separate groups based on NMF components using BADIA

spatiotemporal dynamics
- movement substates (initiation, sustainement, etc)
- if we use kmean clustering, do we have differences into how many substaes are there
- or if we use a fixed number of substaes, are there significant temporal differences (e.g. duration, reccurence)

preferences
```{r}
library(tidyverse)
library(data.table)

library(NMF)

```


Steps and decision
initialisation = random seed
find k
set iterations
fit final


fit drug and placebo separatelly?
```{r}
# Initialise and find k

colnames(df_OF_output_AUsW_unblind_posed_binned)


df_OF_output_AUsW_unblind_posed_binned

# single run and single numeric seed for reproducibility
res_find_k <- nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], 2:6, 
                      seed=123456,
                      nrun = 100,
                       .options = 'v')

summary(res_find_k)

# plot quality measures by rank (k)
NMF::plot(res_find_k)+
  geom_vline(xintercept = 3)

# ?NMF::consensusmap
NMF::consensusmap(res_find_k)

colnames(df_OF_output_AUsW_unblind_posed_binned)
```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

between 3 and 4

Check for overfiting by reshufling the ata and refitting the NMF on simulated data
SHUFFLING to avoid overfiting to noise

```{r}
# shuffle original data 
colnames(df_OF_output_AUsW_unblind_posed_binned)

V.random <- randomize(df_OF_output_AUsW_unblind_posed_binned[,16:32]) 

# estimate quality measures from the shuffled data (use default NMF algorithm) 
estim.k.random <- nmf(V.random, 2:6, nrun=100, seed=123456,
                      .option = 'v') 

# then we can assess the quality of random estimation to our estimation

# plot measures on same graph (x, y) 
plot(res_k3, estim.k.random) + 
  geom_vline(xintercept = 3)

res_k3@
```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

```{r}

colnames(df_OF_output_AUsW_unblind_posed_binned)
df_OF_output_AUsW_unblind_posed_binned$AU01_r_Inner_brow_raiser

res_k3 <- NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


# normalised by max

colnames(df_OF_output_AUsW_unblind_posed_binned[,16:32])

# dcast time to columns
colnames(df_OF_output_AUsW_unblind_posed_binned[,c(1:3,9:10,16:32)])

# funtion to normalise bmax
maxnorm<-function(m){
   (m/max(m, na.rm = T))}

maxnorm(c(1,2,4,44))


df_OF_output_AUsW_unblind_posed_binned$filename<- as.factor(df_OF_output_AUsW_unblind_posed_binned$filename)
colnames(df_OF_output_AUsW_unblind_posed_binned)


for_norm<- df_OF_output_AUsW_unblind_posed_binned[,c(16:32)]+.001

for_norm$filename<-df_OF_output_AUsW_unblind_posed_binned$face_id

df_OF_output_AUsW_unblind_posed_binned_max_norm<- for_norm%>%
  ungroup()%>%
  group_by(filename)%>%
  mutate_if(is.numeric, maxnorm)
  # mutate_at(AU01_r_Inner_brow_raiser:AU45_r_Blink, maxnorm)

table(is.na(df_OF_output_AUsW_unblind_posed_binned[,c(1,16:32)]))
table(is.na(df_OF_output_AUsW_unblind_posed_binned_max_norm))
# new NMF
df_OF_output_AUsW_unblind_posed_binned_max_norm


res_k3_max_norm <- NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_max_norm[,1:17], r = 3, 
                  nrun = 150, 
                  seed=123456,
                 .options = list( 'v')) #


```




# PCA version for comparison

```{r}
   library(prettyGraphs)
   library(InPosition)

df_OF_output_AUsW_unblind_posed_binned
df_OF_output_AUsW_unblind_posed_binned_max_norm
   
table(is.na(df_OF_output_AUsW_unblind_posed_binned_max_norm[,2:18]))
   var.pca<- InPosition::epPCA.inference.battery(df_OF_output_AUsW_unblind_posed_binned_max_norm[,2:18], 
                                       scale = FALSE, 
                                       center = FALSE, 
                                       # DESIGN = var.design1,
                                       # make_design_nominal = TRUE, 
                                       graphs = TRUE, 
                                       k = 3, 
                                       test.iters = 100, 
                                       constrained = FALSE, 
                                       critical.value = 2)


   df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()
   scale_color_viridis_d(option = "magma")
   
   
   
  df_OF_output_AUsW_unblind_posed_binned$PCA_comp1<- var.pca$Fixed.Data$ExPosition.Data$fi[,1] 
  
    df_OF_output_AUsW_unblind_posed_binned$PCA_comp2<- var.pca$Fixed.Data$ExPosition.Data$fi[,2] 
    
      df_OF_output_AUsW_unblind_posed_binned$PCA_comp3<- var.pca$Fixed.Data$ExPosition.Data$fi[,3] 
      
      
      colnames(df_OF_output_AUsW_unblind_posed_binned)
      
      
     
      
      
      
      
pca_AUs<- as.data.frame(var.pca$Fixed.Data$ExPosition.Data$fj)

pca_AUs$AU<- rownames(pca_AUs)
# as.data.frame(res_k3@fit@H)


normalize <- function(x, na.rm = TRUE) {
    return((x- min(x)) /(max(x)-min(x)))
}

chool_talk$pca_AU <- pca_AUs%>%
  # mutate(component = rownames()) %>%
  gather(component, coef, -AU)%>%
  group_by(component)%>%
  mutate_at(c("coef"), normalize)%>%
  # mutate(max_comp = max(coef),
         # coef = coef/max_comp)%>%
  #        # AU = substring(AU,8,40),
  #        AU_code = substring(AU,4,5)
  #        )%>%
  # arrange(AU_code)%>%
  ggplot(aes(component,AU, fill = coef))+
  geom_tile()+
  theme_classic()+
  # scale_fill_viridis_()
  scale_fill_viridis_c(option = "inferno")+
  xlab("K")+
  p$graphstyle_int+
guides(fill=guide_colorbar(ticks.colour = NA))


```


probe NMF vs PCA

```{r}
res_k3_max_norm@fit@W

    bind_cols( df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10)],
              as.data.frame(res_k3_max_norm@fit@W)) %>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  # mutate(coef_max = max(coef),
  #        coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   # scale_color_viridis_d(option = "magma")+
     ggtitle("PCA")
      
      
   
pca_AUs<- as.data.frame(var.pca$Fixed.Data$ExPosition.Data$fj)

pca_AUs$AU <- rownames(pca_AUs)
# as.data.frame(res_k3@fit@H)
as.data.frame(res_k3_max_norm@fit@H)%>%
  mutate(component = row_number()) %>%
  gather(AU, coef, -component)%>%
  group_by(component)%>%
  # mutate(max_comp = max(coef),
         # coef = coef/max_comp)%>%
  #        # AU = substring(AU,8,40),
  #        AU_code = substring(AU,4,5)
  #        )%>%
  # arrange(AU_code)%>%
  ggplot(aes(component,AU, fill = coef))+
  geom_tile()+
  theme_classic()+
  # scale_fill_viridis_()
  scale_fill_viridis_c(option = "inferno")+
  xlab("K")+
  p$graphstyle_int+
guides(fill=guide_colorbar(ticks.colour = NA))

```

Proobe time based nmf
```{r}
# dcast_time<-df_OF_output_AUsW_unblind_posed_binned[,c(1:3,9:10,16:32)]]

unique(dcast_time$bin_frame)
dcast_time$bin_frame

colnames(dcast_time)

dcast_time2<- dcast_time%>%
  gather(AUS, coef, -filename, -bin_frame, -subject,  -expression, -drug.placebo)%>%
    dcast(filename+subject+expression+drug.placebo+AUS~bin_frame, value.var = "coef")



res_k2 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r =2, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


plot(res_k3)
summary(res_k3)

# basis components 
NMF::basismap(res_k3) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3) #hidden variables

# access more info
# res_k3_em

res_k4 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 
coefmap(res_k4) 


```



# NMF on time2
```{r}


colnames(dcast_time2)
# add a very tiny number
dcast_time3<- dcast_time2[,6:105]+.001
?rowMax
colnames(dcast_time3)
pmax(dcast_time3)
install.packages("matrixStats")
library(matrixStats)

dcast_time3$max<- rowMaxs(as.matrix(         dcast_time3))


max(dcast_time3)
table(is.na(dcast_time3))

dcast_time4<- dcast_time3[,1:100]/dcast_time3$max

res_k3_time <- NMF::nmf(dcast_time4, r = 3, 
                  nrun = 100, 
                  seed=123456,
                 .options = list( 'v')) #

NMF::basismap(res_k3_time) 
coefmap(res_k3_time) 

res_k3_time@fit@H

library(NMF)
res_k4_time <- NMF::nmf(dcast_time4, r = 4, 
                  nrun = 100, 
                  seed=123456,
                 .options = list( 'v')) #

NMF::basismap(res_k4_time) 
coefmap(res_k4_time) 


res_k5_time <- NMF::nmf(dcast_time4, r = 5, 
                  nrun = 100, 
                  seed=123456,
                 .options = list( 'v')) #

NMF::basismap(res_k5_time) 
coefmap(res_k5_time) 


dcast_time2$comp1
res_k3_time@fit@W
```




Combine the data and visualise
vis preferrences
```{r}

sf = 1 # scaling factor to make it easier to change sizes of everything, in which case change here

p<- list()

p$graphstyle_int <-  theme(#base plot theme
  
  # axis lines
  axis.line.y = element_line(color="black", size = 1.5),
  axis.line.x = element_line(color="black", size = 1,5),
  
  axis.title.y=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  
  # text
  strip.text.x = element_text(size = 16*(sf+.5),  colour = "black"),
  strip.text.y = element_text(size = 16*(sf+.5),  colour = "black"),
  
  text=element_text(size = 14),
  axis.text.x = element_text(size = 15*(sf+.5), colour = "black",),
  axis.text.y = element_text(size = 15*(sf+.5), colour = "black"),
  
  
  # panel
  panel.grid.major = element_blank(),
  panel.background = element_blank(),
  # panel.background = element_rect(fill="transparent"),
  # panel.border = element_rect(fill="transparent"),
  # strip shades (reco rectagles)
   # strip.background = element_blank(),
  
  # legend
  # legend.position = "top",
  legend.key = element_rect(colour = "transparent", fill="transparent"),
  # axis.ticks = element_blank(),
  # legend.k
  #legend.direction = "horizontal",

  legend.text = element_text(size = 16*(sf+.5)),
  legend.title= element_text(size = 16*(sf+.5)),
  # legend.title = element_text(size = 10*(sf+.3)),
  # legend line tends to be really small in print so adjust here
  # legend.key.height = unit(.5, "cm"),
  # legend.key.width = unit(2, "cm"),
  
  #legend.text = element_text(size = 10*sf),
  # legend.title=element_blank(),
  #legend.text = element_blank(),
  #axis.ticks = element_blank(),
)


```



# recreate heatmap AUS

chool_talk$AU_NM <-
as.data.frame(res_k3@fit@H)%>%
  mutate(component = as.factor(1:n()))%>%
  gather(AU, coef, -component)%>%
  group_by(component)%>%
  mutate(max_comp = max(coef),
         coef = coef/max_comp,
         # AU = substring(AU,8,40),
         AU_code = substring(AU,4,5)
         )%>%
  arrange(AU_code)%>%
  ggplot(aes(component,AU, fill = coef))+
  geom_tile()+
  coord_cartesian(expand = FALSE)+
  make_fullsize()
  
  theme_classic()+
  # scale_fill_viridis_()
    scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  xlab("Component (K)")+

  scale_x_discrete(position = "top")+
guides(fill=guide_colorbar(ticks.colour = NA))
  





library(ggplot2)

library(ggplot2)

# Create some sample data
df <- data.frame(x = 1:10, y = 1:10, z = 1:10)

# Create the plot
p <- ggplot(df, aes(x, y, color = z)) +
  geom_point()

# Set the plot margins to match the height of the color bar
p + theme(plot.margin = unit(c(1,1,1,5), "lines"))

p + theme(plot.margin = unit(c(1,1,1,5), "lines"), legend.position = "bottom")

p + theme(plot.margin = unit(c(1,1,1,5), "lines"), legend.position = "bottom")


library(ggplot2)
library(reshape2)
dat <- iris[,1:4]
cor <- melt(cor(dat, use="p"))
head(cor)
##           Var1         Var2      value
## 1 Sepal.Length Sepal.Length  1.0000000
## 2  Sepal.Width Sepal.Length -0.1175698
## 3 Petal.Length Sepal.Length  0.8717538
## 4  Petal.Width Sepal.Length  0.8179411
## 5 Sepal.Length  Sepal.Width -0.1175698
## 6  Sepal.Width  Sepal.Width  1.0000000
heat <- ggplot(data=cor, aes(x=Var1, y=Var2, fill=value)) 
heat + geom_tile() + labs(x = "", y = "") + scale_fill_gradient2(limits=c(-1, 1))

```

anotate with components
```{r}

triangle_plots$delaunay_tri_comp3
# load images
# install.packages('magick')
library(magick)
# install.packages('imager')
# library(imager)

# library(png)
# library(grid)


require(ggtext)
# require()


# I is for italic
labels <- c(
  `1` = "<img src='https://github.com/hcuve/halo_faces/raw/main/ggtextimgs/comp1n.png'
    width='100' /><br> 1",
  `2` = "<img src='https://github.com/hcuve/halo_faces/raw/main/ggtextimgs/comp2n.png'
    width='100' /><br> 2",
  `3` = "<img src='https://github.com/hcuve/halo_faces/raw/main/ggtextimgs/comp3n.png'
    width='100' /><br> 3"
)
# ggtext::


chool_talk$AU_NM<-  chool_talk$AU_NM +
  xlab("Component (K)")+
    scale_x_discrete(
      position = "top",
    # name = NULL,
    labels = labels
  ) +
  theme(
     axis.text.x.top = element_markdown(color = "black", size = 16*(sf+.5)),
     axis.title.x = element_text(size = 16*(sf+.5)),#update this,
     axis.title.y = element_text(size = 16*(sf+.5)),#update this,
     axis.text.x = element_text(size = 15*(sf+.5), colour = "black"),
  axis.text.y = element_text(size = 15*(sf+.5), colour = "black"),
  legend.key.height = unit(1, "cm"),
  legend.key.width = unit(.7, "cm"),
  legend.text = element_text(size = 16*(sf+.5)),
  legend.title= element_text(size = 16*(sf+.5))
    # axis.text.x = element_markdown(color = "black", size = 15),
       # axis.text.x.top = element_markdown(size = 8, lineheight = 1.05)
     # axis.title.x = element_markdown(color = "black", size = 20)
  )


chool_talk$AU_NM
```

# plot just timeseries for components


Lanmarking
```{r eval=FALSE, include=FALSE}

library(readxl)
LANDMARKNMF <- read_excel("Library/CloudStorage/GoogleDrive-helioclemente.c@gmail.com/My Drive/2022 - University Of Birmingham/HaloStudy/Data/LANDMARKNMF.xlsx")
View(LANDMARKNMF)
LANDMARKNMF

library(ggtext)
install.packages("ggtext")
NMFresk3test<- as.data.frame(res_k3@fit@H)%>%
  mutate(component = 1:n())%>%
  gather(AU, coef, -component)%>%
  group_by(component)%>%
  mutate(max_comp = max(coef),
         coef = coef/max_comp,
         # AU = substring(AU,8,40),
         AU_code = substring(AU,4,5)
         )%>%
  arrange(AU_code)



LANDMARKNMF


NMFresk3test

LANDMARKNMF<- LANDMARKNMF1
colnames(LANDMARKNMF)
colnames(LANDMARKNMF[,c(1,8:9,12:31)])

LANDMARKNMF_dcast<- LANDMARKNMF[,c(1,8:9,12:31)]%>%
gather(AU, land1_0,-c(1:3,21:23))%>%
gather(comp, land1_0_nmf, -c(1:3,7:8))

library(ggvoronoi)

left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  mutate(V1_1 = if_else(land1_0_nmf == 1, V1, NULL),
         V2_2 = if_else(land1_0_nmf == 1, V2, NULL)) %>%
  group_by(lanmark_id, component, AU)%>%
  summarise_if(is.numeric, mean, na.rm = T) %>%
  mutate(coef2 = if_else(land1_0_nmf == 1, coef,0))%>%
  ggplot(aes(V1_1, V2_2, color = coef2))+
  geom_point(aes(size = coef2), alpha = .5)+
  # geom_point( aes(x = V1_1, y = V2_2, color = coef2, fill = coef2))+
  ggvoronoi::stat_voronoi(geom="path")+
  geom_point(aes(x = V1, y = V2))+
  # geom_point(aes(size = coef), alpha = .1)+
  ylim(1,0)+
  facet_grid(~component)+
  scale_color_viridis_c(option = "magma")

  
LANDMARKNMF_dcast

# 

install.packages("ggforce")
library(ggforce)
left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  mutate(V1_1 = if_else(land1_0 == 1, V1, NULL),
         V2_2 = if_else(land1_0 == 1, V2, NULL)) %>%
  # group_by(lanmark_id)%>%
  # summarise_if(is.numeric, mean, na.rm = T) %>%
  mutate(coef2 = if_else(land1_0 == 1, coef,0))%>%
  ggplot(aes(V1_1, V2_2, color = coef2, fill=coef2 ))+
  geom_point(aes(size = coef2), alpha = .5)+
    # ggvoronoi::stat_voronoi(geom="path" )
  # geom_point( aes(x = V1_1, y = V2_2, color = coef2, fill = coef2))+

  geom_point(aes(x = V1, y = V2))+
  # geom_point(aes(size = coef), alpha = .1)+
  ylim(1,0)+
  facet_grid(~component)+
    geom_delaunay_tile(aes(x =V1, V2, fill = lanmark_id), alpha = 0.3, colour = 'black')+
  # geom_delaunay_segment2()+
  scale_color_viridis_c(option = "magma")

NMFresk3test$component
LANDMARKNMF_dcast$component<- as.numeric(substr(LANDMARKNMF_dcast$comp,4,4))

left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  mutate(V1_1 = if_else(land1_0 == 1, V1, NULL),
         V2_2 = if_else(land1_0 == 1, V2, NULL)) %>%
  # group_by(lanmark_id)%>%
  # summarise_if(is.numeric, mean, na.rm = T) %>%
  mutate(coef2 = if_else(land1_0 == 1, coef,0))%>%
  ggplot(aes(V1_1, V2_2, color = coef2, fill=coef2 ))+
  geom_point(aes(size = coef2), alpha = .5)+
    # ggvoronoi::stat_voronoi(geom="path" )
  # geom_point( aes(x = V1_1, y = V2_2, color = coef2, fill = coef2))+

  geom_point(aes(x = V1, y = V2))+
  # geom_point(aes(size = coef), alpha = .1)+
  ylim(1,0)+
  facet_grid(~component)+
    geom_delaunay_tile(aes(x =V1, V2), alpha = 0.1, colour = 'black')+
      geom_delaunay_segment2(aes(x =V1, V2, colour = coef2))+
  # geom_delaunay_segment2()+
  scale_color_viridis_c(option = "magma")


```
?geom_delaunay_tile


```{r eval=FALSE, include=FALSE}
test_del<- left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  mutate(V1_1 = if_else(land1_0_nmf == 1, V1, NULL),
         V2_2 = if_else(land1_0_nmf == 1, V2, NULL)) %>%
    mutate(coloring = if_else(V1_1 == 1, 1,0)) %>%
  subset(!(V1 == 0 & V2 == 0))%>%
   # mutate(coef_max = )%>%
    group_by(lanmark_id) %>%
  mutate(coef = coef/max(coef)) %>%

  mutate(coef2 = if_else(land1_0_nmf == 1, coef,0))%>%
   mutate(coef2 = if_else(is.na(coef2), 0, coef2))%>%
  summarise_if(is.numeric, mean, na.rm = T)

SO<- test_del%>%
  mutate(coef2 = coef2/max(coef2, na.rm = T))
SO<- SO[,c(1:3,14)]

SO%>%
  mutate(coef2 = coef2/max(coef2))%>%
  ggplot(aes(V1, V2))+

   geom_delaunay_tile(aes(colour = coef2, fill = coef2), alpha = .5)+
      geom_delaunay_segment2(aes(colour = coef2, fill = coef2))+
    geom_point(aes(colour = coef2))+
  ylim(1,0)+
      scale_color_viridis_c(option = "magma")+
 scale_fill_viridis_c(option = "magma")



dput(SO)


SO%>%
  mutate(coef2 = coef2/max(coef2))%>%
  ggplot(aes(V1, V2))+

   geom_delaunay_tile(aes(colour = coef2, fill = coef2), alpha = .3)+
      geom_delaunay_segment2(aes(colour = coef2, fill = coef2))+
    geom_point(aes(colour = coef2))+
  ylim(1,0)+
      scale_color_viridis_c(option = "magma")+
 scale_fill_viridis_c(option = "magma")+
  theme_minimal()


left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  


  mutate(V1_1 = if_else(land1_0_nmf == 1, V1, NULL),
         V2_2 = if_else(land1_0_nmf == 1, V2, NULL)) %>%
    mutate(coloring = if_else(V1_1 == 1, 1,0)) %>%
  subset(!(V1 == 0 & V2 == 0))%>%

  mutate(coef2 = if_else(land1_0_nmf == 1, coef,0))%>%
    group_by(lanmark_id, component)%>%
      mutate(coef2 = coef2/max(coef2))%>%
  # summarise_if(is.numeric, mean, na.rm = T)%>%
  
    # mutate(coef2 = coef2/max(coef2))%>%
  ggplot(aes(V1, V2))+

   geom_delaunay_tile(aes(colour = coef2, fill = coef2), alpha = .3)+
      geom_delaunay_segment2(aes(colour = coef2, fill = coef2))+
    geom_point(aes(colour = coef2))+
  # geom_text(aes(label = lanmark_id,colour = coef2), size = 3)+
  ylim(1,0)+
  facet_grid(~component)+
      scale_color_viridis_c(option = "magma")+
 scale_fill_viridis_c(option = "magma")+
  theme_minimal()



SO%>%
  ggplot(aes(V1, V2))+
   geom_text(aes(label = lanmark_id,colour = coef2), size = 3)+
  ylim(1,0)

  

```
  
  GPT
```{r}
# First, install and load the deldir library:
# install.packages("deldir")
library(deldir)

# install.packages("deldir")
install.packages("tricol")






traing_fordeldir <- left_join(LANDMARKNMF_dcast,NMFresk3test)%>%
  


  mutate(V1_1 = if_else(land1_0_nmf == 1, V1, NULL),
         V2_2 = if_else(land1_0_nmf == 1, V2, NULL)) %>%
    mutate(coloring = if_else(V1_1 == 1, 1,0)) %>%
  subset(!(V1 == 0 & V2 == 0))%>%

  mutate(coef2 = if_else(land1_0_nmf == 1, coef,0))%>%
    group_by(lanmark_id, component)%>%
      mutate(coef2 = coef2/max(coef2))%>%
  group_by(lanmark_id)%>%
  summarise_if(is.numeric, mean, na.rm = T)


traing_fordeldir

tri<- deldir(traing_fordeldir$V1, traing_fordeldir$V2)




# Generate some random colors for the vertices:

colors <- rainbow(length(traing_fordeldir$component))
colors <- rainbow(length(traing_fordeldir$V1))





```

```{r eval=FALSE, include=FALSE}
NMFresk3test

df_OF_output_AUsW_unblind_posed_binned$NMFtable


df_OF_output_AUsW_unblind_posed_binned



# FOR THE TIMESERIES NOW
colnames(LANDMARKNMF)
LANDMARKNMF$comp1<- LANDMARKNMF$NMF1
 LANDMARKNMF$comp2<- LANDMARKNMF$NMF2
LANDMARKNMF$comp3<- LANDMARKNMF$NMF3

```


```{r eval=FALSE, include=FALSE}
  
colnames(LANDMARKNMF[,c(1,7:8,31:33)])

LANDMARKNMF_gatherts<-LANDMARKNMF[,c(1,7:8,31:33)]%>%
  gather(component, land1_0,-c(1:3))

df_OF_output%>%
  subset(filename == "./cut_spoken2_sad_day2_p8.csv")%>%


df_OF_output%>%
  ggplot(aes())


# gather(comp, land1_0_nmf, -c(1:3,7:8))
colnames(df_OF_output_AUsW_unblind_posed_binned1_gather)
df_OF_output_AUsW_unblind_posed_binned1_gather <-
df_OF_output_AUsW_unblind_posed_binned1 [,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%

      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max)
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")
  
  
  
  left_join(LANDMARKNMF_gatherts,
  df_OF_output_AUsW_unblind_posed_binned1_gather)%>%
     mutate(V1_1 = if_else(land1_0 == 1, V1, NULL),
         V2_2 = if_else(land1_0 == 1, V2, NULL)) %>%
  group_by(lanmark_id,component, expression) %>%
  summarise_if(is.numeric, mean, na.rm = T) %>%
  mutate(coef2 = if_else(land1_0 == 1, coef,0)) %>%
     ggplot(aes(V1_1, V2_2, color = coef2 ))+
  geom_point(aes(size = coef2), alpha = .5)+
    # ggvoronoi::stat_voronoi(geom="path" )
  # geom_point( aes(x = V1_1, y = V2_2, color = coef2, fill = coef2))+

  geom_point(aes(x = V1, y = V2), color = "black", alpha = .1)+
  # geom_point(aes(size = coef), alpha = .1)+
  ylim(1,0)+
  facet_grid(~component)+
  scale_color_viridis_c(option = "magma")
  
  
  ggforce
  geom_delaunay_tile(alpha = 0.3, colour = 'black')


```



Figure 2


  
```{r}
# chool_talk$AU_NM2<- chool_talk$AU_NM+
#   theme(axis.text.y = element_blank())+
#   ylab("Motor Action Unit")

chool_talk$AU_NM2
chool_talk$ts_smooth

ggsave("AU_NMF2.tiff",chool_talk$AU_NM2, device = "tiff", width = 5, height = 8, dpi = 800)

chool_talk$ts_hm

```


store NMF components o dataset
```{r}

# reconstruct

res_k3

install.packages(NMF)


df_OF_output_AUsW_unblind_posed_binned$NMFtable<- as.data.frame(res_k3@fit@W)

df_OF_output_AUsW_unblind_posed_binned$comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V1
table(is.na(df_OF_output_AUsW_unblind_posed_binned$comp1))
df_OF_output_AUsW_unblind_posed_binned$comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V2
df_OF_output_AUsW_unblind_posed_binned$comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V3

# for k  = 4
df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4<- as.data.frame(res_k4@fit@W)
df_OF_output_AUsW_unblind_posed_binned$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V4

# for k 2
# for k  = 4
df_OF_output_AUsW_unblind_posed_binned_k2<- df_OF_output_AUsW_unblind_posed_binned
df_OF_output_AUsW_unblind_posed_binned_k2$NMFtable_k2<- as.data.frame(res_k2@fit@W)

df_OF_output_AUsW_unblind_posed_binned_k2$k2_comp1 = df_OF_output_AUsW_unblind_posed_binned_k2$NMFtable_k2$V1
df_OF_output_AUsW_unblind_posed_binned_k2$k2_comp2 = df_OF_output_AUsW_unblind_posed_binned_k2$NMFtable_k2$V2

# visualization by emotion
colnames(df_OF_output_AUsW_unblind_posed_binned)

# bind_rows(db_of_natural1, db_of_morph)
colnames(df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,16:32,34:36)])

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  
  group_by(expression, component, drug.placebo, bin_frame)%>%
    group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(~expression )+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()


nrow(df_OF_output_AUsW_unblind_posed_binned)


```



timeseries
```{r}
chool_talk$ts_smooth <- df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")


chool_talk$ts_smooth

# just components
paper_plots$posed_comp_ts<-
df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  # facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")
paper_plots$posed_comp_ts
```


   
chool_talk$ts_smooth

chool_talk$ts_pca_smooth<-
    df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,48:50)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
        # mutate_at(c("coef"), normalize)%>%
  # mutate(coef_max = max(coef),
  #        coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
      mutate(component =substring(component, 5,9))%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
        theme_classic()+
      xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")+
  theme(panel.spacing = unit(1, "cm"))


chool_talk$patch_PCA_NMF_ts <- (chool_talk$ts_smooth+theme(panel.spacing = unit(1, "cm")))/
(chool_talk$ts_pca_smooth+theme(panel.spacing = unit(1, "cm")))+
   plot_layout(guides = "collect") & theme(legend.position = "top")

chool_talk$patch_PCA_NMF_ts
chool_talk$ts_smooth+theme(panel.spacing = unit(1, "cm"))


ggsave("patch_PCA_NMF_ts.tiff", chool_talk$patch_PCA_NMF_ts, device  ="tiff",
       width = 9, height = 7, dpi = 800)

chool_talk$ts_smooth

chool_talk$AU_NM



heatmap + timeseries + timeseries heatmap
```{r}
chool_talk$ts_hm <-
df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max)%>%
  # mutate_at(c("coef"), scale)%>%
  group_by(component, expression, bin_frame)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, component, fill= coef))+
  geom_tile()+
  xlab("time bin")+
  scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  # geom_smooth(se = F)+
  facet_grid(~expression)+
  theme_classic()+
  p$graphstyle_int+
  guides(fill=guide_colorbar(ticks.colour = NA))+
  theme(panel.spacing = unit(1, "cm"))
   # guides(fill = guide_colourbar(barwidth = 1.5,ticks.colour = NA, barheight = 5))

chool_talk$ts_hm 

paper_plots$posed_comp_ts_hm<-
df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max)%>%
  # mutate_at(c("coef"), scale)%>%
  group_by(component, bin_frame)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, component, fill= coef))+
  geom_tile()+
  xlab("time bin")+
  scale_fill_viridis_c(option = "magma", breaks=c(0,.5,1),
                       limits =c(0,1))+#)+
  # facet_grid(~expression)+
  theme_classic()+
  p$graphstyle_int +
  guides(fill=guide_colorbar(ticks.colour = NA))+
  theme(panel.spacing = unit(1, "cm"))
   # guides(fill = guide_colourbar(barwidth = 1.5,ticks.colour = NA, barheight = 5))

chool_talk$ts_hm 

paper_plots$posed_comp_ts_hm

```

library(patchwork)
```{r}
# chool_talk$ts_nmf_heat_NMF <- (chool_talk$ts_smooth/
#   chool_talk$ts_hm)+
#   plot_layout(heights = c(1,2))

# soace out values in x axis
chool_talk$ts_smooth <- chool_talk$ts_smooth + scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
    scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))+
  theme(panel.spacing.x = unit(1.5, "lines"))+
  theme(legend.position = "top")

chool_talk$ts_smooth

test4pot5


# chool_talk$ts_smooth <- test4pot5 + scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
#     scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))+
#   theme(panel.spacing.x = unit(1.5, "lines"))+
#   theme(legend.position = "top")

chool_talk$ts_hm <- chool_talk$ts_hm +scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
  theme(panel.spacing.x = unit(1.5, "lines"))

chool_talk$ts_hm 
# components
paper_plots$posed_comp_ts <- paper_plots$posed_comp_ts + scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
    # scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))+
  theme(panel.spacing.x = unit(1.5, "lines"))+
  theme(legend.position = "top")

paper_plots$posed_comp_ts_hm <-paper_plots$posed_comp_ts_hm +scale_x_continuous(breaks=c(0,50,100), limits = c(0, 100))+
  theme(panel.spacing.x = unit(1.5, "lines"))

chool_talk$ts_smooth
chool_talk$ts_hm 
paper_plots$posed_comp_ts
paper_plots$posed_comp_ts_hm

```

```


````{r}

require(patchwork)

paper_plots$NMF_panel_posed

test
library(patchwork)
# make sure to flip 1 to 3

 triangle_plots$delaunay_tri_comp1.1 <- triangle_plots$delaunay_tri_comp1 +
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp1")


triangle_plots$delaunay_tri_comp2.1<- triangle_plots$delaunay_tri_comp2+
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp2")
 
triangle_plots$delaunay_tri_comp3.1<- triangle_plots$delaunay_tri_comp3+
theme_void()+theme(legend.position = "none",
                     axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)))+xlab("Comp3")


comp1_2_3<- triangle_plots$delaunay_tri_comp1.1 /
        triangle_plots$delaunay_tri_comp2.1/
       triangle_plots$delaunay_tri_comp3.1

comp1_2_3

```
```{r}
paper_plots$posed_comp_ts
paper_plots$posed_comp_ts_hm

ts_ts_hm_compns<- (paper_plots$posed_comp_ts/paper_plots$posed_comp_ts_hm)
ts_ts_hm_compns


comp1_2_3
```


START COMBINING

```{r}
 install.packages("ggtext")
install.packages("matrixStats")

test1 <- (wrap_elements(full = chool_talk$AU_NM)+ wrap_elements(full = comp1_2_3)+wrap_elements(ts_ts_hm_compns))+
    plot_layout(ncol = 3, widths = c(1.2,.5,1))+ plot_annotation(tag_levels = 'A')+
  theme(plot.tag = element_text(size = 20*(sf+.5)))
 
 test1
 
```


```{r}
triangle_plots$delaunay_tri_ang<-triangle_plots$delaunay_tri_ang+scale_x_continuous(limits = c(-.2,1.2))
triangle_plots$delaunay_tri_happy<-triangle_plots$delaunay_tri_happy+scale_x_continuous(limits = c(-.2,1.2))

triangle_plots$delaunay_tri_sad<-triangle_plots$delaunay_tri_sad+scale_x_continuous(limits = c(-.2,1.2))


```


```{r}
patchwork::wrap_elements(test3)/test2


# triangle_plots$delaunay_tri_ang+
#   xlim(-10,110)
triang_patch<- (triangle_plots$delaunay_tri_ang +
                         triangle_plots$delaunay_tri_happy+
                         triangle_plots$delaunay_tri_sad)

test2 <-(chool_talk$ts_smooth/
           patchwork::wrap_elements(triang_patch)/
    chool_talk$ts_hm)+
  plot_layout(nrow = 3, heights = c(1,1.5,1))+
  plot_annotation(tag_levels = list(c('D', 'E','F')))+
  theme(plot.tag = element_text(size =20*(sf+.5)))
  

test2


```
  
 
 
 
```{r} 
 # (chool_talk$ts_smooth/chool_talk$ts_hm)+
  # plot_layout(ncol = 2, widths = c(.7,2))
require(ggtext)
require(tidyverse)

require(patchwork)

paper_plots$panel_NMF_posed <-
wrap_elements(full = test1) + wrap_elements(full = test2) + plot_layout(ncol = 1, nrow = 2, heights = c(1,1))
   plot_annotation(tag_levels = 'A')


paper_plots$panel_NMF_posed

ggsave("panel_NMF_posed.tiff",device = 'tiff', paper_plots$panel_NMF_posed,
       width = 15,
       height = 15,
       dpi = 800)

ggsave("panel_NMF_poseddpi300.tiff",device = 'tiff', paper_plots$panel_NMF_posed,
       width = 25,
       height = 25,
       dpi = 300)

ggsave("panel_NMF_posed1.tiff",device = 'tiff', paper_plots$panel_NMF_posed,
       width = 25,
       height = 25,
       dpi = 800)

```

# setting
# 2300 vy 1200 for test 2
# 2300 by 2300

design<-'AAB
ABC'

wrap_plots(D = p1, C = p2, B = p3, design = layout)

plot_annotation(title = "POSED EXPRESSIONS")




# ggsave("ts_nmf_heat_NMF.tiff", chool_talk$ts_nmf_heat_NMF, device = "tiff",
#        width = 10, height = 7, dpi = 800)
paper_plots$NMF_panel_posed/paper_plots$NMF_panel_posed

paper_plots$NMF_panel_posed
ggsave("fig2_NMF_panel_posed.tiff", paper_plots$NMF_panel_posed, device = "tiff",
       width = 14, height = 7, dpi = 800)


# spoken


require(ggplot2); require(grid); require(png); require(RCurl)
install.packages("RCurl")
require(RCurl)

p = ggplot(iris, aes(Sepal.Length, Sepal.Width)) + geom_point() + facet_wrap(~Species)

img1 = readPNG(getURLContent('https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/ang.png'))
img2 = readPNG(getURLContent('https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/hap.png'))
img3 = readPNG(getURLContent('https://raw.githubusercontent.com/hcuve/halo_faces/main/ggtextimgs/sad.png'))


annotation_custom2 <- 
function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data){ layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))}

test2

test4_df<-
 df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  
      group_by(filename,component,subject,expression)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max) %>%
  
  group_by(expression, component, bin_frame,subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+

test4pot<-test4_df%>%
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  # geom_smooth(aes(group = subject), se = F)+
  # stat_summary(aes(group = subject, color = component), geom = "smooth")+
  facet_grid(~expression )+
  theme_classic()+
   xlab("time bin")+
  p$graphstyle_int+
   scale_color_viridis_d(option = "magma")+
  theme(legend.position = "top")


a1 = annotation_custom2(rasterGrob(img1, interpolate=TRUE), xmin=60, xmax=100, ymin = .5, ymax = 1, data=test4_df%>%subset(expression == "angry"))
a2 = annotation_custom2(rasterGrob(img2, interpolate=TRUE), xmin=60, xmax=100, ymin = .5, ymax = 1, data=test4_df%>%subset(expression == "happy"))
a3 = annotation_custom2(rasterGrob(img3, interpolate=TRUE), xmin=60, xmax=100, ymin = .5, ymax = 1, data=test4_df%>%subset(expression == "sad"))

test4_df[2000,]
test4pot5<- test4pot + a1 + a2 + a3
 + a1 + a2 + a3
```



# plot component classification of emotion

```{r}
df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  group_by(filename,component)%>%
  mutate(coef_max = max(coef),
         coef = coef/coef_max)%>%
  # mutate_at(c("coef"), scale)%>%
  group_by(component, filename, expression)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(component, coef, group = expression, color = expression))+
  stat_summary(geom = "pointrange", position = position_dodge(1))+
  ggpubr::stat_compare_means()+
  geom_jitter( position = position_dodge2( width = .))


```

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned_k2)
df_OF_output_AUsW_unblind_posed_binned_k2[,c(1,2:3,9:10, 49:50)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  group_by(expression, component, drug.placebo, bin_frame,filename)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  # geom_smooth(aes(group = filename), se = F, size = .5)+
  facet_grid(expression~component)+
  theme_classic()


```


PCA
```{r}
chool_talk$NMF_PCA <- chool_talk$AU_NM +theme(legend.position = "none") +(chool_talk$pca_AU+theme(axis.text.y = element_blank(),
                                         axis.title.y = element_blank()))


ggsave("NMF_PCA.tiff", chool_talk$NMF_PCA, device = "tiff", width = 10, height = 7, dpi = 800)

```
  
visualise time NMF


```{r}

dcast_time2$table_time_NMF_k3<- as.data.frame(res_k3_time@fit@W)
# res_k3_time
dcast_time2$comp1 = dcast_time2$table_time_NMF_k3$V1
dcast_time2$comp2 = dcast_time2$table_time_NMF_k3$V2
dcast_time2$comp3 = dcast_time2$table_time_NMF_k3$V3


res_k3_time@fit@ibterms
res_k3_time@fit@H
colnames(dcast_time2)

dcast_time2[c(1:4,106:108)]%>%
    # mutate_if(is.numeric, scale)%>%
  group_by(filename,subject, drug.placebo, expression)%>%

  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  gather(comp, coef, -filename, -subject, -drug.placebo, - expression)%>%
  ggplot(aes(comp, coef, color = expression))+
  geom_jitter(aes(group = expression), position = position_dodge(1), alpha = .1)+
  stat_summary(aes(group = expression), position = position_dodge(1),geom = "pointrange")

  facet_grid(~expression)

  
  as.data.frame(res_k3_time@fit@H)%>%
    # mutate(id = row_number())%>%
    mutate(id = 1:n())%>%
gather(time_bin,coef,-id)%>%
    ggplot(aes(as.numeric(time_bin), id, fill = coef))+
    geom_tile()+
    theme_classic()+
    scale_fill_viridis_c(option = "inferno")
  
  
  
  res_k5_time
  
  
    as.data.frame(res_k5_time@fit@H)%>%
    # mutate(id = row_number())%>%
    mutate(id = 1:n())%>%
gather(time_bin,coef,-id)%>%
    ggplot(aes(as.numeric(time_bin), id, fill = coef))+
    geom_tile()+
    theme_classic()+
    scale_fill_viridis_c(option = "inferno")
    
        as.data.frame(res_k3_time@fit@H)%>%
    # mutate(id = row_number())%>%
    mutate(id = 1:n())%>%
gather(time_bin,coef,-id)%>%
          mutate(coef = ifelse(time_bin <=2, 0,
                               ifelse(time_bin >98, 0, coef))) %>%
          group_by(id)%>%
          mutate_at(c("coef"), scale)%>%
    ggplot(aes(as.numeric(time_bin), coef, color = as.factor(id)))+
          # geom_line()
          geom_smooth(se = F, span = .5, size = 2)+
          # geom_density(aes(y = coef))+
    # geom_tile()+
    theme_classic()+
    scale_fill_viridis_c(option = "inferno")
  
  
        
res_k3_time@fit@W

colnames(dcast_time2)
dcast_time2_aggjasp<- dcast_time2[,c(1:4,107:109)] %>%
  group_by(filename)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

write_csv(dcast_time2_aggjasp, "dcast_time2_aggjasp.csv")



```
  
dcast_time3<- dcast_time2[,6:105]+.001
?rowMax
colnames(dcast_time3)
pmax(dcast_time3)
install.packages("matrixStats")
library(matrixStats)

dcast_time3$max<- rowMaxs(as.matrix(         dcast_time3))


max(dcast_time3)
table(is.na(dcast_time3))

dcast_time_h<-subset(dcast_time4, 
                     dcast_time2$expression == "angry")


  res_k3_time_a <- NMF::nmf(dcast_time_h, r = 3, 
                  nrun = 100, 
                  seed=123456,
                 .options = list( 'v')) #
  
  dcast_time_h<-subset(dcast_time4, 
                     dcast_time2$expression == "sad")


  res_k3_time_s <- NMF::nmf(dcast_time_h, r = 3, 
                  nrun = 100, 
                  seed=123456,
                 .options = list( 'v')) #
  
  # happy
    dcast_time_ha<-subset(dcast_time4, 
                     dcast_time2$expression == "happy")


  res_k3_time_ha <- NMF::nmf(dcast_time_ha, r = 3, 
                  nrun = 100, 
                  seed=123456,
                 .options = list( 'v')) #
  
  
 dcast_time_h$table_time_NMF_k3<- as.data.frame(res_k3_time_a@fit@W)
# res_k3_time
dcast_time_h$comp1 = dcast_time_h$table_time_NMF_k3$V1
dcast_time_h$comp2 = dcast_time_h$table_time_NMF_k3$V2
dcast_time_h$comp3 = dcast_time_h$table_time_NMF_k3$V3

# sad
dcast_time_s$table_time_NMF_k3<- as.data.frame(res_k3_time_s@fit@W)
# res_k3_time
dcast_time_s$comp1 = dcast_time_s$table_time_NMF_k3$V1
dcast_time_s$comp2 = dcast_time_s$table_time_NMF_k3$V2
dcast_time_s$comp3 = dcast_time_s$table_time_NMF_k3$V3

# happy
dcast_time_ha$table_time_NMF_k3<- as.data.frame(res_k3_time_ha@fit@W)
# res_k3_time
dcast_time_ha$comp1 = dcast_time_ha$table_time_NMF_k3$V1
dcast_time_ha$comp2 = dcast_time_ha$table_time_NMF_k3$V2
dcast_time_ha$comp3 = dcast_time_ha$table_time_NMF_k3$V3

# then bidn these


# angry
  

same as above for  k 4

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  facet_grid(~component)+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()



tsne(pollen$data,labels=as.factor(pollen$celltypes))

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]

library(tsne)
library(M3C)

install.packages("M3C")

df_OF_output_AUsW_unblind_posed_binned_max_norm
tsnetest<- df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,34:36)]%>%
  # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(filename, expression, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
   ungroup()%>%
  mutate_if(is.numeric, scale)

tsnetest


```

```{r}
tsnresul<- tsne::tsne(tsnetest[,c(5:7)],
           k = 3)

plot(tsnresul, col = "black", bg =as.numeric(tsnetest$expression))


```

tsnresult

```{r}
tsne(df_OF_output_AUsW_unblind_posed_binned[,c(10, 34:36)],
     labels=as.factor(df_OF_output_AUsW_unblind_posed_binned$expression))


library(Rtsne)



set.seed(142)

```


```{r}
tSNE_fit$Y <- tsnetest[,c(5:7)] %>%
  ungroup() %>%
  mutate(ID=row_number()) %>%
  column_to_rownames("ID") %>%
  scale() %>% 
  Rtsne(dim = 3)

tSNE_df <- 
  as.data.frame(tSNE_fit$Y) %>%
  rename(tSNE1="V1",
         tSNE2="V2") %>%
  mutate(ID=row_number())



 tsnetest<- tsnetest %>%
  ungroup() %>%
  mutate(ID=row_number())

 tSNE_df2 <- tSNE_df %>%
  inner_join(tsnetest[c(1:3,8)], by="ID")
 
 
 

tSNE_df2 %>%
  ggplot(aes(x = tSNE1, 
             y = tSNE2,
             color = expression,
             shape = expression))+
  geom_point()+
  theme(legend.position="bottom")


ggsave("tSNE_plot_example1.png")


require(rgl)
plot3d(tSNE_fit$Y, col=cols[tSNE_df2$expression])
legend3d("topright", legend = '0':'5', pch = 16, col = rainbow(5))

cols
?plot3d
plot3d(tSNE_fit$Y, col= c(1,2,3))
plot3d(tSNE_fit$Y)

# 2nd tsne on AUS

colnames(df_OF_output_AUsW_unblind_posed_binned)
tsnetest2<- df_OF_output_AUsW_unblind_posed_binned[,c(1,2:3,9:10,16:32)]%>%
  # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(filename, expression, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ungroup()%>%
  mutate_if(is.numeric, scale)

tsnetest2
colnames(tsnetest2)


tsnresul2<- tsne::tsne(tsnetest2[,c(5:21)],
           k = 3)

plot(tsnresul2[,1:2], col = "black", bg =c(1,2,3))




tSNE_fit2 <- tsnetest2[,c(5:21)] %>%
  ungroup() %>%
  mutate(ID=row_number()) %>%
  column_to_rownames("ID") %>%
  scale() %>% 
  Rtsne(dim = 3)

tSNE_df2 <- tSNE_fi2t$Y %>% 
  as.data.frame() %>%
  rename(tSNE1="V1",
         tSNE2="V2") %>%
  mutate(ID=row_number())




 tSNE_df2 <- tSNE_df %>%
  inner_join(tsnetest[c(1:3,8)], by="ID")
 
 
 
tSNE_fit2

plot3d(tSNE_fit2$Y, col= c(1,2,3))

library(scatterplot3d)
?scatterplot3d::scatterplot3d
scatterplot3d::scatterplot3d(tSNE_fit2$Y)
install.packages("plot3D")
library(plot3D)
scatter3D(as.data.frame(tSNE_fit2$Y)[,1], phi = 0, bty = "g",  type = "h", 
           ticktype = "detailed", pch = 19, cex = 0.5)
```

aggregate solution
```{r}
library(lmerTest)

# test_lmer<- lmer()
df_OF_output_AUsW_unblind_posed_binned

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
```



```{r}
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(component , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(~expression)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")



```

same as above for k4

```{r}
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
  
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")


  
  df_OF_output_AUsW_unblind_posed_binned
```


do we get different patterns if we fit placebo and drug separately

```{r}
# df_OF_output_AUsW_unblind_posed_binned[df_OF_output_AUsW_unblind_posed_binned$drug.placebo == "drug"] 
#   subset(drug.placebo == "drug")[,16:32]

colnames(df_OF_output_AUsW_unblind_posed_binned)
# df_OF_output_AUsW_unblind_posed_binned$drug.placebo

df_OF_output_AUsW_unblind_posed_binned_drug<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "drug")%>%
                         ungroup()%>%
                         select(16:32)


df_OF_output_AUsW_unblind_posed_binned_placebo<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "placebo")%>%
                         ungroup()%>%
                         select(16:32)

res_k3_drug <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_drug,
                       r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


plot(res_k3_drug)
summary(res_k3_drug)

# basis components 
NMF::basismap(res_k3_drug) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3)
coefmap(res_k3_drug) #hidden variables

# access more info
# res_k3_drug

res_k4_drug <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_drug, r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 
coefmap(res_k4) 
NMF::basismap(res_k4_drug) 
coefmap(res_k4_drug) 

# very similar so far
# now fit placebo

res_k3_placebo <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_placebo,
                       r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


# plot(res_k3_placebo)
# summary(res_k3_placebo)

# basis components 
NMF::basismap(res_k3) 
NMF::basismap(res_k3_placebo) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3)
coefmap(res_k3_placebo) #hidden variables

# access more info
# res_k3_drug

res_k4_placebo <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_placebo, r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 

NMF::basismap(res_k4_placebo) 
coefmap(res_k4) 
coefmap(res_k4_placebo)





# visualisations
# - differences between emotions on the components
# - differences between drug vs no drug?
# - classification - can we classify drug vs no drug based in these components
# 
# 


```

now visualise joint NMF vs separate NMFS

```{r}
df_OF_output_AUsW_unblind_posed_binned_drug
df_OF_output_AUsW_unblind_posed_binned_placebo

# lets store the components frm k 4

df_OF_output_AUsW_unblind_posed_binned_drug

df_OF_output_AUsW_unblind_posed_binned_drug<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "drug")
                         # ungroup()%>%
                         # select(16:32)

df_OF_output_AUsW_unblind_posed_binned_placebo<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo != "drug")

df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4<- as.data.frame(res_k4_drug@fit@W)

# for drug set
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V4

# for placebo set
df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4<- as.data.frame(res_k4_placebo@fit@W)

df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V4



# compare vis for joint vs separwte NMF results

# start with selectign drug

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  subset(drug.placebo == "drug")%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(~expression)+
  theme_classic()

colnames(df_OF_output_AUsW_unblind_posed_binned_drug)
# forgot to store the combined data with info

df_OF_output_AUsW_unblind_posed_binned_drug[,c(2:3,9:10,38:41)]%>%
  # subset(drug.placebo == "drug")%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(~expression)+
  theme_classic()



df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(drug.placebo~expression)+
  theme_classic()

bind_rows(df_OF_output_AUsW_unblind_posed_binned_drug,df_OF_output_AUsW_unblind_posed_binned_placebo)[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(drug.placebo~expression)+
  theme_classic()
  
  


  
  
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")



bind_rows(df_OF_output_AUsW_unblind_posed_binned_drug,df_OF_output_AUsW_unblind_posed_binned_placebo)[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")

# this plot is deceiving as the compents shift order
# overall the patterns are the same_src(
# so its better to fit in one go to abvoid flips in compoent orders
```


we can also do classification on this
i.e. knowing the spatiotemporal components can we predict whether a condition is drug vs placebo

```{r}
df_OF_output_AUsW_unblind_posed_binned

colnames(df_OF_output_AUsW_unblind_posed_binned)
# combine the datasets keep timbeins and stimuli
nmfk4_agg_no_ts <- df_OF_output_AUsW_unblind_posed_binned%>%
  ungroup()%>%
  select(c(3,9:10,16:41))%>%
  # gather( component, coef, -timebin,-Emotion, -Dataset, -morph, -filename)%>%
  group_by(subject,drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

nmfk4_agg_no_ts

# combine datasets and aggregate over time bins
# nmf_agg_ts <- bind_rows(db_of_natural1, db_of_morph)[,c(1,2:5,31:33)]%>%
#   group_by(filename, Emotion, Dataset, morph)%>%
#   summarise_at(c("comp1", "comp2", "comp3"), mean, na.rm = TRUE)
# 
# # save 
write_csv(nmfk4_agg_no_ts, "nmfk4_agg_no_ts.csv")
# write_csv(nmf_agg_ts_tb, "nmf_agg_ts_tb.csv")


```

before we do for classification and clustering
let's do BADIA

```{r}
# start with the dimensions
colnames(nmfk4_agg_no_ts)
# drug no drug

bada_models<-list()
bada_models$drug_nodrug<- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$drug.placebo),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# based on emotion
bada_models$emotion <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)


# based on AUS
colnames(nmfk4_agg_no_ts)
bada_models$drug_nodrug_fromAUS<- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,4:20], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$drug.placebo),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)


bada_models$emotion_fromAUS <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,4:20], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)



# do placebo vs  drug separately
nmfk4_agg_no_ts_drug<-subset(nmfk4_agg_no_ts, drug.placebo == "drug")
nmfk4_agg_no_ts_plac<-subset(nmfk4_agg_no_ts, drug.placebo != "drug")

colnames(nmfk4_agg_no_ts_drug)
bada_models$drug_emotion_NMF <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts_drug[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts_drug$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# lacebo

bada_models$placebo_emotion_NMF <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts_plac[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts_plac$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned_drug<-subset(df_OF_output_AUsW_unblind_posed_binned, drug.placebo  =="drug")

bada_models$ts_drug<- TInPosition::tepBADA.inference.battery(df_OF_output_AUsW_unblind_posed_binned_drug[,38:41], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(df_OF_output_AUsW_unblind_posed_binned_drug$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 100, 
                                                       critical.value = 2)

df_OF_output_AUsW_unblind_posed_binned$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned$subject)

summary(lmer(k4_comp3 ~ 1 + expression*drug.placebo +(1+drug.placebo|subject),
             REML = FALSE,
     data  =df_OF_output_AUsW_unblind_posed_binned))

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(subject, expression, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo, k4_comp4))+
  geom_boxplot(alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group =subject), method = "lm", se  =F, sie = 1, alpha = .1)+
  facet_grid(~expression)


```


movement substates
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)
unique(df_OF_output_AUsW_unblind_posed_binned$filename)

df_OF_output_AUsW_unblind_posed_binned %>%
  ungroup()%>%
  subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:41))%>%
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame)%>%
  group_by( component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef, color = component))+
  geom_line()+
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


library(zoo)

colnames(df_OF_output_AUsW_unblind_posed_binned)

??zoo::rollmean

install.packages("RcppRoll")
library(RcppRoll)
RcppRoll::roll_mean(df_OF_output_AUsW_unblind_posed_binned$k4_comp4)
??RcppRoll::roll_mean

library(zoo)
# stick to k = 3
df_OF_output_AUsW_unblind_posed_binned$idno
df_OF_output_AUsW_unblind_posed_binned[,1:36] %>%
  group_by(filename)%>%
   dplyr::mutate(comp1_k3 = rollmean(comp1, k = 10, fill = NA),
                 comp2_k3 = rollmean(comp2, k = 10, fill = NA),
                 comp3_k3 = rollmean(comp3, k = 10, fill = NA)) %>%
    # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
ungroup%>%
  select(filename,subject, bin_frame,expression, drug.placebo, comp1_k3,comp2_k3,comp3_k3)%>%
  gather(component, coef,-bin_frame,-subject, -expression, -drug.placebo,-filename) %>%

  ggplot(aes(bin_frame, coef, color =drug.placebo ))+
  # geom_line()+
  geom_smooth(se = F)+
  geom_smooth(aes(group = filename), se = F, size = .1)+
  facet_grid(component~expression)+
  theme_classic()
  


```


classify substates

- quick test witha  single case

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)
p1_angry<- df_OF_output_AUsW_unblind_posed_binned %>%
  ungroup()%>%
  subset(filename == "./cut_posed_angry_day1_p1.csv")

set.seed(1)
wcss = vector()
colnames(p1_angry)
# for (i in 1:10) wcss[i] = sum(kmeans(p1_angry[,38:41], i)$withinss)
# plot(1:10,
#      wcss,
#      type = 'b',
#      main = paste('The Elbow Method'),
#      xlab = 'Number of clusters',
#      ylab = 'WCSS')
# 
# # Fitting K-Means to the dataset
# set.seed(25)
# kmeans = kmeans(x = clust_dataset, centers = 3)
# y_kmeans = kmeans$cluster
# 
# # Visualising the clusters
# # install.packages("cluster")
# library(cluster)
# 
# ?clusplot
# 
# clust_dataset
# y_kmeans
# clusplot(clust_dataset,
#          y_kmeans,
#          lines = 2,
#          shade = TRUE,
#          color = TRUE,
#          labels = 1,
#          plotchar = FALSE,
#          span = TRUE
#          # label = 
#          # main = paste('Clusters of customers'),
#          # xlab = 'Annual Income',
#          # ylab = 'Spending Score'
#          )
?kmeans

p1_angry<- p1_angry[,c(2,38:41)]

?diff()

p1_angry 

p1_angry1<- p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k4_comp1_speed = (abs(lag(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)),
         k4_comp2_speed = (abs(lag(k4_comp2) - k4_comp2))/abs((lead(bin_frame)-bin_frame)),
         k4_comp3_speed = (abs(lag(k4_comp3) - k4_comp3))/abs((lead(bin_frame)-bin_frame)),
         k4_comp4_speed = (abs(lag(k4_comp4) - k4_comp4))/abs((lead(bin_frame)-bin_frame)),
         k4_comp1_diff =diff(zoo::zoo(k4_comp1), na.pad = TRUE),
         k4_comp2_diff =diff(zoo::zoo(k4_comp2), na.pad = TRUE),
         k4_comp3_diff =diff(zoo::zoo(k4_comp3), na.pad = TRUE),
         k4_comp4_diff =diff(zoo::zoo(k4_comp4), na.pad = TRUE),
         
         # moving averages
         k4_comp1_diff_ma = zoo::rollmean(k4_comp1_diff, k = 5, fill = NA),
         k4_comp2_diff_ma = zoo::rollmean(k4_comp2_diff, k = 5, fill = NA),
         k4_comp3_diff_ma = zoo::rollmean(k4_comp3_diff, k = 5, fill = NA),
         k4_comp4_diff_ma = zoo::rollmean(k4_comp4_diff, k = 5, fill = NA),
           
          k4_comp1_speed_ma = zoo::rollmean(k4_comp1_speed, k = 5, fill = NA),
        k4_comp2_speed_ma = zoo::rollmean(k4_comp2_speed, k = 5, fill = NA),
         k4_comp3_speed_ma = zoo::rollmean(k4_comp3_speed, k = 5, fill = NA),
         k4_comp4_speed_ma = zoo::rollmean(k4_comp4_speed, k = 5, fill = NA),
         )%>%
  select(1,14:21)%>%
gather(component, coef,-bin_frame)%>%
  # group_by( component, bin_frame)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), abs(coef), color = component))+
  geom_line()

p1_angry1<- na.omit(p1_angry1)
p1_angry1
p1_angry1_scale<- p1_angry1%>%mutate_at(2:9, scale)


p1_angry1_scale%>%
  gather(component, coef,-bin_frame)%>%
  # group_by( component, bin_frame)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef, color = component))+
  geom_line()


cor(p1_angry[,2:5])
  
```


```{r}

colnames(p1_angry)


# replace nas
replace_na(list(p1_angry=0, y = 0))
p1_angry<-as.data.frame(p1_angry)
p1_angry[is.na(p1_angry)] <-0

p1_angry[is.na(p1_angry)] <- 0




p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:42))%>%
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame,-kmean_order)%>%
  group_by( component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


# lets compute speed
colnames(p1_angry)
p1_angry<- p1_angry %>%
mutate_at(c(43:46), ~replace(., is.na(.), 0))
  


testk$cluster
testk<-kmeans(p1_angry[,38:41], 3)
colnames(p1_angry)

# let's do the kmeans
p1_angry1_scale
# p1_angry_kmean_clust<- kmeans(p1_angry1_scale[,2:9], 3)
# p1_angry_kmean_clust_speed<- kmeans(p1_angry[,43:46], 3)
# p1_angry$kmean_order<- p1_angry_kmean_clust$cluster
# p1_angry$kmean_order_speed<- p1_angry_kmean_clust_speed$cluster
# 
# p1_angry$kmean_center<- p1_angry_kmean_clust$cluster


# based on dist and speed
# scale predictors

p1_angry_kmean_clust_speed_dist<- kmeans(p1_angry1_scale[,c(2:9)], 3)
p1_angry1_scale$kmean_order_dist_speed<- p1_angry_kmean_clust_speed_dist$cluster


# plot cluster absed on component weights
colnames(p1_angry)
p1_angry1_scale%>%
ungroup()%>%
  # select(c(2,38:42))%>%
  gather(component, coef,-bin_frame,-kmean_order_dist_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_dist_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


left_join(p1_angry1_scale, p1_angry)[,c(1,10:14)]%>%
  # su
  
  # select(c(2,38:42))%>%
  gather(component, coef,-bin_frame,-kmean_order_dist_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_dist_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

# lets test in a seconf example


```



# what we need to do now is for every person run a loop that first for each trial a kmean,

algorithmic from 2 to 10 and 
store
- kmean result cluster in each itteration

we need a list that will store unique trial name + number of K+ resulting k object


when we find these clusters we can write a  simple algorythim that classifies the data into

sustain, activation, sustain, dectivatio sutain
for example is the respective cluster average is bigger than the avergae of all clusters or smaller than,
its sustain.

if the clister dispalcement is bigger than the whole average and the speed is higher than the whole average - displacement, is direction is positive, activation, of direction is negeative is deactovation



```{r}


# <- unique(df_OF_output_AUsW_unblind_posed_binned$filename)
# 228

store_kmeans<- list()

# len <- 5
# empty_list <- vector(mode = "list", length = length(unique_trial))

empty_list


colnames(df_OF_output_AUsW_unblind_posed_binned)

# compute the speed metrics
options(scipen = 999)
df_OF_output_AUsW_unblind_posed_binned

df_OF_output_AUsW_unblind_posed_binned1<- df_OF_output_AUsW_unblind_posed_binned[,1:36]%>%
  ungroup()%>%
  group_by(filename)%>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k3_comp1_speed = (abs(lag(comp1) - comp1))/abs((lead(bin_frame)-bin_frame)),
         k3_comp2_speed = (abs(lag(comp2) - comp2))/abs((lead(bin_frame)-bin_frame)),
         k3_comp3_speed = (abs(lag(comp3) - comp3))/abs((lead(bin_frame)-bin_frame)),
        
         k3_comp1_diff = as.numeric(diff(zoo::zoo(comp1), na.pad = TRUE)),
         k3_comp2_diff =as.numeric(diff(zoo::zoo(comp2), na.pad = TRUE)),
         k3_comp3_diff =as.numeric(diff(zoo::zoo(comp3), na.pad = TRUE)),
         
         # moving averages
         k3_comp1_diff_ma = as.numeric(zoo::rollmean(k3_comp1_diff, k = 5, fill = NA)),
         k3_comp2_diff_ma = as.numeric(zoo::rollmean(k3_comp2_diff, k = 5, fill = NA)),
         k3_comp3_diff_ma = as.numeric(zoo::rollmean(k3_comp3_diff, k = 5, fill = NA)),
           
          k3_comp1_speed_ma = as.numeric(zoo::rollmean(k3_comp1_speed, k = 5, fill = NA)),
        k3_comp2_speed_ma = as.numeric(zoo::rollmean(k3_comp2_speed, k = 5, fill = NA)),
         k3_comp3_speed_ma = as.numeric(zoo::rollmean(k3_comp3_speed, k = 5, fill = NA)))%>%
    ungroup()%>%
  mutate(idno = rep(1:228, each = 100))

# 
# pad NAS
#   mutate(df_OF_output_AUsW_unblind_posed_binned1, across(everything(), ~replace_na(.x, 0)))
# 
#   mutate_at(c("k4_comp1_speed", "k4_comp2_speed", "k4_comp3_speed", "k4_comp4_speed"), ~replace(., is.na(.), 0))


unique(df_OF_output_AUsW_unblind_posed_binned1$filename)
df_OF_output_AUsW_unblind_posed_binned1%>%
  subset(filename == "./cut_posed_sad_day1_p7.csv")%>%
  mutate(speed_diff = abs(k3_comp1_speed - lag(k3_comp1_speed)))%>%
  ggplot(aes(bin_frame, k3_comp1_speed))+
  geom_line()+
  geom_line(aes(y  = speed_diff), color = "red")

df_OF_output_AUsW_unblind_posed_binned

```
  ungroup()%>%
  group_by(filename)%>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k3_comp1_speed = (abs(lag(comp1) - comp1))/abs((lead(bin_frame)-bin_frame)),
         k3_comp2_speed = (abs(lag(comp2) - comp2))/abs((lead(bin_frame)-bin_frame)),
         k3_comp3_speed = (abs(lag(comp3) - comp3))/abs((lead(bin_frame)-bin_frame)),
        
         k3_comp1_diff = as.numeric(diff(zoo::zoo(comp1), na.pad = TRUE)),
         k3_comp2_diff =as.numeric(diff(zoo::zoo(comp2), na.pad = TRUE)),
         k3_comp3_diff =as.numeric(diff(zoo::zoo(comp3), na.pad = TRUE)),
         
         # moving averages
         k3_comp1_diff_ma = as.numeric(zoo::rollmean(k3_comp1_diff, k = 5, fill = NA)),
         k3_comp2_diff_ma = as.numeric(zoo::rollmean(k3_comp2_diff, k = 5, fill = NA)),
         k3_comp3_diff_ma = as.numeric(zoo::rollmean(k3_comp3_diff, k = 5, fill = NA)),
           
          k3_comp1_speed_ma = as.numeric(zoo::rollmean(k3_comp1_speed, k = 5, fill = NA)),
        k3_comp2_speed_ma = as.numeric(zoo::rollmean(k3_comp2_speed, k = 5, fill = NA)),
         k3_comp3_speed_ma = as.numeric(zoo::rollmean(k3_comp3_speed, k = 5, fill = NA)))%>%
    ungroup()%>%
  mutate(idno = rep(1:228, each = 100))
  
quick tst lmer approach
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned1)

lmermodels<-list()

posed_forlmertest_maxnorm <- df_OF_output_AUsW_unblind_posed_binned1[c(1:3,9:10,34:36)] %>%
  group_by(filename)%>%
  gather(comp, nmf_comp_value, -c(1:5))%>%
    group_by(subject)%>%
    mutate(nmf_comp_value = maxnorm(nmf_comp_value))

library(lmerTest)

posed_forlmertest_maxnorm$nmf_comp_value
posed_forlmertest_maxnorm$comp


posed_forlmertest_maxnorm$bin_frame_z <- scale(posed_forlmertest_maxnorm$bin_frame)

lmermodels$moel1<- lmer(nmf_comp_value ~ expression * comp  *drug.placebo +bin_frame_z
       (1 +expression * comp+bin_frame_z | subject),
     REML = FALSE,
     data = posed_forlmertest_maxnorm,
     # optimizer="nloptwrap",
     control = lmerControl(calc.derivs = FALSE),
     verbose = T)

summary(lmermodels$moel1)

lmermodels$moel2<- lmer(nmf_comp_value ~ expression * comp  *drug.placebo +bin_frame_z+
       (1 +expression * comp+bin_frame_z | subject),
     REML = FALSE,
     data = posed_forlmertest_maxnorm,
     # optimizer="nloptwrap",
     control = lmerControl(calc.derivs = FALSE),
     verbose = T)
summary(lmermodels$moel2)
write.csv(posed_forlmertest_maxnorm, "posed_forlmertest_maxnorm.csv")

lmermodels$moel3<- lmer(nmf_comp_value ~ expression * comp  *drug.placebo +bin_frame_z+
       (1 +expression * comp*drug.placebo+bin_frame_z | subject),
     REML = FALSE,
     data = posed_forlmertest_maxnorm,
     # optimizer="nloptwrap",
     control = lmerControl(calc.derivs = FALSE),
     verbose = T)
summary(lmermodels$moel2)



```



spatiotemporal clustering using k-means 

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned1)

empty_list<- list()


df_OF_output_AUsW_unblind_posed_binned1

colnames(df_OF_output_AUsW_unblind_posed_binned1)



df_OF_output_AUsW_unblind_posed_binned2_nona<- df_OF_output_AUsW_unblind_posed_binned1
# replace NAS
df_OF_output_AUsW_unblind_posed_binned2_nona[, 37:48][is.na(df_OF_output_AUsW_unblind_posed_binned2_nona[, 37:48])] <- 0

table(df_OF_output_AUsW_unblind_posed_binned2_nona$filename)
df_OF_output_AUsW_unblind_posed_binned1$idno
colnames(df_OF_output_AUsW_unblind_posed_binned2_nona)



# k-means clustering based on NMF components and derivatives
k3_list<- list()

unique_trial<- unique(df_OF_output_AUsW_unblind_posed_binned2_nona$filename)
 
df_OF_output_AUsW_unblind_posed_binned2_nona
# df_OF_output_AUsW_unblind_posed_binned$clust3<- NA

df_OF_output_AUsW_unblind_posed_binned3_nona<- df_OF_output_AUsW_unblind_posed_binned2_nona
df_OF_output_AUsW_unblind_posed_binned3_nona$clust3<- NA
colnames(df_OF_output_AUsW_unblind_posed_binned2_nona)

# loop fit kmeans and store clusters in the original data

for (u in 1: length(unique_trial)) {
  # subset each trail on every run
   temp_df<- subset(df_OF_output_AUsW_unblind_posed_binned2_nona,filename == unique_trial[u])[,43:48]

       # r = u+r
  # for (k in 2:10) {
    k3_list[[u]] = kmeans(temp_df, 3)
    df_OF_output_AUsW_unblind_posed_binned3_nona$clust3[df_OF_output_AUsW_unblind_posed_binned3_nona$idno == u] <- k3_list[[u]]$cluster
    # r = r+1
}

table(df_OF_output_AUsW_unblind_posed_binned3_nona$clust3)

# visualise one or two people


unique(df_OF_output_AUsW_unblind_posed_binned3_nona$idno)
df_OF_output_AUsW_unblind_posed_binned3_nona

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)

# heurictis ionspired by eye movement classification
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  subset(idno  == 1)%>%
    group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3,
           cutoff = (mean(sp_avg, na.rm = TRUE) + (2* mad(sp_avg, na.rm = TRUE)))) %>%
  ungroup() %>%
  select(c(2,43:49, 50:51, 34:36))%>%
  gather(component, coef,-bin_frame,-clust3,-idno ) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf"))))%>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  # mutate(coef_z = scale(coef))%>%
  group_by(component,var_type, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)+
  geom_hline(yintercept = 0.5118612)
# 0.5118612 1.071568
# the ones where it fails
  # subset(idno  == 5)%>%

# scald

df_OF_output
df_OF_output_AUsW_unblind_posed_binned1$timestamp
colnames(df_OF_output)

colnames(df_OF_output[,c(1,3,300:435,715)])

unique(df_OF_output$filename)

df_OF_output_land<- df_OF_output[,c(1,3,300:435,715)]


# avarage and normalise
df_OF_output_land

library(data.table)

df_OF_output_land_f10<- df_OF_output_land%>%
subset(frame == 10)

df_OF_output_land_f10_dcast<-df_OF_output_land_f10%>%
  group_by(filename)%>%
  gather(key, value, -frame, -timestamp,-filename) %>%
  mutate(coordinate = substr(key,1,1))%>%
  mutate(lanmark_id = substr(key,3,4)) %>%
  dcast(filename+lanmark_id+frame+timestamp~coordinate, value.var = "value",  mean)



# maxnormalize <- function(x, ...) {
#     return((x - min(x, na ...)) /(max(x, ...) - min(x, ...))) }

df_OF_output_land_f10_dcast_norm<- df_OF_output_land_f10_dcast%>%
    group_by(filename,frame)%>%
  mutate(x_new_norm = maxnormalize(x),
         y_new_norm = maxnormalize(y))

df_OF_output_land_f10_dcast_norm%>%
  group_by(lanmark_id)%>%
summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x_new_norm, y_new_norm))+
  geom_point()+
  ylim(1,0)



df_OF_output_land_f10_dcast_normagg<-df_OF_output_land_f10_dcast_norm%>%
  group_by(lanmark_id)%>%
summarise_if(is.numeric, mean, na.rm = T)



# First, isolate the points of interest (the subject's left and right eyes)

left_eye  <- df_OF_output_land_f10_dcast_normagg[df_OF_output_land_f10_dcast_normagg$lanmark_id == 42,]
right_eye <- df_OF_output_land_f10_dcast_normagg[df_OF_output_land_f10_dcast_normagg$lanmark_id == 39,] 

# Now find the difference in the y co-ordinates and x co-ordinates between these two points:

diff_x <- left_eye$x_new_norm - right_eye$x_new_norm
diff_y <- left_eye$y_new_norm - right_eye$y_new_norm


# The arctangent of the ratio will be the angle you need to rotate all the points by:

theta  <- atan2(-diff_y, diff_x)

mat <- matrix(c(cos(theta), sin(theta), -sin(theta), cos(theta)), 2)

df_OF_output_land_f10_dcast_normagg[,8:9] <- t(apply(df_OF_output_land_f10_dcast_normagg[,6:7], 1, function(x) mat %*% x))


df_OF_output_land_f10_dcast_normagg %>%
  ggplot(aes(V1, V2, label = lanmark_id)) + 
  geom_point(color = 'gray') +
  geom_text() +
  scale_y_reverse() +
  theme_bw()


df_OF_output_land_f10_dcast_normagg


install.packages("ggvoronoi")

?ggvoronoi::stat_voronoi
write_csv(df_OF_output_land_f10_dcast_normagg, "df_OF_output_land_f10_dcast_normagg.csv")
df_OF_output_land_f10_dcast_normagg %>%
  arrange(lanmark_id)%>%
  ggplot(aes(V1, V2, label = lanmark_id)) + 
  ggvoronoi::stat_voronoi(geom="path", outline = c(df_OF_output_land_f10_dcast_normagg$V1, df_OF_output_land_f10_dcast_normagg$V2)) +
  geom_point()+
  ylim(1,0)


write_csv(pca_AUs, "pca_AUs.csv")


# coded landmarks
library(readxl)
codeLandmarksAUs <- read_excel("codeLandmarksAUs.xlsx")
View(codeLandmarksAUs)
codeLandmarksAUs%>%
  arrange(lanmark_id)%>%
  ggplot(aes(V1, V2, label = lanmark_id)) + 
  # geom_path()+
  # ggvoronoi::stat_voronoi(geom="path", outline = c(df_OF_output_land_f10_dcast_normagg$V1, df_OF_output_land_f10_dcast_normagg$V2)) +
  geom_point()+
  ylim(1,0)+
  theme_bw()

codeLandmarksAUs


df_OF_output_AUsW_unblind_posed_binned1

library(readxl)
LANDMARKNMF <- read_excel("LANDMARKNMF.xlsx")
View(LANDMARKNMF)

LANDMARKNMF[is.na(LANDMARKNMF)] <- 0

```


```{r}

#Replace NA avalues with 0
LANDMARKNMF <- replace(as.data.frame(LANDMARKNMF),is.na(as.data.frame(LANDMARKNMF)),0)
LANDMARKNMF

LANDMARKNMF%>%
  # mutate()
  arrange(lanmark_id)%>%
  ggplot(aes(V1, V2, label = lanmark_id, color = NMF1)) + 
  # geom_path()+
  # ggvoronoi::stat_voronoi(geom="path", outline = c(df_OF_output_land_f10_dcast_normagg$V1, df_OF_output_land_f10_dcast_normagg$V2)) +
  geom_point()+
  ylim(1,0)+
  theme_bw()


LANDMARKNMF$frame<-NULL

LANDMARKNMF



```


all for loop

```{r}

temp_df_bind<- data.frame() # e empty dataframe to store results

for (f in 1:length(filename_unique)) {
  # f = 2
  # video = filename_video[f]
  temp_df <- df_OF_select%>%
    subset(Stimuli_frame == filename_unique[f])
  
    # start
  message(paste0("running video no_: ", f), paste0("_",filename_unique[f]))


  
  # First, isolate the points of interest (the subject's left and right eyes)
  left_eye  <- temp_df[temp_df$lanmark_id == 42,]
  right_eye <- temp_df[temp_df$lanmark_id == 39,] 
  
  # now find the difference in the y co-ordinates and x co-ordinates between these two points:
  diff_x <- left_eye$x - right_eye$x
  diff_y <- left_eye$y - right_eye$y
  
   message(paste0("angle - ratio - transform"))
  # The arctangent of the ratio will be the angle you need to rotate all the points by:
  theta  <- atan2(-diff_y, diff_x)
  
# print("matrix") 
# To transform the points, you need to create a rotation matrix, which is a specific two-by-two matrix which you can use to rotate the original points:
# 
# enter image description here - https://stackoverflow.com/questions/74493141/align-x-and-y-coordinates-of-face-landmarks-in-r/74493424?noredirect=1#comment131500839_74493424
  mat <- matrix(c(cos(theta), sin(theta), -sin(theta), cos(theta)), 2)

# Now we multiply each x, y point by this matrix to get our rotated points, and write it back into our original data frame:
  temp_df[,9:10] <- t(apply(temp_df[,6:7], 1, function(x) mat %*% x))
  
   message(paste0("bind datasets"))
  
    temp_df_bind<- bind_rows(temp_df_bind,temp_df)
}


```

spatiotemporal clustering

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust = if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ (2*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                                "stable state"))%>%
  
  
   ungroup()%>%
   subset(idno  == 1)%>%
     select(c(2,43:49, 50:52, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64,65))%>%
  gather(component, coef,-bin_frame,-clust3,-idno) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf")))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, clust3)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)




```

# what if we say when speed exceedes X ammounts of sd

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)


```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust = if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ (2*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                                "stable state"))%>%
  
  
   ungroup()%>%
   subset(idno  == 1)%>%
    select(c(2,43:49, 50:52, 34:36,56))%>%
  # select(c(2,52:59, 46:47,38:41,64,65))%>%
  gather(component, coef,-bin_frame,-clust3,-idno,-manual_clust) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf")))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)


```



# if speed is above the adaptive threshold and diff is positive = acceleration
# if speed is abobe the threshold and diff = negative
# anything else stable state


```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)
install.packages("ggforce")

max(df_OF_output_AUsW_unblind_posed_binned3_nona[,46:48])


chool_talk$substate_illustration <-
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
   group_by(idno)%>%
  mutate(comp_delta_avg1 = scale(comp_delta_avg))%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), 
                   # & 
                     # comp_delta_avg > (mean(abs(comp_delta_avg), na.rm = TRUE)+(.5*(mad(abs(comp_delta_avg), na.rm = TRUE)))), 
                   "transition state", "sustain state"))%>%
  group_by(idno, manual_clust_sp_disp)%>%
  
   ungroup()%>%
   subset(idno  == 10)%>%
      select(c(2,43:49, 34:36, 55:56, 58))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno) %>%
  mutate(var_type = if_else(grepl("diff", component ), "3. diff",
                        if_else(grepl("speed", component ), "2. speed",  
                                if_else(grepl("sp_avg", component ), "3. avg speed",  
                                        if_else(grepl("comp_delta_avg", component ), "5. avg diff",  
                            "1. NMF comp"))))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            alpha = .2)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
    # ggforce::facet_col(facets = vars(var_type), 
    #                  scales = "free_y", 
    #                  space = "free")+

  theme_classic()+
  facet_grid(var_type~.)+

  # scale_fill_viridis_d(option = "inferno")+
  theme_classic()+
  xlab("time bin")+
  ylab("coef")+
  p$graphstyle_int+
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 5))+
    scale_fill_brewer(palette = "Dark2")



chool_talk$substate_illustrationnosahde <-
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
   group_by(idno)%>%
  mutate(comp_delta_avg1 = scale(comp_delta_avg))%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), 
                   # & 
                     # comp_delta_avg > (mean(abs(comp_delta_avg), na.rm = TRUE)+(.5*(mad(abs(comp_delta_avg), na.rm = TRUE)))), 
                   "transition state", "sustain state"))%>%
  group_by(idno, manual_clust_sp_disp)%>%
  
   ungroup()%>%
   subset(idno  == 10)%>%
      select(c(2,43:49, 34:36, 55:56, 58))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno) %>%
  mutate(var_type = if_else(grepl("diff", component ), "3. diff",
                        if_else(grepl("speed", component ), "2. speed",  
                                if_else(grepl("sp_avg", component ), "3. avg speed",  
                                        if_else(grepl("comp_delta_avg", component ), "5. avg diff",  
                            "1. NMF comp"))))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef_z, group = component))+

  # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
  #           alpha = .2)  +
    geom_line(aes(group = component, color = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
    # ggforce::facet_col(facets = vars(var_type), 
    #                  scales = "free_y", 
    #                  space = "free")+

  theme_classic()+
  facet_grid(var_type~.)+

  scale_color_viridis_d(option = "magma")+
  theme_classic()+
  xlab("time bin")+
  ylab("coef")+
  p$graphstyle_int+
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 5))
    scale_fill_brewer(palette = "Dark2")


# do a third whether we take the clusters and put transition whenever they are larger than a specified speed



  ggsave("substate_illustration.tiff", chool_talk$substate_illustration,
         device = "tiff",
         width = 10, height = 10, dpi = 800)
  
  
    ggsave("substate_illustrationnoshade.tiff", chool_talk$substate_illustrationnosahde,
         device = "tiff",
         width = 10, height = 10, dpi = 800)
  

```

the k means segmentation




```{r}
# colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)

df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  subset(idno  == 10)%>%
ungroup()%>%
        # select(c(2, 34:36,43:49, 50:53))%>%
   select(c(2, 34:36,50))%>%
  # select(c(2,38:41, 47))%>%
  gather(component, coef,-bin_frame,-clust3)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()
```


```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona$clust3
# okay let's do some smoothing such that a cluster needs to have at least 3 in row



library(dplyr)
library(data.table)


df_OF_output_AUsW_unblind_posed_binned3_nona<- df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  group_by(idno)%>%
    mutate(new = cumsum(clust3)) %>%
    group_by(grp = rleid(clust3)) %>%
    mutate(output = if(n() <2) NA else clust3) %>%
    # ungroup %>%
    # select(idno,grp, new,output,clust3)%>%
    group_by(idno)%>%
  mutate(output1= output)%>%
  fill(output1, .direction = c("down"))

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)


df_OF_output_AUsW_unblind_posed_binned3_nona1<- df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  group_by(filename)%>%
  
  mutate(cluster_ordered = match(clust3, unique(clust3)))%>%
  # select(clust3, bin_frame, cluster_ordered)%>%
  arrange(filename, bin_frame)


  
  colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)

  
  # heatmap drug vs placebo
  df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
     select(c(1,2,9,34:36, 49,55))%>%
  # select(c(1,2,9,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(filename,component, bin_frame,cluster_ordered, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~.)
  
  
  
  
  # to do: do this plot with the heuristics
  # colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)
  
  
```


```{r}
  
  df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  # group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (2*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
      select(c(2, 9,10, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno,-drug.placebo,-expression) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(idno,component, bin_frame,manual_clust_sp_disp, drug.placebo,expression)%>%
  
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.factor(idno)))+
            geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
 #            alpha = .9)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  scale_color_brewer(palette = "dark2")+
  # facet_grid(drug.placebo~expression)+
    scale_fill_viridis_d(option = "inferno")

  
```



now heat maps bye xpression
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
       select(c(1,2,10,34:36, 49,55))%>%
  # select(c(1,2,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -expression)%>%
  group_by(filename,component, bin_frame,cluster_ordered,expression)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)


```



```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
        select(c(1,2,3,10,34:36, 49,55))%>%
  # select(c(1,2,3,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -expression,-subject)%>%
  group_by(filename,component, bin_frame,cluster_ordered,expression, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered)))+

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)+
  scale_fill_viridis_d()

```



```{r}
# heap with participants and clusters
 df_OF_output_AUsW_unblind_posed_binned3 %>%
  
  # compare kmean and manual clustering
  # group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg > 
                     1.5*(mad(comp_delta_avg, na.rm = TRUE))+mean(sp_avg, na.rm = TRUE), "activation state", 
                    
                   if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < mean(sp_avg, na.rm = TRUE)+
                              (-1.5*(mad(comp_delta_avg, na.rm = TRUE))), "de-activation state", 
                   
                                "stable state")))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
    select(c(1,2,3,9,34:36, 49,57))%>%
      # select(c(2, 9, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-drug.placebo) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(subject,component, bin_frame,manual_clust_sp_disp, drug.placebo)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
   geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            # alpha = .3)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  # facet_grid(drug.placebo~.)+
     scale_fill_viridis_d()
    

```


```{r}
    
# expresion
    
 df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "activation state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
    select(c(1,2,3,10,34:36, 49,57))%>%
      # select(c(2, 9, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
   group_by(subject,component,manual_clust_sp_disp, expression)%>%
   # mutate_at(c())
  group_by(subject,component, bin_frame,manual_clust_sp_disp, expression)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
   geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            # alpha = .3)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)+
   # scale_fill_brewer(palette = "Dark2")
     # scale_fill_viridis_d()
    scale_fill_viridis_d(option = "plasma")



```

COMPUTE THE HEURISTIC BASED CLUSTERS AND PUT TO THE DATAFRAME

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust<- df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()


# now compare the speed per cluster
# copare duration of custers


   # subset(idno  == 10)%>%

  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression) %>%
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, clust_frame_no_bin))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  ggtitle("transition state")
```
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)



```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp,subject)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, expression,subject)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression , clust_frame_no_bin, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
      geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # facet_grid(~expression)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  ggtitle("transition state")

# stable
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, clust_frame_no_bin))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
   ggtitle("stable state")


# colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, manual_clust_sp_disp,component, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # facet_grid(~drug.placebo)+
  theme_classic()+
    ggpubr::stat_compare_means()+
  ggtitle("transition state")


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  # subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = manual_clust_sp_disp))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
  # facet_grid(~drug.placebo)+
  theme_classic()+
  facet_grid(~manual_clust_sp_disp)+
  ggpubr::stat_compare_means()+
     ggtitle("stable state")
  



  
  
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE),
          sp_sd_clust = sd(sp_avg, na.rm = TRUE)) %>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  # subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, sp_sd_clust, color = manual_clust_sp_disp))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
  # facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  facet_grid(~manual_clust_sp_disp)
  
  
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg

  df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE),
          sp_sd_clust = sd(sp_avg, na.rm = TRUE),
         RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)))   %>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE) %>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, RMS_sd_clust, color = manual_clust_sp_disp))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
      facet_grid(~manual_clust_sp_disp)+
  # facet_grid(~)+
  theme_classic()
      # ggpubr::stat_compare_means()+
  
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  # subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = manual_clust_sp_disp))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
  # facet_grid(~drug.placebo)+
  theme_classic()+
  facet_grid(~manual_clust_sp_disp)+
  ggpubr::stat_compare_means()+
     ggtitle("stable state")



```

Count how any states do we have

```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$BMI


df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp
library(data.table)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, drug.placebo)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
    mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(grp, color = expression, fill = expression))+
  geom_histogram(aes(y=..density..), alpha=0.5,
                position="identity")+
   geom_density(alpha=.2)+
  facet_grid(~drug.placebo)+
  theme_classic()


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, drug.placebo)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(expression, log(grp+.1), color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  facet_grid(~drug.placebo)+
  theme_classic()

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, drug.placebo, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(drug.placebo, grp, color = drug.placebo))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  # facet_grid(~drug.placebo)+
  theme_classic()


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(expression, grp, color = expression))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
    geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  # facet_grid(~drug.placebo)+
  theme_classic()
```


 model mixed models on the variables above

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(clust_frame_no = rleid(manual_clust_sp_disp))

# 
df_OF_output_AUsW_unblind_posed_binned3_nona_clust

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)
lmer_substates<- list()

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp)

library(lmerTest)

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$clust_frame_no)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg<-
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  group_by(filename, subject,drug.placebo,expression)%>%
  summarise_if(is.numeric, max, na.rm = TRUE)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$clust_frame_no

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$subject)

lmer_substates$clust_no <- glmer(clust_frame_no ~   1+expression+
                              (1 |subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg,
                            # REML = FALSE)
                            # ,
                            family = "poisson")
?isSingular
isSingular(lmer_substates$clust_no, tol = .002)

summary(lmer_substates$clust_no )

anova(lmer_substates$clust_no)

emmeans::emmeans(lmer_substates$clust_no, pairwise~drug.placebo, type = "response" )
emmeans::emmeans(lmer_substates$clust_no, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$clust_no, pairwise~ drug.placebo|expression, type = "response" )


interactions::cat_plot(lmer_substates$clust_no, pred = expression, modx = drug.placebo)



# 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  #     select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
   group_by(filename, subject,drug.placebo,expression,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$clust_frame_no_bin)


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$subject)

lmer_substates$clust_no_framebin <- glmer(clust_frame_no_bin ~  manual_clust_sp_disp * expression+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2,
                            # REML = FALSE)
                            # ,
                            family = "poisson")

summary(lmer_substates$clust_no_framebin)

anova(lmer_substates$clust_no_framebin)

emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~drug.placebo, type = "response" )
emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~ expression|manual_clust_sp_disp, type = "response" )

# m,odel how many states are ine ach 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  group_by(filename, subject,drug.placebo,expression)%>%
  summarise_if(is.numeric, max, na.rm = TRUE)

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3$grp)

lmer_substates$howmanystate_trans <- glmer(grp ~  drug.placebo * expression+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3,
                            # REML = FALSE)
                            # ,
                            family = "poisson")

summary(lmer_substates$howmanystate_trans)
anova(lmer_substates$howmanystate_trans)

# speed

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust  %>%
      # select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         # speed
         sp_avg_clust_k1 = mean(k3_comp1_speed_ma, na.rm = TRUE),
         sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         RMS_sd_clust_k1 = sqrt(mean(((lead(k3_comp1_speed_ma) - k3_comp1_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k2 = sqrt(mean(((lead(k3_comp2_speed_ma) - k3_comp2_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k3 = sqrt(mean(((lead(k3_comp3_speed_ma) - k3_comp3_speed_ma)^2),na.rm = TRUE)))%>%
         
          # 
          # 
          # sp_sd_clust = sd(sp_avg, na.rm = TRUE),
          # RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)),
          # RMS_diff_clust = sqrt(mean((comp_delta_avg^2),na.rm = TRUE)))   %>%
         # )%>%
group_by(filename, manual_clust_sp_disp, expression, subject, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4$test_ind<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4$drug.placebo == "drug", 1,0)


# do we compute these metrics for each co,ponent or just averages?
# 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$k3_comp1_diff_ma


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust  %>%
      # select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust
group_by(filename,manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         # speed
         sp_avg_clust_k1 = mean(k3_comp1_speed_ma, na.rm = TRUE),
         sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         
          avg_disp_clust_k1 = sum(abs(k3_comp1_diff_ma), na.rm = TRUE),
          avg_disp_clust_k2 = sum(abs(k3_comp2_diff_ma), na.rm = TRUE),
          avg_disp_clust_k3 = sum(abs(k3_comp3_diff_ma), na.rm = TRUE),
         # sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         # sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         
         
        peak_sp_avg_clust_k1 = max(k3_comp1_speed_ma, na.rm = TRUE),
          peak_sp_avg_clust_k2 = max(k3_comp2_speed_ma, na.rm = TRUE),
          peak_sp_avg_clust_k3 = max(k3_comp3_speed_ma, na.rm = TRUE),
         
         RMS_sd_clust_k1 = sqrt(mean(((lead(k3_comp1_speed_ma) - k3_comp1_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k2 = sqrt(mean(((lead(k3_comp2_speed_ma) - k3_comp2_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k3 = sqrt(mean(((lead(k3_comp3_speed_ma) - k3_comp3_speed_ma)^2),na.rm = TRUE)))%>%
         
          # 
          # 
          # sp_sd_clust = sd(sp_avg, na.rm = TRUE),
          # RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)),
          # RMS_diff_clust = sqrt(mean((comp_delta_avg^2),na.rm = TRUE)))   %>%
         # )%>%
group_by(filename, manual_clust_sp_disp, expression, subject, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)


# power low
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  # subset(manual_clust_sp_disp == "stable state")%>%
  
  ggplot(aes(avg_disp_clust_k1,peak_sp_avg_clust_k1, color = expression))+
  geom_point(alpha = .5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~manual_clust_sp_disp)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
   #                    method.args = list(family = gaussian(link = 'log2'),
   #                                       start=c(A=0,B=0)), size = .2)+
  
 geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor()+
  scale_color_brewer(palette = "Dark2")+
  # scale_color_viridis_d(option = "inferno")+
  p$graphstyle_int


chool_talk$speed_disp_fucntionk1 
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum%>%
  ungroup()%>%
  mutate_if(is.numeric, maxnorm)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k1,peak_sp_avg_clust_k1, color = expression))+
  geom_point(alpha = .5, size = 1.5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~statespace)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)))+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(p.accuracy = .001)+
  ylab("peak speed k1 - au")+
   xlab("displacement k1 - au")+
  scale_color_brewer(palette = "Dark2")+
    scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))+
  # scale_colour_viridis_d()+
  # ggpubr::stat_conf_ellipse()+
  p$graphstyle_int+
    theme(panel.spacing = unit(1, "cm"))

```

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq$statespace<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq$manual_clust_sp_disp == "stable state",
"sustain", "transition")

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum$statespace<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq_sum$manual_clust_sp_disp == "stable state",
"sustain", "transition")

chool_talk$speed_disp_fucntionk2 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  ungroup()%>%
  mutate_if(is.numeric, maxnorm)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k2,peak_sp_avg_clust_k2, color = expression))+
  geom_point(alpha = .5, size = 1.5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~statespace)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)))+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(p.accuracy = .001)+
  ylab("peak speed k2 - au")+
   xlab("displacement k2 - au")+
  scale_color_brewer(palette = "Dark2")+
    scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))+
  # scale_colour_viridis_d()+
  # ggpubr::stat_conf_ellipse()+
  p$graphstyle_int+
    theme(panel.spacing = unit(1, "cm"))


chool_talk$speed_disp_fucntionk3 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
ungroup()%>%
  mutate_if(is.numeric, maxnorm)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k3,peak_sp_avg_clust_k3, color = expression))+
  geom_point(alpha = .5, size = 1.5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(.~statespace)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = expression), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)))+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(p.accuracy = .001)+
  ylab("peak speed k3 - au")+
   xlab("displacement k3 - au")+
  scale_color_brewer(palette = "Dark2")+
  # scale_colour_viridis_d()+
  # ggpubr::stat_conf_ellipse()+
    scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))+
  p$graphstyle_int+
    theme(panel.spacing = unit(1, "cm"))


chool_talk$speed_disp_fucntionk3

library(patchwork)
chool_talk$speed_displace_fucn_patch<- (chool_talk$speed_disp_fucntionk1 +chool_talk$speed_disp_fucntionk2 +chool_talk$speed_disp_fucntionk3)+
   plot_layout(guides = "collect") & theme(legend.position = "top")


chool_talk$speed_displace_fucn_patch+  scale_x_continuous(breaks = c(0,.5,1), limits = c(0,1))
ggsave("speed_displace_fucn_patch2.tiff", chool_talk$speed_displace_fucn_patch,
       device = "tiff",
       width = 18, height = 5, dpi = 100)
```



```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq


df %>%
  gather(key = "age", value = "age_values", age1, age2) %>%
  gather(key = "weight", value = "weight_values", weight1, weight2) %>%
  filter(substring(age, 4) == substring(weight, 7))


speed_dis_func_agg_lmer<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq %>%
  # group_by(filename)
  gather(key = "speed_k", value = "peak_speed", peak_sp_avg_clust_k1, peak_sp_avg_clust_k2,
         peak_sp_avg_clust_k3) %>%
  gather(key = "displ_k", value = "disp_avg", avg_disp_clust_k1, avg_disp_clust_k2,
         avg_disp_clust_k3)%>%
  group_by(filename, subject, expression, manual_clust_sp_disp, drug.placebo,speed_k,displ_k)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
library(lmerTest)
poly()
lmer_substates$speed_diusp_fucn <- lmer(peak_speed ~ poly(disp_avg, degree = 2) * drug.placebo  + (1|manual_clust_sp_disp),
                                       REML = FALSE,data = speed_dis_func_agg_lmer)

summary(lmer_substates$speed_diusp_fucn)
anova(lmer_substates$speed_diusp_fucn)
```

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  group_by(subject)%>%
  mutate(n_subj = n())%>%
  subset(n_subj>6)%>%
  # subset(manual_clust_sp_disp == "transition state")%>%
  
  ggplot(aes(avg_disp_clust_k3,peak_sp_avg_clust_k3, color = drug.placebo))+
  geom_point(alpha = .5)+
 
  # geom_smooth(aes(group = subject), se = F)+
  facet_grid(~manual_clust_sp_disp)+
  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   geom_smooth(aes(group = drug.placebo), method = "glm", formula = y~log(x+.1),
                      method.args = list(
                                         start=c(A=0,B=0)), size = .2)+
  
 # geom_smooth(aes(group = expression), method = "glm", formula = y~log(x),
 #                      method.args = list(start=c(A=0,B=0)), size = .2)+
  theme_classic()+
  ggpubr::stat_cor(method = "spearman", cor.coef.name = c("R"))+
  # ggpubr::stat_conf_ellipse()+
  scale_color_brewer(palette = "Dark2")+
  # scale_color_viridis_d(option = "inferno")+
  p$graphstyle_int


1lmer(peak_s)


test<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  group_by(subject)%>%
  mutate(n_subj = n())%>%
  subset(n_subj>6)

unique(test$subject)
```




df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq %>%
  # group_by(manual_clust_sp_disp)%>%
  # mutate_if(is.numeric, scale) %>%
  ggplot(aes(expression, avg_disp_clust_k1))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~ manual_clust_sp_disp)+
  ggpubr::stat_compare_means(method = "anova")+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(2.5, 3.5, 4.5))
   stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons)
   
   
   write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq, "df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq.csv")
```





df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1_main_seq%>%
  subset(manual_clust_sp_disp != "stable state")%>%
  # group_by(expression)%>%
  # mutate_if(is.numeric, maxnorm)%>%
  # 
  ggplot(aes(avg_disp_clust_k1,peak_sp_avg_clust_k1, color = expression,group = expression))+

 
  # geom_smooth(aes(group = subject), se = F)+

  # geom_smooth(method = "lm", formula = y~x,col="blue", se=FALSE)+
  # geom_smooth(method = "nls", formula = y~A*x^ B, se=FALSE,col="red", 
  #             method.args =list(start=c(A=0,B=0)))
  # 
  
     # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
     #                  method.args = list(start=c(A=0,B=0)), size = .2)+
   # geom_smooth(aes(group = expression), method = "glm", formula = y~x,
   #                    method.args = list(family = gaussian(link = 'log2'),
   #                                       start=c(A=0,B=0)), size = .2)+

    geom_point(alpha = .5)+
  
 # geom_smooth(aes(group = expression), method = "nls",
 #             method.args = list(start=c(a=21,b=0)),
 #             formula = y~a*log(b*x),
 #             size = .2,)+

    facet_grid(.~manual_clust_sp_disp)+
  theme_classic()+
  # ggpubr::stat_cor()+
  scale_color_brewer(palette = "Dark2")+
  # scale_color_viridis_d(option = "inferno")+
  p$graphstyle_int

```


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust  %>%
      # select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust
group_by(filename,manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         # speed
         sp_avg_clust_k1 = mean(k3_comp1_speed_ma, na.rm = TRUE),
         sp_avg_clust_k2 = mean(k3_comp2_speed_ma, na.rm = TRUE),
         sp_avg_clust_k3 = mean(k3_comp3_speed_ma, na.rm = TRUE),
         RMS_sd_clust_k1 = sqrt(mean(((lead(k3_comp1_speed_ma) - k3_comp1_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k2 = sqrt(mean(((lead(k3_comp2_speed_ma) - k3_comp2_speed_ma)^2),na.rm = TRUE)),
        RMS_sd_clust_k3 = sqrt(mean(((lead(k3_comp3_speed_ma) - k3_comp3_speed_ma)^2),na.rm = TRUE)))%>%
         
          # 
          # 
          # sp_sd_clust = sd(sp_avg, na.rm = TRUE),
          # RMS_sd_clust = sqrt(mean(((lead(sp_avg) - sp_avg)^2),na.rm = TRUE)),
          # RMS_diff_clust = sqrt(mean((comp_delta_avg^2),na.rm = TRUE)))   %>%
         # )%>%
group_by(filename, expression, subject, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)

write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,"df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.csv")


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$test_ind<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$drug.placebo == "drug", 1,0)
write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1,
          "df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1.csv")

```

```

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2$test_ind<- if_else(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2$drug.placebo == "drug", 1,0)
write_csv(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2,
          "df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2.csv")


my_comparisons <- list( c("angry", "sad"), c("angry", "happy"), c("happy", "sad") )
ggboxplot(ToothGrowth, x = "dose", y = "len",
          color = "dose", palette = "npg")+
# Add pairwise comparisons p-value
stat_compare_means(comparisons = my_comparisons, label.y = c(29, 35, 40))+
stat_compare_means(label.y = 45)     # Add global Anova p-value

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2)

library(ggpubr)

```

```

```{r}

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1:5,60:62)]%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
  
  
  # select(!starts_with("comp"))%>%
  gather(component_AU, coef, - filename, - manual_clust_sp_disp, - expression, - subject, - drug.placebo)%>%
  group_by(component_AU)%>%
  
  
  #   group_by(component_AU,manual_clust_sp_disp)%>%
  # mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = manual_clust_sp_disp))+
  # geom_jitter(width = .1, alpha = .1, position = position_dodge())+
  geom_bar(stat = "summary", fun.y = "mean", alpha = .1, position = position_dodge())+
  stat_summary(geom = "pointrange", position = position_dodge(1))+
  stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70", position = position_dodge(1))+
  facet_grid( ~ component_AU)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  stat_compare_means(aes(label = ..p.signif..),method = "anova", label.y = 3)+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(1.8, 2, 2.2))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()


colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$Speed_RMS_AVG<-
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$RMS_sd_clust_k1+
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$RMS_sd_clust_k2+
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$RMS_sd_clust_k3


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$com_sum<-
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$comp1+
  df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$comp2+
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1$comp3


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1:5, 64)]%>%
  # select(!starts_with("comp"))%>%
  gather(component_AU, coef, - filename, - manual_clust_sp_disp, - expression, - subject, - drug.placebo)%>%

  #   group_by(component_AU,manual_clust_sp_disp)%>%
  # mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  geom_bar(stat = "summary", fun.y = "mean", alpha = .1)+
  stat_summary(geom = "pointrange")+
  stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70")+
  facet_grid( ~manual_clust_sp_disp)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  stat_compare_means(aes(label = ..p.signif..),method = "anova", label.y = 3)+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(1.8, 2, 2.2))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()



colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1,3:5, 49,33:35,57:59)]%>%
  # df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
  
  
  # select(!starts_with("comp"))%>%
  gather(component_AU, coef, - filename, - clust3, - expression, - subject, - drug.placebo)%>%
  # group_by(component_AU)%>%
  
  
    # group_by(component_AU,clust3)%>%
  # mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,clust3)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = expression))+
  # geom_jitter(width = .1, alpha = .1)+
  # geom_bar(stat = "summary", fun.y = "mean", alpha = .1)+
  stat_summary(geom = "pointrange", fun = mean)+
  # stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70")+
  facet_grid( clust3~ component_AU)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  # stat_compare_means(aes(label = ..p.signif..),method = "anova", label.y = 3)+
  # stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     # label.y = c(1.8, 2, 2.2))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()


write_csv("RMS_new.csv",
          df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1
```
  

unique(test$component_AU)
 # gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject)%>%
   
   
   
# corr
   
   df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.1[,c(1:5,33:35,60:62)]%>%
  select(!starts_with("RMS"))%>%
  gather(component_AU, coef, - filename, - manual_clust_sp_disp, - expression, - subject, - drug.placebo)%>%
  group_by(component_AU)%>%
  
  mutate_at(c("coef"), scale)%>%
    group_by(component_AU, expression, subject,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(expression, coef, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  geom_bar(stat = "summary", fun.y = "mean", alpha = .1)+
  stat_summary(geom = "pointrange")+
  stat_summary(aes(group = subject), geom = "line", alpha = .1, size = .5, color = "gray70")+
  facet_grid( manual_clust_sp_disp~ component_AU)+
  theme(axis.text.x = element_text(angle = 90))+
  # ggpubr::stat_compare_means(method = "t.test")+
  # stat_compare_means(method = "anova", label.y = 10)+
  stat_compare_means(aes(label = ..p.signif..), comparisons = my_comparisons,
                     label.y = c(2.5, 3.5, 4.5))+
# stat_compare_means(label.y = 3.5)  +
  theme_classic()
  
# 
# unique(test$component_AU)
#  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject)
#  
 dcast_time2_aggjasp
 df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2
 
space_time<- left_join(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4.2,
           dcast_time2_aggjasp, by = "filename")
write_csv(space_time, "space_time.csv")
```


df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg


lmer_substates$speed <- lmer(sp_avg_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1+|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed)

# emmeans::emmeans(lmer_substates$speed , pairwise~drug.placebo, type = "response" ) #ns
emmeans::emmeans(lmer_substates$speed, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$speed, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot
int_plot_speed <- interactions::cat_plot(lmer_substates$speed, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)
  ggExtra::ggMarginal(int_plot_speed)

  library(ggside)

  int_plot_speed+ geom_ysidedensity(aes(x=stat(density), fill = expression), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "left") +
  labs(title = "FacetNull", subtitle = "Xside placed bottom, Yside placed left")
  
  
  # sd
lmer_substates$speed1 <- lmer(sp_sd_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed1)

emmeans::emmeans(lmer_substates$speed1, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$speed1, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot

int_plot_speed1<- interactions::cat_plot(lmer_substates$speed1, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)


   int_plot_speed1+ geom_ysidedensity(aes(x=stat(density), color = expression,  fill = expression), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "left") +
  labs(title = "FacetNull", subtitle = "Xside placed bottom, Yside placed left")+
     facet_grid(~manual_clust_sp_disp)+
    geom_smooth(aes(group = subject), method = "lm", se = F)
   
   
   # RMS_sd_clust
   
   lmer_substates$speed2 <- lmer(RMS_sd_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed2)

emmeans::emmeans(lmer_substates$speed2, pairwise~expression, type = "response" )
emmeans::emmeans(lmer_substates$speed2, pairwise~ manual_clust_sp_disp, type = "response" )

emmeans::emmeans(lmer_substates$speed2, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot

interactions::cat_plot(lmer_substates$speed2, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)
   
   

   
  
```

```{r}
# try anovas

library(afex)
library(car)
# avg number of frames 
afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2,
              id = "subject",
              dv = "clust_frame_no_bin",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)


afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg,
              id = "subject",
              dv = "clust_frame_no",
              within = c("drug.placebo", "expression"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

# how many states


afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3,
              id = "subject",
              dv = "grp",
              within = c("drug.placebo", "expression"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

# speed
afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
              id = "subject",
              dv = "sp_avg_clust",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4

afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
              id = "subject",
              dv = "RMS_sd_clust",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

```




```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
  select(c(1,2,3,9,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject)%>%
  group_by(filename,component, bin_frame,cluster_ordered,drug.placebo, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered))) +

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~.)+
  scale_fill_viridis_d()



df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
  select(c(1,2,3,9,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject,-expression)%>%
  group_by(filename,component, bin_frame,cluster_ordered, expression, drug.placebo, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered)))+

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~expression)+
  scale_fill_viridis_d()


# let's plot variabkes based on the clusters
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  ungroup()%>%
  select(c(3,9,10,48:59, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-cluster_ordered, -drug.placebo,-subject,-expression,)%>%
  group_by(cluster_ordered, drug.placebo,subject,expression,component)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(cluster_ordered), coef))+
  geom_jitter(width = .1, alpha = .01)+
  geom_boxplot(alpha = .1)+
  facet_grid(~component)+
  theme_classic()

```



```{r}

# don't plot
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  ungroup()%>%
  select(c(3,9,10,48:52, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-cluster_ordered, -drug.placebo,-subject,-expression,)%>%
  group_by(cluster_ordered, drug.placebo,subject,expression,component)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(component ), coef))+
  geom_jitter(width = .1, alpha = .01)+
  geom_boxplot(alpha = .1)+
  geom_smooth(aes(group = subject), se = F, size = .1)+
  # facet_grid(~cluster_ordered)+
  theme_classic()
```

new algorithm first find sustain and transition
based on:
- if cluster duration (in frames) > than the average duration of a cluster = sustain (this is beacuse transition should be short, sustain should be longest, so)

and the cluster avg speed < than the average speed



```{r}

rleid(df_OF_output_AUsW_unblind_posed_binned3_nona1$cluster_ordered)

df_OF_output_AUsW_unblind_posed_binned3_nona2<- df_OF_output_AUsW_unblind_posed_binned3_nona1 %>%
  ungroup()%>%
  group_by(idno)%>%
  mutate(cluster_ordered_unique = rleid(cluster_ordered), bin_new_id = 1:n())%>%
  group_by(idno, cluster_ordered_unique)%>%
  mutate(frame_dur = n())%>%
  group_by(idno)%>%
  mutate(frame_dur_avg = mean(frame_dur, na.rm = TRUE),
         frame_dur_min = min(frame_dur, na.rm = TRUE),
         frame_dur_max = max(frame_dur, na.rm  = TRUE),
         )
  

df_OF_output_AUsW_unblind_posed_binned3_nona3<-
df_OF_output_AUsW_unblind_posed_binned3_nona2%>%
  group_by(idno)%>%
  mutate(name_new_clust = if_else(frame_dur> frame_dur_avg, "sustain", "transition"))
  
  
  select(c(3,9,10,48:56, 64))
  
  
  
  colnames(df_OF_output_AUsW_unblind_posed_binned3_nona3)
  
  df_OF_output_AUsW_unblind_posed_binned3_nona3%>%
  subset(idno  == 12)%>%
ungroup()%>%
  select(c(2,38:41, 46,71))%>%
  gather(component, coef,-bin_frame,-name_new_clust,-idno )%>%
  group_by(component, bin_frame,name_new_clust)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(name_new_clust)), 
            alpha = .5)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

```


then look at transitions to find

if the average weight of the last 2 samples of the transition a higher than the first 2 samples then its activation, if the last two samples value if lower than the first 2 then deactivation

```{r}

```

transform(k3_list[[1]]$cluster, id = as.numeric(factor(k3_list[[1]]$cluster)))
# create a unique value for new values ina. column in r

df2 <- transform(df,id=as.numeric(factor(sample)))

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(filename)%>%
  group_indices(clust3)
  transform(id = as.numeric(factor(clust3)))
  
  
colnames(df_OF_output_AUsW_unblind_posed_binned)
  
df_OF_output_AUsW_unblind_posed_binned%>%
  
  ggplot(aes(as.numeric(bin_frame), idno))+
  # ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(~drug.placebo)



```


  message(sprintf("$$$$$RUNING kmean %i", i))
  
  
  
  resampled_temp_test<- fabricatr::resample_data(clustering_new_pre_PCA3.1 [,c(1,2,3, 5:9)], 
                                  N = c(51,55),
                                  ID_labels = c("ssid", "stimDescription"),
                                  unique_labels = TRUE)
  resampled_temp$sim_no = i
  
# run PCA on the resampled data
# ?list
    message(sprintf("$$$$$fitting PCA %i", i))
mfa.res_res <- FactoMineR::MFA(resampled_temp[,1:8], 
               group = c(3, 3, 2), 
               type = c("n", "s", "s"),
              # ind.sup = c(1),
              ncp = 2,
               name.group = c("pp_stim","auton","subj"),
               num.group.sup = c(1),
               # ind.sup = c(1,2),
               graph = FALSE)


# store the eigen values
  message(sprintf("$$$$$storing PCA %i", i))
eugentest<- as.data.frame(mfa.res_res$eig[1:2,])
eugentest$sim_no<- i

cortest<- as.data.frame(mfa.res_res$quanti.var$cor)
cortest$sim_no = i

partials_temp<- as.data.frame(res.mfa_bio_vs_self2_k2$partial.axes$cor)
partials_temp$sim_no = i
# update the initial d=frames
  message(sprintf("$$$$$upating dataframes %i", i))
  resamp_1st<- (bind_rows(resamp_1st, resampled_temp))
eigen_first<- bind_rows(eigen_first, eugentest)
cor_first<- bind_rows(cor_first, cortest)
partials_first<- bind_rows(partials_first, partials_temp)
  message(sprintf("$$$$$completed iteration%i", i))
}



```

store the cluster


```
colnames(df_OF_output_AUsW_unblind_posed_binned_max_norm)
df_OF_output_AUsW_unblind_posed_binned_max_norm[, c(2,3,10,1:17)]%>%
  gather(AU,coef,-subject, -expression,-bin_frame)%>%
  group_by(subject,AU)%>%
  # mutate(coef = maxnorm(coef))%>%
  group_by(bin_frame,subject,AU, expression)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(bin_frame, AU, fill = coef))+
  geom_tile()+
  scale_fill_viridis_c(option = "magma")+
  facet_grid(~expression)
  

```{r}

df_OF_output_AUsW_unblind_posed_binned1_gather
df_OF_output_AUsW_unblind_posed_binned1_gather
colnames(df_OF_output_AUsW_unblind_posed_binned1_gather)
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona3)


df_OF_output_AUsW_unblind_posed_binned3_nona3[, c(2,3,10,16:32)]%>%
  gather(AU,coef,-subject, -expression,-bin_frame)%>%
  group_by(subject,AU)%>%
  mutate(coef = maxnorm(coef))%>%
  group_by(bin_frame,subject,AU, expression)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(bin_frame, AU, fill = coef))+
  geom_tile()+
  scale_fill_viridis_c(option = "magma")+
  facet_grid(~expression)


df_OF_output_AUsW_unblind_posed_binned[, c(2,3,10,16:32)]%>%
  gather(AU,coef,-subject, -expression,-bin_frame)%>%
  group_by(subject,AU)%>%
  mutate(coef = maxnorm(coef))%>%
  group_by(bin_frame,subject,AU, expression)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(bin_frame, AU, fill = coef))+
  geom_tile()+
  scale_fill_viridis_c(option = "magma")+
  facet_grid(~expression)


# spoken
colnames(df_OF_output_AUsW_unblind_spoken1_binned_NOZERO)
df_OF_output_AUsW_unblind_spoken1_binned_NOZERO[, c(1,2,3,10,17:33)]%>%
  gather(AU,coef,-subject, -expression,-bin_frame,-filename)%>%
  group_by(subject,AU)%>%
  mutate(coef = maxnorm(coef))%>%
  group_by(bin_frame,subject,AU, expression)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(bin_frame, AU, fill = coef))+
  geom_tile()+
  scale_fill_viridis_c(option = "magma")+
  facet_grid(~expression)
```
