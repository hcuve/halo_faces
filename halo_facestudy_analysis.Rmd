---
title: "analysys_halofacestudy"
author: "Helio"
date: "06/06/2022"
output: html_document
---


dependencies: preprocss_halofaces.Rmd
df_OF_output_AUsW_unblind_posed



for the actual analyses we want
1- learn spatiotemporal structure suing NMF
2 - does drug vs no drug differ in NMF metrics?
3- can we separate groups based on NMF components using BADIA

spatiotemporal dynamics
- movement substates (initiation, sustainement, etc)
- if we use kmean clustering, do we have differences into how many substaes are there
- or if we use a fixed number of substaes, are there significant temporal differences (e.g. duration, reccurence)

preferences
```{r}
library(tidyverse)
library(data.table)

library(NMF)

```


Steps and decision
initialisation = random seed
find k
set iteratiions
fit final


fit drug and placebo separatelly?
```{r}
# Initialise and find k

colnames(df_OF_output_AUsW_unblind_posed_binned)


df_OF_output_AUsW_unblind_posed_binned

# single run and single numeric seed for reproducibility
res_find_k <- nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], 2:6, 
                      seed=123456,
                      nrun = 100,
                       .options = 'v')

summary(res_find_k)

# plot quality measures by rank (k)
NMF::plot(res_find_k)+
  geom_vline(xintercept = 3)

# ?NMF::consensusmap
NMF::consensusmap(res_find_k)


```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

between 3 and 4

Check for overfiting by reshufling the ata and refitting the NMF on simulated data
SHUFFLING to avoid overfiting to noise

```{r}
# shuffle original data 
colnames(df_OF_output_AUsW_unblind_posed_binned)

V.random <- randomize(df_OF_output_AUsW_unblind_posed_binned[,16:32]) 

# estimate quality measures from the shuffled data (use default NMF algorithm) 
estim.k.random <- nmf(V.random, 2:6, nrun=100, seed=123456,
                      .option = 'v') 

# then we can assess the quality of random estimation to our estimation

# plot measures on same graph (x, y) 
plot(res_k3, estim.k.random) + 
  geom_vline(xintercept = 3)


```

We select values of k where the magnitude of the cophenetic correlation coefficient begins to fall (see below).
so now we can fit the final model

```{r}

res_k3 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #

res_k2 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r =2, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


plot(res_k3)
summary(res_k3)

# basis components 
NMF::basismap(res_k3) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3) #hidden variables

# access more info
# res_k3_em

res_k4 <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned[,16:32], r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 
coefmap(res_k4) 


```






Combine the data and visualise
```{r}
res_k3@fit@H

df_OF_output_AUsW_unblind_posed_binned$NMFtable<- as.data.frame(res_k3@fit@W)

df_OF_output_AUsW_unblind_posed_binned$comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V1
table(is.na(df_OF_output_AUsW_unblind_posed_binned$comp1))
df_OF_output_AUsW_unblind_posed_binned$comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V2
df_OF_output_AUsW_unblind_posed_binned$comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable$V3

# for k  = 4
df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4<- as.data.frame(res_k4@fit@W)
df_OF_output_AUsW_unblind_posed_binned$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned$NMFtable_k4$V4

# for k 2
# for k  = 4
df_OF_output_AUsW_unblind_posed_binned_k2<- df_OF_output_AUsW_unblind_posed_binned
df_OF_output_AUsW_unblind_posed_binned_k2$NMFtable_k2<- as.data.frame(res_k2@fit@W)

df_OF_output_AUsW_unblind_posed_binned_k2$k2_comp1 = df_OF_output_AUsW_unblind_posed_binned_k2$NMFtable_k2$V1
df_OF_output_AUsW_unblind_posed_binned_k2$k2_comp2 = df_OF_output_AUsW_unblind_posed_binned_k2$NMFtable_k2$V2

# visualization by emotion
colnames(df_OF_output_AUsW_unblind_posed_binned)
# bind_rows(db_of_natural1, db_of_morph)
colnames(df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,16:32,34:36)])
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  facet_grid(~component)+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(~component)+
  theme_classic()



# 
colnames(df_OF_output_AUsW_unblind_posed_binned_k2)
df_OF_output_AUsW_unblind_posed_binned_k2[,c(1,2:3,9:10, 49:50)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo,-filename)%>%
  group_by(expression, component, drug.placebo, bin_frame,filename)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  # geom_smooth(aes(group = filename), se = F, size = .5)+
  facet_grid(expression~component)+
  theme_classic()


```


same as above for  k 4

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = expression))+
  geom_smooth()+
  facet_grid(~component)+
  theme_classic()

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = drug.placebo))+
  geom_smooth(se = F)+
  facet_grid(expression~component)+
  theme_classic()


```

aggregate solution
```{r}
library(lmerTest)

# test_lmer<- lmer()
df_OF_output_AUsW_unblind_posed_binned

# visualization by emotion and drug
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
  
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,34:36)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")



```

same as above for k4

```{r}
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(expression, component, fill = coef))+
    geom_tile()+
  facet_grid(~drug.placebo)+
  theme_classic()+
    scale_fill_viridis_c(option="magma")


# 
#   ggplot(aes(Emotion, component, fill = coef))+
#   geom_tile()+
#   scale_fill_viridis(option="magma")+
#   theme_classic()+
#   facet_grid(~Dataset)


# aggregated plot
  
  df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")


```




do we get different patterns if we fit placebo and drug separately

```{r}
# df_OF_output_AUsW_unblind_posed_binned[df_OF_output_AUsW_unblind_posed_binned$drug.placebo == "drug"] 
#   subset(drug.placebo == "drug")[,16:32]

colnames(df_OF_output_AUsW_unblind_posed_binned)
# df_OF_output_AUsW_unblind_posed_binned$drug.placebo

df_OF_output_AUsW_unblind_posed_binned_drug<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "drug")%>%
                         ungroup()%>%
                         select(16:32)


df_OF_output_AUsW_unblind_posed_binned_placebo<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "placebo")%>%
                         ungroup()%>%
                         select(16:32)

res_k3_drug <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_drug,
                       r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


plot(res_k3_drug)
summary(res_k3_drug)

# basis components 
NMF::basismap(res_k3_drug) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3)
coefmap(res_k3_drug) #hidden variables

# access more info
# res_k3_drug

res_k4_drug <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_drug, r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 
coefmap(res_k4) 
NMF::basismap(res_k4_drug) 
coefmap(res_k4_drug) 

# very similar so far
# now fit placebo

res_k3_placebo <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_placebo,
                       r = 3, 
                  nrun = 200, 
                  seed=123456,
                 .options = list( 'v')) #


# plot(res_k3_placebo)
# summary(res_k3_placebo)

# basis components 
NMF::basismap(res_k3) 
NMF::basismap(res_k3_placebo) # weights/ amplitudes

# mixture coefficients 
coefmap(res_k3)
coefmap(res_k3_placebo) #hidden variables

# access more info
# res_k3_drug

res_k4_placebo <-NMF::nmf(df_OF_output_AUsW_unblind_posed_binned_placebo, r = 4, 
                  nrun = 200, 
                   seed=123456,
                   .options = list( 'v'))


NMF::basismap(res_k4) 

NMF::basismap(res_k4_placebo) 
coefmap(res_k4) 
coefmap(res_k4_placebo)





# visualisations
# - differences between emotions on the components
# - differences between drug vs no drug?
# - classification - can we classify drug vs no drug based in these components
# 
# 


```

now visualise joint NMF vs separate NMFS

```{r}
df_OF_output_AUsW_unblind_posed_binned_drug
df_OF_output_AUsW_unblind_posed_binned_placebo

# lets store the components frm k 4

df_OF_output_AUsW_unblind_posed_binned_drug

df_OF_output_AUsW_unblind_posed_binned_drug<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo == "drug")
                         # ungroup()%>%
                         # select(16:32)

df_OF_output_AUsW_unblind_posed_binned_placebo<- df_OF_output_AUsW_unblind_posed_binned %>%
                         subset(drug.placebo != "drug")

df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4<- as.data.frame(res_k4_drug@fit@W)

# for drug set
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned_drug$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned_drug$NMFtable_k4$V4

# for placebo set
df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4<- as.data.frame(res_k4_placebo@fit@W)

df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp1 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V1
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp2 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V2
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp3 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V3
df_OF_output_AUsW_unblind_posed_binned_placebo$k4_comp4 = df_OF_output_AUsW_unblind_posed_binned_placebo$NMFtable_k4$V4



# compare vis for joint vs separwte NMF results

# start with selectign drug

df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  subset(drug.placebo == "drug")%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(~expression)+
  theme_classic()

colnames(df_OF_output_AUsW_unblind_posed_binned_drug)
# forgot to store the combined data with info

df_OF_output_AUsW_unblind_posed_binned_drug[,c(2:3,9:10,38:41)]%>%
  # subset(drug.placebo == "drug")%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(~expression)+
  theme_classic()



df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(drug.placebo~expression)+
  theme_classic()

bind_rows(df_OF_output_AUsW_unblind_posed_binned_drug,df_OF_output_AUsW_unblind_posed_binned_placebo)[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(expression, component, drug.placebo, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(Dataset, coef , color = Dataset, fill = Dataset))+
  ggplot(aes(bin_frame, coef, color = component))+
  geom_smooth()+
  facet_grid(drug.placebo~expression)+
  theme_classic()
  
  


  
  
df_OF_output_AUsW_unblind_posed_binned[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")



bind_rows(df_OF_output_AUsW_unblind_posed_binned_drug,df_OF_output_AUsW_unblind_posed_binned_placebo)[,c(2:3,9:10,38:41)]%>%
  gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  group_by(subject,expression, component, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo , coef, color = expression, fill = expression)) +
  geom_jitter(alpha = .1, position = position_dodge(1))+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
    theme_classic()+
  facet_grid(expression~component)+
  ggpubr::stat_compare_means()+
  scale_color_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")

# this plot is deceiving as the compents shift order
# overall the patterns are the same_src(
# so its better to fit in one go to abvoid flips in compoent orders
```


we can also do classification on this
i.e. knowing the spatiotemporal components can we predict whether a condition is drug vs placebo

```{r}
df_OF_output_AUsW_unblind_posed_binned

colnames(df_OF_output_AUsW_unblind_posed_binned)
# combine the datasets keep timbeins and stimuli
nmfk4_agg_no_ts <- df_OF_output_AUsW_unblind_posed_binned%>%
  ungroup()%>%
  select(c(3,9:10,16:41))%>%
  # gather( component, coef, -timebin,-Emotion, -Dataset, -morph, -filename)%>%
  group_by(subject,drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

nmfk4_agg_no_ts

# combine datasets and aggregate over time bins
# nmf_agg_ts <- bind_rows(db_of_natural1, db_of_morph)[,c(1,2:5,31:33)]%>%
#   group_by(filename, Emotion, Dataset, morph)%>%
#   summarise_at(c("comp1", "comp2", "comp3"), mean, na.rm = TRUE)
# 
# # save 
write_csv(nmfk4_agg_no_ts, "nmfk4_agg_no_ts.csv")
# write_csv(nmf_agg_ts_tb, "nmf_agg_ts_tb.csv")


```
before we do for classification and clustering
let's do BADIA

```{r}
# start with the dimensions
colnames(nmfk4_agg_no_ts)
# drug no drug

bada_models<-list()
bada_models$drug_nodrug<- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$drug.placebo),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# based on emotion
bada_models$emotion <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)


# based on AUS
colnames(nmfk4_agg_no_ts)
bada_models$drug_nodrug_fromAUS<- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,4:20], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$drug.placebo),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)


bada_models$emotion_fromAUS <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts[,4:20], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)



# do placebo vs  drug separately
nmfk4_agg_no_ts_drug<-subset(nmfk4_agg_no_ts, drug.placebo == "drug")
nmfk4_agg_no_ts_plac<-subset(nmfk4_agg_no_ts, drug.placebo != "drug")

colnames(nmfk4_agg_no_ts_drug)
bada_models$drug_emotion_NMF <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts_drug[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts_drug$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# lacebo

bada_models$placebo_emotion_NMF <- TInPosition::tepBADA.inference.battery(nmfk4_agg_no_ts_plac[,24:27], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(nmfk4_agg_no_ts_plac$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

colnames(df_OF_output_AUsW_unblind_posed_binned)

df_OF_output_AUsW_unblind_posed_binned_drug<-subset(df_OF_output_AUsW_unblind_posed_binned, drug.placebo  =="drug")

bada_models$ts_drug<- TInPosition::tepBADA.inference.battery(df_OF_output_AUsW_unblind_posed_binned_drug[,38:41], 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = as.factor(df_OF_output_AUsW_unblind_posed_binned_drug$expression),
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 100, 
                                                       critical.value = 2)

df_OF_output_AUsW_unblind_posed_binned$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned$subject)

summary(lmer(k4_comp3 ~ 1 + expression*drug.placebo +(1+drug.placebo|subject),
             REML = FALSE,
     data  =df_OF_output_AUsW_unblind_posed_binned))

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(subject, expression, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(drug.placebo, k4_comp4))+
  geom_boxplot(alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group =subject), method = "lm", se  =F, sie = 1, alpha = .1)+
  facet_grid(~expression)


```


movement subspaces
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)
unique(df_OF_output_AUsW_unblind_posed_binned$filename)

df_OF_output_AUsW_unblind_posed_binned %>%
  ungroup()%>%
  subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:41))%>%
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame)%>%
  group_by( component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(bin_frame, coef, color = component))+
  geom_line()+
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


library(zoo)

colnames(df_OF_output_AUsW_unblind_posed_binned)

??zoo::rollmean

install.packages("RcppRoll")
library(RcppRoll)
RcppRoll::roll_mean(df_OF_output_AUsW_unblind_posed_binned$k4_comp4)
??RcppRoll::roll_mean

library(zoo)
# stick to k = 3
df_OF_output_AUsW_unblind_posed_binned$idno
df_OF_output_AUsW_unblind_posed_binned[,1:36] %>%
  group_by(filename)%>%
   dplyr::mutate(comp1_k3 = rollmean(comp1, k = 10, fill = NA),
                 comp2_k3 = rollmean(comp2, k = 10, fill = NA),
                 comp3_k3 = rollmean(comp3, k = 10, fill = NA)) %>%
    # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
ungroup%>%
  select(filename,subject, bin_frame,expression, drug.placebo, comp1_k3,comp2_k3,comp3_k3)%>%
  gather(component, coef,-bin_frame,-subject, -expression, -drug.placebo,-filename) %>%

  ggplot(aes(bin_frame, coef, color =drug.placebo ))+
  # geom_line()+
  geom_smooth(se = F)+
  geom_smooth(aes(group = filename), se = F, size = .1)+
  facet_grid(component~expression)+
  theme_classic()
  


```
classify substates

- quick test witha  single case

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned)
p1_angry<- df_OF_output_AUsW_unblind_posed_binned %>%
  ungroup()%>%
  subset(filename == "./cut_posed_angry_day1_p1.csv")

set.seed(1)
wcss = vector()
colnames(p1_angry)
# for (i in 1:10) wcss[i] = sum(kmeans(p1_angry[,38:41], i)$withinss)
# plot(1:10,
#      wcss,
#      type = 'b',
#      main = paste('The Elbow Method'),
#      xlab = 'Number of clusters',
#      ylab = 'WCSS')
# 
# # Fitting K-Means to the dataset
# set.seed(25)
# kmeans = kmeans(x = clust_dataset, centers = 3)
# y_kmeans = kmeans$cluster
# 
# # Visualising the clusters
# # install.packages("cluster")
# library(cluster)
# 
# ?clusplot
# 
# clust_dataset
# y_kmeans
# clusplot(clust_dataset,
#          y_kmeans,
#          lines = 2,
#          shade = TRUE,
#          color = TRUE,
#          labels = 1,
#          plotchar = FALSE,
#          span = TRUE
#          # label = 
#          # main = paste('Clusters of customers'),
#          # xlab = 'Annual Income',
#          # ylab = 'Spending Score'
#          )
?kmeans

p1_angry<- p1_angry[,c(2,38:41)]

?diff()

p1_angry 

p1_angry1<- p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k4_comp1_speed = (abs(lag(k4_comp1) - k4_comp1))/abs((lead(bin_frame)-bin_frame)),
         k4_comp2_speed = (abs(lag(k4_comp2) - k4_comp2))/abs((lead(bin_frame)-bin_frame)),
         k4_comp3_speed = (abs(lag(k4_comp3) - k4_comp3))/abs((lead(bin_frame)-bin_frame)),
         k4_comp4_speed = (abs(lag(k4_comp4) - k4_comp4))/abs((lead(bin_frame)-bin_frame)),
         k4_comp1_diff =diff(zoo::zoo(k4_comp1), na.pad = TRUE),
         k4_comp2_diff =diff(zoo::zoo(k4_comp2), na.pad = TRUE),
         k4_comp3_diff =diff(zoo::zoo(k4_comp3), na.pad = TRUE),
         k4_comp4_diff =diff(zoo::zoo(k4_comp4), na.pad = TRUE),
         
         # moving averages
         k4_comp1_diff_ma = zoo::rollmean(k4_comp1_diff, k = 5, fill = NA),
         k4_comp2_diff_ma = zoo::rollmean(k4_comp2_diff, k = 5, fill = NA),
         k4_comp3_diff_ma = zoo::rollmean(k4_comp3_diff, k = 5, fill = NA),
         k4_comp4_diff_ma = zoo::rollmean(k4_comp4_diff, k = 5, fill = NA),
           
          k4_comp1_speed_ma = zoo::rollmean(k4_comp1_speed, k = 5, fill = NA),
        k4_comp2_speed_ma = zoo::rollmean(k4_comp2_speed, k = 5, fill = NA),
         k4_comp3_speed_ma = zoo::rollmean(k4_comp3_speed, k = 5, fill = NA),
         k4_comp4_speed_ma = zoo::rollmean(k4_comp4_speed, k = 5, fill = NA),
         )%>%
  select(1,14:21)%>%
gather(component, coef,-bin_frame)%>%
  # group_by( component, bin_frame)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), abs(coef), color = component))+
  geom_line()

p1_angry1<- na.omit(p1_angry1)
p1_angry1
p1_angry1_scale<- p1_angry1%>%mutate_at(2:9, scale)


p1_angry1_scale%>%
  gather(component, coef,-bin_frame)%>%
  # group_by( component, bin_frame)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef, color = component))+
  geom_line()


cor(p1_angry[,2:5])
  
```


```{r}

colnames(p1_angry)


# replace nas
replace_na(list(p1_angry=0, y = 0))
p1_angry<-as.data.frame(p1_angry)
p1_angry[is.na(p1_angry)] <-0

p1_angry[is.na(p1_angry)] <- 0




p1_angry %>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  select(c(2,38:42))%>%
    # gather(component, coef,-bin_frame, -subject, -expression, -drug.placebo)%>%
  gather(component, coef,-bin_frame,-kmean_order)%>%
  group_by( component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


# lets compute speed
colnames(p1_angry)
p1_angry<- p1_angry %>%
mutate_at(c(43:46), ~replace(., is.na(.), 0))
  


testk$cluster
testk<-kmeans(p1_angry[,38:41], 3)
colnames(p1_angry)

# let's do the kmeans
p1_angry1_scale
# p1_angry_kmean_clust<- kmeans(p1_angry1_scale[,2:9], 3)
# p1_angry_kmean_clust_speed<- kmeans(p1_angry[,43:46], 3)
# p1_angry$kmean_order<- p1_angry_kmean_clust$cluster
# p1_angry$kmean_order_speed<- p1_angry_kmean_clust_speed$cluster
# 
# p1_angry$kmean_center<- p1_angry_kmean_clust$cluster


# based on dist and speed
# scale predictors

p1_angry_kmean_clust_speed_dist<- kmeans(p1_angry1_scale[,c(2:9)], 3)
p1_angry1_scale$kmean_order_dist_speed<- p1_angry_kmean_clust_speed_dist$cluster


# plot cluster absed on component weights
colnames(p1_angry)
p1_angry1_scale%>%
ungroup()%>%
  # select(c(2,38:42))%>%
  gather(component, coef,-bin_frame,-kmean_order_dist_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_dist_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()


left_join(p1_angry1_scale, p1_angry)[,c(1,10:14)]%>%
  # su
  
  # select(c(2,38:42))%>%
  gather(component, coef,-bin_frame,-kmean_order_dist_speed)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(kmean_order_dist_speed)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

# lets test in a seconf example


```



# what we need to do now is for every person run a loop that first for each trial a kmean,

algorithmic from 2 to 10 and 
store
- kmean result cluster in each itteration

we need a list that will store unique trial name + number of K+ resulting k object


when we find these clusters we can write a  simple algorythim that classifies the data into

sustain, activation, sustain, dectivatio sutain
for example is the respective cluster average is bigger than the avergae of all clusters or smaller than,
its sustain.

if the clister dispalcement is bigger than the whole average and the speed is higher than the whole average - displacement, is direction is positive, activation, of direction is negeative is deactovation



```{r}


# <- unique(df_OF_output_AUsW_unblind_posed_binned$filename)
# 228

store_kmeans<- list()

# len <- 5
# empty_list <- vector(mode = "list", length = length(unique_trial))

empty_list


colnames(df_OF_output_AUsW_unblind_posed_binned)

# compute the speed metrics
options(scipen = 999)
df_OF_output_AUsW_unblind_posed_binned

df_OF_output_AUsW_unblind_posed_binned1<- df_OF_output_AUsW_unblind_posed_binned[,1:36]%>%
  ungroup()%>%
  group_by(filename)%>%
  ungroup()%>%
  # subset(filename == "./cut_posed_angry_day1_p1.csv")%>%
  # select(c(2,38,42))%>%
  mutate(k3_comp1_speed = (abs(lag(comp1) - comp1))/abs((lead(bin_frame)-bin_frame)),
         k3_comp2_speed = (abs(lag(comp2) - comp2))/abs((lead(bin_frame)-bin_frame)),
         k3_comp3_speed = (abs(lag(comp3) - comp3))/abs((lead(bin_frame)-bin_frame)),
        
         k3_comp1_diff = as.numeric(diff(zoo::zoo(comp1), na.pad = TRUE)),
         k3_comp2_diff =as.numeric(diff(zoo::zoo(comp2), na.pad = TRUE)),
         k3_comp3_diff =as.numeric(diff(zoo::zoo(comp3), na.pad = TRUE)),
         
         # moving averages
         k3_comp1_diff_ma = as.numeric(zoo::rollmean(k3_comp1_diff, k = 5, fill = NA)),
         k3_comp2_diff_ma = as.numeric(zoo::rollmean(k3_comp2_diff, k = 5, fill = NA)),
         k3_comp3_diff_ma = as.numeric(zoo::rollmean(k3_comp3_diff, k = 5, fill = NA)),
           
          k3_comp1_speed_ma = as.numeric(zoo::rollmean(k3_comp1_speed, k = 5, fill = NA)),
        k3_comp2_speed_ma = as.numeric(zoo::rollmean(k3_comp2_speed, k = 5, fill = NA)),
         k3_comp3_speed_ma = as.numeric(zoo::rollmean(k3_comp3_speed, k = 5, fill = NA)))%>%
    ungroup()%>%
  mutate(idno = rep(1:228, each = 100))

# 
# pad NAS
#   mutate(df_OF_output_AUsW_unblind_posed_binned1, across(everything(), ~replace_na(.x, 0)))
# 
#   mutate_at(c("k4_comp1_speed", "k4_comp2_speed", "k4_comp3_speed", "k4_comp4_speed"), ~replace(., is.na(.), 0))
```  


spatiotemporal clustering using k-means 

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned1)

empty_list<- list()


df_OF_output_AUsW_unblind_posed_binned1

colnames(df_OF_output_AUsW_unblind_posed_binned1)



df_OF_output_AUsW_unblind_posed_binned2_nona<- df_OF_output_AUsW_unblind_posed_binned1
# replace NAS
df_OF_output_AUsW_unblind_posed_binned2_nona[, 37:48][is.na(df_OF_output_AUsW_unblind_posed_binned2_nona[, 37:48])] <- 0

table(df_OF_output_AUsW_unblind_posed_binned2_nona$filename)
df_OF_output_AUsW_unblind_posed_binned1$idno
colnames(df_OF_output_AUsW_unblind_posed_binned2_nona)



# k-means clustering based on NMF components and derivatives
k3_list<- list()

unique_trial<- unique(df_OF_output_AUsW_unblind_posed_binned2_nona$filename)
 
df_OF_output_AUsW_unblind_posed_binned2_nona
# df_OF_output_AUsW_unblind_posed_binned$clust3<- NA

df_OF_output_AUsW_unblind_posed_binned3_nona<- df_OF_output_AUsW_unblind_posed_binned2_nona
df_OF_output_AUsW_unblind_posed_binned3_nona$clust3<- NA
colnames(df_OF_output_AUsW_unblind_posed_binned2_nona)

# loop fit kmeans and store clusters in the original data

for (u in 1: length(unique_trial)) {
  # subset each trail on every run
   temp_df<- subset(df_OF_output_AUsW_unblind_posed_binned2_nona,filename == unique_trial[u])[,43:48]

       # r = u+r
  # for (k in 2:10) {
    k3_list[[u]] = kmeans(temp_df, 3)
    df_OF_output_AUsW_unblind_posed_binned3_nona$clust3[df_OF_output_AUsW_unblind_posed_binned3_nona$idno == u] <- k3_list[[u]]$cluster
    # r = r+1
}

table(df_OF_output_AUsW_unblind_posed_binned3_nona$clust3)

# visualise one or two people


unique(df_OF_output_AUsW_unblind_posed_binned3_nona$idno)
df_OF_output_AUsW_unblind_posed_binned3_nona

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)

# heurictis ionspired by eye movement classification
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  subset(idno  == 1)%>%
    group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3,
           cutoff = (mean(sp_avg, na.rm = TRUE) + (2* mad(sp_avg, na.rm = TRUE)))) %>%
  ungroup() %>%
  select(c(2,43:49, 50:51, 34:36))%>%
  gather(component, coef,-bin_frame,-clust3,-idno ) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf"))))%>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  # mutate(coef_z = scale(coef))%>%
  group_by(component,var_type, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)+
  geom_hline(yintercept = 0.5118612)
# 0.5118612 1.071568
# the ones where it fails
  # subset(idno  == 5)%>%

# scald

df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust = if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ (2*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                                "stable state"))%>%
  
  
   ungroup()%>%
   subset(idno  == 1)%>%
     select(c(2,43:49, 50:52, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64,65))%>%
  gather(component, coef,-bin_frame,-clust3,-idno,-manual_clust) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf")))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, clust3)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)


```

# what if we say when speed exceedes X ammounts of sd

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)


```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust = if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ (2*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                                "stable state"))%>%
  
  
   ungroup()%>%
   subset(idno  == 1)%>%
    select(c(2,43:49, 50:52, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64,65))%>%
  gather(component, coef,-bin_frame,-clust3,-idno,-manual_clust) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                            "comp_nmf")))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust)), 
            alpha = .1)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)


```



# if speed is above the adaptive threshold and diff is positive = acceleration
# if speed is abobe the threshold and diff = negative
# anything else stable state

```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)

max(df_OF_output_AUsW_unblind_posed_binned3_nona[,46:48])
df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
   group_by(idno)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
   group_by(idno)%>%
  mutate(comp_delta_avg1 = scale(comp_delta_avg))%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), 
                   # & 
                     # comp_delta_avg > (mean(abs(comp_delta_avg), na.rm = TRUE)+(.5*(mad(abs(comp_delta_avg), na.rm = TRUE)))), 
                   "activation state", "stable state"))%>%
  group_by(idno, manual_clust_sp_disp)%>%
  # mutate(comp_delta_avg_by_clust = mean(comp_delta_avg1, na.rm = TRUE))%>%
  # group_by(idno)%>%
  # mutate(manual_clust_sp_disp2 = if_else(manual_clust_sp_disp == "activation state" &
  #                                          comp_delta_avg1 < -1,
  #                                        "deactivation state",
  #                                        manual_clust_sp_disp)) %>%

  
  # mutate(manual_clust_sp_disp2 = if_else(manual_clust_sp_disp == "activation state" & 
  #                                          comp_delta_avg < 0,
  #                                        "deactivation state",
  #                                        manual_clust_sp_disp))%>%
  # (mean(comp_delta_avg, na.rm = TRUE)-
                                                               # (.5*(mad(comp_delta_avg, na.rm = TRUE)))), 
                    #         "de-activation state",))
   
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (2*(mad(sp_avg, na.rm = TRUE)))) & 
                    #           comp_delta_avg < (mean(comp_delta_avg, na.rm = TRUE)-(.5*(mad(comp_delta_avg, na.rm = TRUE)))),
                    #         "de-activation state",
                    # manual_clust_sp_disp2
  
   ungroup()%>%
   subset(idno  == 1)%>%
      select(c(2,43:49, 34:36, 55:56, 58))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno) %>%
  mutate(var_type = if_else(grepl("diff", component ), "diff",
                        if_else(grepl("speed", component ), "speed",  
                                if_else(grepl("sp_avg", component ), "avg_speed",  
                                        if_else(grepl("comp_delta_avg", component ), "disp_avg",  
                            "comp_nmf"))))) %>%

  
  # scale so we dob;t have massivelly different sizes acordss variables
   group_by(var_type)%>%
  mutate(coef_z = scale(coef))%>%
  group_by(component, bin_frame,var_type, manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef_z, group = component))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            alpha = .2)  +
    geom_line(aes(group = component, linetype = var_type), size = 1)+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(var_type~.)


# do a third whether we take the clusters and put transition whenever they are larger than a specified speed



  
  

```

the k means segmentation
```{r}
# colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)

df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  subset(idno  == 10)%>%
ungroup()%>%
        # select(c(2, 34:36,43:49, 50:53))%>%
   select(c(2, 34:36,50))%>%
  # select(c(2,38:41, 47))%>%
  gather(component, coef,-bin_frame,-clust3)%>%
  group_by(component, bin_frame)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()
```


```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona$clust3
# okay let's do some smoothing such that a cluster needs to have at least 3 in row



library(dplyr)
library(data.table)


df_OF_output_AUsW_unblind_posed_binned3_nona<- df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  group_by(idno)%>%
    mutate(new = cumsum(clust3)) %>%
    group_by(grp = rleid(clust3)) %>%
    mutate(output = if(n() <2) NA else clust3) %>%
    # ungroup %>%
    # select(idno,grp, new,output,clust3)%>%
    group_by(idno)%>%
  mutate(output1= output)%>%
  fill(output1, .direction = c("down"))

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)


df_OF_output_AUsW_unblind_posed_binned3_nona1<- df_OF_output_AUsW_unblind_posed_binned3_nona%>%
  group_by(filename)%>%
  
  mutate(cluster_ordered = match(clust3, unique(clust3)))%>%
  # select(clust3, bin_frame, cluster_ordered)%>%
  arrange(filename, bin_frame)


  
  colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)

  
  # heatmap drug vs placebo
  df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
     select(c(1,2,9,34:36, 49,55))%>%
  # select(c(1,2,9,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(filename,component, bin_frame,cluster_ordered, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~.)
  
  
  
  
  # to do: do this plot with the heuristics
  # colnames(df_OF_output_AUsW_unblind_posed_binned3_nona)
  
  df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  # group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg > 0, "transition state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (2*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
      select(c(2, 9,10, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-idno,-drug.placebo,-expression) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(idno,component, bin_frame,manual_clust_sp_disp, drug.placebo,expression)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lag(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            alpha = .9)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~expression)+
    scale_fill_viridis_d(option = "inferno")

  
```



now heat maps bye xpression
```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
       select(c(1,2,10,34:36, 49,55))%>%
  # select(c(1,2,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -expression)%>%
  group_by(filename,component, bin_frame,cluster_ordered,expression)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

 geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)


```



```{r}
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
        select(c(1,2,3,10,34:36, 49,55))%>%
  # select(c(1,2,3,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -expression,-subject)%>%
  group_by(filename,component, bin_frame,cluster_ordered,expression, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered)))+

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)+
  scale_fill_viridis_d()


# heap with participants and clusters
 df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  # group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg > 
                     1.5*(mad(comp_delta_avg, na.rm = TRUE))+mean(sp_avg, na.rm = TRUE), "activation state", 
                    
                   if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < mean(sp_avg, na.rm = TRUE)+
                              (-1.5*(mad(comp_delta_avg, na.rm = TRUE))), "de-activation state", 
                   
                                "stable state")))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
    select(c(1,2,3,9,34:36, 49,57))%>%
      # select(c(2, 9, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-drug.placebo) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(subject,component, bin_frame,manual_clust_sp_disp, drug.placebo)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
   geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            # alpha = .3)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~.)+
     scale_fill_viridis_d()
    
    
    
    
# expresion
    
 df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "activation state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()%>%
   # subset(idno  == 10)%>%
    select(c(1,2,3,10,34:36, 49,57))%>%
      # select(c(2, 9, 34:36, 49, 57))%>%
      # select(c(1,2, 9, 43:49, 50:53, 34:36))%>%
  # select(c(2,52:59, 46:47,38:41,64:66))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression) %>%
      # gather(component, coef,-bin_frame,-cluster_ordered,-filename,-drug.placebo) %>%
  group_by(subject,component, bin_frame,manual_clust_sp_disp, expression)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
   geom_tile(aes(fill = factor(manual_clust_sp_disp)))+

 # geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(manual_clust_sp_disp)), 
            # alpha = .3)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(expression~.)+
   # scale_fill_brewer(palette = "Dark2")
     scale_fill_viridis_d()
    scale_fill_viridis_d(option = "inferno")



```

COMPUTE THE HEURISTIC BASED CLUSTERS AND PUT TO THE DATAFRAME

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust<- df_OF_output_AUsW_unblind_posed_binned3_nona %>%
  
  # compare kmean and manual clustering
  group_by(filename)%>%
    mutate(sp_avg = (k3_comp1_speed_ma+k3_comp2_speed_ma+k3_comp3_speed_ma)/3)%>%
   mutate(comp_delta_avg = (k3_comp1_diff_ma +k3_comp2_diff_ma+k3_comp3_diff_ma)/3)%>%
  # mutate(df, IVMean = rowMeans(select(df, starts_with("IV")), na.rm = TRUE))
  mutate(manual_clust_sp_disp = 
           if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                               (1.5*(mad(sp_avg, na.rm = TRUE)))), "transition state", 
                    # if_else(sp_avg > (mean(sp_avg, na.rm = TRUE)+ 
                    #            (1.5*(mad(sp_avg, na.rm = TRUE)))) & comp_delta_avg < 0, "de-activation state", 
                   
                                "stable state"))%>%
  
  
   ungroup()


# now compare the speed per cluster
# copare duration of custers


   # subset(idno  == 10)%>%

  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression) %>%
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, clust_frame_no_bin))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  ggtitle("transition state")

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp,subject)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, expression,subject)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression , clust_frame_no_bin, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
      geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # facet_grid(~expression)+
  theme_classic()+
      ggpubr::stat_compare_means()+
  ggtitle("transition state")

# stable
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,34:36, 49,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n())%>%
group_by(filename, manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, clust_frame_no_bin))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  facet_grid(~drug.placebo)+
  theme_classic()+
      ggpubr::stat_compare_means()+
   ggtitle("stable state")


# colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, manual_clust_sp_disp,component, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  subset(manual_clust_sp_disp == "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # facet_grid(~drug.placebo)+
  theme_classic()+
    ggpubr::stat_compare_means()+
  ggtitle("transition state")


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
group_by(filename, subject,manual_clust_sp_disp, drug.placebo, expression)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)%>%
  # subset(manual_clust_sp_disp != "transition state")%>%
  ggplot(aes(expression, sp_avg_clust, color = manual_clust_sp_disp))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), se = F, alpha = .5, size = .1)+
  # facet_grid(~drug.placebo)+
  theme_classic()+
  facet_grid(~manual_clust_sp_disp)+
  ggpubr::stat_compare_means()+
     ggtitle("stable state")
  

```

Count how any states do we have

```{r}

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$BMI


df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp
library(data.table)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, drug.placebo)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
    mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(grp, color = expression, fill = expression))+
  geom_histogram(aes(y=..density..), alpha=0.5,
                position="identity")+
   geom_density(alpha=.2)+
  facet_grid(~drug.placebo)+
  theme_classic()


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, drug.placebo)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(expression, log(grp+.1), color = expression))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  facet_grid(~drug.placebo)+
  theme_classic()

df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, drug.placebo, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(drug.placebo, grp, color = drug.placebo))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
  geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  # facet_grid(~drug.placebo)+
  theme_classic()


df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(expression, grp, color = expression))+
  # geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = "pointrange")+
    geom_smooth(aes(group = subject), method = "lm", se = F, size = .2, color = "gray80")+
  # geom_histogram(aes(y=..density..), alpha=0.5,
  #               position="identity")+
  #  geom_density(alpha=.2)+
  # facet_grid(~drug.placebo)+
  theme_classic()
```


try and model mixed models on the variabes above

```{r}
df_OF_output_AUsW_unblind_posed_binned3_nona_clust<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(clust_frame_no = rleid(manual_clust_sp_disp))

# 
df_OF_output_AUsW_unblind_posed_binned3_nona_clust

colnames(df_OF_output_AUsW_unblind_posed_binned3_nona_clust)
lmer_substates<- list()

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp)

library(lmerTest)

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust$clust_frame_no)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg<-
df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  group_by(filename, subject,drug.placebo,expression)%>%
  summarise_if(is.numeric, max, na.rm = TRUE)

df_OF_output_AUsW_unblind_posed_binned3_nona_clust$manual_clust_sp_disp

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$clust_frame_no

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg$subject)

lmer_substates$clust_no <- glmer(clust_frame_no ~   1+expression+
                              (1 |subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg,
                            # REML = FALSE)
                            # ,
                            family = "poisson")
?isSingular
isSingular(lmer_substates$clust_no, tol = .002)

summary(lmer_substates$clust_no )

anova(lmer_substates$clust_no)

emmeans::emmeans(lmer_substates$clust_no, pairwise~drug.placebo, type = "response" )
emmeans::emmeans(lmer_substates$clust_no, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$clust_no, pairwise~ drug.placebo|expression, type = "response" )


interactions::cat_plot(lmer_substates$clust_no, pred = expression, modx = drug.placebo)



# 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  #     select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE))%>%
   group_by(filename, subject,drug.placebo,expression,manual_clust_sp_disp)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$clust_frame_no_bin)


df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$subject<- as.factor(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2$subject)

lmer_substates$clust_no_framebin <- glmer(clust_frame_no_bin ~  manual_clust_sp_disp * expression+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2,
                            # REML = FALSE)
                            # ,
                            family = "poisson")

summary(lmer_substates$clust_no_framebin)

anova(lmer_substates$clust_no_framebin)

emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~drug.placebo, type = "response" )
emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$clust_no_framebin, pairwise~ expression|manual_clust_sp_disp, type = "response" )

# m,odel how many states are ine ach 

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3 <- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
  ungroup()%>%
  group_by(filename, expression, subject)%>%
    # mutate(new = cumsum(manual_clust_sp_disp)) %>%
  mutate(grp = rleid(manual_clust_sp_disp))%>%
  group_by(filename, subject,drug.placebo,expression)%>%
  summarise_if(is.numeric, max, na.rm = TRUE)

unique(df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3$grp)

lmer_substates$howmanystate_trans <- glmer(grp ~  drug.placebo * expression+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3,
                            # REML = FALSE)
                            # ,
                            family = "poisson")

summary(lmer_substates$howmanystate_trans)
anova(lmer_substates$howmanystate_trans)

# speed

df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4<- df_OF_output_AUsW_unblind_posed_binned3_nona_clust%>%
      # select(c(1,2,3,9,10,46:48, 49,55,57))%>%
  # gather(component, coef,-bin_frame,-manual_clust_sp_disp,-subject,-expression,-drug.placebo,  -filename, -idno,-sp_avg )%>%
group_by(filename, manual_clust_sp_disp)%>%
  mutate(clust_frame_no_bin = n(),
         sp_avg_clust = mean(sp_avg, na.rm = TRUE),
          sp_sd_clust = sd(sp_avg, na.rm = TRUE))%>%
group_by(filename, manual_clust_sp_disp, expression, subject, drug.placebo)%>%
  summarise_if(is.numeric, mean, na.rm  =TRUE)




df_OF_output_AUsW_unblind_posed_binned3_nona_clust$sp_avg


lmer_substates$speed <- lmer(sp_avg_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1+|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed)

# emmeans::emmeans(lmer_substates$speed , pairwise~drug.placebo, type = "response" ) #ns
emmeans::emmeans(lmer_substates$speed, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$speed, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot
int_plot_speed <- interactions::cat_plot(lmer_substates$speed, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)
  ggExtra::ggMarginal(int_plot_speed)

  library(ggside)

  int_plot_speed+ geom_ysidedensity(aes(x=stat(density), fill = expression), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "left") +
  labs(title = "FacetNull", subtitle = "Xside placed bottom, Yside placed left")
  
  
  # sd
lmer_substates$speed1 <- lmer(sp_sd_clust ~  drug.placebo * expression*manual_clust_sp_disp+
                              (1|subject),
                            data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
                            REML = FALSE)

anova(lmer_substates$speed1)

emmeans::emmeans(lmer_substates$speed1, pairwise~expression, type = "response" )

emmeans::emmeans(lmer_substates$speed1, pairwise~ expression|manual_clust_sp_disp, type = "response" )

?interactions::cat_plot

int_plot_speed1<- interactions::cat_plot(lmer_substates$speed1, pred = expression, modx = manual_clust_sp_disp,
                       plot.points = TRUE,
                       point.alpha = .3)


   int_plot_speed1+ geom_ysidedensity(aes(x=stat(density), color = expression,  fill = expression), alpha = .5) +
     ggside(x.pos = "bottom", y.pos = "left") +
  labs(title = "FacetNull", subtitle = "Xside placed bottom, Yside placed left")+
     facet_grid(~manual_clust_sp_disp)+
    geom_smooth(aes(group = subject), method = "lm", se = F)
  
```

```{r}
# try anovas

library(afex)
library(car)
# avg number of frames 
afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg2,
              id = "subject",
              dv = "clust_frame_no_bin",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)


afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg,
              id = "subject",
              dv = "clust_frame_no",
              within = c("drug.placebo", "expression"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

# how many states


afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg3,
              id = "subject",
              dv = "grp",
              within = c("drug.placebo", "expression"),
              # fun_aggregate = "mean",
              print.formula = TRUE)

# speed
afex::aov_ez(data = df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4,
              id = "subject",
              dv = "sp_avg_clust",
              within = c("drug.placebo", "expression","manual_clust_sp_disp"),
              # fun_aggregate = "mean",
              print.formula = TRUE)
df_OF_output_AUsW_unblind_posed_binned3_nona_clust_agg4

```





df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
  select(c(1,2,3,9,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject)%>%
  group_by(filename,component, bin_frame,cluster_ordered,drug.placebo, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered)))+

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~.)+
  scale_fill_viridis_d()



df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  # subset(idno  == 54)%>%
ungroup()%>%
  select(c(1,2,3,9,10,38:41, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-bin_frame,-cluster_ordered,-filename, -drug.placebo,-subject,-expression)%>%
  group_by(filename,component, bin_frame,cluster_ordered, expression, drug.placebo, subject)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), as.numeric(subject)))+
  geom_tile(aes(fill = factor(cluster_ordered)))+

 # geom_rect(aes(xmin = bin_frame, group = subject, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(cluster_ordered)), 
 #            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(drug.placebo~expression)+
  scale_fill_viridis_d()


# let's plot variabkes based on the clusters
colnames(df_OF_output_AUsW_unblind_posed_binned3_nona1)
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  ungroup()%>%
  select(c(3,9,10,48:59, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-cluster_ordered, -drug.placebo,-subject,-expression,)%>%
  group_by(cluster_ordered, drug.placebo,subject,expression,component)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(cluster_ordered), coef))+
  geom_jitter(width = .1, alpha = .01)+
  geom_boxplot(alpha = .1)+
  facet_grid(~component)+
  theme_classic()

```



```{r}

# don't plot
df_OF_output_AUsW_unblind_posed_binned3_nona1%>%
  ungroup()%>%
  select(c(3,9,10,48:52, 64))%>%
  # mutate_if(is.numeric, scale)%>%
  gather(component, coef,-cluster_ordered, -drug.placebo,-subject,-expression,)%>%
  group_by(cluster_ordered, drug.placebo,subject,expression,component)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(component ), coef))+
  geom_jitter(width = .1, alpha = .01)+
  geom_boxplot(alpha = .1)+
  geom_smooth(aes(group = subject), se = F, size = .1)+
  # facet_grid(~cluster_ordered)+
  theme_classic()
```

new algorithm first find sustain and transition
based on:
- if cluster duration (in frames) > than the average duration of a cluster = sustain (this is beacuse transition should be short, sustain should be longest, so)

and the cluster avg speed < than the average speed



```{r}

rleid(df_OF_output_AUsW_unblind_posed_binned3_nona1$cluster_ordered)

df_OF_output_AUsW_unblind_posed_binned3_nona2<- df_OF_output_AUsW_unblind_posed_binned3_nona1 %>%
  ungroup()%>%
  group_by(idno)%>%
  mutate(cluster_ordered_unique = rleid(cluster_ordered), bin_new_id = 1:n())%>%
  group_by(idno, cluster_ordered_unique)%>%
  mutate(frame_dur = n())%>%
  group_by(idno)%>%
  mutate(frame_dur_avg = mean(frame_dur, na.rm = TRUE),
         frame_dur_min = min(frame_dur, na.rm = TRUE),
         frame_dur_max = max(frame_dur, na.rm  = TRUE),
         )
  

df_OF_output_AUsW_unblind_posed_binned3_nona3<-
df_OF_output_AUsW_unblind_posed_binned3_nona2%>%
  group_by(idno)%>%
  mutate(name_new_clust = if_else(frame_dur> frame_dur_avg, "sustain", "transition"))
  
  
  select(c(3,9,10,48:56, 64))
  
  
  
  colnames(df_OF_output_AUsW_unblind_posed_binned3_nona3)
  df_OF_output_AUsW_unblind_posed_binned3_nona3%>%
  subset(idno  == 12)%>%
ungroup()%>%
  select(c(2,38:41, 46,71))%>%
  gather(component, coef,-bin_frame,-name_new_clust,-idno )%>%
  group_by(component, bin_frame,name_new_clust)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(name_new_clust)), 
            alpha = .5)  +
    geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()

```


then look at transitions to find

if the average weight of the last 2 samples of the transition a higher than the first 2 samples then its activation, if the last two samples value if lower than the first 2 then deactivation

```{r}

```

transform(k3_list[[1]]$cluster, id = as.numeric(factor(k3_list[[1]]$cluster)))
# create a unique value for new values ina. column in r

df2 <- transform(df,id=as.numeric(factor(sample)))

df_OF_output_AUsW_unblind_posed_binned%>%
  group_by(filename)%>%
  group_indices(clust3)
  transform(id = as.numeric(factor(clust3)))
  
  
colnames(df_OF_output_AUsW_unblind_posed_binned)
  
df_OF_output_AUsW_unblind_posed_binned%>%
  
  ggplot(aes(as.numeric(bin_frame), idno))+
  # ggplot(aes(as.numeric(bin_frame), coef))+

  geom_rect(aes(xmin = bin_frame, xmax = dplyr::lead(bin_frame), ymin = -Inf, ymax = Inf, fill = factor(clust3)), 
            alpha = .1)  +
    # geom_line(aes(group = component))+
  # geom_rect(aes(xmin=kmean_order-0.5, xmax=kmean_order+0.5))+ 
  # geom_smooth(se = F)+
  # facet_grid(expression~component)+
  theme_classic()+
  facet_grid(~drug.placebo)



```


  message(sprintf("$$$$$RUNING kmean %i", i))
  
  
  
  resampled_temp_test<- fabricatr::resample_data(clustering_new_pre_PCA3.1 [,c(1,2,3, 5:9)], 
                                  N = c(51,55),
                                  ID_labels = c("ssid", "stimDescription"),
                                  unique_labels = TRUE)
  resampled_temp$sim_no = i
  
# run PCA on the resampled data
# ?list
    message(sprintf("$$$$$fitting PCA %i", i))
mfa.res_res <- FactoMineR::MFA(resampled_temp[,1:8], 
               group = c(3, 3, 2), 
               type = c("n", "s", "s"),
              # ind.sup = c(1),
              ncp = 2,
               name.group = c("pp_stim","auton","subj"),
               num.group.sup = c(1),
               # ind.sup = c(1,2),
               graph = FALSE)


# store the eigen values
  message(sprintf("$$$$$storing PCA %i", i))
eugentest<- as.data.frame(mfa.res_res$eig[1:2,])
eugentest$sim_no<- i

cortest<- as.data.frame(mfa.res_res$quanti.var$cor)
cortest$sim_no = i

partials_temp<- as.data.frame(res.mfa_bio_vs_self2_k2$partial.axes$cor)
partials_temp$sim_no = i
# update the initial d=frames
  message(sprintf("$$$$$upating dataframes %i", i))
  resamp_1st<- (bind_rows(resamp_1st, resampled_temp))
eigen_first<- bind_rows(eigen_first, eugentest)
cor_first<- bind_rows(cor_first, cortest)
partials_first<- bind_rows(partials_first, partials_temp)
  message(sprintf("$$$$$completed iteration%i", i))
}



```

store the cluster
