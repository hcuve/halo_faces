---
title: "Delaunay triangulation Spoken"
author: "Helio"
date: "2022-12-30"
output: html_document
---


ROTATE STIMULI and ALLIgn

```{r}
colnames(df_OF_output_AUsW_unblind_spoken1_binned)
df_OF_output_AUsW_unblind_spoken1_binned
range(df_OF_output_AUsW_unblind_spoken1_binned$bin_frame)

# select_AUS and landmarks

colnames(df_OF_output)

df_OF_output_AU_andLand<- df_OF_output[,c(1:5,300:435, 680:715)]
colnames(df_OF_output_AU_andLand)


# create necessary columns
library(stringr)
library(tidyverse)
df_OF_output_AU_andLand$subject<- sub(".*_p", "", str_match(df_OF_output_AU_andLand$filename, "p\\s*(.*?)\\s*.csv")[,2])

df_OF_output_AU_andLand$test.day<- str_match(df_OF_output_AU_andLand$filename, "_day\\s*(.*?)\\s*_p")[,2]

# merge
df_OF_output_AU_andLand$subject<- as.factor(as.character( df_OF_output_AU_andLand$subject))
Unblinding_BMI_drugday$subject<-as.factor(as.character(Unblinding_BMI_drugday$subject))

# expected rows()
# nrow(df_OF_output_AU_andLand)  =131476
df_OF_output_AU_andLand_unblind<- left_join(df_OF_output_AU_andLand, Unblinding_BMI_drugday)

# if test.day == drugday  = "halo, vs placebo
colnames(df_OF_output_AU_andLand_unblind)

df_OF_output_AU_andLand_unblind$drug.placebo <- if_else(df_OF_output_AU_andLand_unblind$test.day == df_OF_output_AU_andLand_unblind$drug.day, "drug", "placebo")

# add emotion
# return word between 3rd and 4rth underscore df$values = sapply(strsplit(df$V1, "_"), function(x) x[3])

df_OF_output_AU_andLand_unblind$expression <-sapply(strsplit(df_OF_output_AU_andLand_unblind$filename, "_"), function(x) x[3])
# 2nd and 3rd undrcore
# unique( sapply(strsplit(df_OF_output_AU_andLand_unblind$filename, "_"), function(x) x[2]))
df_OF_output_AU_andLand_unblind$posed.spoken<- sapply(strsplit(df_OF_output_AU_andLand_unblind$filename, "_"), function(x) x[2])

cname2<-c(cnames1[1:5],t(AU_OF_codes_merged$AU_Code_OF_r),t(AU_OF_codes_merged$AU_Code_OF_c), "filename")
# cnames1
# t(AU_OF_codes_merged$AU_Code_OF_r)
# note OF addded a new action fpr presence 28 (lipsuck) I will exclude this for now
df_OF_output_AU_andLand_unblind$AU28_c<-NULL

# df_OF_output_AUstest<-df_OF_output_AUs
# names(df_OF_output_AUstest)<- cname2

colnames(df_OF_output_AU_andLand_unblind)
names(df_OF_output_AU_andLand_unblind)[142:175]<- cname2[6:39]
colnames(df_OF_output_AU_andLand_unblind)


# binify
unique(df_OF_output_AU_andLand_unblind$posed.spoken)
df_OF_output_AU_andLand_unblind_spoken_binned <-df_OF_output_AU_andLand_unblind%>%
  subset(posed.spoken == "spoken")%>%
  group_by(filename, subject,test.day, age, gender,BMI,drug.day, drug.placebo, expression,posed.spoken )%>%
  mutate(bin_frame = cut(frame, 100, labels = FALSE))%>%
  group_by(filename,bin_frame,subject,test.day, age, gender,BMI,drug.day, drug.placebo, expression,posed.spoken)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

colnames(df_OF_output_AU_andLand_unblind_spoken_binned)

# gather lamndmarks
require(data.table)
df_OF_output_andLand_unblind_spoken_binned_dcast<- df_OF_output_AU_andLand_unblind_spoken_binned[,-c(153:186)] %>%
group_by(filename)%>%
  gather(key, value, -c(1:16)) %>%
  mutate(coordinate = substr(key,1,1))%>%
  mutate(lanmark_id = substr(key,3,4)) %>%
  setDT%>%  dcast(filename+bin_frame+timestamp+subject+test.day+ age +gender +BMI + drug.day + drug.placebo+
          expression+posed.spoken+confidence+success+lanmark_id~coordinate, value.var = "value",  mean)


df_OF_output_andLand_unblind_spoken_binned_dcast<-df_OF_output_andLand_unblind_spoken_binned_dcast%>%
  group_by(filename)%>%
  arrange(as.numeric(lanmark_id))


df_OF_output_AU_andLand_unblind_spoken_binned
```

rotate landmarks to align eyes and normalise position to remove gross movement
```{r}
# create a unique ID fr frame and stim

df_OF_output_andLand_unblind_spoken_binned_dcast$Stimuli_frame <- paste0(df_OF_output_andLand_unblind_spoken_binned_dcast$filename,df_OF_output_andLand_unblind_spoken_binned_dcast$bin_frame)

filename_unique<-unique(df_OF_output_andLand_unblind_spoken_binned_dcast$Stimuli_frame)
colnames(df_OF_output_andLand_unblind_spoken_binned_dcast)
f = 1

temp_df_bind<- data.frame() # e empty dataframe to store results

for (f in 1:length(filename_unique)) {
  # f = 2
  # video = filename_video[f]
  temp_df <- df_OF_output_andLand_unblind_spoken_binned_dcast%>%
    subset(Stimuli_frame == filename_unique[f])
  
    # start
  message(paste0("running video no_: ", f), paste0("_",filename_unique[f]))


  
  # First, isolate the points of interest (the subject's left and right eyes)
  left_eye  <- temp_df[temp_df$lanmark_id == 42,]
  right_eye <- temp_df[temp_df$lanmark_id == 39,] 
  
  # now find the difference in the y co-ordinates and x co-ordinates between these two points:
  diff_x <- left_eye$x - right_eye$x
  diff_y <- left_eye$y - right_eye$y
  
   message(paste0("angle - ratio - transform"))
  # The arctangent of the ratio will be the angle you need to rotate all the points by:
  theta  <- atan2(-diff_y, diff_x)
  
# print("matrix") 
# To transform the points, you need to create a rotation matrix, which is a specific two-by-two matrix which you can use to rotate the original points:
# 
# enter image description here - https://stackoverflow.com/questions/74493141/align-x-and-y-coordinates-of-face-landmarks-in-r/74493424?noredirect=1#comment131500839_74493424
  
  mat <- matrix(c(cos(theta), sin(theta), -sin(theta), cos(theta)), 2)

# Now we multiply each x, y point by this matrix to get our rotated points, and write it back into our original data frame:
  temp_df$x_new_norm_rot <- t(apply(temp_df[,16:17], 1, function(x) mat %*% x))[,1]
  temp_df$y_new_norm_rot <- t(apply(temp_df[,16:17], 1, function(x) mat %*% x))[,2] 
   
  message(paste0("bind datasets"))
  
    temp_df_bind<- bind_rows(temp_df_bind,temp_df)
}

temp_df_bind
# unique(temp_df_bind$filename)
unique(temp_df_bind$filename)

temp_df_bind

df_OF_output_land_spoken_binned_select_alligned_eyes<- temp_df_bind


```

Now compute displacement for landmarks
```{r}
require(tidyverse)
df_OF_output_land_spoken_binned_select_alligned_eyes<-

df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  mutate(lanmark_id = as.numeric(lanmark_id))%>%
  group_by(filename)%>%
  arrange(lanmark_id)%>%
  # group_by(filename, expression,lanmark_id)%>%
 group_by(filename, bin_frame)%>%
  mutate(x_new_norm_rot2 = maxnormalize(x_new_norm_rot),
         y_new_norm_rot2 = maxnormalize(y_new_norm_rot))%>%
  # compute landmark differences
  group_by(filename,lanmark_id)%>%
  mutate(x_norm_diff= x_new_norm_rot2 - lag(x_new_norm_rot2),
         y_norm_diff= y_new_norm_rot2 - lag(y_new_norm_rot2))%>%
# %>%
    mutate(x_norm_diff_abs= (x_norm_diff),#decide wherher to absolute or not, i cut the abs for now
         y_norm_diff_abs= (y_norm_diff))%>%

  # compute a sum - also consider a rolling sum

  mutate(fill_x_y_sum = (x_norm_diff_abs+y_norm_diff_abs)/2) %>%
  # this is what we are goint to use to colour pints
  
  group_by(filename,lanmark_id)%>%
  
  #the line below just ignores NA (introduced in lag) which would throw error to cumsum otehrwise
      mutate(cum_x_norm_abs_diff = cumsum(ifelse(is.na(x_norm_diff_abs), 0, x_norm_diff_abs)) + x_norm_diff_abs*0,
             cum_y_norm_abs_diff = cumsum(ifelse(is.na(y_norm_diff_abs), 0, y_norm_diff_abs)) + y_norm_diff_abs*0)%>%
  mutate(cum_x_y_norm_abs_diff_mean_fill = ((cum_x_norm_abs_diff+cum_y_norm_abs_diff)/2))%>%
  mutate(fill_x_y_sum2 = sum(fill_x_y_sum))%>%

  # normalise the fills
  group_by(subject, lanmark_id)%>%
  mutate(cum_x_y_norm_abs_diff_mean_fill_norm = maxnormalize(cum_y_norm_abs_diff))%>%
          # ungroup()%>% 
         
        mutate(fill_x_y_sum_norm = maxnormalize(fill_x_y_sum),
               # fill_x_y_sum_norm2 = maxnormalize(fill_x_y_sum2)
               )


df_OF_output_land_spoken_binned_select_alligned_eyes$fill_x_y_sum
```

# summarise for delaunay triangles and voronoi plots

```{r}

# range(df_OF_output_AUsW_unblind_spoken1_binned$bin_frame)
colnames(df_OF_output_land_spoken_binned_select_alligned_eyes)
df_OF_output_land_spoken_binned_select_alligned_eyes
colnames(df_OF_output_AUsW_unblind_spoken1_binned)

df_OF_output_land_spoken_binned_select_alligned_eyes<- left_join(df_OF_output_land_spoken_binned_select_alligned_eyes,
df_OF_output_AUsW_unblind_spoken1_binned[,c(1,2:3,10,34:36)])



# store component with correwct names

df_OF_output_land_spoken_binned_select_alligned_eyes$comp1<-df_OF_output_land_spoken_binned_select_alligned_eyes$k3_comp1

df_OF_output_land_spoken_binned_select_alligned_eyes$comp2<-df_OF_output_land_spoken_binned_select_alligned_eyes$k3_comp2

df_OF_output_land_spoken_binned_select_alligned_eyes$comp3<-df_OF_output_land_spoken_binned_select_alligned_eyes$k3_comp3

require(ggforce)
df_OF_output_land_spoken_binned_select_alligned_eyes<-
df_OF_output_land_spoken_binned_select_alligned_eyes %>%
    # subset(subject == 1)%>% 
 # filter(bin_frame>40 & bin_frame<75)%>%
 # filter(bin_frame>10 & bin_frame<60)%>%
  group_by(filename)%>%
  mutate(comp1_normmax = maxnormalize(comp1),
         comp2_normmax = maxnormalize(comp2),
         comp3_normmax = maxnormalize(comp3)
         
         )
  
    # mutate(comp1_NMFLand = maxnormalize(comp1_NMFLand),
         # comp2_NMFLand = maxnormalize(comp2_NMFLand),
         # comp3_NMFLand = maxnormalize(comp3_NMFLand)
         
         # )
# %>%
  # mutate(coef_fill = (comp1_normmax+comp2_normmax+comp3_normmax)*(nmf_land_value_norm1 +
                                                                    # nmf_land_value_norm2+nmf_land_value_norm3))%>%
  
    mutate(coef_fill =  (comp1_normmax+comp2_normmax+comp3_normmax)/3)%>% #+(nmf_land_value_norm1 *
                                                                    # nmf_land_value_norm2*nmf_land_value_norm3))%>%
  
# explore specific subj
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)


# visualise just one component
df_OF_output_land_spoken_binned_select_alligned_eyes %>%
    subset(subject == 1)%>% 
 # filter(bin_frame>40 & bin_frame<75)%>%
 filter(bin_frame>10 & bin_frame<60)%>%
  group_by(filename)%>%
  mutate(comp1_normmax = maxnormalize(comp1),
         comp2_normmax = maxnormalize(comp2),
         comp3_normmax = maxnormalize(comp3)
         
         )%>%
  
    # mutate(comp1_NMFLand = maxnormalize(comp1_NMFLand),
    #      comp2_NMFLand = maxnormalize(comp2_NMFLand),
    #      comp3_NMFLand = maxnormalize(comp3_NMFLand)
         
         # )%>%
  # mutate(coef_fill = (comp1_normmax+comp2_normmax+comp3_normmax)*(nmf_land_value_norm1 +
                                                                    # nmf_land_value_norm2+nmf_land_value_norm3))%>%
  
    mutate(coef_fill =  cum_x_y_norm_abs_diff_mean_fill_norm *(comp1_normmax ))%>%
  # %>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)

```

map component to landmark weights


```{r}

nrow(df_OF_output_land_spoken_binned_select_alligned_eyes)
# maybe we don't need to dcast

colnames(df_OF_output_land_spoken_binned_select_alligned_eyes)


range(df_OF_output_land_spoken_binned_select_alligned_eyes$cum_x_y_norm_abs_diff_mean_fill_norm, na.rm = T)

# if_else(is.na(df_OF_output_land_spoken_binned_select_alligned_eyes$cum_x_y_norm_abs_diff_mean_fill_norm) == TRUE,0,df_OF_output_land_spoken_binned_select_alligned_eyes$cum_x_y_norm_abs_diff_mean_fill_norm )
options(scipen = 999)
df_OF_output_land_spoken_binned_select_alligned_eyes$comp3_normmax

df_OF_output_land_spoken_binned_select_alligned_eyes<-
df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  ungroup()%>%
  mutate(cum_x_y_norm_abs_diff_mean_fill_norm =
           if_else(is.na(cum_x_y_norm_abs_diff_mean_fill_norm) == TRUE, 0,
                   cum_x_y_norm_abs_diff_mean_fill_norm)) %>%
  group_by(lanmark_id)%>% #consider grouping it by file too
  mutate(cor_comp1_land_cum_diff_fill = cor(cum_x_y_norm_abs_diff_mean_fill_norm,comp1_normmax,use = "complete.obs"),
    cor_comp2_land_cum_diff_fill = cor(cum_x_y_norm_abs_diff_mean_fill_norm,comp2_normmax,use = "complete.obs"), 
    cor_comp3_land_cum_diff_fill = cor(cum_x_y_norm_abs_diff_mean_fill_norm,comp3_normmax, use = "complete.obs"))



df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  group_by(lanmark_id)%>%
  summarise_if(is.numeric, mean, narm = TRUE)%>%
  select(lanmark_id,cor_comp1_land_cum_diff_fill,cor_comp2_land_cum_diff_fill,cor_comp3_land_cum_diff_fill)%>%
  gather(key,value,-lanmark_id)%>%
  ggplot(aes(lanmark_id,key,fill = value^2))+
  geom_tile()+
  scale_fill_viridis_c(option = "magma")


# comp1
df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  mutate(cor_comp1_land_cum_diff_fill_sq = cor_comp1_land_cum_diff_fill^2,
         cor_comp2_land_cum_diff_fill_sq = cor_comp2_land_cum_diff_fill^2,
         cor_comp3_land_cum_diff_fill_sq = cor_comp3_land_cum_diff_fill^2
         )%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
   mutate(coef_fill =  cum_x_y_norm_abs_diff_mean_fill_norm *(cor_comp1_land_cum_diff_fill_sq ))%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)

# comp2
df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  mutate(cor_comp1_land_cum_diff_fill_sq = cor_comp1_land_cum_diff_fill^2,
         cor_comp2_land_cum_diff_fill_sq = cor_comp2_land_cum_diff_fill^2,
         cor_comp3_land_cum_diff_fill_sq = cor_comp3_land_cum_diff_fill^2
         )%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
   mutate(coef_fill =  cum_x_y_norm_abs_diff_mean_fill_norm *(cor_comp2_land_cum_diff_fill_sq ))%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)

# comp3
df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  mutate(cor_comp1_land_cum_diff_fill_sq = cor_comp1_land_cum_diff_fill^2,
         cor_comp2_land_cum_diff_fill_sq = cor_comp2_land_cum_diff_fill^2,
         cor_comp3_land_cum_diff_fill_sq = cor_comp3_land_cum_diff_fill^2
         )%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
   mutate(coef_fill =  cum_x_y_norm_abs_diff_mean_fill_norm *(cor_comp3_land_cum_diff_fill_sq ))%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)


# just expressions

df_OF_output_land_spoken_binned_select_alligned_eyes<- df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  mutate(cor_comp1_land_cum_diff_fill_sq = cor_comp1_land_cum_diff_fill^2,
         cor_comp2_land_cum_diff_fill_sq = cor_comp2_land_cum_diff_fill^2,
         cor_comp3_land_cum_diff_fill_sq = cor_comp3_land_cum_diff_fill^2
         )
df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  ungroup()%>%
  # group_by(lanmark_id)
  mutate(cor_comp1_land_cum_diff_fill_sq_max_norm = maxnormalize(cor_comp1_land_cum_diff_fill_sq),
         cor_comp2_land_cum_diff_fill_sq_max_norm = maxnormalize(cor_comp2_land_cum_diff_fill_sq),
         cor_comp3_land_cum_diff_fill_sq_max_norm = maxnormalize(cor_comp3_land_cum_diff_fill_sq))%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
   mutate(coef_fill =  cum_x_y_norm_abs_diff_mean_fill_norm* ((cor_comp1_land_cum_diff_fill_sq_max_norm+cor_comp2_land_cum_diff_fill_sq_max_norm+
   cor_comp3_land_cum_diff_fill_sq_max_norm)/3))%>% #*(cor_comp3_land_cum_diff_fill_sq ))%>%
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = x_new_norm_rot2, y = 1-y_new_norm_rot2, fill = coef_fill,
               colour = coef_fill))+
   geom_voronoi_tile(aes(fill = coef_fill), colour =NA)+
   geom_point(aes(y = 1-y_new_norm_rot2), colour = "white",size = .5,alpha = .5)+
     scale_color_viridis_c(option = "magma")+
  scale_fill_viridis_c(option = "magma")+
    facet_grid(~expression)+
  geom_hline(yintercept = 1)

# maxnorm squared
df_OF_output_land_spoken_binned_select_alligned_eyes<-
df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  ungroup()%>%
  # group_by(lanmark_id)
  mutate(cor_comp1_land_cum_diff_fill_sq_max_norm = maxnormalize(cor_comp1_land_cum_diff_fill_sq),
         cor_comp2_land_cum_diff_fill_sq_max_norm = maxnormalize(cor_comp2_land_cum_diff_fill_sq),
         cor_comp3_land_cum_diff_fill_sq_max_norm = maxnormalize(cor_comp3_land_cum_diff_fill_sq))

```

delaunay plots


```{r}
df_OF_output_land_spoken_binned_select_alligned_eyes_agg<-
# colnames(df_OF_output_land_spoken_binned_select_alligned_eyes)
df_OF_output_land_spoken_binned_select_alligned_eyes%>%
  
  mutate(coef_fill =cum_x_y_norm_abs_diff_mean_fill_norm* ((cor_comp1_land_cum_diff_fill_sq_max_norm+cor_comp2_land_cum_diff_fill_sq_max_norm+cor_comp3_land_cum_diff_fill_sq_max_norm)/3))%>%
  
  mutate(coef_fill_max_norm = maxnormalize(coef_fill))%>%
  
  group_by(expression, lanmark_id)%>% #posed.spoken
  summarise_if(is.numeric, mean, na.rm = T)


df_OF_output_land_spoken_binned_select_alligned_eyes_agg

```



```{r}
library(deldir)

df_OF_output_land_spoken_binned_select_alligned_eyes_agg

tri_data<-list()


tri_data$tri_data_spoken_all<-
triang.list(deldir(df_OF_output_land_spoken_binned_select_alligned_eyes_agg$x_new_norm_rot2, 
                          df_OF_output_land_spoken_binned_select_alligned_eyes_agg$y_new_norm_rot2))

delaunay_spoken<-list()

delaunay_spoken$delaunay_tri_all_spoken

# 
do.call(rbind, lapply(seq_along(tri_data$tri_data_spoken_all), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_data$tri_data_spoken_all[[x]]$x, y_new_norm_rot2 = tri_data$tri_data_spoken_all[[x]]$y, 
             coef_fill = mean(df_OF_output_land_spoken_binned_select_alligned_eyes_agg$coef_fill[tri_data$tri_data_spoken_all[[x]]$ptNum]),
             tri = x)
  })) |>
  # mutate(count = 1:1518)%>%
  # mutate(expression = cut(count,3, labels = c("anger", "happiness", "sadness")))%>%
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  geom_polygon(aes(fill = coef_fill, group = tri)) +

  geom_point(aes(colour = coef_fill))+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")
#   facet_grid(~expression)
# 
# delaunay_tri_all

View(delaunay_tri_all)

```


expressions


```{r}
df_OF_output_land_spoken_binned_select_alligned_eyes_agg$expression

delaunay_spoken_data<-list()

delaunay_spoken_data$anger_del<-subset(df_OF_output_land_spoken_binned_select_alligned_eyes_agg,
                expression == "angry")
delaunay_spoken_data$anger_del

delaunay_spoken_data$happy_del<-subset(df_OF_output_land_spoken_binned_select_alligned_eyes_agg,
                expression == "happy")


delaunay_spoken_data$sad_del<-subset(df_OF_output_land_spoken_binned_select_alligned_eyes_agg,
                expression == "sad")



```

Spoken anger delaunay


```{r}


delaunay_spoken_data$tri_ang <- triang.list(deldir(delaunay_spoken_data$anger_del$x_new_norm_rot2, 
                          delaunay_spoken_data$anger_del$y_new_norm_rot2))


tri_angtest <- triang.list(deldir(delaunay_spoken_data$anger_del$x_new_norm_rot2, 
                          delaunay_spoken_data$anger_del$y_new_norm_rot2))


delaunay_spoken_data$tri_ang



# do.call(rbind, lapply(seq_along(tri_ang), 
#                       function(x) {
#   data.frame(x_new_norm_rot2 = tri_ang[[x]]$x, y_new_norm_rot2 = tri_ang[[x]]$y, 
#              coef_fill = mean(anger_del$cum_x_y_norm_abs_diff_mean_fill_norm[tri_ang[[x]]$ptNum]),
#              tri_ang = x)
#   })) |>
#   
#   

delaunay_spoken_plots<-list()

delaunay_spoken_plots$spoken_triang_ang<-
do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_ang), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_angtest[[x]]$x, 
             y_new_norm_rot2 = tri_angtest[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$anger_del$coef_fill_max_norm[tri_angtest[[x]]$ptNum]),
             tri_angtest = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_angtest)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

delaunay_spoken_plots$spoken_triang_ang
  
# theme(plot.background = element_rect(fill = "black"),
#                                        legend.position = "none")



# comp 1 anger


delaunay_spoken_data$anger_del$cor_comp1_land_cum_diff_fill_sq_max_norm

# delaunay_spoken_data$tri_ang <- triang.list(deldir(delaunay_spoken_data$anger_del$x_new_norm_rot2, 
#                           delaunay_spoken_data$anger_del$y_new_norm_rot2))

# 
# tri_angtest <- triang.list(deldir(delaunay_spoken_data$anger_del$x_new_norm_rot2, 
#                           delaunay_spoken_data$anger_del$y_new_norm_rot2))
# 

delaunay_spoken_data$tri_ang

delaunay_spoken_plots$spoken_triang_ang_comp1 <-

do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_ang), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_angtest[[x]]$x, 
             y_new_norm_rot2 = tri_angtest[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$anger_del$cor_comp1_land_cum_diff_fill_sq_max_norm[tri_angtest[[x]]$ptNum]),
             tri_angtest = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_angtest)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

delaunay_spoken_plots$spoken_triang_ang_comp1

# comp 2
delaunay_spoken_plots$spoken_triang_ang_comp2 <-

do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_ang), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_angtest[[x]]$x, 
             y_new_norm_rot2 = tri_angtest[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$anger_del$cor_comp2_land_cum_diff_fill_sq_max_norm[tri_angtest[[x]]$ptNum]),
             tri_angtest = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_angtest)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

delaunay_spoken_plots$spoken_triang_ang_comp2

# comp 3
delaunay_spoken_plots$spoken_triang_ang_comp3 <-

do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_ang), 
                      function(x) {
  data.frame(x_new_norm_rot2 = tri_angtest[[x]]$x, 
             y_new_norm_rot2 = tri_angtest[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$anger_del$cor_comp3_land_cum_diff_fill_sq_max_norm[tri_angtest[[x]]$ptNum]),
             tri_angtest = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = tri_angtest)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

delaunay_spoken_plots$spoken_triang_ang_comp3

require(patchwork)
  delaunay_spoken_plots$spoken_triang_ang/
    (delaunay_spoken_plots$spoken_triang_ang_comp1|delaunay_spoken_plots$spoken_triang_ang_comp2|delaunay_spoken_plots$spoken_triang_ang_comp3)

```

happy

```{r}

delaunay_spoken_data$tri_happy<- triang.list(deldir(delaunay_spoken_data$happy_del$x_new_norm_rot2, 
                          delaunay_spoken_data$happy_del$y_new_norm_rot2))


spoken_tri_happy<- triang.list(deldir(delaunay_spoken_data$happy_del$x_new_norm_rot2, 
                          delaunay_spoken_data$happy_del$y_new_norm_rot2))




delaunay_spoken_plots$spoken_triang_happy<-
do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_happy), 
                      function(x) {
  data.frame(x_new_norm_rot2 = delaunay_spoken_data$tri_happy[[x]]$x, 
             y_new_norm_rot2 = delaunay_spoken_data$tri_happy[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$happy_del$coef_fill_max_norm[
   spoken_tri_happy[[x]]$ptNum]),
             spoken_tri_happy = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = spoken_tri_happy)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

delaunay_spoken_plots$spoken_triang_ang
delaunay_spoken_plots$spoken_triang_happy

```
  


# comp 1 happy

```{r}


delaunay_spoken_data$happy_del$cor_comp1_land_cum_diff_fill_sq_max_norm

# delaunay_spoken_data$tri_happy<- triang.list(deldir(delaunay_spoken_data$happy_del$x_new_norm_rot2, 
#                           delaunay_spoken_data$happy_del$y_new_norm_rot2))

# 
# tri_angtest <- triang.list(deldir(delaunay_spoken_data$happy_del$x_new_norm_rot2, 
#                           delaunay_spoken_data$happy_del$y_new_norm_rot2))
# 

delaunay_spoken_data$tri_ang

delaunay_spoken_plots$spoken_triang_happy_comp1 

delaunay_spoken_plots$spoken_triang_ang_comp1 

delaunay_spoken_plots$spoken_triang_happy_comp1 <-
do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_happy), 
                      function(x) {
  data.frame(x_new_norm_rot2 = spoken_tri_happy[[x]]$x, 
             y_new_norm_rot2 = spoken_tri_happy[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$happy_del$cor_comp1_land_cum_diff_fill_sq_max_norm[spoken_tri_happy[[x]]$ptNum]),
             spoken_tri_happy = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = spoken_tri_happy)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

```

delaunay_spoken_plots$spoken_triang_happy_comp1

# comp 2

```{r}
delaunay_spoken_plots$spoken_triang_happy_comp2 <-
do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_happy), 
                      function(x) {
  data.frame(x_new_norm_rot2 = spoken_tri_happy[[x]]$x, 
             y_new_norm_rot2 = spoken_tri_happy[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$happy_del$cor_comp2_land_cum_diff_fill_sq_max_norm[spoken_tri_happy[[x]]$ptNum]),
             spoken_tri_happy = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = spoken_tri_happy)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

delaunay_spoken_plots$spoken_triang_ang_comp2
delaunay_spoken_plots$spoken_triang_happy_comp2


```

# comp 3

```{r}
delaunay_spoken_plots$spoken_triang_happy_comp3 <-

do.call(rbind, lapply(seq_along(delaunay_spoken_data$tri_happy), 
                      function(x) {
  data.frame(x_new_norm_rot2 = spoken_tri_happy[[x]]$x, 
             y_new_norm_rot2 = spoken_tri_happy[[x]]$y, 
 coef_fill = mean(delaunay_spoken_data$happy_del$cor_comp3_land_cum_diff_fill_sq_max_norm[spoken_tri_happy[[x]]$ptNum]),
             spoken_tri_happy = x)
  })) |>
  ggplot(aes(x_new_norm_rot2, 1-y_new_norm_rot2)) +
  # tri
  geom_polygon(aes(fill = coef_fill, group = spoken_tri_happy)) +

  geom_point(colour = "white", alpha = .5, size = .4)+
    scale_fill_viridis_c(option = "magma")+
    scale_colour_viridis_c(option = "magma")+
  theme_void()+
    theme(
                                       legend.position = "none")

delaunay_spoken_plots$spoken_triang_ang_comp3
delaunay_spoken_plots$spoken_triang_happy_comp3

```

```{r}
require(patchwork)
  delaunay_spoken_plots$spoken_triang_ang/
    (delaunay_spoken_plots$spoken_triang_ang_comp1|delaunay_spoken_plots$spoken_triang_ang_comp2|delaunay_spoken_plots$spoken_triang_ang_comp3)/
     delaunay_spoken_plots$spoken_triang_happy/
    (delaunay_spoken_plots$spoken_triang_happy_comp1|delaunay_spoken_plots$spoken_triang_happy_comp2|delaunay_spoken_plots$spoken_triang_happy_comp3)
  
  # i gues of we do the corelation per filename, we can get comp[onents that vary per expression]

```



